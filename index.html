<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی شهر مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS styles remain mostly the same as your original file, with minor additions for new elements */
        body { font-family: 'Vazirmatn', sans-serif; color: #e0e0e0; overflow-x: hidden; }
        .mafia-animated-bg { background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a); background-size: 400% 400%; animation: gradientAnimation 30s ease infinite; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .panel { background-color: rgba(30, 30, 30, 0.95); border: 1px solid #c49730; box-shadow: 0 0 20px rgba(200, 150, 50, 0.5); transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        .panel-hidden { opacity: 0; transform: scale(0.9) translateY(-20px); pointer-events: none; visibility: hidden; }
        .panel-visible { opacity: 1; transform: scale(1) translateY(0); visibility: visible; }
        .btn-mafia { background-color: #c49730; color: #1a1a1a; border: 2px solid #a57c1a; padding: 8px 16px; font-size: 0.9rem; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; }
        @media (min-width: 640px) { .btn-mafia { padding: 10px 20px; font-size: 1rem; } }
        .btn-mafia:hover { background-color: #d4a840; box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4); transform: translateY(-2px); }
        .btn-mafia:disabled { background-color: #7e6a3b; color: #524425; border-color: #6a531f; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-mafia-secondary { background-color: #4a4a4a; color: #e0e0e0; border: 2px solid #333333; padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; transition: all 0.3s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        @media (min-width: 640px) { .btn-mafia-secondary { padding: 8px 16px; font-size: 0.9rem; } }
        .btn-mafia-secondary:hover { background-color: #5a5a5a; color: #c49730; transform: scale(1.05) translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .input-mafia { background-color: #333; border: 1px solid #c49730; color: #e0e0e0; border-radius: 8px; padding: 10px; font-size: 1rem; }
        .input-mafia:focus { outline: none; box-shadow: 0 0 10px rgba(200, 150, 50, 0.7); }
        .input-mafia.invalid { border-color: #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.7); }
        .option-btn { background-color: rgba(50, 50, 50, 0.8); border: 1px solid #c49730; color: #e0e0e0; transition: background-color 0.3s ease, transform 0.2s ease; padding: 12px; }
        .option-btn:hover { background-color: rgba(70, 70, 70, 0.9); transform: scale(1.02); }
        .option-btn.correct { background-color: #28a745 !important; border-color: #1e7e34 !important; }
        .option-btn.incorrect { background-color: #dc3545 !important; border-color: #b02a37 !important; }
        .loader { border: 8px solid #444; border-top: 8px solid #c49730; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .screen { position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh; padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden; transition: opacity 0.7s ease-in-out, visibility 0.7s; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .screen.active { opacity: 1; visibility: visible; position: relative; z-index: 1; }
        .screen-content-wrapper { width: 100%; max-width: 800px; margin: auto; padding-bottom: 20px; }
        #user-profile-area { position: fixed; z-index: 100; top: 20px; right: 20px; }
        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error { color: #dc3545; font-size: 0.875rem; text-align: right; min-height: 1.2rem; margin-top: 0.25rem; }
        .hidden { display: none !important; }

        /* Styles for Clan (Family) Screen */
        .clan-member-item { background-color: rgba(40,40,40,0.8); padding: 10px 15px; border-radius: 8px; border-right: 4px solid #c49730; }
        .clan-member-role { font-size: 0.8em; color: #a0a0a0; }
        #clan-chat-messages { height: 250px; background-color: rgba(10,10,10,0.5); border: 1px solid #444; border-radius: 8px; padding: 10px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message { background-color: rgba(50,50,50,0.7); padding: 8px; border-radius: 6px; margin-bottom: 8px; }
        .chat-message-sender { font-weight: bold; color: #c49730; margin-left: 8px; }
        .chat-message-time { font-size: 0.75em; color: #888; }
        .clan-list-item { cursor: pointer; }
        .clan-list-item:hover { background-color: rgba(196, 151, 48, 0.1); }
    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>
    <!-- User Profile Area (simplified for brevity) -->
    <div id="user-profile-area" class="hidden">...</div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <h1 class="text-4xl font-bold mb-6 text-[#c49730]">بارگذاری شهر مافیا...</h1>
        <div class="loader mb-4"></div>
        <p id="loading-message" class="text-xl">در حال بررسی اتصال...</p>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
             <div id="registration-form" class="panel p-6 rounded-lg max-w-md mx-auto">...</div>
             <div id="main-screen-buttons-layout" class="mt-8 hidden">
                <div id="top-action-buttons" class="flex flex-wrap justify-center gap-4">
                    <button id="start-game-btn" class="btn-mafia">شروع بازی آنلاین</button>
                    <button id="clan-btn" class="btn-mafia">خانواده 👑</button>
                    <button id="mafia-fact-btn" class="btn-mafia">دانستنی‌های مافیا ✨</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Screen (Trivia) -->
    <div id="game-screen" class="screen">...</div>

    <!-- NEW: Clan (Family) Screen -->
    <div id="clan-screen" class="screen">
        <div class="screen-content-wrapper">
            <div class="flex justify-between items-center mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg">
                <button id="back-to-main-from-clan-btn" class="btn-mafia-secondary">بازگشت ⟵</button>
                <h2 class="text-3xl font-bold text-[#c49730]">خانواده</h2>
                <div></div>
            </div>

            <!-- View for users NOT in a clan -->
            <div id="clan-join-create-view" class="hidden">
                <div class="panel p-6 rounded-lg text-center">
                    <p class="mb-6 text-lg">شما در حال حاضر عضو هیچ خانواده‌ای نیستید.</p>
                    <button id="show-create-clan-modal-btn" class="btn-mafia w-full mb-4">ایجاد خانواده جدید</button>
                    <h3 class="text-xl font-semibold mt-8 mb-4 border-b-2 border-[#c49730] pb-2">لیست خانواده‌های فعال</h3>
                    <div id="public-clans-list" class="space-y-3 max-h-96 overflow-y-auto p-2">
                        <!-- Clan list will be populated here -->
                        <p>در حال بارگذاری لیست...</p>
                    </div>
                </div>
            </div>

            <!-- View for users IN a clan -->
            <div id="clan-details-view" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left Column (Mobile: Top) - Clan Info & Members -->
                <div class="md:col-span-1 space-y-6">
                    <div class="panel p-6 rounded-lg">
                        <h3 id="clan-name-display" class="text-2xl font-bold text-[#c49730] mb-1"></h3>
                        <p id="clan-tag-display" class="text-gray-400 mb-4 font-mono"></p>
                        <p id="clan-description-display" class="text-sm mb-4"></p>
                        <button id="leave-clan-btn" class="btn-mafia-secondary w-full bg-red-800/50 border-red-600 hover:bg-red-700/50">ترک خانواده</button>
                    </div>
                    <div class="panel p-6 rounded-lg">
                        <h4 class="text-xl font-semibold mb-4 text-[#c49730]">اعضا (<span id="clan-member-count"></span>)</h4>
                        <div id="clan-members-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- Member list will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column (Mobile: Bottom) - Clan Chat -->
                <div class="panel p-6 rounded-lg md:col-span-2">
                    <h3 class="text-2xl font-semibold mb-4 text-[#c49730]">چت خانواده</h3>
                    <div id="clan-chat-messages" class="mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="clan-chat-input" class="input-mafia w-full" placeholder="پیام خود را بنویسید...">
                        <button id="send-clan-message-btn" class="btn-mafia">ارسال</button>
                    </div>
                    <p id="chat-message-error"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel p-8 rounded-lg max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#c49730]"></h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3"></p>
                <!-- Container for changing name -->
                <div id="change-name-input-container" class="hidden">...</div>
                <!-- Container for avatar generation -->
                <div id="avatar-generation-container" class="hidden">...</div>
                <!-- NEW: Container for creating a clan -->
                <div id="create-clan-input-container" class="hidden space-y-4">
                    <input type="text" id="new-clan-name-input" placeholder="نام خانواده (فارسی یا انگلیسی)" class="input-mafia w-full" maxlength="30">
                    <input type="text" id="new-clan-tag-input" placeholder="تگ 3-5 کاراکتری (فقط انگلیسی)" class="input-mafia w-full" maxlength="5">
                    <textarea id="new-clan-description-input" placeholder="توضیح کوتاه درباره خانواده" class="input-mafia w-full h-24" maxlength="150"></textarea>
                    <p id="create-clan-error-message"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-4">
                <button id="modal-confirm-btn" class="btn-mafia"></button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary"></button>
            </div>
        </div>
    </div>

    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 ... z-[51]">...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc, writeBatch, limit, getDocs, runTransaction, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (remains the same) ---
        const firebaseConfig = {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
        };
        const appId = 'mafia-game-default';
        
        // --- App State ---
        let app, auth, db, currentUserId = null, isAuthReady = false, clanChatUnsubscribe = null;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            avatarUrl: '',
            clanId: null, // NEW: To store the user's current clan ID
            clanData: null, // NEW: To store details of the current clan
        };

        // --- DOM Elements ---
        let loadingScreen, mainScreen, gameScreen, clanScreen, backToMainFromClanBtn,
            registrationForm, mainScreenButtonsLayout, clanBtn, showCreateClanModalBtn,
            clanJoinCreateView, clanDetailsView, publicClansList,
            clanNameDisplay, clanTagDisplay, clanDescriptionDisplay, leaveClanBtn,
            clanMemberCount, clanMembersList, clanChatMessages, clanChatInput, sendClanMessageBtn,
            chatMessageError, modalContainer, modalTitle, modalContentDynamic, modalMessage,
            createClanInputContainer, newClanNameInput, newClanTagInput, newClanDescriptionInput,
            createClanErrorMessage, modalConfirmBtn, modalCancelBtn;
        
        // --- Utility Functions ---
        function showScreen(screenElement) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            updateUI();
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            
            // Hide all special containers first
            createClanInputContainer.classList.add('hidden');

            if (modalType === "createClan") {
                createClanInputContainer.classList.remove('hidden');
                createClanErrorMessage.textContent = '';
            }
            
            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.onclick = onConfirm; // Simplified for this example
            
            if (cancelText) {
                modalCancelBtn.textContent = cancelText;
                modalCancelBtn.classList.remove('hidden');
                modalCancelBtn.onclick = onCancel || hideModal;
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
        }

        function hideModal() {
            modalContainer.classList.add('panel-hidden');
        }

        // --- UI Update ---
        function updateUI() {
            // ... (existing UI update logic for profile, etc.)
            
            const isRegistered = isAuthReady && gameState.displayName && gameState.publicUserId;
            if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.toggle('hidden', !isRegistered);
            if(registrationForm) registrationForm.classList.toggle('hidden', isRegistered);

            if (clanScreen.classList.contains('active')) {
                if (gameState.clanId && gameState.clanData) {
                    clanJoinCreateView.classList.add('hidden');
                    clanDetailsView.classList.remove('hidden');
                    displayClanDetails();
                } else {
                    clanJoinCreateView.classList.remove('hidden');
                    clanDetailsView.classList.add('hidden');
                    loadPublicClans();
                }
            }
        }
        
        // --- Firebase Core Functions ---
        async function initFirebase() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    await loadUserData();
                } else {
                    await signInAnonymously(auth);
                }
                isAuthReady = true;
                if(loadingScreen.classList.contains('active')) {
                    setTimeout(() => showScreen(mainScreen), 500);
                }
                updateUI();
            });
        }
        
        async function loadUserData() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                gameState.displayName = data.displayName || "";
                gameState.publicUserId = data.publicUserId || "";
                gameState.avatarUrl = data.avatarUrl || '';
                gameState.clanId = data.clanId || null; // Load clan ID
                
                if (gameState.clanId) {
                    await loadClanData(gameState.clanId);
                }
            }
            // ... (rest of the function)
        }

        async function saveUserData(dataToSave) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            await setDoc(userDocRef, { ...dataToSave, lastUpdated: serverTimestamp() }, { merge: true });
        }

        // --- NEW: Clan (Family) Functions ---

        async function createClan() {
            const name = newClanNameInput.value.trim();
            const tag = newClanTagInput.value.trim().toUpperCase();
            const description = newClanDescriptionInput.value.trim();

            if (name.length < 3 || name.length > 30) {
                createClanErrorMessage.textContent = "نام خانواده باید بین ۳ تا ۳۰ کاراکتر باشد."; return;
            }
            if (!/^[A-Z0-9]{3,5}$/.test(tag)) {
                createClanErrorMessage.textContent = "تگ باید ۳ تا ۵ کاراکتر انگلیسی و بدون فاصله باشد."; return;
            }

            try {
                const batch = writeBatch(db);
                const clanDocRef = doc(collection(db, "clans"));

                // 1. Create the clan document
                batch.set(clanDocRef, {
                    name, tag, description,
                    ownerId: currentUserId,
                    ownerName: gameState.displayName,
                    memberCount: 1,
                    createdAt: serverTimestamp()
                });

                // 2. Add owner as the first member
                const memberDocRef = doc(db, `clans/${clanDocRef.id}/members/${currentUserId}`);
                batch.set(memberDocRef, {
                    displayName: gameState.displayName,
                    role: "owner",
                    joinedAt: serverTimestamp()
                });

                // 3. Update user's profile with clanId
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                batch.update(userProfileRef, { clanId: clanDocRef.id });

                await batch.commit();

                gameState.clanId = clanDocRef.id;
                await loadClanData(clanDocRef.id);
                hideModal();
                updateUI();

            } catch (error) {
                console.error("Error creating clan: ", error);
                createClanErrorMessage.textContent = "خطا در ایجاد خانواده. لطفاً دوباره تلاش کنید.";
            }
        }

        async function joinClan(clanId) {
            if (gameState.clanId) {
                showModal("خطا", "شما قبلاً عضو یک خانواده هستید."); return;
            }
            try {
                const clanDocRef = doc(db, "clans", clanId);
                await runTransaction(db, async (transaction) => {
                    const clanDoc = await transaction.get(clanDocRef);
                    if (!clanDoc.exists()) throw "Clan not found!";
                    
                    // Add member to subcollection
                    const memberDocRef = doc(db, `clans/${clanId}/members/${currentUserId}`);
                    transaction.set(memberDocRef, {
                        displayName: gameState.displayName,
                        role: "member",
                        joinedAt: serverTimestamp()
                    });
                    
                    // Update user profile
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                    transaction.update(userProfileRef, { clanId: clanId });

                    // Increment member count
                    transaction.update(clanDocRef, { memberCount: increment(1) });
                });

                gameState.clanId = clanId;
                await loadClanData(clanId);
                updateUI();

            } catch (error) {
                console.error("Error joining clan: ", error);
                showModal("خطا", "امکان عضویت در این خانواده وجود ندارد.");
            }
        }

        async function leaveClan() {
             if (!gameState.clanId) return;
             const clanId = gameState.clanId;
             try {
                const clanDocRef = doc(db, "clans", clanId);
                await runTransaction(db, async (transaction) => {
                    // Delete member from subcollection
                    const memberDocRef = doc(db, `clans/${clanId}/members/${currentUserId}`);
                    transaction.delete(memberDocRef);
                    
                    // Update user profile
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                    transaction.update(userProfileRef, { clanId: null });

                    // Decrement member count
                    transaction.update(clanDocRef, { memberCount: increment(-1) });
                });

                if (clanChatUnsubscribe) clanChatUnsubscribe();
                gameState.clanId = null;
                gameState.clanData = null;
                updateUI();

             } catch (error) {
                 console.error("Error leaving clan:", error);
                 showModal("خطا", "مشکلی در ترک خانواده پیش آمد.");
             }
        }
        
        async function loadClanData(clanId) {
            const clanDocRef = doc(db, "clans", clanId);
            const clanDoc = await getDoc(clanDocRef);

            if (clanDoc.exists()) {
                gameState.clanData = { id: clanDoc.id, ...clanDoc.data() };
                await loadClanMembers(clanId);
                listenForClanChat(clanId);
            } else {
                gameState.clanId = null;
                gameState.clanData = null;
            }
        }

        async function loadClanMembers(clanId) {
            const membersQuery = query(collection(db, `clans/${clanId}/members`), orderBy("joinedAt"));
            const snapshot = await getDocs(membersQuery);
            gameState.clanData.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadPublicClans() {
            publicClansList.innerHTML = `<div class="loader mx-auto"></div>`;
            const clansQuery = query(collection(db, "clans"), orderBy("memberCount", "desc"), limit(20));
            const snapshot = await getDocs(clansQuery);
            publicClansList.innerHTML = "";
            if (snapshot.empty) {
                publicClansList.innerHTML = `<p>هنوز هیچ خانواده‌ای ساخته نشده. اولین نفر باش!</p>`;
            } else {
                snapshot.forEach(doc => {
                    const clan = { id: doc.id, ...doc.data() };
                    const clanEl = document.createElement('div');
                    clanEl.className = 'panel clan-list-item flex justify-between items-center p-3 rounded-lg border-transparent border-2 hover:border-[#c49730]';
                    clanEl.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${clan.name} <span class="text-sm text-gray-400">[${clan.tag}]</span></p>
                            <p class="text-xs text-gray-300">اعضا: ${clan.memberCount} | موسس: ${clan.ownerName}</p>
                        </div>
                        <button class="btn-mafia-secondary">عضویت</button>
                    `;
                    clanEl.querySelector('button').onclick = (e) => {
                        e.stopPropagation();
                        joinClan(clan.id);
                    };
                    publicClansList.appendChild(clanEl);
                });
            }
        }
        
        function displayClanDetails() {
            if (!gameState.clanData) return;
            const { name, tag, description, memberCount, members } = gameState.clanData;
            clanNameDisplay.textContent = name;
            clanTagDisplay.textContent = `[${tag}]`;
            clanDescriptionDisplay.textContent = description;
            clanMemberCount.textContent = memberCount;
            
            clanMembersList.innerHTML = "";
            members.forEach(member => {
                const memberEl = document.createElement('div');
                memberEl.className = 'clan-member-item';
                memberEl.innerHTML = `
                    <p class="font-bold">${member.displayName}</p>
                    <p class="clan-member-role">${member.role}</p>
                `;
                clanMembersList.appendChild(memberEl);
            });
        }

        function listenForClanChat(clanId) {
            if (clanChatUnsubscribe) clanChatUnsubscribe(); // Unsubscribe from previous listener
            const chatQuery = query(collection(db, `clans/${clanId}/chat`), orderBy("timestamp", "desc"), limit(50));
            
            clanChatUnsubscribe = onSnapshot(chatQuery, (snapshot) => {
                clanChatMessages.innerHTML = "";
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgEl = document.createElement('div');
                    msgEl.className = 'chat-message';
                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'}) : '';
                    msgEl.innerHTML = `
                        <div>
                            <span class="chat-message-sender">${msg.senderName}:</span>
                            <span>${msg.text}</span>
                        </div>
                        <div class="text-left text-xs text-gray-500">${time}</div>
                    `;
                    clanChatMessages.appendChild(msgEl);
                });
            });
        }
        
        async function sendClanMessage() {
            const text = clanChatInput.value.trim();
            if (text.length === 0 || !gameState.clanId) return;

            sendClanMessageBtn.disabled = true;
            try {
                await addDoc(collection(db, `clans/${gameState.clanId}/chat`), {
                    senderId: currentUserId,
                    senderName: gameState.displayName,
                    text: text,
                    timestamp: serverTimestamp()
                });
                clanChatInput.value = "";
            } catch (error) {
                console.error("Error sending message:", error);
                chatMessageError.textContent = "خطا در ارسال پیام.";
            } finally {
                sendClanMessageBtn.disabled = false;
            }
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // ... (your existing event listeners)

            clanBtn.addEventListener('click', () => showScreen(clanScreen));
            backToMainFromClanBtn.addEventListener('click', () => showScreen(mainScreen));
            
            showCreateClanModalBtn.addEventListener('click', () => {
                showModal(
                    "ایجاد خانواده جدید",
                    "یک نام، تگ و توضیح برای خانواده خود انتخاب کنید.",
                    "ایجاد کن", "لغو",
                    createClan, hideModal, "createClan"
                );
            });

            leaveClanBtn.addEventListener('click', () => {
                 showModal(
                    "ترک خانواده",
                    "آیا مطمئن هستید که می‌خواهید این خانواده را ترک کنید؟",
                    "بله، ترک می‌کنم", "لغو",
                    leaveClan, hideModal
                );
            });
            
            sendClanMessageBtn.addEventListener('click', sendClanMessage);
            clanChatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendClanMessage();
            });
        }

        // --- Game Initialization ---
        async function initializeGame() {
            // Cache all DOM elements
            loadingScreen = document.getElementById('loading-screen');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            clanScreen = document.getElementById('clan-screen');
            registrationForm = document.getElementById('registration-form');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            clanBtn = document.getElementById('clan-btn');
            backToMainFromClanBtn = document.getElementById('back-to-main-from-clan-btn');
            showCreateClanModalBtn = document.getElementById('show-create-clan-modal-btn');
            clanJoinCreateView = document.getElementById('clan-join-create-view');
            clanDetailsView = document.getElementById('clan-details-view');
            publicClansList = document.getElementById('public-clans-list');
            clanNameDisplay = document.getElementById('clan-name-display');
            clanTagDisplay = document.getElementById('clan-tag-display');
            clanDescriptionDisplay = document.getElementById('clan-description-display');
            leaveClanBtn = document.getElementById('leave-clan-btn');
            clanMemberCount = document.getElementById('clan-member-count');
            clanMembersList = document.getElementById('clan-members-list');
            clanChatMessages = document.getElementById('clan-chat-messages');
            clanChatInput = document.getElementById('clan-chat-input');
            sendClanMessageBtn = document.getElementById('send-clan-message-btn');
            chatMessageError = document.getElementById('chat-message-error');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            createClanInputContainer = document.getElementById('create-clan-input-container');
            newClanNameInput = document.getElementById('new-clan-name-input');
            newClanTagInput = document.getElementById('new-clan-tag-input');
            newClanDescriptionInput = document.getElementById('new-clan-description-input');
            createClanErrorMessage = document.getElementById('create-clan-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            // Start the initialization process
            setupEventListeners();
            await initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>