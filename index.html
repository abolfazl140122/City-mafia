<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ - Ù†Ø³Ø®Ù‡ Ú©Ù„Ø´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            /* Android Fix: Improve touch responsiveness */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after, #leaderboard-panel::before, #leaderboard-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
            /* Android Fix: Improve touch interaction */
            -webkit-user-select: auto;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: auto;
            touch-action: manipulation;
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { justify-content: center; }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: center; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 15px; min-width: 180px; max-width: 200px; }
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; display: flex; align-items: center; gap: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.8em; color: #f0d5bf; margin-bottom: 0; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 0.9em; font-weight: bold; }
        @media (min-width: 768px) {
            .user-info-item { display: block; }
            .user-info-item .label { font-size: 0.9em; }
            .user-info-item .value { font-size: 1.1em; }
        }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover { color: #fff8a8; }

        /* NEW: Logout Button Style */
        #logout-btn {
            background-color: var(--clash-red); color: white;
            padding: 4px 8px; border-radius: 6px; font-weight: bold;
            border: 1px solid var(--clash-red-dark); font-size: 0.8rem;
            transition: background-color 0.2s; margin-top: 5px; cursor: pointer;
        }
        #logout-btn:hover { background-color: var(--clash-red-dark); }
        @media (max-width: 767px) { #logout-btn { display: none; } /* Hide on mobile view inside the box */ }
        @media (min-width: 768px) { #display-name-output-container { flex-wrap: wrap; } } /* Allow wrapping */

        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid;
            border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Prevents avatar from shrinking */
        }
        @media (min-width: 768px) { #avatar-container { width: 80px; height: 80px; } }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        
        #main-screen-header { 
            display: flex; justify-content: center; /* MODIFIED: Center the title */
            align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1.5rem; /* MODIFIED: Increased margin bottom */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
        }
        
        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }

        /* Shared style for header icon buttons (No longer in use, kept for safety) */
        .header-icon-btn {
            background: var(--clash-blue-light); color: white; border: 2px solid var(--clash-panel-border-dark);
            padding: 0.5rem; border-radius: 50%; font-weight: bold; transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); display: inline-flex;
            align-items: center; justify-content: center; width: 44px; height: 44px; flex-shrink: 0;
        }
        .header-icon-btn:hover { background-color: #6c98d8; transform: scale(1.1); }
        .header-icon-btn svg { width: 24px; height: 24px; pointer-events: none; } /* Slightly larger icon */
        
        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; width: 100%; padding-bottom: 5px; } /* MODIFIED: Increased gap */
        #start-game-btn { order: 0; }
        #mafia-fact-btn { font-size: 1rem !important; padding: 10px 20px !important; order: 3; } /* MODIFIED: order */
        
        #registration-error-message, #login-error-message, #change-name-error-message, #avatar-error-message {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        /* NEW: Style for auth form toggle link */
        .auth-toggle-link {
            color: var(--clash-gold);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .auth-toggle-link:hover {
            color: #fff8a8;
        }

        /* Styles for Pop-up Panels */
        #developers-panel-container, #leaderboard-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        #developers-panel, #leaderboard-panel {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
        }
        #close-developers-panel-btn, #close-leaderboard-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        #close-developers-panel-btn:hover, #close-leaderboard-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        #close-developers-panel-btn:active, #close-leaderboard-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        .developer-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .dev-header { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .dev-role-icon { font-size: 1.7em; color: var(--clash-gold); margin-left: 10px; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; font-family: 'Vazirmatn'; }
        .dev-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }
        .dev-description { font-size: 0.9rem; color: #d0e0ff; line-height: 1.65; font-family: 'Vazirmatn'; }

        /* Styles for Leaderboard Panel */
        .leaderboard-item {
            display: flex;
            align-items: center;
            background-color: rgba(42, 65, 102, 0.9);
            padding: 0.75rem;
            border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
            gap: 1rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .leaderboard-item:hover {
            background-color: rgba(60, 85, 122, 0.9);
            transform: scale(1.02);
        }
        .leaderboard-rank {
            font-family: 'Lilita One', cursive;
            font-size: 1.75rem;
            color: var(--clash-gold);
            -webkit-text-stroke: 1.5px var(--clash-brown-dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--clash-gold-dark);
            object-fit: cover;
            background-color: #2a4166;
            flex-shrink: 0;
        }
        .leaderboard-info {
            flex-grow: 1;
        }
        .leaderboard-name {
            font-family: 'Lilita One', cursive;
            font-size: 1.2rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px #000;
        }
        .leaderboard-stage {
            font-size: 0.9rem;
            color: #d0e0ff;
            font-weight: bold;
        }
        .leaderboard-stage-value {
            color: var(--clash-gold);
            font-family: 'Lilita One', cursive;
            font-size: 1.1em;
            margin-right: 4px;
        }

        /* --- NEW STYLES for Avatar URL Input --- */
        #avatar-preview-container {
            margin: 1rem auto;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--clash-gold);
            overflow: hidden;
            background-color: var(--clash-panel-border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #avatar-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    </style>
</head>
<body>
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>Ø¨Ø§Ø²ÛŒÚ©Ù†:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="ØªØºÛŒÛŒØ± Ù†Ø§Ù…">âœï¸</span>
                    <div id="display-name-output" class="value clash-font"></div>
                    <!-- NEW: Logout Button -->
                    <button id="logout-btn" title="Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨" class="clash-font">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>Ø´Ù†Ø§Ø³Ù‡:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²ÛŒ...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <h1 id="main-title" class="clash-font">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                </div>

                <!-- === NEW: RESTRUCTURED AUTH PANEL === -->
                <div id="auth-panel" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <!-- Registration Form -->
                    <div id="registration-form">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                        
                        <label for="register-display-name-input" class="block mb-2">
                            <span class="text-sm font-medium mb-1 inline-block">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (3-15 Ø­Ø±Ù Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ø¹Ø¯Ø¯):</span>
                            <input type="text" id="register-display-name-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="15">
                        </label>

                        <label for="register-password-input" class="block mb-2">
                            <span class="text-sm font-medium mb-1 inline-block">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ±):</span>
                            <input type="password" id="register-password-input" placeholder="ÛŒÚ© Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù‚ÙˆÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg" maxlength="50">
                        </label>
                        
                        <p id="registration-error-message" class="hidden"></p>

                        <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯</button>

                        <p class="text-center mt-4">
                            <span class="text-gray-300">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ </span>
                            <a id="show-login-form-btn" class="auth-toggle-link">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
                        </p>
                    </div>

                    <!-- Login Form (hidden by default) -->
                    <div id="login-form" class="hidden">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h2>
                        
                        <label for="login-display-name-input" class="block mb-2">
                            <span class="text-sm font-medium mb-1 inline-block">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</span>
                            <input type="text" id="login-display-name-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="15">
                        </label>
                        
                        <label for="login-password-input" class="block mb-2">
                            <span class="text-sm font-medium mb-1 inline-block">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</span>
                            <input type="password" id="login-password-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg" maxlength="50">
                        </label>
                        
                        <p id="login-error-message" class="hidden"></p>

                        <button id="login-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±</button>
                        
                        <p class="text-center mt-4">
                            <span class="text-gray-300">Ù‡Ù†ÙˆØ² Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ </span>
                            <a id="show-registration-form-btn" class="auth-toggle-link">ÛŒÚ© Ø­Ø³Ø§Ø¨ Ø¨Ø³Ø§Ø²ÛŒØ¯</a>
                        </p>
                    </div>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
                    <button id="leaderboard-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 1;">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</button>
                    <button id="developers-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 2;">ğŸ‘¥ Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù†</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font">Ø¯Ø§Ù†Ø³ØªÙ†ÛŒâ€ŒÙ‡Ø§ âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other screens (game, modal, etc.) remain largely the same -->
    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <div class="font-bold">Ù…Ø±Ø­Ù„Ù‡: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">Ø³ÙˆØ§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù† Ø§Ø³Øª...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">ØªÙˆØ¬Ù‡</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <div id="avatar-upload-ui-container" class="hidden">
                    <div class="flex flex-col sm:flex-row items-stretch gap-2 my-4">
                        <input type="url" id="avatar-url-input" placeholder="Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ØªØµÙˆÛŒØ± Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-3 text-base" style="direction: ltr; text-align: left;">
                        <button id="preview-avatar-btn" class="btn-clash btn-clash-secondary clash-font whitespace-nowrap px-4">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
                    </div>
                    <div id="avatar-preview-container" class="hidden">
                        <img id="avatar-preview-image" src="#" alt="Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ø¢ÙˆØ§ØªØ§Ø±">
                    </div>
                    <p id="avatar-error-message" class="hidden"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’»</span>
                        <h4 class="dev-role">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    </div>
                    <p class="dev-username clash-font">abolfazl1401</p>
                    <p class="dev-description">Ù…Ø¹Ù…Ø§Ø± Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ú¯ÛŒÙ…â€ŒÙ¾Ù„ÛŒØŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ¨</span>
                        <h4 class="dev-role">Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    </div>
                    <p class="dev-username clash-font">Vahid</p>
                    <p class="dev-description">Ø·Ø±Ø§Ø­ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (UX). Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®Ù„Ù‚ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¬Ø°Ø§Ø¨ Ùˆ ØªÙ… Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø§Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’¡</span>
                        <h4 class="dev-role">Ø§ÛŒØ¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²</h4>
                    </div>
                    <p class="dev-username clash-font">Ali.k</p>
                    <p class="dev-description">Ø®Ø§Ù„Ù‚ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø³ØªØ§Ù†â€ŒØ³Ø±Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">â˜ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">Neda_Tech</p>
                    <p class="dev-description">Ù…ØªØ®ØµØµ Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ØŒ ØªØ¶Ù…ÛŒÙ† Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ø²ÛŒ.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">âš™ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">SinaCloud</p>
                    <p class="dev-description">Ù…Ø³Ø¦ÙˆÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø´Ø¨Ú©Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ§Ù†.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸš€</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ± (DevOps)</h4>
                    </div>
                    <p class="dev-username clash-font">ParsaDevOps</p>
                    <p class="dev-description">Ù…ØªÙ…Ø±Ú©Ø² Ø¨Ø± ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ DevOpsØŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div id="leaderboard-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-2xl w-full relative">
            <button id="close-leaderboard-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ± Ø´Ù‡Ø±</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-3 font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ±...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        // --- JAVASCRIPT LOGIC (WITH USERNAME/PASSWORD AUTH) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- NEW/MODIFIED: Added new auth methods and removed anonymous sign-in ---
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- NEW/MODIFIED: Added runTransaction for atomic operations ---
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- AUDIO MANAGER (Unchanged) ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');

                Object.values(this.sounds).forEach(sound => {
                    if (sound) sound.volume = 0.4;
                });
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };
        
        // --- NEW/MODIFIED: Element variables for new auth forms ---
        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            authPanel, 
            registrationForm, registerDisplayNameInput, registerPasswordInput, registerBtn, registrationErrorMessage, showLoginFormBtn,
            loginForm, loginDisplayNameInput, loginPasswordInput, loginBtn, loginErrorMessage, showRegistrationFormBtn,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn, logoutBtn, // new logoutBtn
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, developersBtn, leaderboardBtn,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            leaderboardPanelContainer, leaderboardList, closeLeaderboardPanelBtn,
            avatarUploadUiContainer, avatarUrlInput, previewAvatarBtn,
            avatarPreviewContainer, avatarPreviewImage, avatarErrorMessage;
        
        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }


        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');

            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            
            screenElement.scrollTop = 0;
            updateUI();
        }
        
        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalContainer) { console.error("[showModal] Modal elements not found."); return; }
            audioManager.play('panelOpen');
            modalContainer.classList.remove('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.add('panel-visible'); 
            
            modalTitle.textContent = title;
            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarUploadUiContainer.classList.add('hidden');
            if (registrationErrorMessage) registrationErrorMessage.classList.add('hidden');
            if (loginErrorMessage) loginErrorMessage.classList.add('hidden');
            if (changeNameErrorMessage) changeNameErrorMessage.classList.add('hidden');
            if (avatarErrorMessage) avatarErrorMessage.classList.add('hidden');
            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName;
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = '';
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") { modalMessage.innerHTML = message; modalMessage.classList.remove('hidden'); }
            } else if (modalType === "avatar") {
                avatarUploadUiContainer.classList.remove('hidden');
                if(avatarUrlInput) avatarUrlInput.value = '';
                if(avatarPreviewContainer) avatarPreviewContainer.classList.add('hidden');
                if(avatarErrorMessage) avatarErrorMessage.classList.add('hidden');
                if (message && message.trim() !== "") { modalMessage.innerHTML = message; modalMessage.classList.remove('hidden'); }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.disabled = (modalType === 'avatar');
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;
            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function hideModal() {
            if (!modalContainer) return;
            audioManager.play('panelClose');
            modalContainer.classList.add('panel-hidden');
            modalConfirmCallback = null;
            modalCancelCallback = null;
            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try { modalConfirmCallback(); } catch (e) {
                    console.error("[handleModalConfirm] Error:", e);
                    hideModal();
                }
            } else { hideModal(); }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try { modalCancelCallback(); } catch (e) { console.error("[handleModalCancel] Error:", e); }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelOpen');
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) { userProfileArea.classList.add('profile-area-hidden'); }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelClose');
            developersPanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) { userProfileArea.classList.remove('profile-area-hidden'); }
        }

        function showLeaderboardPanel() {
            if (!leaderboardPanelContainer) return;
            audioManager.play('panelOpen');
            leaderboardPanelContainer.classList.remove('panel-hidden');
            leaderboardPanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) { userProfileArea.classList.add('profile-area-hidden'); }
            fetchAndDisplayLeaderboard();
        }

        function hideLeaderboardPanel() {
            if (!leaderboardPanelContainer) return;
            audioManager.play('panelClose');
            leaderboardPanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) { userProfileArea.classList.remove('profile-area-hidden'); }
        }

        function updateUI() {
            const loggedIn = isAuthReady && currentUserId;

            if (loggedIn) {
                if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
                if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
                if(avatarImage && gameState.avatarUrl) {
                    avatarImage.src = gameState.avatarUrl;
                } else if (avatarImage) {
                    avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
                }

                if (authPanel) authPanel.classList.add('panel-hidden');
                if (mainScreenButtonsLayout) mainScreenButtonsLayout.classList.remove('hidden');
                if (startGameBtn) startGameBtn.classList.add('breathing');
                
                const isAnyPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                        (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                        (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));

                if (mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                    if (userProfileArea) userProfileArea.classList.remove('hidden', 'profile-area-hidden');
                    if (avatarContainer) avatarContainer.classList.remove('hidden');
                    if (userInfoBox) userInfoBox.classList.remove('hidden');
                }
            } else {
                if (authPanel) authPanel.classList.remove('panel-hidden');
                if (mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
                if (userProfileArea) userProfileArea.classList.add('hidden');
                if (startGameBtn) startGameBtn.classList.remove('breathing');
            }

            if (stageDisplay) stageDisplay.textContent = gameState.currentStage;
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized (Auth, Firestore).");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        await loadUserData(user.uid);
                    } else {
                        console.log("User is signed out.");
                        currentUserId = null;
                        Object.assign(gameState, {
                            displayName: '', publicUserId: '', currentStage: 1,
                            avatarUrl: '', seenQuestionHashes: new Set()
                        });
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen.classList.contains('active')) {
                        if(loadingMessage) loadingMessage.textContent = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!";
                        setTimeout(() => showScreen(mainScreen), 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø§Ø²ÛŒ.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }
        
        async function loadUserData(userIdToLoad) {
            if (!userIdToLoad || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToLoad}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                    console.log(`Loaded profile for ${gameState.displayName}. Stage: ${gameState.currentStage}`);
                } else {
                    console.log("No user profile found for", userIdToLoad, "A new one will be created.");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }

        async function saveUserData(isNewUser = false, newName = null) {
            const userIdToSave = currentUserId;
            if (!userIdToSave || !db) return;
            
            const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToSave}/mafiaGameData/profile`);
            const dataToSave = {
                displayName: newName ?? gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                lastUpdated: serverTimestamp()
            };
            if(isNewUser) {
                dataToSave.createdAt = serverTimestamp();
            }

            const leaderboardDocRef = doc(db, `artifacts/${appId}/publicLeaderboard/${userIdToSave}`);
            
            try {
                await setDoc(userDocRef, dataToSave, { merge: true });
                await setDoc(leaderboardDocRef, {
                    displayName: dataToSave.displayName,
                    publicUserId: dataToSave.publicUserId,
                    currentStage: dataToSave.currentStage,
                    avatarUrl: dataToSave.avatarUrl,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                console.log("User data saved successfully for", userIdToSave);
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }
        
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        async function callGeminiAPI(prompt, isJsonOutput = false, schema = null) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJsonOutput) {
                payload.generationConfig = { responseMimeType: "application/json" };
                if (schema) payload.generationConfig.responseSchema = schema;
            }
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.text(); throw new Error(`API request failed: ${response.status} ${errorBody}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJsonOutput ? JSON.parse(text) : text;
                } else {
                     if (result.candidates?.[0]?.finishReason) { throw new Error(`Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± (Ø¯Ù„ÛŒÙ„: ${result.candidates[0].finishReason})`); }
                    throw new Error("Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (!prompt.includes("offensive")) {
                    showModal("Ø®Ø·Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø®Ø§Ù…ÙˆØ´ Ø¨ÙˆØ¯Ù† ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.<br><small>${error.message}</small>`, "Ø¨Ø§Ø´Ù‡");
                }
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function generateQuestion() { /* ... (This function is unchanged) ... */ }
        function displayQuestion() { /* ... (This function is unchanged) ... */ }
        async function handleAnswerSelection(event) { /* ... (This function is unchanged and still works) ... */ }
        
        function isValidImageUrl(url) {
            if (!url) return false;
            const imageRegex = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))(?:\?.*)?$/i;
            return imageRegex.test(url);
        }

        function previewAvatarFromUrl() {
            if (!avatarUrlInput || !avatarPreviewImage || !avatarPreviewContainer || !avatarErrorMessage || !modalConfirmBtn) return;
            const url = avatarUrlInput.value.trim();
            avatarErrorMessage.classList.add('hidden');
            modalConfirmBtn.disabled = true;
            if (!isValidImageUrl(url)) {
                avatarErrorMessage.textContent = 'Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.';
                avatarErrorMessage.classList.remove('hidden');
                avatarPreviewContainer.classList.add('hidden');
                return;
            }
            avatarPreviewImage.src = url;
            avatarPreviewImage.onerror = () => {
                avatarErrorMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±. Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
                avatarErrorMessage.classList.remove('hidden');
                avatarPreviewContainer.classList.add('hidden');
            };
            avatarPreviewImage.onload = () => {
                avatarPreviewContainer.classList.remove('hidden');
                modalConfirmBtn.disabled = false;
            };
        }

        async function saveAvatarFromUrl() {
            const newUrl = avatarUrlInput.value.trim();
            if (!isValidImageUrl(newUrl)) {
                if(avatarErrorMessage) { avatarErrorMessage.textContent = 'Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.'; avatarErrorMessage.classList.remove('hidden'); }
                return;
            }
            modalConfirmBtn.disabled = true;
            modalCancelBtn.disabled = true;
            try {
                gameState.avatarUrl = newUrl;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
            } catch(error) {
                console.error("Error saving avatar URL:", error);
                if(avatarErrorMessage) { avatarErrorMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ø¢ÙˆØ§ØªØ§Ø±.'; avatarErrorMessage.classList.remove('hidden'); }
            } finally {
                if(modalConfirmBtn) modalConfirmBtn.disabled = false;
                if(modalCancelBtn) modalCancelBtn.disabled = false;
            }
        }
        
        function validateUsername(username, errorElement, inputElement) {
            if (!inputElement || !errorElement) return null;
            const regex = /^[a-zA-Z0-9_.-]+$/;
            const trimmedName = username.trim();

            if (trimmedName === '') {
                errorElement.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length < 3) {
                errorElement.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
             if (trimmedName.length > 15) {
                errorElement.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 15 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            if (!regex.test(trimmedName)) {
                errorElement.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙÙ‚Ø· Ù…ÛŒØªÙˆØ§Ù†Ø¯ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¹Ø¯Ø¯ Ùˆ ._- Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.classList.add('hidden');
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        // --- NEW: Function to check if username is taken ---
        async function isUsernameTaken(username) {
            const usernameRef = doc(db, `usernames/${username.toLowerCase()}`);
            const docSnap = await getDoc(usernameRef);
            return docSnap.exists();
        }

        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const newName = validateUsername(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName.toLowerCase() === gameState.displayName.toLowerCase()) {
               changeNameErrorMessage.textContent = "Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… ÙØ¹Ù„ÛŒ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.";
               changeNameErrorMessage.classList.remove('hidden');
               newDisplayNameInput.classList.add('invalid');
                return;
            }
            
            // Check if new name is taken
            if (await isUsernameTaken(newName)) {
                changeNameErrorMessage.textContent = "Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.";
                changeNameErrorMessage.classList.remove('hidden');
                newDisplayNameInput.classList.add('invalid');
                return;
            }
            
            modalConfirmBtn.disabled = true;
            modalCancelBtn.disabled = true;

            try {
                // --- NEW: Use a transaction to ensure atomicity ---
                await runTransaction(db, async (transaction) => {
                    const oldUsernameRef = doc(db, `usernames/${gameState.displayName.toLowerCase()}`);
                    const newUsernameRef = doc(db, `usernames/${newName.toLowerCase()}`);
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                    const leaderboardRef = doc(db, `artifacts/${appId}/publicLeaderboard/${currentUserId}`);

                    transaction.delete(oldUsernameRef);
                    transaction.set(newUsernameRef, { userId: currentUserId });
                    transaction.update(userProfileRef, { displayName: newName });
                    transaction.update(leaderboardRef, { displayName: newName });
                });

                gameState.displayName = newName; // Update local state
                updateUI();
                hideModal();
                showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
            } catch (error) {
                console.error("Error changing display name:", error);
                changeNameErrorMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ø§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
                changeNameErrorMessage.classList.remove('hidden');
            } finally {
                modalConfirmBtn.disabled = false;
                modalCancelBtn.disabled = false;
            }
        }

        async function generateMafiaFact() { /* ... (This function is unchanged) ... */ }
        function generateAlphanumericPublicUserId(length = 5) { /* ... (This function is unchanged) ... */ }
        async function fetchAndDisplayLeaderboard() { /* ... (This function is unchanged) ... */ }
        function renderLeaderboardList(users) { /* ... (This function is unchanged) ... */ }
        
        // --- NEW: Toggle between login and registration forms ---
        function toggleAuthForms(showLogin) {
            if (showLogin) {
                registrationForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            } else {
                registrationForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
            // Clear any previous error messages
            if (registrationErrorMessage) registrationErrorMessage.classList.add('hidden');
            if (loginErrorMessage) loginErrorMessage.classList.add('hidden');
        }
        
        // --- NEW: Handle User Logout ---
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("User signed out successfully.");
                // onAuthStateChanged will handle UI updates
            } catch (error) {
                console.error("Error signing out:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', (event) => {
                if (event.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });

            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            // --- NEW: Event listeners for auth forms ---
            if (showLoginFormBtn) showLoginFormBtn.addEventListener('click', () => toggleAuthForms(true));
            if (showRegistrationFormBtn) showRegistrationFormBtn.addEventListener('click', () => toggleAuthForms(false));
            
            if (registerBtn) registerBtn.addEventListener('click', handleRegister);
            if (loginBtn) loginBtn.addEventListener('click', handleLogin);
            
            // Allow submitting with Enter key
            [registerDisplayNameInput, registerPasswordInput].forEach(input => {
                if(input) input.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerBtn.click(); });
            });
            [loginDisplayNameInput, loginPasswordInput].forEach(input => {
                if(input) input.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginBtn.click(); });
            });

            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            if (newDisplayNameInput) {
                newDisplayNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && modalConfirmCallback === handleChangeDisplayName) modalConfirmBtn.click(); });
            }

            if (editNameBtn) {
                editNameBtn.addEventListener('click', () => {
                    showModal("ØªØºÛŒÛŒØ± Ù†Ø§Ù…", "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ ÛŒÚ©ØªØ§ Ø¨Ø§Ø´Ø¯.", "ØªØºÛŒÛŒØ±", "Ù„ØºÙˆ", handleChangeDisplayName, null, "changeName");
                });
            }

            if (avatarContainer) {
                avatarContainer.addEventListener('click', () => {
                    showModal("ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±", "Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÛŒÚ© ØªØµÙˆÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.", "Ø°Ø®ÛŒØ±Ù‡", "Ù„ØºÙˆ", saveAvatarFromUrl, null, "avatar");
                });
            }
            
            if(previewAvatarBtn) previewAvatarBtn.addEventListener('click', previewAvatarFromUrl);
            if(avatarUrlInput) avatarUrlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') previewAvatarFromUrl(); });

            const allActionButtons = [startGameBtn, mafiaFactBtn, developersBtn, leaderboardBtn].filter(btn => btn !== null);
            allActionButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    if (!currentUserId) {
                        event.stopPropagation();
                        showModal("ÙˆØ±ÙˆØ¯ Ù„Ø§Ø²Ù… Ø§Ø³Øª", "Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.", "Ø¨Ø§Ø´Ù‡");
                    }
                }, true);
            });

            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    if (!currentUserId) return;
                    audioManager.play('startGame');
                    showModal("Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ", "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ø² ÛŒÚ© Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "Ø§Ø¯Ø§Ù…Ù‡", null, () => {
                        hideModal(); showScreen(gameScreen); generateQuestion();
                    });
                });
            }

            if (mafiaFactBtn) mafiaFactBtn.addEventListener('click', () => currentUserId && generateMafiaFact());
            if (developersBtn) developersBtn.addEventListener('click', showDevelopersPanel);
            if (closeDevelopersPanelBtn) closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            if (leaderboardBtn) leaderboardBtn.addEventListener('click', showLeaderboardPanel);
            if (closeLeaderboardPanelBtn) closeLeaderboardPanelBtn.addEventListener('click', hideLeaderboardPanel);
            if(backToMainBtn) backToMainBtn.addEventListener('click', async () => { await saveUserData(); gameState.currentQuestionData = null; showScreen(mainScreen); });
            window.addEventListener('resize', updateUI);
        }

        // --- NEW/MODIFIED: Registration handler ---
        async function handleRegister() {
            const username = validateUsername(registerDisplayNameInput.value, registrationErrorMessage, registerDisplayNameInput);
            const password = registerPasswordInput.value;

            if (!username) return;

            if (password.length < 6) {
                registrationErrorMessage.textContent = "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
                registrationErrorMessage.classList.remove('hidden');
                registerPasswordInput.classList.add('invalid');
                return;
            } else {
                registrationErrorMessage.classList.add('hidden');
                registerPasswordInput.classList.remove('invalid');
            }

            registerBtn.disabled = true;
            registerBtn.textContent = "Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...";

            if (await isUsernameTaken(username)) {
                registrationErrorMessage.textContent = "Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
                registrationErrorMessage.classList.remove('hidden');
                registerDisplayNameInput.classList.add('invalid');
                registerBtn.disabled = false;
                registerBtn.textContent = "Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯";
                return;
            }

            try {
                // Create a "fake" email for Firebase Auth
                const email = `${username.toLowerCase()}@city-mafia-game.com`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("New user created:", user.uid);
                
                // Now create the user's data in Firestore
                await runTransaction(db, async (transaction) => {
                    const usernameRef = doc(db, `usernames/${username.toLowerCase()}`);
                    transaction.set(usernameRef, { userId: user.uid });
                });

                // Set initial game state and save it
                gameState.displayName = username;
                gameState.publicUserId = generateAlphanumericPublicUserId();
                await saveUserData(true, username);
                
                // UI will update via onAuthStateChanged
            } catch (error) {
                console.error("Registration error:", error);
                registrationErrorMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
                registrationErrorMessage.classList.remove('hidden');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = "Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯";
            }
        }

        // --- NEW/MODIFIED: Login handler ---
        async function handleLogin() {
            const username = loginDisplayNameInput.value.trim();
            const password = loginPasswordInput.value;

            if (!username) {
                loginErrorMessage.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
                loginErrorMessage.classList.remove('hidden');
                loginDisplayNameInput.classList.add('invalid');
                return;
            } else {
                 loginDisplayNameInput.classList.remove('invalid');
            }
             if (!password) {
                loginErrorMessage.textContent = "Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
                loginErrorMessage.classList.remove('hidden');
                loginPasswordInput.classList.add('invalid');
                return;
            } else {
                loginPasswordInput.classList.remove('invalid');
            }
            loginErrorMessage.classList.add('hidden');

            loginBtn.disabled = true;
            loginBtn.textContent = "Ø¯Ø±Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...";
            
            try {
                const email = `${username.toLowerCase()}@city-mafia-game.com`;
                await signInWithEmailAndPassword(auth, email, password);
                // Success: onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login error:", error.code);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    loginErrorMessage.textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.";
                } else {
                    loginErrorMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯. Ø§ØªØµØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
                }
                loginErrorMessage.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±";
            }
        }

        async function initializeGame() {
            // --- NEW: Element selections for auth forms ---
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            
            authPanel = document.getElementById('auth-panel');
            registrationForm = document.getElementById('registration-form');
            registerDisplayNameInput = document.getElementById('register-display-name-input');
            registerPasswordInput = document.getElementById('register-password-input');
            registerBtn = document.getElementById('register-btn');
            registrationErrorMessage = document.getElementById('registration-error-message');
            showLoginFormBtn = document.getElementById('show-login-form-btn');
            
            loginForm = document.getElementById('login-form');
            loginDisplayNameInput = document.getElementById('login-display-name-input');
            loginPasswordInput = document.getElementById('login-password-input');
            loginBtn = document.getElementById('login-btn');
            loginErrorMessage = document.getElementById('login-error-message');
            showRegistrationFormBtn = document.getElementById('show-registration-form-btn');

            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            logoutBtn = document.getElementById('logout-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            developersBtn = document.getElementById('developers-btn');
            leaderboardBtn = document.getElementById('leaderboard-btn');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            
            avatarUploadUiContainer = document.getElementById('avatar-upload-ui-container');
            avatarUrlInput = document.getElementById('avatar-url-input');
            previewAvatarBtn = document.getElementById('preview-avatar-btn');
            avatarPreviewContainer = document.getElementById('avatar-preview-container');
            avatarPreviewImage = document.getElementById('avatar-preview-image');
            avatarErrorMessage = document.getElementById('avatar-error-message');

            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');

            leaderboardPanelContainer = document.getElementById('leaderboard-panel-container');
            leaderboardList = document.getElementById('leaderboard-list');
            closeLeaderboardPanelBtn = document.getElementById('close-leaderboard-panel-btn');


            audioManager.init();
            if(loadingMessage) loadingMessage.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„...";
            if (!navigator.onLine) {
                showModal("Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„", "Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", null, () => {
                    hideModal(); if (navigator.onLine) initializeGame(); else showModal("Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„", "Ù‡Ù…Ú†Ù†Ø§Ù† Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…ØªØµÙ„ Ù†ÛŒØ³ØªÛŒØ¯.", "Ø¨Ø§Ø´Ù‡");
                });
                return;
            }
            if(loadingMessage) loadingMessage.textContent = "Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯...";

            try {
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>
