<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ - Ù†Ø³Ø®Ù‡ Ú©Ù„Ø´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after { top: 15px; }
        #leaderboard-panel::before, #leaderboard-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { justify-content: center; }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: flex-start; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 15px; min-width: 180px; max-width: 200px; }
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; display: flex; align-items: center; gap: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.8em; color: #f0d5bf; margin-bottom: 0; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 0.9em; font-weight: bold; }
        @media (min-width: 768px) {
            .user-info-item { display: block; }
            .user-info-item .label { font-size: 0.9em; }
            .user-info-item .value { font-size: 1.1em; }
        }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover { color: #fff8a8; }

        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid;
            border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        @media (min-width: 768px) { #avatar-container { width: 80px; height: 80px; } }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        
        #avatar-suggestions-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .avatar-suggestion-item { width: 100px; height: 100px; border-radius: 8px; border: 4px solid transparent; cursor: pointer; overflow: hidden; transition: border-color 0.3s ease, transform 0.2s ease; }
        .avatar-suggestion-item:hover { transform: scale(1.05); }
        .avatar-suggestion-item.selected { border-color: var(--clash-green); box-shadow: 0 0 10px var(--clash-green); }

        #main-screen-header { 
            display: flex; justify-content: space-between; align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1rem; 
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
            gap: 0.5rem;
        }
        
        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }

        #header-icons-container {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .header-icon-btn {
            background: var(--clash-blue-light); color: white; border: 2px solid var(--clash-panel-border-dark);
            padding: 0.5rem; border-radius: 50%; font-weight: bold; transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); display: inline-flex;
            align-items: center; justify-content: center; width: 44px; height: 44px; flex-shrink: 0;
        }
        .header-icon-btn:hover { background-color: #6c98d8; transform: scale(1.1); }
        .header-icon-btn svg { width: 22px; height: 22px; }
        
        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.75rem; width: 100%; padding-bottom: 5px; }
        #start-game-btn { order: 0; }
        #mafia-fact-btn { font-size: 1rem !important; padding: 10px 20px !important; }
        
        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        .close-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        .close-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        .close-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        #developers-panel-container, #leaderboard-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        #developers-panel, #leaderboard-panel {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
        }
        .developer-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .dev-header { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .dev-role-icon { font-size: 1.7em; color: var(--clash-gold); margin-left: 10px; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; font-family: 'Vazirmatn'; }
        .dev-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }
        .dev-description { font-size: 0.9rem; color: #d0e0ff; line-height: 1.65; font-family: 'Vazirmatn'; }

        .leaderboard-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 0.75rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
            display: flex; align-items: center; gap: 1rem;
        }
        .leaderboard-rank {
            font-size: 1.5rem; font-weight: bold; color: var(--clash-gold);
            width: 40px; text-align: center; flex-shrink: 0;
            text-shadow: 2px 2px 2px #000;
        }
        .leaderboard-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid var(--clash-gold);
            object-fit: cover; background-color: #333;
            flex-shrink: 0;
        }
        .leaderboard-info { flex-grow: 1; }
        .leaderboard-name {
            font-size: 1.2rem; font-weight: bold; color: #fff;
            font-family: 'Lilita One', cursive;
        }
        .leaderboard-id { font-size: 0.8rem; color: #c0d8ff; font-family: monospace; }
        .leaderboard-level {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 1.1rem; font-weight: bold;
            color: #fff;
        }
        .leaderboard-level-value {
            font-family: 'Lilita One', cursive;
            font-size: 1.4rem; color: var(--clash-gold);
        }
    </style>
</head>
<body>

    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>Ø¨Ø§Ø²ÛŒÚ©Ù†:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="ØªØºÛŒÛŒØ± Ù†Ø§Ù…">âœï¸</span>
                    <div id="display-name-output" class="value clash-font"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>Ø´Ù†Ø§Ø³Ù‡:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²ÛŒ...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <div id="header-icons-container">
                        <button id="dev-intro-icon-btn-header" class="header-icon-btn" title="Ù…Ø¹Ø±ÙÛŒ ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ú¯Ø§Ù†">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </button>
                        <button id="leaderboard-icon-btn-header" class="header-icon-btn" title="Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ± Ø´Ù‡Ø±">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" d="M13.842 2.5a.75.75 0 0 1 .158.5V21a.75.75 0 0 1-1.22.616l-3.38-2.624a.75.75 0 0 0-.92 0L5.097 21.615A.75.75 0 0 1 3.878 21V3a.75.75 0 0 1 .75-.75h8.922c.153 0 .3.045.434.125.135.08.243.207.358.375zM15 3a.75.75 0 0 1 .75.75v16.5a.75.75 0 0 1-1.22.615l-3.38-2.624a.75.75 0 0 0-.92 0L6.855 20.865A.75.75 0 0 1 5.636 20.25V3.75A.75.75 0 0 1 6.386 3H15z" clip-rule="evenodd"/>
                                <path d="M18 3.75a.75.75 0 0 0-1.5 0v16.5a.75.75 0 0 0 1.5 0V3.75z"/>
                            </svg>
                        </button>
                    </div>

                    <h1 id="main-title" class="clash-font">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                    
                    <div id="header-spacer" style="width: 98px; flex-shrink: 0;"></div>
                </div>

                <div id="registration-form" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">Ø«Ø¨Øª Ù†Ø§Ù… / ÙˆØ±ÙˆØ¯</h2>
                    <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-clash w-full mb-1 p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="20">
                    <p id="input-error-message" class="hidden"></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (5 Ø±Ù‚Ù…ÛŒ):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="Ø¨Ø³Ø§Ø²!">
                            <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm clash-font">Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡</button>
                        </div>
                        <p id="user-id-error-message" class="hidden"></p>
                    </div>

                    <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±</button>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 1;">Ø¯Ø§Ù†Ø³ØªÙ†ÛŒâ€ŒÙ‡Ø§ âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <div class="font-bold">Ù…Ø±Ø­Ù„Ù‡: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">Ø³ÙˆØ§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù† Ø§Ø³Øª...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">ØªÙˆØ¬Ù‡</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-clash btn-clash-primary my-4 clash-font">Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-300">Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ...</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                    <p id="avatar-error-message" class="text-red-300 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>
    
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn" class="close-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’»</span>
                        <h4 class="dev-role">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    </div>
                    <p class="dev-username clash-font">abolfazl1401</p>
                    <p class="dev-description">Ù…Ø¹Ù…Ø§Ø± Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ú¯ÛŒÙ…â€ŒÙ¾Ù„ÛŒØŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ¨</span>
                        <h4 class="dev-role">Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    </div>
                    <p class="dev-username clash-font">Vahid</p>
                    <p class="dev-description">Ø·Ø±Ø§Ø­ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (UX). Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®Ù„Ù‚ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¬Ø°Ø§Ø¨ Ùˆ ØªÙ… Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø§Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’¡</span>
                        <h4 class="dev-role">Ø§ÛŒØ¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²</h4>
                    </div>
                    <p class="dev-username clash-font">Ali.k</p>
                    <p class="dev-description">Ø®Ø§Ù„Ù‚ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø³ØªØ§Ù†â€ŒØ³Ø±Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">â˜ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">Neda_Tech</p>
                    <p class="dev-description">Ù…ØªØ®ØµØµ Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ØŒ ØªØ¶Ù…ÛŒÙ† Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ø²ÛŒ.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">âš™ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">SinaCloud</p>
                    <p class="dev-description">Ù…Ø³Ø¦ÙˆÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø´Ø¨Ú©Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ§Ù†.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸš€</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ± (DevOps)</h4>
                    </div>
                    <p class="dev-username clash-font">ParsaDevOps</p>
                    <p class="dev-description">Ù…ØªÙ…Ø±Ú©Ø² Ø¨Ø± ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ DevOpsØŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboard-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-2xl w-full relative">
            <button id="close-leaderboard-panel-btn" class="close-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="leaderboard-list" class="space-y-3 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <!-- User items will be injected here by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        // --- JAVASCRIPT LOGIC (WITH LEADERBOARD) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');

                Object.values(this.sounds).forEach(sound => {
                    if (sound) sound.volume = 0.4;
                });
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };
        
        // --- GLOBAL UI ELEMENT VARIABLES ---
        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader, leaderboardBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            leaderboardPanelContainer, closeLeaderboardPanelBtn, leaderboardList;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;
        
        const isUserLoggedIn = () => isAuthReady && gameState.displayName && gameState.publicUserId;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            screenElement.scrollTop = 0;
            updateUI();
        }
        
        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalContainer) return;
            audioManager.play('panelOpen');
            modalContainer.classList.remove('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible');
            void modalContainer.offsetWidth;
            modalContainer.querySelector('.panel-clash').classList.add('panel-visible');
            
            modalTitle.textContent = title;
            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            if (inputErrorMessage) inputErrorMessage.classList.add('hidden');
            if (userIdErrorMessage) userIdErrorMessage.classList.add('hidden');
            if (changeNameErrorMessage) changeNameErrorMessage.classList.add('hidden');

            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.textContent = '';
                newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                avatarSuggestionsContainer.innerHTML = '';
                avatarErrorMessage.textContent = '';
                avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function hideModal() {
            if (!modalContainer) return;
            audioManager.play('panelClose');
            modalContainer.classList.add('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible');

            modalConfirmCallback = null;
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            modalMessage.classList.add('hidden');
            if(userProfileArea && mainScreen.classList.contains('active') &&
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden')) &&
               (!leaderboardPanelContainer || leaderboardPanelContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) modalConfirmCallback(); else hideModal();
        }

        function handleModalCancel() {
            if (modalCancelCallback) modalCancelCallback();
            hideModal();
        }
        
        function showPanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelOpen');
            panelContainer.classList.remove('panel-hidden');
            const panel = panelContainer.querySelector('.panel-clash');
            panel.classList.remove('panel-visible');
            void panel.offsetWidth;
            panel.classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hidePanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelClose');
            panelContainer.classList.add('panel-hidden');
            panelContainer.querySelector('.panel-clash').classList.remove('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active') &&
               (!modalContainer || modalContainer.classList.contains('panel-hidden')) &&
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden')) &&
               (!leaderboardPanelContainer || leaderboardPanelContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        async function showLeaderboardPanel() {
            showPanel(leaderboardPanelContainer);
            await fetchAndDisplayLeaderboard();
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;

            if(avatarImage) avatarImage.src = gameState.avatarUrl || `https://placehold.co/80x80/333333/777777?text=?`;

            const loggedIn = isUserLoggedIn();
            const showRegistration = !loggedIn;
            let showUserInfoAndAvatar = false;
            if (loggedIn && mainScreen && mainScreen.classList.contains('active')) {
                showUserInfoAndAvatar = true;
            }

            if(registrationForm) registrationForm.classList.toggle('panel-hidden', !showRegistration);
            if(registrationForm) registrationForm.classList.toggle('panel-visible', showRegistration);
            if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.toggle('hidden', !loggedIn);
            if(startGameBtn) startGameBtn.classList.toggle('breathing', loggedIn);

            if(userProfileArea){
                const isAnyPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                        (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                        (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
                
                if (showUserInfoAndAvatar && !isAnyPanelVisible) {
                    userProfileArea.classList.remove('profile-area-hidden', 'hidden');
                    avatarContainer.classList.toggle('hidden', window.innerWidth < 768);
                    userInfoBox.classList.remove('hidden');
                } else if (!showUserInfoAndAvatar) {
                    userProfileArea.classList.add('hidden');
                } else if (isAnyPanelVisible) {
                    userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("User is signed out. Attempting to sign in.");
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Auth error, falling back to anonymous:", error);
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        loadingMessage.textContent = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!";
                        setTimeout(() => showScreen(mainScreen), 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø§Ø²ÛŒ.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }
        
        async function loadUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                } else {
                    Object.assign(gameState, { displayName: "", publicUserId: "", avatarUrl: '', seenQuestionHashes: new Set() });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
                Object.assign(gameState, { displayName: "", publicUserId: "", avatarUrl: '', seenQuestionHashes: new Set() });
            }
        }
        
        async function saveUserData() {
            if (!currentUserId || !db) return;
            const privateDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const publicDocRef = doc(db, `artifacts/${appId}/publicUserProfiles/${currentUserId}`);
            
            const commonData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                lastUpdated: serverTimestamp()
            };
            
            const privateData = {
                ...commonData,
                seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
            };

            try {
                await setDoc(privateDocRef, privateData, { merge: true });
                await setDoc(publicDocRef, commonData, { merge: true });
                console.log("Private and Public user data saved successfully.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }
        
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";

        async function callGeminiAPI(prompt) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
                const result = await response.json();
                
                const content = result.candidates?.[0]?.content?.parts?.[0];
                if (content?.text) {
                    try { return JSON.parse(content.text); } catch (e) { return content.text; } // Return text if not JSON
                }
                throw new Error(`Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ø¯Ù„ÛŒÙ„: ${result.candidates?.[0]?.finishReason || 'Unknown'})`);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Ø®Ø·Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.<br><small>Ø¬Ø²Ø¦ÛŒØ§Øª: ${error.message}</small>`, "Ø¨Ø§Ø´Ù‡");
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function callImagenAPI(prompt, sampleCount = 4) {
            if(avatarAiLoading) avatarAiLoading.classList.remove('hidden');
            if(avatarErrorMessage) avatarErrorMessage.textContent = '';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ instances: [{ prompt }], parameters: { sampleCount } }) });
                if (!response.ok) throw new Error(`API request failed: ${response.status} ${await response.text()}`);
                const result = await response.json();
                if (result.predictions?.length > 0) return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                throw new Error("Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±: ${error.message}`;
                return null;
            } finally {
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
            }
        }
        
        async function fetchAndDisplayLeaderboard() {
            if (!db || !leaderboardList) return;
            leaderboardList.innerHTML = `<div class="text-center py-4"><div class="loader mx-auto"></div><p class="mt-2 font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ±...</p></div>`;

            try {
                const q = query(collection(db, `artifacts/${appId}/publicUserProfiles`), orderBy("currentStage", "desc"), limit(50));
                const querySnapshot = await getDocs(q);

                leaderboardList.innerHTML = '';
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<p class="text-center py-4">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø´Ù‡Ø± Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª!</p>';
                    return;
                }
                
                querySnapshot.forEach((doc, index) => {
                    const user = doc.data();
                    const avatarSrc = user.avatarUrl || 'https://placehold.co/50x50/333333/777777?text=?';
                    const userElement = document.createElement('div');
                    userElement.className = 'leaderboard-item';
                    userElement.innerHTML = `
                        <div class="leaderboard-rank">${index + 1}</div>
                        <img src="${avatarSrc}" alt="Avatar" class="leaderboard-avatar" onerror="this.src='https://placehold.co/50x50/333333/777777?text=?'">
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${user.displayName || 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…'}</div>
                            <div class="leaderboard-id">#${user.publicUserId || '-----'}</div>
                        </div>
                        <div class="leaderboard-level">
                            <span>Ù„ÙˆÙ„: </span>
                            <span class="leaderboard-level-value">${user.currentStage || 1}</span>
                        </div>
                    `;
                    leaderboardList.appendChild(userElement);
                });
            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                leaderboardList.innerHTML = `<p class="text-center py-4 text-red-300">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>`;
            }
        }

        // ... Other functions (generateQuestion, displayQuestion, etc.) are mostly unchanged ...
        // I will copy them here for completeness.

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            questionText.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯ Ùˆ ØºÛŒØ±ØªÚ©Ø±Ø§Ø±ÛŒ...";
            optionsContainer.innerHTML = "";
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            
            let attempts = 0, maxAttempts = 3, questionData = null;

            while (attempts < maxAttempts) {
                let difficulty = gameState.currentStage > 20 ? "Ø¨Ø³ÛŒØ§Ø± Ø³Ø®Øª" : gameState.currentStage > 10 ? "Ø³Ø®Øª" : gameState.currentStage > 5 ? "Ù…ØªÙˆØ³Ø·" : "Ø¢Ø³Ø§Ù†";
                const prompt = `ÛŒÚ© Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Û´ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ) Ø¬Ø¯ÛŒØ¯ Ùˆ Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø§ÙÛŒØ§ Ø¨Ø§ Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ "${difficulty}" Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ ${gameState.currentStage} Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†. Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª JSON Ø®Ø§Ù… Ø¨Ø§ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ "question", "options", "correctAnswerIndex", "explanation" Ø¨Ø§Ø´Ø¯.`;
                const data = await callGeminiAPI(prompt);

                if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    const questionHash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(questionHash)) {
                        questionData = data;
                        break;
                    }
                    console.warn(`Duplicate question, retrying...`);
                }
                attempts++;
            }

            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                questionText.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„ ØºÛŒØ±ØªÚ©Ø±Ø§Ø±ÛŒ.";
                showModal("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„", `Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒÙ…. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ØŸ`, "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", "ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); showScreen(mainScreen); }
                );
            }
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            gameState.isQuestionActive = true;
        }
        
        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive) return;
            gameState.isQuestionActive = false;

            const selectedBtn = event.target.closest('.option-btn');
            if (!selectedBtn) return;

            const selectedIndex = parseInt(selectedBtn.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            if (selectedIndex === correctAnswerIndex) {
                audioManager.play('correct');
                selectedBtn.classList.add('correct');
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#aaffaa] clash-font';
                gameState.seenQuestionHashes.add(simpleHash(question));
                gameState.currentStage++;
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                audioManager.play('incorrect');
                selectedBtn.classList.add('incorrect');
                optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`)?.classList.add('correct');
                const taunt = await callGeminiAPI(`ÛŒÚ© Ø·Ø¹Ù†Ù‡ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¨Ø§Ù…Ø²Ù‡ Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ú¯Ùˆ Ú†ÙˆÙ† Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³ÙˆØ§Ù„ "${question}" Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡ "${options[selectedIndex]}" Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª. Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ "${options[correctAnswerIndex]}" Ø¨ÙˆØ¯.`);
                gameFeedback.innerHTML = taunt || "Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-auto text-[#ffaaaa] clash-font';
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            if (explanation) {
                questionExplanation.textContent = `ØªÙˆØ¶ÛŒØ­: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }
        
        async function generateAndDisplayAvatars() {
            const prompt = "Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons, cartoonish, stylized, game art style";
            const suggestions = await callImagenAPI(prompt);
            avatarSuggestionsContainer.innerHTML = '';
            selectedAvatarForConfirmation = null;
            if (suggestions?.length > 0) {
                suggestions.forEach(base64Url => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'avatar-suggestion-item';
                    const img = document.createElement('img');
                    img.src = base64Url;
                    imgWrapper.appendChild(img);
                    imgWrapper.onclick = () => {
                        audioManager.play('click');
                        avatarSuggestionsContainer.querySelector('.selected')?.classList.remove('selected');
                        imgWrapper.classList.add('selected');
                        selectedAvatarForConfirmation = base64Url;
                        modalConfirmBtn.disabled = false;
                    };
                    avatarSuggestionsContainer.appendChild(imgWrapper);
                });
                modalConfirmBtn.textContent = "Ø§Ù†ØªØ®Ø§Ø¨";
                modalConfirmBtn.disabled = true;
            } else {
                avatarErrorMessage.textContent = "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø¢ÙˆØ§ØªØ§Ø±ÛŒ Ø¨Ø³Ø§Ø²ÛŒÙ….";
                modalConfirmBtn.disabled = true;
            }
        }
        
        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
            } else {
                avatarErrorMessage.textContent = "Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¢ÙˆØ§ØªØ§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
            }
        }

        function validateAndSanitizeName(nameValue, errorEl, inputEl) {
            const sanitized = nameValue.replace(/[^a-zA-Z0-9_.-]/g, '').trim();
            if (inputEl.value !== sanitized) inputEl.value = sanitized;
            if (sanitized.length < 3 || sanitized.length > 20) {
                errorEl.textContent = "Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³ ØªØ§ Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø§Ø´Ø¯.";
                errorEl.classList.remove('hidden');
                inputEl.classList.add('invalid');
                return null;
            }
            errorEl.classList.add('hidden');
            inputEl.classList.remove('invalid');
            return sanitized;
        }

        async function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;
            if (newName === gameState.displayName) {
                changeNameErrorMessage.textContent = "Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.";
                changeNameErrorMessage.classList.remove('hidden');
                return;
            }
            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
        }

        async function generateMafiaFact() {
            showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨", "<div class='loader mx-auto my-3'></div>", "Ø¨Ø§Ø´Ù‡");
            const fact = await callGeminiAPI("ÛŒÚ© Ø­Ù‚ÛŒÙ‚Øª Ø¬Ø§Ù„Ø¨ Ùˆ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ú¯Ùˆ.");
            if (fact) showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨", fact, "Ø¬Ø§Ù„Ø¨ Ø¨ÙˆØ¯!");
        }
        
        function generateAlphanumericPublicUserId(length = 5) {
            return Array.from({length}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.floor(Math.random() * 36))).join('');
        }
        
        // --- REFACTORED AND CORRECTED EVENT LISTENERS ---
        function setupEventListeners() {
            document.body.addEventListener('click', (event) => {
                if (event.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });

            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            const showLoginRequiredModal = () => showModal("Ø«Ø¨Øª Ù†Ø§Ù… Ù„Ø§Ø²Ù… Ø§Ø³Øª", "Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø«Ø¨Øª Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.", "Ø¨Ø§Ø´Ù‡");
            
            if (devIntroBtnHeader) {
                devIntroBtnHeader.addEventListener('click', () => {
                    isUserLoggedIn() ? showPanel(developersPanelContainer) : showLoginRequiredModal();
                });
            }

            if (leaderboardBtnHeader) {
                leaderboardBtnHeader.addEventListener('click', () => {
                     isUserLoggedIn() ? showLeaderboardPanel() : showLoginRequiredModal();
                });
            }
            
            if (startGameBtn) {
                 startGameBtn.addEventListener('click', () => {
                    if (!isUserLoggedIn()) return;
                    audioManager.play('startGame');
                    showModal("Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ", "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ø² ÛŒÚ© Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "Ø§Ø¯Ø§Ù…Ù‡", null,
                        () => {
                            hideModal();
                            showScreen(gameScreen);
                            generateQuestion();
                        }
                    );
                });
            }

            if (mafiaFactBtn) {
                 mafiaFactBtn.addEventListener('click', () => {
                    if (!isUserLoggedIn()) return;
                    generateMafiaFact();
                });
            }

            if (closeDevelopersPanelBtn) closeDevelopersPanelBtn.addEventListener('click', () => hidePanel(developersPanelContainer));
            if (closeLeaderboardPanelBtn) closeLeaderboardPanelBtn.addEventListener('click', () => hidePanel(leaderboardPanelContainer));
            
            if (registerBtn) {
                registerBtn.addEventListener('click', async () => {
                    const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                    if (!gameState.publicUserId) {
                        userIdErrorMessage.textContent = "Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯.";
                        userIdErrorMessage.classList.remove('hidden');
                        return;
                    }
                    if (!validatedName) return;

                    gameState.displayName = validatedName;
                    await saveUserData();
                    updateUI();
                });
            }
            
            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', () => {
                    userIdDisplayInput.value = generateAlphanumericPublicUserId();
                    gameState.publicUserId = userIdDisplayInput.value;
                    userIdErrorMessage.classList.add('hidden');
                });
            }

            if (editNameBtn) {
                editNameBtn.addEventListener('click', () => {
                    if (!isUserLoggedIn()) return;
                    showModal("ØªØºÛŒÛŒØ± Ù†Ø§Ù…", "ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.", "ØªØºÛŒÛŒØ±", "Ù„ØºÙˆ", handleChangeDisplayName, hideModal, "changeName");
                });
            }
            
            if (avatarContainer) {
                avatarContainer.addEventListener('click', () => {
                    if (!isUserLoggedIn()) return;
                    selectedAvatarForConfirmation = null;
                    showModal("ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±", "", "Ø§Ù†ØªØ®Ø§Ø¨", "Ù„ØºÙˆ", confirmAvatarSelection, hideModal, "avatar");
                    if(modalConfirmBtn) modalConfirmBtn.disabled = true;
                });
            }
            
            if (generateAvatarBtn) generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);

            if(backToMainBtn) {
                backToMainBtn.addEventListener('click', async () => {
                    await saveUserData();
                    gameState.currentQuestionData = null;
                    showScreen(mainScreen);
                });
            }
            
            [displayNameInput, newDisplayNameInput].forEach(input => {
                if(input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.target.closest('.panel-clash, .screen').querySelector('.btn-clash-primary')?.click(); });
            });
            
            window.addEventListener('resize', updateUI);
        }
        
        function initializeGame() {
            const ids = [ "loading-screen", "loading-message", "main-screen", "game-screen", "registration-form", "display-name-input", "register-btn", "input-error-message", "user-id-display", "generate-user-id-btn", "user-id-error-message", "user-profile-area", "avatar-container", "avatar-image", "user-info-box", "display-name-output", "public-user-id-output", "edit-name-btn", "main-screen-buttons-layout", "start-game-btn", "mafia-fact-btn", "dev-intro-icon-btn-header", "leaderboard-icon-btn-header", "stage-display", "question-text", "options-container", "question-explanation", "back-to-main-btn", "game-feedback", "ai-thinking-indicator", "modal-container", "modal-title", "modal-content-dynamic", "modal-message", "change-name-input-container", "new-display-name-input", "change-name-error-message", "avatar-generation-container", "generate-avatar-btn", "avatar-ai-loading", "avatar-suggestions-container", "avatar-error-message", "modal-confirm-btn", "modal-cancel-btn", "developers-panel-container", "close-developers-panel-btn", "leaderboard-panel-container", "close-leaderboard-panel-btn", "leaderboard-list" ];
            const camelCase = s => s.replace(/-./g, x => x[1].toUpperCase());
            ids.forEach(id => window[camelCase(id)] = document.getElementById(id));

            audioManager.init();
            if (!navigator.onLine) {
                showModal("Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª", "Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.", "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", null, () => window.location.reload());
                return;
            }
            setupEventListeners();
            initFirebase().catch(e => console.error("Critical initialization error:", e));
        }

        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>
