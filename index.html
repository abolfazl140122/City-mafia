<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ - Ù†Ø³Ø®Ù‡ Ú©Ù„Ø´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- NEW LOADING SCREEN ANIMATIONS --- */
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 200, 58, 0.4)); }
            50% { filter: drop-shadow(0 0 16px rgba(255, 200, 58, 0.8)); }
        }
        
        @keyframes tipFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            /* Android Fix: Improve touch responsiveness */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after, #leaderboard-panel::before, #leaderboard-panel::after, #game-mode-panel::before, #game-mode-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
            /* Android Fix: Improve touch interaction */
            -webkit-user-select: auto;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: auto;
            touch-action: manipulation;
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { 
            justify-content: center; 
            background: radial-gradient(circle, rgba(42,65,102,0.5) 0%, rgba(26,40,62,0.8) 70%);
        }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        /* --- NEW: Professional Loading Screen Styles --- */
        #loading-content-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 450px;
        }
        #loading-logo {
            max-width: 280px;
            width: 70%;
            margin-bottom: 1.5rem;
            animation: fadeInScaleUp 1s ease-out, pulseGlow 3s infinite 1s;
        }
        #loading-progress-bar-container {
            width: 100%;
            background-color: var(--clash-panel-border-dark);
            border: 3px solid #2a4166;
            border-radius: 12px;
            padding: 4px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        #loading-progress-bar-fill {
            height: 18px;
            width: 0%; /* Starts at 0, controlled by JS */
            background: linear-gradient(to right, var(--clash-gold-dark), var(--clash-gold));
            border-radius: 8px;
            transition: width 0.5s ease-out;
            box-shadow: 0 0 10px var(--clash-gold);
        }
        #loading-message {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px #000;
            min-height: 28px; /* Prevent layout shift */
        }
        #loading-tip {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #d0e0ff;
            font-style: italic;
            background-color: rgba(0,0,0,0.25);
            padding: 8px 12px;
            border-radius: 8px;
            min-height: 50px; /* Prevent layout shift */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: tipFadeIn 0.8s ease-out;
        }

        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: center; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 15px; min-width: 180px; max-width: 200px; }
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; display: flex; align-items: center; gap: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.8em; color: #f0d5bf; margin-bottom: 0; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 0.9em; font-weight: bold; }
        @media (min-width: 768px) {
            .user-info-item { display: block; }
            .user-info-item .label { font-size: 0.9em; }
            .user-info-item .value { font-size: 1.1em; }
        }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover { color: #fff8a8; }

        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid;
            border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Prevents avatar from shrinking */
        }
        @media (min-width: 768px) { #avatar-container { width: 80px; height: 80px; } }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        
        #main-screen-header { 
            display: flex; justify-content: center; /* MODIFIED: Center the title */
            align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1.5rem; /* MODIFIED: Increased margin bottom */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
        }
        
        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }

        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; width: 100%; padding-bottom: 5px; }
        
        #mafia-fact-btn { font-size: 1rem !important; padding: 10px 20px !important; }
        
        #input-error-message, #user-id-error-message, #change-name-error-message, #login-error-message, #avatar-error-message {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        /* Styles for Pop-up Panels */
        #developers-panel-container, #leaderboard-panel-container, #game-mode-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        #developers-panel, #leaderboard-panel, #game-mode-panel {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
        }
        #close-developers-panel-btn, #close-leaderboard-panel-btn, #close-game-mode-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        #close-developers-panel-btn:hover, #close-leaderboard-panel-btn:hover, #close-game-mode-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        #close-developers-panel-btn:active, #close-leaderboard-panel-btn:active, #close-game-mode-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        .developer-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .dev-header { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .dev-role-icon { font-size: 1.7em; color: var(--clash-gold); margin-left: 10px; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; font-family: 'Vazirmatn'; }
        .dev-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }
        .dev-description { font-size: 0.9rem; color: #d0e0ff; line-height: 1.65; font-family: 'Vazirmatn'; }

        /* Styles for Leaderboard Panel */
        .leaderboard-item {
            display: flex;
            align-items: center;
            background-color: rgba(42, 65, 102, 0.9);
            padding: 0.75rem;
            border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
            gap: 1rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .leaderboard-item:hover {
            background-color: rgba(60, 85, 122, 0.9);
            transform: scale(1.02);
        }
        .leaderboard-rank {
            font-family: 'Lilita One', cursive;
            font-size: 1.75rem;
            color: var(--clash-gold);
            -webkit-text-stroke: 1.5px var(--clash-brown-dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--clash-gold-dark);
            object-fit: cover;
            background-color: #2a4166;
            flex-shrink: 0;
        }
        .leaderboard-info {
            flex-grow: 1;
        }
        .leaderboard-name {
            font-family: 'Lilita One', cursive;
            font-size: 1.2rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px #000;
        }
        .leaderboard-stage {
            font-size: 0.9rem;
            color: #d0e0ff;
            font-weight: bold;
        }
        .leaderboard-stage-value {
            color: var(--clash-gold);
            font-family: 'Lilita One', cursive;
            font-size: 1.1em;
            margin-right: 4px;
        }

        /* --- NEW STYLES for Avatar URL Input --- */
        #avatar-preview-container {
            margin: 1rem auto;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--clash-gold);
            overflow: hidden;
            background-color: var(--clash-panel-border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #avatar-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- NEW STYLES for Game Mode Panel --- */
        #game-mode-panel .btn-clash-primary {
            padding: 16px 32px;
            font-size: 1.5rem;
            width: 100%;
            max-width: 300px;
        }
        #game-mode-panel .btn-clash-primary .icon {
            font-size: 2rem;
            margin-left: 12px;
        }
        
        /* --- NEW STYLES for Question Timer --- */
        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        #stage-info, #timer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-label {
            font-weight: bold;
            font-size: 1.1rem;
        }
        #stage-display {
            font-family: 'Lilita One', cursive;
            color: var(--clash-gold);
            font-size: 1.75rem;
        }
        #timer-container {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #timer-progress {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--clash-gold) 360deg, var(--clash-blue-dark) 0deg);
            transition: background 0.3s linear;
        }
        #timer-container.warning #timer-progress {
            background: conic-gradient(var(--clash-red) 360deg, var(--clash-blue-dark) 0deg);
        }
        #timer-text {
            position: relative;
            font-family: 'Lilita One', cursive;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 2px 2px 3px #000;
        }

    </style>
</head>
<body>
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>Ø¨Ø§Ø²ÛŒÚ©Ù†:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="ØªØºÛŒÛŒØ± Ù†Ø§Ù…">âœï¸</span>
                    <div id="display-name-output" class="value clash-font"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>Ø´Ù†Ø§Ø³Ù‡:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <!-- MODIFIED: Professional Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div id="loading-content-box">
            <img id="loading-logo" src="https://up.20script.ir/file/7e7a-Copilot-20250812-110015-removebg-preview.png" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§">
            <h1 class="text-4xl sm:text-5xl font-bold clash-font text-[var(--clash-gold)]" style="text-shadow: 3px 3px 4px #000;">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
            
            <div id="loading-progress-bar-container">
                <div id="loading-progress-bar-fill"></div>
            </div>
            
            <p id="loading-message" class="text-lg">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ...</p>
            
            <p id="loading-tip">âœ¨ Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§ÛŒ Ù…Ø®ÙÛŒ... âœ¨</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <h1 id="main-title" class="clash-font">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                </div>

                <div id="auth-panel" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <!-- Registration Form -->
                    <div id="registration-form">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
                        <label for="display-name-input" class="block mb-1">
                            <span class="text-sm font-medium mb-1 inline-block">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ):</span>
                            <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="20">
                        </label>
                        <p id="input-error-message" class="hidden"></p>

                        <div class="mt-3 mb-2">
                            <label for="user-id-display" class="block text-sm font-medium mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (5 Ø±Ù‚Ù…ÛŒ):</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="user-id-display" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="Ø¨Ø³Ø§Ø²!">
                                <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm clash-font">Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡</button>
                            </div>
                            <p id="user-id-error-message" class="hidden"></p>
                        </div>

                        <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±</button>
                    </div>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <button id="leaderboard-btn" class="btn-clash btn-clash-secondary clash-font">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ</button>
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
                    <button id="developers-btn" class="btn-clash btn-clash-secondary clash-font">ğŸ‘¥ Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù†</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font">Ø¯Ø§Ù†Ø³ØªÙ†ÛŒâ€ŒÙ‡Ø§ âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <!-- NEW: Game Header with Timer -->
            <div id="game-header">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <div id="stage-info">
                    <span class="info-label">Ù…Ø±Ø­Ù„Ù‡:</span>
                    <span id="stage-display">1</span>
                </div>
                <div id="timer-info">
                    <div id="timer-container">
                        <div id="timer-progress"></div>
                        <span id="timer-text">20</span>
                    </div>
                </div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">Ø³ÙˆØ§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù† Ø§Ø³Øª...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">ØªÙˆØ¬Ù‡</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <div id="avatar-upload-ui-container" class="hidden">
                    <div class="flex flex-col sm:flex-row items-stretch gap-2 my-4">
                        <input type="url" id="avatar-url-input" placeholder="Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ØªØµÙˆÛŒØ± Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-3 text-base" style="direction: ltr; text-align: left;">
                        <button id="preview-avatar-btn" class="btn-clash btn-clash-secondary clash-font whitespace-nowrap px-4">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
                    </div>

                    <div id="avatar-preview-container" class="hidden">
                        <img id="avatar-preview-image" src="#" alt="Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ø¢ÙˆØ§ØªØ§Ø±">
                    </div>

                    <p id="avatar-error-message" class="hidden"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’»</span>
                        <h4 class="dev-role">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    </div>
                    <p class="dev-username clash-font">abolfazl1401</p>
                    <p class="dev-description">Ù…Ø¹Ù…Ø§Ø± Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ú¯ÛŒÙ…â€ŒÙ¾Ù„ÛŒØŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ¨</span>
                        <h4 class="dev-role">Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    </div>
                    <p class="dev-username clash-font">Vahid</p>
                    <p class="dev-description">Ø·Ø±Ø§Ø­ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (UX). Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®Ù„Ù‚ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¬Ø°Ø§Ø¨ Ùˆ ØªÙ… Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø§Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’¡</span>
                        <h4 class="dev-role">Ø§ÛŒØ¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²</h4>
                    </div>
                    <p class="dev-username clash-font">Ali.k</p>
                    <p class="dev-description">Ø®Ø§Ù„Ù‚ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø³ØªØ§Ù†â€ŒØ³Ø±Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">â˜ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">Neda_Tech</p>
                    <p class="dev-description">Ù…ØªØ®ØµØµ Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ØŒ ØªØ¶Ù…ÛŒÙ† Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ø²ÛŒ.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">âš™ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">SinaCloud</p>
                    <p class="dev-description">Ù…Ø³Ø¦ÙˆÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø´Ø¨Ú©Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ§Ù†.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸš€</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ± (DevOps)</h4>
                    </div>
                    <p class="dev-username clash-font">ParsaDevOps</p>
                    <p class="dev-description">Ù…ØªÙ…Ø±Ú©Ø² Ø¨Ø± ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ DevOpsØŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div id="leaderboard-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-2xl w-full relative">
            <button id="close-leaderboard-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ± Ø´Ù‡Ø±</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-3 font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ±...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Game Mode Selection Panel -->
    <div id="game-mode-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="game-mode-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg w-full relative">
            <button id="close-game-mode-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-6 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</h3>
            <p class="text-center text-gray-200 mb-8">Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
            <div class="flex flex-col items-center justify-center gap-6">
                <button id="single-player-btn" class="btn-clash btn-clash-primary clash-font">
                    <span class="icon">ğŸ‘¤</span>
                    <span>Ø¨Ø§Ø²ÛŒ ØªÚ©â€ŒÙ†ÙØ±Ù‡</span>
                </button>
                <button id="multiplayer-btn" class="btn-clash btn-clash-primary clash-font">
                    <span class="icon">ğŸ‘¥</span>
                    <span>Ø¨Ø§Ø²ÛŒ Ú†Ù†Ø¯Ù†ÙØ±Ù‡</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        // --- JAVASCRIPT LOGIC (WITH LOCAL QUESTIONS FALLBACK TO AI) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- AUDIO MANAGER ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');

                Object.values(this.sounds).forEach(sound => {
                    if (sound) sound.volume = 0.4; // Adjust volume globally
                });
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        // --- NEW: Variables for local questions ---
        let localQuestions = [];
        let areLocalQuestionsLoaded = false;
        
        // --- NEW: Timer variables ---
        const TIMER_DURATION = 20; // seconds
        let timerInterval = null;
        let timeLeft = TIMER_DURATION;


        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };
        
        // --- Variables ---
        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            authPanel, registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, developersBtn, leaderboardBtn,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            leaderboardPanelContainer, leaderboardList, closeLeaderboardPanelBtn;
        
        let avatarUploadUiContainer, avatarUrlInput, previewAvatarBtn,
            avatarPreviewContainer, avatarPreviewImage, avatarErrorMessage;
        
        let gameModePanelContainer, closeGameModePanelBtn, singlePlayerBtn, multiplayerBtn;

        let loadingProgressBarFill, loadingTip;
        let tipInterval;
        
        // --- NEW: Timer UI Elements ---
        let timerContainer, timerProgress, timerText;

        
        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function simpleHash(str) {
            let hash = 0;
            if (!str || str.length === 0) return 'h0';
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }


        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');

            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            
            screenElement.scrollTop = 0;
            updateUI();
        }
        
        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarUploadUiContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) {
                console.error("[showModal] Modal elements not found, cannot show modal.");
                return;
            }

            audioManager.play('panelOpen');

            modalContainer.classList.remove('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible'); 
            void modalContainer.offsetWidth; 
            modalContainer.querySelector('.panel-clash').classList.add('panel-visible'); 
            
            modalTitle.textContent = title;

            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarUploadUiContainer.classList.add('hidden');
            if (inputErrorMessage) inputErrorMessage.classList.add('hidden');
            if (userIdErrorMessage) userIdErrorMessage.classList.add('hidden');
            if (changeNameErrorMessage) changeNameErrorMessage.classList.add('hidden');
            if (avatarErrorMessage) avatarErrorMessage.classList.add('hidden');


            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || 
                                      (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')) ||
                                      (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));

            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName;
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = '';
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarUploadUiContainer.classList.remove('hidden');
                if(avatarUrlInput) avatarUrlInput.value = '';
                if(avatarPreviewContainer) avatarPreviewContainer.classList.add('hidden');
                if(avatarErrorMessage) avatarErrorMessage.classList.add('hidden');
                
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.disabled = (modalType === 'avatar');
            modalCancelBtn.disabled = false;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function hideModal() {
            if (!modalContainer || !modalMessage || !changeNameInputContainer || !avatarUploadUiContainer) {
                return;
            }
            
            audioManager.play('panelClose');
            modalContainer.classList.add('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible');

            modalConfirmCallback = null;
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            avatarUploadUiContainer.classList.add('hidden');
            modalMessage.classList.add('hidden');

            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || 
                                      (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')) ||
                                      (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
            
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("[handleModalConfirm] Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) {
                    console.error("[handleModalCancel] Error in modal cancel callback:", e);
                }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelOpen');
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelClose');
            developersPanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || 
                                           (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')) ||
                                           (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
             if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function showLeaderboardPanel() {
            if (!leaderboardPanelContainer) return;
            audioManager.play('panelOpen');
            leaderboardPanelContainer.classList.remove('panel-hidden');
            leaderboardPanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
            fetchAndDisplayLeaderboard();
        }

        function hideLeaderboardPanel() {
            if (!leaderboardPanelContainer) return;
            audioManager.play('panelClose');
            leaderboardPanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || 
                                           (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                           (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function showGameModePanel() {
            if (!gameModePanelContainer) return;
            audioManager.play('panelOpen');
            gameModePanelContainer.classList.remove('panel-hidden');
            gameModePanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideGameModePanel() {
            if (!gameModePanelContainer) return;
            audioManager.play('panelClose');
            gameModePanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || 
                                           (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                           (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }

            let showAuthPanel = true;
            let showActionButtons = false;
            let showUserInfoAndAvatar = false;

            if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                showAuthPanel = false;
                showActionButtons = true;
                if(startGameBtn) startGameBtn.classList.add('breathing');
                if (mainScreen && mainScreen.classList.contains('active')) {
                    showUserInfoAndAvatar = true;
                }
            } else if (isAuthReady && (!gameState.displayName || !gameState.publicUserId)) {
                showAuthPanel = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
                if(startGameBtn) startGameBtn.classList.remove('breathing');
            } else {
                showAuthPanel = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
                if(startGameBtn) startGameBtn.classList.remove('breathing');
            }

            if(authPanel){
                authPanel.classList.toggle('panel-hidden', !showAuthPanel);
                authPanel.classList.toggle('panel-visible', showAuthPanel);
            }

            if(mainScreenButtonsLayout){
                mainScreenButtonsLayout.classList.toggle('hidden', !showActionButtons);
            }

            if(userProfileArea){
                const isAnyPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                        (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                        (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')) ||
                                        (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
                if (showUserInfoAndAvatar && !isAnyPanelVisible) {
                    userProfileArea.classList.remove('profile-area-hidden', 'hidden');
                    if(avatarContainer) avatarContainer.classList.remove('hidden');
                    if(userInfoBox) userInfoBox.classList.remove('hidden');
                } else if (!showUserInfoAndAvatar) {
                    userProfileArea.classList.add('hidden');
                } else if (isAnyPanelVisible) {
                    userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }
        
        function simulateLoading() {
            const tips = [
                "âœ¨ Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø³ØªÛŒØ¯ Ù†Ù‚Ø´ Â«Ú¯Ø§Ø¯ÙØ§Ø¯Ø±Â» ÛŒØ§ Â«Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡Â» Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ØªØ±ÛŒÙ† Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø¨Ø§Ø²ÛŒ Ø§Ø³ØªØŸ",
                "âœ¨ Ø¯Ø± Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Â«Ø´Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø§ÙÛŒØ§Â»ØŒ Ù†Ù‚Ø´ Â«Ø¯Ú©ØªØ± Ù„Ú©ØªØ±Â» Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®ÙˆØ¯Ø´ Ø±Ø§ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù†Ø¬Ø§Øª Ø¯Ù‡Ø¯.",
                "âœ¨ Â«Ø¢Ù„ Ú©Ø§Ù¾ÙˆÙ†Â»ØŒ ÛŒÚ©ÛŒ Ø§Ø² Ù…Ø¹Ø±ÙˆÙâ€ŒØªØ±ÛŒÙ† Ú¯Ù†Ú¯Ø³ØªØ±Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ØŒ Ø³Ø±Ø§Ù†Ø¬Ø§Ù… Ø¨Ù‡ Ø®Ø§Ø·Ø± ÙØ±Ø§Ø± Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¯Ø³ØªÚ¯ÛŒØ± Ø´Ø¯.",
                "âœ¨ ÙÛŒÙ„Ù… Â«Ø±ÙÙ‚Ø§ÛŒ Ø®ÙˆØ¨Â» (Goodfellas) Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø§Ø³ØªØ§Ù† ÙˆØ§Ù‚Ø¹ÛŒ Â«Ù‡Ù†Ø±ÛŒ Ù‡ÛŒÙ„Â»ØŒ Ú¯Ù†Ú¯Ø³ØªØ± Ø³Ø§Ø¨Ù‚ØŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.",
                "âœ¨ Ø§ØµØ·Ù„Ø§Ø­ Â«OmertÃ Â» Ø¨Ù‡ Ù‚Ø§Ù†ÙˆÙ† Ø³Ú©ÙˆØª Ø¯Ø± Ø¨ÛŒÙ† Ø§Ø¹Ø¶Ø§ÛŒ Ù…Ø§ÙÛŒØ§ Ø§Ø´Ø§Ø±Ù‡ Ø¯Ø§Ø±Ø¯."
            ];
            let currentTipIndex = Math.floor(Math.random() * tips.length);
            
            if (loadingTip) loadingTip.innerHTML = tips[currentTipIndex];

            tipInterval = setInterval(() => {
                currentTipIndex = (currentTipIndex + 1) % tips.length;
                if (loadingTip) {
                    loadingTip.style.animation = 'none';
                    loadingTip.offsetHeight; // Trigger reflow
                    loadingTip.style.animation = 'tipFadeIn 0.8s ease-out';
                    loadingTip.innerHTML = tips[currentTipIndex];
                }
            }, 4000);

            setTimeout(() => {
                if (loadingProgressBarFill) loadingProgressBarFill.style.width = '30%';
                if (loadingMessage) loadingMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±...';
            }, 500);
            setTimeout(() => {
                if (loadingProgressBarFill) loadingProgressBarFill.style.width = '65%';
                if (loadingMessage) loadingMessage.textContent = 'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ...';
            }, 1500);
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized (Auth, Firestore).");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData(user.uid);
                    } else {
                        await signInAnonymously(auth);
                        gameState.displayName = '';
                        gameState.publicUserId = '';
                        gameState.avatarUrl = '';
                        gameState.seenQuestionHashes.clear();
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        clearInterval(tipInterval);
                        if (loadingProgressBarFill) loadingProgressBarFill.style.width = '100%';
                        if (loadingMessage) loadingMessage.textContent = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen);
                        }, 800);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø§Ø²ÛŒ.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }
        
        async function loadUserData(userIdToLoad) {
            if (!userIdToLoad || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToLoad}/mafiaGameData/profile`);
            try {
                if (loadingMessage) loadingMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§...';
                if (loadingProgressBarFill) loadingProgressBarFill.style.width = '85%';
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                    console.log(`Loaded ${gameState.seenQuestionHashes.size} seen questions.`);
                } else {
                    gameState.displayName = "";
                    gameState.publicUserId = "";
                    gameState.avatarUrl = '';
                    gameState.seenQuestionHashes = new Set();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db) return;
            
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const privateData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                lastUpdated: serverTimestamp()
            };
            
            const leaderboardDocRef = doc(db, `artifacts/${appId}/publicLeaderboard/${currentUserId}`);
            const publicData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                lastUpdated: serverTimestamp()
            };

            try {
                await Promise.all([
                    setDoc(userDocRef, privateData, { merge: true }),
                    setDoc(leaderboardDocRef, publicData, { merge: true })
                ]);
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }

        async function isDisplayNameTaken(nameToCheck) {
            if (!db) return true;
            const usersRef = collection(db, `artifacts/${appId}/publicLeaderboard`);
            const q = query(usersRef, where("displayName", "==", nameToCheck), limit(1));
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return false;
                return querySnapshot.docs[0].id !== currentUserId; 
            } catch (error) {
                console.error("Error checking display name uniqueness:", error);
                showModal("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±", `Ø§Ù…Ú©Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©ØªØ§ Ø¨ÙˆØ¯Ù† Ù†Ø§Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. <br><small>${error.message}</small>`, "Ø¨Ø§Ø´Ù‡");
                return true;
            }
        }
        
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";

        async function callGeminiAPI(prompt) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
                
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                }
                throw new Error(`Invalid AI response (Finish Reason: ${result.candidates?.[0]?.finishReason})`);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Ø®Ø·Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø®Ø§Ù…ÙˆØ´ Ø¨ÙˆØ¯Ù† ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.<br><small>${error.message}</small>`, "Ø¨Ø§Ø´Ù‡");
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function generateQuestionFromAI() {
            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                let difficulty = "Ø¢Ø³Ø§Ù†";
                if (gameState.currentStage > 20) difficulty = "Ø¨Ø³ÛŒØ§Ø± Ø³Ø®Øª";
                else if (gameState.currentStage > 10) difficulty = "Ø³Ø®Øª";
                else if (gameState.currentStage > 5) difficulty = "Ù…ØªÙˆØ³Ø·";
                
                const prompt = `
                Ø´Ù…Ø§ ÛŒÚ© Ø·Ø±Ø§Ø­ Ø¨Ø§Ø²ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ù‡Ø³ØªÛŒØ¯. ÛŒÚ© Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Û´ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ) Ø¬Ø¯ÛŒØ¯ Ùˆ Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø§ÙÛŒØ§ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ØŒ ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ØŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§ØŒ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª) Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†.
                Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ø³ÙˆØ§Ù„ Ø¨Ø§ÛŒØ¯ "${difficulty}" Ø¨Ø§Ø´Ø¯ Ú†ÙˆÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ ${gameState.currentStage} Ø§Ø³Øª.
                Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª JSON Ø®Ø§Ù… Ø¨Ø§ Ø§ÛŒÙ† Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø´Ø¯:
                {
                  "question": "Ù…ØªÙ† Ø³ÙˆØ§Ù„",
                  "options": ["Ú¯Ø²ÛŒÙ†Ù‡ Û±", "Ú¯Ø²ÛŒÙ†Ù‡ Û²", "Ú¯Ø²ÛŒÙ†Ù‡ Û³", "Ú¯Ø²ÛŒÙ†Ù‡ Û´"],
                  "correctAnswerIndex": 0,
                  "explanation": "ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­"
                }
                `;

                const data = await callGeminiAPI(prompt);

                if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    const questionHash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(questionHash)) {
                        return data; // Unique question found
                    } else {
                        console.warn(`Duplicate AI question received (hash: ${questionHash}), retrying...`);
                        attempts++;
                    }
                } else {
                    console.error("Invalid question data structure from AI:", data);
                    attempts++;
                }
            }
            return null; // Failed to get a unique question
        }

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            if (questionText) questionText.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙˆØ§Ù„...";
            if (optionsContainer) optionsContainer.innerHTML = "";
            if (questionExplanation) questionExplanation.classList.add('hidden');
            if (gameFeedback) gameFeedback.textContent = "";
            
            let questionData = null;

            if (areLocalQuestionsLoaded && localQuestions.length > 0) {
                const unseenQuestions = localQuestions.filter(q => !gameState.seenQuestionHashes.has(simpleHash(q.question)));
                
                if (unseenQuestions.length > 0) {
                    console.log(`${unseenQuestions.length} unseen local questions remaining.`);
                    const randomIndex = Math.floor(Math.random() * unseenQuestions.length);
                    questionData = unseenQuestions[randomIndex];
                } else {
                    console.log("All local questions have been answered. Switching to AI generator.");
                }
            }

            if (!questionData) {
                if(questionText) questionText.textContent = "Ø¨Ø§Ù†Ú© Ø³ÙˆØ§Ù„Ø§Øª ØªÙ…Ø§Ù… Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯ ØªÙˆØ³Ø· Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...";
                questionData = await generateQuestionFromAI();
            }

            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                console.error("Failed to generate any question (local or AI).");
                if (questionText) questionText.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„.";
                showModal("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„", `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`, "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", "ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); if (mainScreen) showScreen(mainScreen); }
                );
            }
            
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData || !questionText || !optionsContainer) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(gameFeedback) gameFeedback.textContent = "";
            gameState.isQuestionActive = true;
            startTimer(); // --- NEW: Start timer with the question
        }
        
        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion) return;
            
            stopTimer(); // --- NEW: Stop timer on selection
            
            gameState.isQuestionActive = false;

            const selectedOptionButton = event.target.closest('.option-btn');
            if (!selectedOptionButton) return;

            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                audioManager.play('correct');
                selectedOptionButton.classList.add('correct');
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#aaffaa] clash-font';
                
                gameState.seenQuestionHashes.add(simpleHash(question));
                gameState.currentStage++;
                
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');
                handleIncorrectAnswer("Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡!");
            }
            if (explanation && questionExplanation) {
                questionExplanation.textContent = `ØªÙˆØ¶ÛŒØ­: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }
        
        function handleIncorrectAnswer(feedbackText) {
            audioManager.play('incorrect');
            gameFeedback.textContent = feedbackText;
            gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#ffaaaa] clash-font';

            setTimeout(() => {
                showModal("Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ", `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ ${feedbackText.toLowerCase()} Ø´Ù…Ø§ ØªØ§ Ù…Ø±Ø­Ù„Ù‡ ${gameState.currentStage} Ù¾ÛŒØ´ Ø±ÙØªÛŒØ¯. Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ØŸ`, "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯", "ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",
                () => { // onConfirm
                    hideModal();
                    gameState.currentStage = 1;
                    gameState.seenQuestionHashes.clear();
                    
                    // --- BUG FIX: Removed saveUserData() from here. ---
                    // The game state is reset locally. It will be saved on the next *correct* answer.
                    // This prevents the "Error saving data" bug on restart.
                    
                    generateQuestion();
                    updateUI();
                },
                () => { // onCancel
                    hideModal();
                    if(mainScreen) showScreen(mainScreen);
                });
            }, 2500);
        }
        
        // --- NEW: Timer functions ---
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIMER_DURATION;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            if (!timerText || !timerProgress || !timerContainer) return;
            
            timerText.textContent = timeLeft;
            const degrees = (timeLeft / TIMER_DURATION) * 360;
            timerProgress.style.background = `conic-gradient(var(--clash-gold) ${degrees}deg, var(--clash-blue-dark) 0deg)`;

            if (timeLeft <= 5) {
                timerContainer.classList.add('warning');
                 timerProgress.style.background = `conic-gradient(var(--clash-red) ${degrees}deg, var(--clash-blue-dark) 0deg)`;
            } else {
                timerContainer.classList.remove('warning');
            }
        }

        function handleTimeUp() {
            if (!gameState.isQuestionActive) return;
            stopTimer();
            gameState.isQuestionActive = false;
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });
            const { correctAnswerIndex, explanation } = gameState.currentQuestionData;
            const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
            if (correctButton) correctButton.classList.add('correct');

            if (explanation && questionExplanation) {
                questionExplanation.textContent = `ØªÙˆØ¶ÛŒØ­: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
            handleIncorrectAnswer("ÙˆÙ‚Øª ØªÙ…Ø§Ù… Ø´Ø¯!");
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            const imageRegex = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))(?:\?.*)?$/i;
            return imageRegex.test(url);
        }

        function previewAvatarFromUrl() {
            if (!avatarUrlInput || !avatarPreviewImage || !avatarPreviewContainer || !avatarErrorMessage || !modalConfirmBtn) return;
            
            const url = avatarUrlInput.value.trim();
            avatarErrorMessage.classList.add('hidden');
            modalConfirmBtn.disabled = true;

            if (!isValidImageUrl(url)) {
                avatarErrorMessage.textContent = 'Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.';
                avatarErrorMessage.classList.remove('hidden');
                avatarPreviewContainer.classList.add('hidden');
                return;
            }

            avatarPreviewImage.src = url;
            avatarPreviewImage.onerror = () => {
                avatarErrorMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±.';
                avatarErrorMessage.classList.remove('hidden');
                avatarPreviewContainer.classList.add('hidden');
            };
            avatarPreviewImage.onload = () => {
                avatarPreviewContainer.classList.remove('hidden');
                modalConfirmBtn.disabled = false;
            };
        }

        async function saveAvatarFromUrl() {
            if (!avatarUrlInput) return;
            const newUrl = avatarUrlInput.value.trim();
            if (!isValidImageUrl(newUrl)) {
                if(avatarErrorMessage) avatarErrorMessage.textContent = 'Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.';
                return;
            }

            modalConfirmBtn.disabled = true;
            modalCancelBtn.disabled = true;

            try {
                gameState.avatarUrl = newUrl;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
            } catch(error) {
                console.error("Error saving avatar URL:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ø¢ÙˆØ§ØªØ§Ø±.';
            } finally {
                if(modalConfirmBtn) modalConfirmBtn.disabled = false;
                if(modalCancelBtn) modalCancelBtn.disabled = false;
            }
        }
        
        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            if (!inputElement || !errorElement) return null;
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');

            if (nameValue !== sanitizedValue) inputElement.value = sanitizedValue;

            const trimmedName = sanitizedValue.trim();

            if (trimmedName.length < 3) {
                errorElement.textContent = "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.classList.add('hidden');
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName === gameState.displayName) {
               if(changeNameErrorMessage) changeNameErrorMessage.textContent = "Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… ÙØ¹Ù„ÛŒ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.";
               return;
            }

            modalConfirmBtn.disabled = true;
            modalCancelBtn.disabled = true;
            if (await isDisplayNameTaken(newName)) {
                changeNameErrorMessage.textContent = "Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§ ØªÙˆØ³Ø· Ø´Ø®Øµ Ø¯ÛŒÚ¯Ø±ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.";
                modalConfirmBtn.disabled = false;
                modalCancelBtn.disabled = false;
                return;
            }

            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
        }

        async function generateMafiaFact() {
            const prompt = "ÛŒÚ© Ø­Ù‚ÛŒÙ‚Øª Ø¬Ø§Ù„Ø¨ Ùˆ Ú©ÙˆØªØ§Ù‡ (Û²-Û´ Ø¬Ù…Ù„Ù‡) Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ØŒ ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ØŒ Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§) Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ú¯Ùˆ.";
            showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨", "<div class='loader mx-auto my-3'></div>", "Ø¨Ø§Ø´Ù‡");

            // This function needs a different Gemini call format since it's not JSON
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const fact = result.candidates[0].content.parts[0].text;
                if (fact) {
                    showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨", fact.replace(/\n/g, '<br>'), "Ø¬Ø§Ù„Ø¨ Ø¨ÙˆØ¯!");
                } else {
                    throw new Error("No fact received from AI.");
                }
            } catch (error) {
                console.error("Error generating fact:", error);
                showModal("Ø®Ø·Ø§", "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†Ú©ØªÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙØªÙ† Ù†ÛŒØ³Øª.", "Ø¨Ø§Ø´Ù‡");
            }
        }
        
        function generateAlphanumericPublicUserId(length = 5) {
            return Array(length).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.random() * 36)).join('');
        }

        async function fetchAndDisplayLeaderboard() {
            if (!db || !leaderboardList) return;
            leaderboardList.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div><p class="mt-3 font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>`;
            try {
                const q = query(collection(db, `artifacts/${appId}/publicLeaderboard`), orderBy("currentStage", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-gray-300">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ Ù†ÛŒØ³Øª!</p>`;
                    return;
                }
                renderLeaderboardList(querySnapshot.docs.map(doc => doc.data()));
            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-red-300">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.</p>`;
            }
        }

        function renderLeaderboardList(users) {
            if (!leaderboardList) return;
            leaderboardList.innerHTML = users.map((user, index) => {
                const rank = index + 1;
                const avatarSrc = user.avatarUrl || 'https://placehold.co/50x50/2a4166/ffffff?text=?';
                return `
                    <div class="leaderboard-item">
                        <span class="leaderboard-rank">${rank}</span>
                        <img src="${avatarSrc}" alt="Avatar for ${user.displayName}" class="leaderboard-avatar" onerror="this.src='https://placehold.co/50x50/2a4166/ffffff?text=?'">
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${user.displayName || "Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨ÛŒâ€ŒÙ†Ø§Ù…"}</div>
                            <div class="leaderboard-stage">
                                <span>Ù…Ø±Ø­Ù„Ù‡:</span>
                                <span class="leaderboard-stage-value">${user.currentStage || 1}</span>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        async function loadLocalQuestions() {
            try {
                const response = await fetch('Questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                localQuestions = await response.json();
                if (Array.isArray(localQuestions) && localQuestions.length > 0) {
                    areLocalQuestionsLoaded = true;
                    console.log(`Successfully loaded ${localQuestions.length} local questions.`);
                } else {
                    console.warn("Questions.json is empty or not a valid array.");
                }
            } catch (error) {
                console.error("Could not load local questions from Questions.json:", error);
            }
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', (event) => {
                if (event.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });

            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            if (displayNameInput) displayNameInput.addEventListener('input', () => validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput));

            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', () => {
                    if (userIdDisplayInput) userIdDisplayInput.value = generateAlphanumericPublicUserId();
                    gameState.publicUserId = userIdDisplayInput.value;
                    if (userIdErrorMessage) userIdErrorMessage.classList.add('hidden');
                });
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', async () => {
                    const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                    if (!gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯.";
                        return;
                    }
                    if (!validatedName) return;

                    registerBtn.disabled = true;
                    if (await isDisplayNameTaken(validatedName)) {
                        inputErrorMessage.textContent = "Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.";
                        registerBtn.disabled = false;
                        return;
                    }

                    gameState.displayName = validatedName;
                    await saveUserData();
                    updateUI();
                });
            }

            if (editNameBtn) editNameBtn.addEventListener('click', () => showModal("ØªØºÛŒÛŒØ± Ù†Ø§Ù…", "ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.", "ØªØºÛŒÛŒØ±", "Ù„ØºÙˆ", handleChangeDisplayName, hideModal, "changeName"));

            if (avatarContainer) avatarContainer.addEventListener('click', () => showModal("ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±", "Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ØªØµÙˆÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.", "Ø°Ø®ÛŒØ±Ù‡", "Ù„ØºÙˆ", saveAvatarFromUrl, hideModal, "avatar"));
            
            if(previewAvatarBtn) previewAvatarBtn.addEventListener('click', previewAvatarFromUrl);
            
            [startGameBtn, mafiaFactBtn, developersBtn, leaderboardBtn].forEach(button => {
                if(button) button.addEventListener('click', (event) => {
                    if (!isAuthReady || !gameState.displayName) {
                        event.stopPropagation();
                        showModal("Ø«Ø¨Øª Ù†Ø§Ù… Ù„Ø§Ø²Ù… Ø§Ø³Øª", "Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯.", "Ø¨Ø§Ø´Ù‡");
                    }
                }, true);
            });

            if (startGameBtn) startGameBtn.addEventListener('click', () => { if(isAuthReady && gameState.displayName) showGameModePanel(); });
            if (closeGameModePanelBtn) closeGameModePanelBtn.addEventListener('click', hideGameModePanel);
            if (singlePlayerBtn) singlePlayerBtn.addEventListener('click', () => { hideGameModePanel(); if(gameScreen) showScreen(gameScreen); generateQuestion(); });
            if (multiplayerBtn) multiplayerBtn.addEventListener('click', () => { window.location.href = 'serchplayers.html'; });

            if (mafiaFactBtn) mafiaFactBtn.addEventListener('click', () => { if(isAuthReady && gameState.displayName) generateMafiaFact(); });
            if (developersBtn) developersBtn.addEventListener('click', showDevelopersPanel);
            if (closeDevelopersPanelBtn) closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            if (leaderboardBtn) leaderboardBtn.addEventListener('click', showLeaderboardPanel);
            if (closeLeaderboardPanelBtn) closeLeaderboardPanelBtn.addEventListener('click', hideLeaderboardPanel);
            if(backToMainBtn) backToMainBtn.addEventListener('click', async () => { stopTimer(); await saveUserData(); gameState.currentQuestionData = null; if(mainScreen) showScreen(mainScreen); });

        }
        
        async function initializeGame() {
            // Query DOM elements
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            authPanel = document.getElementById('auth-panel');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');
            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            developersBtn = document.getElementById('developers-btn');
            leaderboardBtn = document.getElementById('leaderboard-btn');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarUploadUiContainer = document.getElementById('avatar-upload-ui-container');
            avatarUrlInput = document.getElementById('avatar-url-input');
            previewAvatarBtn = document.getElementById('preview-avatar-btn');
            avatarPreviewContainer = document.getElementById('avatar-preview-container');
            avatarPreviewImage = document.getElementById('avatar-preview-image');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');
            leaderboardPanelContainer = document.getElementById('leaderboard-panel-container');
            leaderboardList = document.getElementById('leaderboard-list');
            closeLeaderboardPanelBtn = document.getElementById('close-leaderboard-panel-btn');
            gameModePanelContainer = document.getElementById('game-mode-panel-container');
            closeGameModePanelBtn = document.getElementById('close-game-mode-panel-btn');
            singlePlayerBtn = document.getElementById('single-player-btn');
            multiplayerBtn = document.getElementById('multiplayer-btn');
            loadingProgressBarFill = document.getElementById('loading-progress-bar-fill');
            loadingTip = document.getElementById('loading-tip');
            
            // --- NEW: Query Timer Elements ---
            timerContainer = document.getElementById('timer-container');
            timerProgress = document.getElementById('timer-progress');
            timerText = document.getElementById('timer-text');


            // Initialize game logic
            audioManager.init();
            if(userProfileArea) userProfileArea.classList.add('hidden');
            simulateLoading();
            
            if (!navigator.onLine) {
                showModal("Ø¹Ø¯Ù… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª", "Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", null, () => window.location.reload());
                return;
            }

            try {
                await loadLocalQuestions();
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>
