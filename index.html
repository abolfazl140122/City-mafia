<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #eab308; /* yellow-500 */
            --glow-color-rgb: 234, 179, 8;
            --border-gradient: linear-gradient(145deg, #eab308, #b45309, #eab308);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e5e7eb; /* gray-200 */
            background-color: #000;
            overflow: hidden;
        }

        /* --- Cinematic Background & Effects --- */
        #background-container {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: -2; overflow: hidden;
        }
        #background-image {
            width: 100%; height: 100%; object-fit: cover;
            animation: ken-burns 40s ease-in-out infinite;
            transform-origin: center;
        }
        #smoke-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: url(https://www.transparenttextures.com/patterns/foggy-birds.png) repeat;
            opacity: 0.15;
            animation: drift 60s linear infinite;
        }
        @keyframes ken-burns {
            0%, 100% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(1%, -1%); }
        }
        @keyframes drift {
            from { background-position: 0 0; } to { background-position: 512px 512px; }
        }

        /* --- Metallic & Gold Trim Panels --- */
        .panel {
            background-color: rgba(10, 10, 12, 0.85);
            backdrop-filter: blur(5px);
            border: 2px solid; border-image-slice: 1;
            border-image-source: var(--border-gradient);
            box-shadow: 0 0 25px rgba(var(--glow-color-rgb), 0.2), inset 0 0 10px rgba(0,0,0,0.5);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .panel-hidden {
            opacity: 0; transform: scale(0.98) translateY(15px);
            pointer-events: none; visibility: hidden;
        }
        .panel-visible {
            opacity: 1; transform: scale(1) translateY(0); visibility: visible;
        }
        
        /* --- Modern Buttons with Gold Trim --- */
        .btn-mafia, .btn-mafia-secondary {
            color: #f3f4f6; border: 2px solid;
            border-image-slice: 1; border-image-source: var(--border-gradient);
            padding: 10px 24px; font-size: 1rem;
            border-radius: 8px; font-weight: 700;
            transition: all 0.3s ease; position: relative;
            background-color: rgba(10, 10, 12, 0.6);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .btn-mafia:hover, .btn-mafia-secondary:hover {
            transform: translateY(-2px); color: #fff;
        }
        .btn-mafia:hover {
            box-shadow: 0 0 20px rgba(var(--glow-color-rgb), 0.5), inset 0 0 15px rgba(var(--glow-color-rgb), 0.2);
        }
        .btn-mafia-secondary {
            border-image-source: linear-gradient(145deg, #888, #555, #888); color: #a0a0a0;
        }
        .btn-mafia-secondary:hover {
             border-image-source: linear-gradient(145deg, #ccc, #999, #ccc);
             box-shadow: 0 0 15px rgba(200,200,200, 0.3);
        }

        .input-mafia {
            background-color: rgba(0, 0, 0, 0.7); border: 1px solid rgba(196, 151, 48, 0.4);
            color: #e0e0e0; border-radius: 8px; padding: 12px;
            font-size: 1rem; transition: all 0.3s ease;
        }
        .input-mafia:focus {
            outline: none; border-color: var(--glow-color);
            box-shadow: 0 0 15px rgba(var(--glow-color-rgb), 0.5);
        }
        .input-mafia.invalid {
            border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        #main-title {
            font-size: 3.5rem; font-weight: 800; color: #eab308;
            animation: flicker 4s linear infinite;
        }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }
        @keyframes flicker {
            0%, 100% { text-shadow: 0 0 5px #000, 0 0 10px #000, 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); }
            50% { text-shadow: 0 0 5px #000, 0 0 10px #000, 0 0 15px var(--glow-color), 0 0 25px var(--glow-color); }
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh;
            padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease; display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
        }
        .screen.active { opacity: 1; visibility: visible; }
        .screen-content-wrapper {
            width: 100%; max-width: 800px; margin: auto;
            display: flex; flex-direction: column; flex-grow: 1; justify-content: center;
        }
        #main-screen .screen-content-wrapper { justify-content: space-between; }
        
        #game-feedback {
            font-size: 2rem; font-weight: bold; opacity: 0; transform: scale(0.5);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #game-feedback.animate-in { opacity: 1; transform: scale(1); }
        .feedback-correct { color: #22c55e; } .feedback-incorrect { color: #ef4444; }

        body.shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* --- Super Cool Loading Screen --- */
        #loading-screen-content { text-align: center; }
        #loading-title-container {
            font-weight: 800; font-size: 4rem; overflow: hidden;
            display: flex; justify-content: center; gap: 1rem;
        }
        @media (min-width: 768px) { #loading-title-container { font-size: 6rem; } }
        
        #loading-title-container span {
            display: block; transform: translateY(110%);
            animation-duration: 0.8s; animation-fill-mode: forwards;
            animation-timing-function: cubic-bezier(0.2, 1, 0.3, 1);
        }
        #loading-title-container.animate-in span:first-child { animation-name: reveal-text; }
        #loading-title-container.animate-in span:last-child { animation-name: reveal-text; animation-delay: 0.2s; }

        #loading-screen.exiting #loading-title-container span:first-child { animation-name: hide-text; }
        #loading-screen.exiting #loading-title-container span:last-child { animation-name: hide-text; animation-delay: 0.2s; }

        @keyframes reveal-text { from { transform: translateY(110%); } to { transform: translateY(0); } }
        @keyframes hide-text { from { transform: translateY(0); } to { transform: translateY(-110%); } }

        #loading-bar-container {
            width: 100%; max-width: 300px; height: 4px;
            background-color: rgba(255, 255, 255, 0.2); margin: 1.5rem auto;
            border-radius: 2px; overflow: hidden; transform: scaleX(0);
            transition: transform 0.5s ease;
        }
        #loading-screen.animate-in #loading-bar-container { transform: scaleX(1); transition-delay: 0.5s; }
        #loading-screen.exiting #loading-bar-container { transform: scaleX(0); transition-delay: 0s; }

        #loading-bar {
            width: 0%; height: 100%; background-color: var(--glow-color);
            border-radius: 2px; transition: width 3s ease-out;
        }

        #loading-message {
            opacity: 0; transform: translateY(10px); transition: opacity 0.5s, transform 0.5s;
        }
        #loading-screen.animate-in #loading-message { opacity: 1; transform: translateY(0); transition-delay: 0.8s; }
        #loading-screen.exiting #loading-message { opacity: 0; transition-delay: 0s; }


        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar-thumb { background: var(--glow-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="background-container">
        <img id="background-image" src="https://images.unsplash.com/photo-1594225499423-11b2a2aa6a4b?q=80&w=2070&auto=format&fit=crop" alt="Dark city background">
        <div id="smoke-overlay"></div>
    </div>
    
    <div id="user-profile-area" class="fixed top-5 right-5 z-50 hidden">
        <div id="user-info-box" class="panel panel-hidden flex items-center gap-4 p-3 rounded-lg">
            <div id="avatar-container" title="تغییر آواتار" class="hidden">
                 <img id="avatar-image" class="w-16 h-16 rounded-full object-cover border-2 border-yellow-500 cursor-pointer transition-transform hover:scale-110" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار">
            </div>
            <div>
                 <div id="display-name-output-container" class="flex items-center gap-2">
                    <div id="display-name-output" class="text-lg font-bold"></div>
                    <span id="edit-name-btn" title="تغییر نام" class="cursor-pointer text-xl text-yellow-400 hover:text-yellow-200 transition-colors">✏️</span>
                </div>
                <div class="flex items-center gap-1 text-xs text-gray-400">
                    <span>شناسه:</span>
                    <div id="public-user-id-output" class="font-mono"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active">
        <div id="loading-screen-content">
            <h1 id="loading-title-container">
                <span class="text-gray-300">شهر</span>
                <span class="text-yellow-500">مافیا</span>
            </h1>
            <div id="loading-bar-container">
                <div id="loading-bar"></div>
            </div>
            <p id="loading-message" class="text-lg text-gray-400">در حال اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
             <header class="text-center pt-16">
                 <h1 id="main-title">شهر مافیا</h1>
             </header>

            <div id="registration-form-container" class="w-full max-w-md mx-auto">
                 <div id="registration-form" class="panel p-8 rounded-2xl">
                    <h2 class="text-2xl font-semibold mb-6 text-center text-yellow-400">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1" maxlength="20">
                    <p id="input-error-message" class="text-red-400 text-sm h-6"></p>

                    <div class="mt-3 mb-2">
                        <label class="block text-sm font-medium text-gray-300 mb-2">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-3">
                            <input type="text" id="user-id-display" class="input-mafia w-full text-center tracking-widest" readonly placeholder="---">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-4 !py-3">ساخت</button>
                        </div>
                        <p id="user-id-error-message" class="text-red-400 text-sm h-6"></p>
                    </div>
                    <button id="register-btn" class="btn-mafia w-full py-3 text-lg mt-4">ورود به شهر</button>
                </div>
            </div>

            <footer id="main-screen-buttons-layout" class="pb-8 hidden">
                <div class="flex justify-center items-center flex-wrap gap-4">
                    <button id="start-game-btn" class="btn-mafia text-xl py-4 px-8">شروع بازی</button>
                    <button id="mafia-fact-btn" class="btn-mafia-secondary">دانستنی‌های مافیا ✨</button>
                    <button id="dev-intro-icon-btn-header" class="btn-mafia-secondary" title="معرفی سازندگان">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M17 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start py-6">
            <div class="flex justify-between items-center mb-6 p-3 panel rounded-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">⟵ بازگشت</button>
                <div class="text-lg">مرحله: <span id="stage-display" class="font-bold text-yellow-400 text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel p-6 rounded-2xl mb-6 min-h-[250px] flex flex-col justify-center">
                <p id="question-text" class="text-2xl md:text-3xl mb-8 text-center leading-relaxed">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="question-explanation" class="text-sm mt-6 text-gray-300 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center font-semibold my-4 h-12"></div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel p-8 rounded-2xl max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-5 text-yellow-400">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-4 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید" class="input-mafia w-full" maxlength="20">
                    <p id="change-name-error-message" class="text-red-400 text-sm h-6"></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <p class="text-gray-400 mb-4">این قابلیت در حال حاضر روی دستگاه شما در دسترس نیست.</p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-6">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s", authDomain: "city-mafia.firebaseapp.com",
            projectId: "city-mafia", storageBucket: "city-mafia.appspot.com",
            messagingSenderId: "66458127103", appId: "1:66458127103:web:8bcc2ad470f51b5db45aca"
        };
        const appId = 'mafia-game-default';
        let app, auth, db, currentUserId = null, isAuthReady = false;

        const gameState = {
            displayName: '', publicUserId: '', currentStage: 1, currentQuestionData: null,
            isQuestionActive: false, isLoadingNextQuestion: false, avatarUrl: '',
        };
        
        const isWindows = /Windows/i.test(navigator.userAgent);
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        const disableAvatarFeature = isWindows || isMobile;

        const elements = {};
        let modalConfirmCallback = null, modalCancelCallback = null;

        function showScreen(screenElement) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            updateUI();
        }

        function showPanel(panel) { if (panel) panel.classList.remove('panel-hidden'); }
        function hidePanel(panel) { if (panel) panel.classList.add('panel-hidden'); }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            elements.modalTitle.textContent = title;
            elements.modalMessage.innerHTML = message;

            elements.changeNameInputContainer.classList.add('hidden');
            elements.avatarGenerationContainer.classList.add('hidden');

            if (modalType === "changeName") {
                elements.changeNameInputContainer.classList.remove('hidden');
                elements.newDisplayNameInput.value = gameState.displayName;
            } else if (modalType === "avatar" && !disableAvatarFeature) {
                elements.avatarGenerationContainer.classList.remove('hidden');
            }

            elements.modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;
            elements.modalCancelBtn.classList.toggle('hidden', !cancelText);
            if (cancelText) elements.modalCancelBtn.textContent = cancelText;

            elements.modalContainer.classList.remove('panel-hidden');
            showPanel(elements.modalContainer.querySelector('.panel'));
        }

        function hideModal() {
            elements.modalContainer.classList.add('panel-hidden');
            hidePanel(elements.modalContainer.querySelector('.panel'));
        }

        function handleModalConfirm() { (modalConfirmCallback) ? modalConfirmCallback() : hideModal(); }
        function handleModalCancel() { (modalCancelCallback) ? modalCancelCallback() : hideModal(); }
        
        function updateUI() {
            if (!isAuthReady) return;
            elements.displayNameOutput.textContent = gameState.displayName || "مهمان";
            elements.publicUserIdOutput.textContent = gameState.publicUserId || "---";
            elements.stageDisplay.textContent = gameState.currentStage;
            if (elements.avatarImage) elements.avatarImage.src = gameState.avatarUrl || `https://placehold.co/80x80/333333/777777?text=?`;

            const isLoggedIn = gameState.displayName && gameState.publicUserId;
            
            if (isLoggedIn) {
                hidePanel(elements.registrationFormContainer);
                elements.mainScreenButtonsLayout.classList.remove('hidden');
                elements.userProfileArea.classList.remove('hidden');
                showPanel(elements.userInfoBox);
                if (!disableAvatarFeature) elements.avatarContainer.classList.remove('hidden');
            } else {
                showPanel(elements.registrationFormContainer);
                elements.mainScreenButtonsLayout.classList.add('hidden');
                elements.userProfileArea.classList.add('hidden');
                hidePanel(elements.userInfoBox);
            }
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        const { user: newUser } = await signInAnonymously(auth);
                        currentUserId = newUser.uid;
                    }
                    await loadUserData();
                    isAuthReady = true;
                    updateUI();
                    
                    // This will be triggered once auth is ready, ending the loading sequence
                    elements.loadingMessage.textContent = "خوش آمدید!";
                    elements.loadingBar.style.width = '100%';
                    setTimeout(() => {
                        elements.loadingScreen.classList.add('exiting');
                        setTimeout(() => showScreen(elements.mainScreen), 600);
                    }, 500);
                });
            } catch (error) {
                 elements.loadingMessage.textContent = "خطا در اتصال به سرور.";
            }
        }
        
        async function loadUserData() {
            if (!currentUserId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(gameState, {
                        displayName: data.displayName || "", publicUserId: data.publicUserId || "",
                        currentStage: data.currentStage || 1, avatarUrl: data.avatarUrl || '',
                    });
                }
            } catch (error) { console.error("Error loading user data", error); }
        }
        
        async function saveUserData() {
            if (!currentUserId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const { displayName, publicUserId, currentStage, avatarUrl } = gameState;
            await setDoc(docRef, { displayName, publicUserId, currentStage, avatarUrl, lastUpdated: serverTimestamp() }, { merge: true });
        }
        
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash";
        
        async function callGeminiAPI(prompt, isJsonOutput = false) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJsonOutput) payload.generationConfig = { responseMimeType: "application/json" };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Invalid AI response.");
                return isJsonOutput ? JSON.parse(text) : text;
            } catch (error) {
                showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد.`, "باشه");
                return null;
            }
        }
        
        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            elements.questionText.textContent = "در حال تولید سوال جدید...";
            elements.optionsContainer.innerHTML = "";
            elements.questionExplanation.classList.add('hidden');
            elements.gameFeedback.className = 'text-center font-semibold my-4 h-12';
            const prompt = `یک سوال چند گزینه ای با موضوع مافیا به زبان فارسی ایجاد کن. پاسخ شما باید فقط یک آبجکت JSON خام باشد. ساختار: { "question": "متن سوال", "options": ["گزینه ۱", "گزینه ۲", "گزینه ۳", "گزینه ۴"], "correctAnswerIndex": 0, "explanation": "توضیح پاسخ" }`;
            const data = await callGeminiAPI(prompt, true);
            if (data?.question && data.options?.length === 4) {
                gameState.currentQuestionData = data;
                displayQuestion();
            } else {
                showModal("خطا در سوال", "مشکلی در تولید سوال پیش آمد.", "تلاش مجدد", "صفحه اصلی", () => { hideModal(); generateQuestion(); }, () => { hideModal(); showScreen(elements.mainScreen); });
            }
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            const { question, options } = gameState.currentQuestionData;
            elements.questionText.textContent = question;
            elements.optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'btn-mafia-secondary !py-4 text-base';
                button.textContent = option;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                elements.optionsContainer.appendChild(button);
            });
            gameState.isQuestionActive = true;
        }
        
        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive) return;
            gameState.isQuestionActive = false;
            const selectedBtn = event.target.closest('button');
            const selectedIndex = parseInt(selectedBtn.dataset.index);
            const { correctAnswerIndex, explanation } = gameState.currentQuestionData;
            
            elements.optionsContainer.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                if(parseInt(btn.dataset.index) === correctAnswerIndex) btn.classList.add('!border-green-500', '!text-green-400');
            });
            
            if (selectedIndex === correctAnswerIndex) {
                elements.gameFeedback.textContent = '✔️';
                elements.gameFeedback.className = 'text-center font-semibold my-4 h-12 animate-in feedback-correct';
                gameState.currentStage++;
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedBtn.classList.add('!border-red-500', '!text-red-400', 'opacity-70');
                elements.gameFeedback.textContent = '❌';
                elements.gameFeedback.className = 'text-center font-semibold my-4 h-12 animate-in feedback-incorrect';
                document.body.classList.add('shake-animation');
                setTimeout(() => document.body.classList.remove('shake-animation'), 500);
                setTimeout(() => { generateQuestion(); updateUI(); }, 3000);
            }
            if (explanation) {
                elements.questionExplanation.textContent = `توضیح: ${explanation}`;
                elements.questionExplanation.classList.remove('hidden');
            }
        }
        
        function validateAndSanitizeName(name, errorEl, inputEl) {
            const sanitized = name.replace(/[^a-zA-Z0-9_.-]/g, '');
            if (name !== sanitized) inputEl.value = sanitized;
            const trimmed = sanitized.trim();
            if (trimmed.length < 3) {
                errorEl.textContent = "نام باید حداقل ۳ کاراکتر باشد.";
                inputEl.classList.add('invalid');
                return null;
            }
            errorEl.textContent = '';
            inputEl.classList.remove('invalid');
            return trimmed;
        }

        function setupEventListeners() {
            elements.modalConfirmBtn.addEventListener('click', handleModalConfirm);
            elements.modalCancelBtn.addEventListener('click', handleModalCancel);

            elements.registerBtn.addEventListener('click', async () => {
                const validatedName = validateAndSanitizeName(elements.displayNameInput.value, elements.inputErrorMessage, elements.displayNameInput);
                if (!gameState.publicUserId) elements.userIdErrorMessage.textContent = "لطفاً ابتدا شناسه بسازید.";
                if (!validatedName || !gameState.publicUserId) return;
                gameState.displayName = validatedName;
                await saveUserData();
                updateUI();
            });

            elements.generateUserIdBtn.addEventListener('click', () => {
                gameState.publicUserId = Array(5).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]).join('');
                elements.userIdDisplayInput.value = gameState.publicUserId;
                elements.userIdErrorMessage.textContent = '';
            });

            elements.editNameBtn.addEventListener('click', () => showModal("تغییر نام", "تغییر نام رایگان است.", "تغییر", "لغو", async () => {
                 const newName = validateAndSanitizeName(elements.newDisplayNameInput.value, elements.changeNameErrorMessage, elements.newDisplayNameInput);
                 if (newName && newName !== gameState.displayName) {
                     gameState.displayName = newName;
                     await saveUserData(); updateUI(); hideModal();
                 }
            }, hideModal, "changeName"));

            if (!disableAvatarFeature) {
                elements.avatarContainer.addEventListener('click', () => showModal("تغییر آواتار", "", "انتخاب", "لغو", null, hideModal, "avatar"));
            }

            elements.startGameBtn.addEventListener('click', () => {
                if(!gameState.displayName) { showModal("ثبت نام لازم است", "ابتدا ثبت نام خود را کامل کنید.", "باشه"); return; }
                showScreen(elements.gameScreen);
                generateQuestion();
            });
            
            elements.mafiaFactBtn.addEventListener('click', async () => {
                showModal("دانستنی مافیا ✨", "در حال جستجو...", "باشه");
                const fact = await callGeminiAPI("یک حقیقت جالب و کوتاه (۲-۴ جمله) در مورد دنیای مافیا به زبان فارسی بگو.");
                if (fact) showModal("دانستنی مافیا ✨", fact, "جالب بود!");
            });
            
            elements.backToMainBtn.addEventListener('click', async () => { await saveUserData(); showScreen(elements.mainScreen); });
        }

        function initializeGame() {
            const ids = ["loading-screen", "loading-title-container", "loading-bar", "loading-message", "main-screen", "game-screen", "registration-form-container", "display-name-input", "register-btn", "input-error-message", "user-id-display", "generate-user-id-btn", "user-id-error-message", "user-profile-area", "avatar-container", "avatar-image", "user-info-box", "display-name-output", "public-user-id-output", "edit-name-btn", "main-screen-buttons-layout", "start-game-btn", "mafia-fact-btn", "dev-intro-icon-btn-header", "stage-display", "question-text", "options-container", "question-explanation", "back-to-main-btn", "game-feedback", "modal-container", "modal-title", "modal-message", "change-name-input-container", "new-display-name-input", "change-name-error-message", "avatar-generation-container", "modal-confirm-btn", "modal-cancel-btn"];
            const camelCase = s => s.replace(/-./g, x => x[1].toUpperCase());
            ids.forEach(id => elements[camelCase(id)] = document.getElementById(id));
            
            if (!navigator.onLine) {
                showModal("عدم اتصال", "لطفاً اتصال اینترنت خود را بررسی کنید.", "باشه");
                return;
            }
            
            // Start Loading Animation
            setTimeout(() => {
                elements.loadingScreen.classList.add('animate-in');
                elements.loadingBar.style.width = '70%'; // Simulate progress
                elements.loadingMessage.textContent = 'برقراری ارتباط با سرور...';
            }, 100);

            setupEventListeners();
            initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>