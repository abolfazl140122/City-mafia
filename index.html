<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بازی مافیا - نسخه کلش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME & CORE STYLES --- */
        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            from { opacity: 0; transform: scale(0.8) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes action-buttons-intro {
            from { opacity: 0; transform: scale(0.7) translateY(40px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }
        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- BASE STYLES & MOBILE-FIRST SETUP --- */
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Prevent scrolling on the body itself */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 150%; height: 150%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* --- SCREEN & LAYOUT MANAGEMENT --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh; /* Full viewport height */
            padding: 1rem;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; /* Allow scrolling within the screen */
            z-index: 1;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
        }
        .screen-content-wrapper {
            width: 100%;
            max-width: 900px; /* Increased max-width for desktop */
            margin: auto;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* --- UI COMPONENTS --- */
        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: relative;
        }
        .panel-clash::before, .panel-clash::after { /* Rivets */
            content: ''; position: absolute; width: 10px; height: 10px;
            background: var(--clash-gold); border-radius: 50%; border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000; top: 10px;
        }
        .panel-clash::before { left: 10px; }
        .panel-clash::after { right: 10px; }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
            visibility: hidden;
        }
        .panel-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
            animation: clash-panel-intro 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px; font-weight: bold; text-transform: uppercase;
            transition: all 0.1s ease-out; cursor: pointer; position: relative;
            white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
            color: var(--clash-text-dark); text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%); cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important; transform: translateY(0) !important;
        }

        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 12px 28px; font-size: 1.2rem;
        }
        .btn-clash-primary:hover:not(:disabled) {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px); box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active:not(:disabled) {
            transform: translateY(4px) !important; box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        #start-game-btn.breathing { animation: breathe 2.5s ease-in-out infinite; }
        
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 10px 20px; font-size: 1rem;
            color: var(--clash-text-light); text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .btn-clash-secondary:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px); box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active:not(:disabled) {
            transform: translateY(3px) !important; box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark); border: 2px solid #2a4166;
            color: #fff; border-radius: 10px; padding: 12px; font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4); text-align: center;
        }
        .input-clash::placeholder { color: #a0b8d8; }
        .input-clash:focus {
            outline: none; border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid { border-color: var(--clash-red); }
        .input-clash:read-only { background-color: #314a70; cursor: default; }

        .loader {
            border: 6px solid #3a5b8a; border-top: 6px solid var(--clash-gold);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }

        .error-message {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem;
            font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 5px 10px;
            border-radius: 6px; border: 1px solid var(--clash-red); transition: all 0.3s;
        }
        .hidden { display: none !important; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 4px; border: 1px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }


        /* --- MAIN SCREEN LAYOUT (Mobile First) --- */
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
        }
        #main-screen-header {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 0.5rem; margin-bottom: 1rem;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31; border-radius: 12px; border: 3px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
        }
        #main-title {
            text-align: center; flex-grow: 1; font-size: 2.8rem; /* Smaller for mobile */
            color: var(--clash-gold);
            text-shadow: -2px -2px 0 var(--clash-brown-dark), 2px -2px 0 var(--clash-brown-dark),
                         -2px 2px 0 var(--clash-brown-dark), 2px 2px 0 var(--clash-brown-dark),
                         4px 4px 6px rgba(0,0,0,0.6);
        }
        .header-icon-btn {
            background: var(--clash-blue-light); color: white; border: 2px solid var(--clash-panel-border-dark);
            padding: 0.5rem; border-radius: 50%; font-weight: bold; transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); display: inline-flex;
            align-items: center; justify-content: center; width: 44px; height: 44px; flex-shrink: 0;
        }
        .header-icon-btn:hover { background-color: #6c98d8; transform: scale(1.1); }
        .header-icon-btn svg { width: 22px; height: 22px; }

        #main-content-area {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; width: 100%; transition: all 0.5s ease;
        }
        #main-screen-buttons-layout {
            display: flex; flex-direction: column; align-items: center; gap: 1rem;
            width: 100%;
            animation: action-buttons-intro 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }

        /* --- GAME SCREEN LAYOUT --- */
        #game-screen .panel-clash { min-height: 180px; }
        #question-text { font-size: 1.1rem; line-height: 1.8; }
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8); border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185; color: white; transition: all 0.15s ease;
            font-size: 1rem; padding: 12px; border-radius: 12px; font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px); box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important; box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important; box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }
        
        /* --- POP-UPs & MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(10, 10, 10, 0.85);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 50;
        }
        .close-modal-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425; box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        .close-modal-btn:hover { transform: scale(1.1) rotate(90deg); }
        .close-modal-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        /* Developer & Leaderboard Panel Specifics */
        .list-panel-content {
            max-height: calc(80vh - 150px); overflow-y: auto; padding-right: 1rem;
        }
        .list-item {
            background-color: rgba(42, 65, 102, 0.9); padding: 1rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4); transition: all 0.2s ease;
        }
        .list-item:hover { background-color: rgba(60, 85, 122, 0.9); transform: scale(1.02); }

        /* Leaderboard Item Styles */
        .leaderboard-rank {
            font-family: 'Lilita One', cursive; font-size: 1.75rem; color: var(--clash-gold);
            -webkit-text-stroke: 1.5px var(--clash-brown-dark); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            width: 40px; text-align: center; flex-shrink: 0;
        }
        .leaderboard-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid var(--clash-gold-dark); object-fit: cover;
            background-color: #2a4166; flex-shrink: 0;
        }
        .leaderboard-name {
            font-family: 'Lilita One', cursive; font-size: 1.2rem; color: #ffffff;
            text-shadow: 1px 1px 2px #000;
        }
        .leaderboard-stage-value {
            color: var(--clash-gold); font-family: 'Lilita One', cursive;
            font-size: 1.1em; margin-right: 4px;
        }
        
        /* User Profile Panel (New) */
        #user-profile-panel .user-info-item {
            background-color: rgba(60,40,30,0.7); padding: 0.75rem 1rem; border-radius: 8px;
            border: 1px solid #4a2f20;
        }
        #user-profile-panel .label { font-size: 0.9em; color: #f0d5bf; }
        #user-profile-panel .value { font-size: 1.1em; font-weight: bold; }
        #main-avatar-display {
            width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 1rem;
            border: 5px solid; border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; overflow: hidden; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        #main-avatar-image { width: 100%; height: 100%; object-fit: cover; }
        #edit-name-btn { cursor: pointer; color: var(--clash-gold); transition: color 0.3s ease; font-size: 1.2rem; }
        #edit-name-btn:hover { color: #fff8a8; }
        
        /* Avatar Upload UI in Modal */
        #avatar-preview-container {
            margin: 1rem auto; width: 120px; height: 120px; border-radius: 50%;
            border: 4px solid var(--clash-gold); overflow: hidden; background-color: var(--clash-panel-border-dark);
            display: flex; align-items: center; justify-content: center;
        }
        #avatar-preview-image { width: 100%; height: 100%; object-fit: cover; }
        #avatar-upload-progress-container {
            width: 90%; margin: 1rem auto 0; background-color: var(--clash-panel-border-dark);
            border-radius: 8px; padding: 4px; border: 1px solid var(--clash-panel-border);
        }
        #avatar-upload-progress-bar {
            width: 0%; height: 12px; background-color: var(--clash-green);
            border-radius: 5px; transition: width 0.3s ease;
        }

        /* --- RESPONSIVE DESIGN (for Tablets & Desktops) --- */
        @media (min-width: 640px) {
            .screen { padding: 1.5rem; }
            #main-title { font-size: 4rem; }
            #question-text { font-size: 1.5rem; }
            .option-btn { font-size: 1.1rem; padding: 14px; }
        }

        @media (min-width: 768px) {
            #main-title { font-size: 5rem; }
            #game-screen .options-container { grid-template-columns: repeat(2, 1fr); }
        }

    </style>
</head>
<body>

    <!-- Loading Screen (No change needed) -->
    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center items-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">بارگذاری بازی...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">در حال بررسی اتصال...</p>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <!-- Header -->
            <header id="main-screen-header">
                <button id="leaderboard-icon-btn-header" class="header-icon-btn" title="رتبه‌بندی">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 5v6.09c0 4.67 3.41 8.94 8 10.91c4.59-1.97 8-6.24 8-10.91V5l-8-3z"/></svg>
                </button>
                <h1 id="main-title" class="clash-font">شهر مافیا</h1>
                <button id="profile-icon-btn-header" class="header-icon-btn hidden" title="پروفایل کاربری">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                </button>
            </header>

            <!-- Main Content Area (Registration or Game Buttons) -->
            <main id="main-content-area" class="py-4">
                <div id="registration-form" class="panel-clash panel-visible p-4 sm:p-6 w-full max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ورود به شهر</h2>
                    <div class="space-y-3">
                        <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-clash w-full clash-font" maxlength="20">
                        <input type="text" id="user-id-display" class="input-clash w-full" readonly placeholder="شناسه ساخته می‌شود...">
                    </div>
                    <p id="input-error-message" class="error-message hidden"></p>
                    <button id="register-btn" class="btn-clash btn-clash-primary w-full mt-4 clash-font">ورود</button>
                </div>

                <div id="main-screen-buttons-layout" class="hidden">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">شروع بازی</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font">دانستنی‌ها ✨</button>
                </div>
            </main>

            <!-- Footer -->
            <footer class="text-center py-2">
                <button id="dev-intro-btn-footer" class="text-gray-400 hover:text-white transition-colors duration-300">
                    سازندگان بازی
                </button>
            </footer>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper">
            <div class="flex justify-between items-center mb-4 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">بازگشت</button>
                <div class="font-bold">مرحله: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 flex-grow flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-2 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center my-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold mt-2">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <!-- Generic Modal Container -->
    <div id="modal-container" class="modal-overlay panel-hidden">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md w-full text-center relative">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <!-- Name Change UI -->
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="error-message hidden"></p>
                </div>
                <!-- Avatar Upload UI -->
                <div id="avatar-upload-ui-container" class="hidden">
                    <input type="file" id="avatar-file-input" class="hidden" accept="image/png, image/jpeg, image/gif">
                    <button id="select-avatar-file-btn" class="btn-clash btn-clash-secondary my-4 clash-font">انتخاب فایل</button>
                    <div id="avatar-preview-container" class="hidden"><img id="avatar-preview-image" src="#"></div>
                    <div id="avatar-upload-progress-container" class="hidden">
                        <div id="avatar-upload-progress-bar"></div>
                        <p id="avatar-upload-status"></p>
                    </div>
                    <p id="avatar-error-message" class="error-message hidden"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">تایید</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">لغو</button>
            </div>
        </div>
    </div>
    
    <!-- User Profile Panel -->
    <div id="user-profile-panel-container" class="modal-overlay panel-hidden z-[51]">
        <div id="user-profile-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-md w-full relative">
            <button class="close-modal-btn" data-target="user-profile-panel-container">×</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-4 text-center clash-font text-[var(--clash-gold)]">پروفایل کاربری</h3>
            <div id="main-avatar-display">
                <img id="main-avatar-image" src="https://placehold.co/100x100/333333/777777?text=?" alt="آواتار کاربر">
            </div>
            <div class="space-y-3 text-center">
                 <div class="user-info-item">
                    <div class="label flex items-center justify-center gap-2"><span>بازیکن:</span><span id="edit-name-btn" title="تغییر نام">✏️</span></div>
                    <div id="display-name-output" class="value clash-font text-xl text-yellow-300"></div>
                </div>
                 <div class="user-info-item">
                    <div class="label">شناسه:</div>
                    <div id="public-user-id-output" class="value font-mono text-gray-300"></div>
                </div>
                <button id="change-avatar-btn" class="btn-clash btn-clash-secondary w-full mt-2">تغییر آواتار</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="modal-overlay panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg w-full relative">
            <button class="close-modal-btn" data-target="developers-panel-container">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-6 text-center clash-font text-[var(--clash-gold)]">سازندگان شهر مافیا</h3>
            <div class="list-panel-content space-y-4 text-right pr-3 pl-1">
                <!-- Developer items -->
            </div>
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div id="leaderboard-panel-container" class="modal-overlay panel-hidden z-[51]">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg w-full relative">
            <button class="close-modal-btn" data-target="leaderboard-panel-container">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-6 text-center clash-font text-[var(--clash-gold)]">کاربران برتر شهر</h3>
            <div id="leaderboard-list" class="list-panel-content space-y-2">
                <!-- Leaderboard items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        // --- JAVASCRIPT LOGIC (REFACTORED FOR MOBILE-FIRST & STABILITY) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // =================================================================================
        // ⚠️ CRITICAL SECURITY WARNING ⚠️
        // =================================================================================
        // NEVER expose your API keys in client-side code like this. 
        // Anyone can view your source code and steal these keys.
        // For services like Google Gemini, you MUST use a backend server or a
        // Cloud Function to make the API call securely.
        // I have replaced your key with a placeholder.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_GOES_HERE"; // <-- DO NOT HARDCODE YOUR REAL KEY HERE
        
        // This is your Firebase configuration. It is generally safe to expose this,
        // but make sure your Firestore/Storage security rules are properly configured.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY_GOES_HERE", // <-- Replace with your actual Firebase API Key
            authDomain: "city-mafia.firebaseapp.com",
            projectId: "city-mafia",
            storageBucket: "city-mafia.appspot.com", 
            messagingSenderId: "66458127103",
            appId: "1:66458127103:web:8bcc2ad470f51b5db45aca"
        };
        // =================================================================================
        
        // --- GLOBAL STATE & INSTANCES ---
        let app, auth, db, storage;
        let currentUserId = null;
        let isAuthReady = false;
        const appId = 'mafia-game-default'; // Unique ID for this game instance

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
        };

        // --- DOM ELEMENT CACHE ---
        const DOM = {};

        // --- AUDIO MANAGER ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');
                Object.values(this.sounds).forEach(s => s && (s.volume = 0.4));
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };

        // --- UTILITY FUNCTIONS ---
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }

        function generateAlphanumericPublicUserId(length = 5) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- UI & SCREEN MANAGEMENT ---
        function showScreen(screenElement) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            screenElement.scrollTop = 0;
            updateUI();
        }
        
        function updateUI() {
            const isLoggedIn = isAuthReady && gameState.displayName && gameState.publicUserId;

            // Update user info displays
            DOM.displayNameOutput.textContent = gameState.displayName || "مهمان";
            DOM.publicUserIdOutput.textContent = gameState.publicUserId || "---";
            DOM.stageDisplay.textContent = gameState.currentStage;
            DOM.mainAvatarImage.src = gameState.avatarUrl || `https://placehold.co/100x100/333/777?text=?`;

            // Main screen layout logic
            if (DOM.mainScreen.classList.contains('active')) {
                if (isLoggedIn) {
                    DOM.registrationForm.classList.add('panel-hidden');
                    DOM.mainScreenButtonsLayout.classList.remove('hidden');
                    DOM.startGameBtn.classList.add('breathing');
                    DOM.profileIconBtnHeader.classList.remove('hidden');
                } else {
                    DOM.registrationForm.classList.remove('panel-hidden');
                    DOM.mainScreenButtonsLayout.classList.add('hidden');
                    DOM.startGameBtn.classList.remove('breathing');
                    DOM.profileIconBtnHeader.classList.add('hidden');
                }
            }
        }

        function showPanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelOpen');
            panelContainer.classList.remove('panel-hidden');
            const panel = panelContainer.querySelector('.panel-clash');
            if (panel) {
                panel.classList.remove('panel-visible');
                void panel.offsetWidth; // Force reflow for animation
                panel.classList.add('panel-visible');
            }
        }

        function hidePanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelClose');
            panelContainer.classList.add('panel-hidden');
            const panel = panelContainer.querySelector('.panel-clash');
            if (panel) panel.classList.remove('panel-visible');
        }

        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function showModal(config) {
            const { title, message, confirmText = "تایید", cancelText = "لغو", onConfirm, onCancel, type = "generic" } = config;
            
            showPanel(DOM.modalContainer);
            
            DOM.modalTitle.textContent = title;
            DOM.modalMessage.innerHTML = message || "";
            DOM.modalMessage.classList.toggle('hidden', !message);
            
            DOM.changeNameInputContainer.classList.add('hidden');
            DOM.avatarUploadUiContainer.classList.add('hidden');

            if (type === "changeName") {
                DOM.changeNameInputContainer.classList.remove('hidden');
                DOM.newDisplayNameInput.value = gameState.displayName;
                DOM.changeNameErrorMessage.classList.add('hidden');
                DOM.newDisplayNameInput.classList.remove('invalid');
            } else if (type === "avatar") {
                DOM.avatarUploadUiContainer.classList.remove('hidden');
                // Reset avatar UI
                DOM.avatarPreviewContainer.classList.add('hidden');
                DOM.avatarUploadProgressContainer.classList.add('hidden');
                DOM.avatarErrorMessage.classList.add('hidden');
                DOM.avatarFileInput.value = '';
                DOM.modalConfirmBtn.disabled = true;
            }

            DOM.modalConfirmBtn.textContent = confirmText;
            DOM.modalCancelBtn.textContent = cancelText;
            DOM.modalCancelBtn.classList.toggle('hidden', !onCancel && type !== 'changeName' && type !== 'avatar');

            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel || (() => hidePanel(DOM.modalContainer));
        }
        
        // --- FIREBASE & DATA HANDLING ---
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        await signInAnonymously(auth);
                        Object.assign(gameState, { displayName: '', publicUserId: '', avatarUrl: '', seenQuestionHashes: new Set() });
                    }
                    isAuthReady = true;
                    updateUI();

                    if (DOM.loadingScreen.classList.contains('active')) {
                        DOM.loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => showScreen(DOM.mainScreen), 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                DOM.loadingMessage.textContent = "خطا در اتصال به سرور.";
            }
        }
        
        async function loadUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(gameState, {
                        displayName: data.displayName || "",
                        publicUserId: data.publicUserId || "",
                        currentStage: data.currentStage || 1,
                        avatarUrl: data.avatarUrl || '',
                        seenQuestionHashes: new Set(data.seenQuestionHashes || [])
                    });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db || !gameState.displayName) return;
            
            const privateData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                lastUpdated: serverTimestamp()
            };
            const publicData = {
                displayName: gameState.displayName,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                lastUpdated: serverTimestamp()
            };

            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const leaderboardDocRef = doc(db, `artifacts/${appId}/publicLeaderboard/${currentUserId}`);

            try {
                await Promise.all([
                    setDoc(userDocRef, privateData, { merge: true }),
                    setDoc(leaderboardDocRef, publicData, { merge: true })
                ]);
                console.log("User data saved.");
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }

        // --- API CALLS (GEMINI) ---
        async function callGeminiAPI(prompt, isJsonOutput = false) {
             if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_GOES_HERE") {
                showModal({
                    title: "خطای پیکربندی",
                    message: "کلید API برای سرویس هوش مصنوعی تنظیم نشده است. لطفاً با توسعه‌دهنده تماس بگیرید.",
                    onConfirm: () => hidePanel(DOM.modalContainer)
                });
                return null;
            }
            DOM.aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJsonOutput) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("پاسخ نامعتبر از API");
                return isJsonOutput ? JSON.parse(text) : text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                 showModal({
                    title: "خطای هوش مصنوعی",
                    message: `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن VPN/فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.<br><small>(${error.message})</small>`,
                    onConfirm: () => hidePanel(DOM.modalContainer)
                });
                return null;
            } finally {
                DOM.aiThinkingIndicator.classList.add('hidden');
            }
        }
        
        // --- GAME LOGIC ---
        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            DOM.questionText.textContent = "در حال تولید سوال جدید و غیرتکراری...";
            DOM.optionsContainer.innerHTML = "";
            DOM.questionExplanation.classList.add('hidden');
            DOM.gameFeedback.textContent = "";

            let questionData = null;
            for (let i = 0; i < 3; i++) { // Max 3 retries
                const difficulty = gameState.currentStage > 10 ? "سخت" : (gameState.currentStage > 5 ? "متوسط" : "آسان");
                const prompt = `یک سوال 4 گزینه‌ای به زبان فارسی با موضوع مافیا (تاریخچه، فیلم، اصطلاحات) با سطح دشواری "${difficulty}" برای مرحله ${gameState.currentStage} طراحی کن. سوال نباید کلیشه‌ای باشد. خروجی فقط یک JSON با این ساختار باشد: {"question": "...", "options": ["...", "...", "...", "..."], "correctAnswerIndex": 0, "explanation": "..."}`;
                
                const data = await callGeminiAPI(prompt, true);
                if (data?.question) {
                    const hash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(hash)) {
                        questionData = data;
                        break;
                    }
                }
            }

            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                 showModal({
                    title: "خطا در تولید سوال",
                    message: "متاسفانه نتوانستیم سوال جدیدی بسازیم. آیا می‌خواهید دوباره تلاش کنید؟",
                    onConfirm: () => { hidePanel(DOM.modalContainer); generateQuestion(); },
                    onCancel: () => { hidePanel(DOM.modalContainer); showScreen(DOM.mainScreen); }
                });
            }
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            const { question, options } = gameState.currentQuestionData;
            DOM.questionText.textContent = question;
            DOM.optionsContainer.innerHTML = options.map((option, index) => 
                `<button class="option-btn" data-index="${index}">${index + 1}. ${option}</button>`
            ).join('');
            DOM.optionsContainer.querySelectorAll('.option-btn').forEach(btn => 
                btn.addEventListener('click', handleAnswerSelection)
            );
            gameState.isQuestionActive = true;
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive) return;
            gameState.isQuestionActive = false;

            const selectedBtn = event.target.closest('.option-btn');
            const selectedIndex = parseInt(selectedBtn.dataset.index);
            const { question, correctAnswerIndex, explanation } = gameState.currentQuestionData;
            
            DOM.optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            if (selectedIndex === correctAnswerIndex) {
                audioManager.play('correct');
                selectedBtn.classList.add('correct');
                DOM.gameFeedback.textContent = "پاسخ صحیح!";
                DOM.gameFeedback.className = 'text-center text-lg font-semibold my-2 h-8 clash-font text-green-400';
                
                gameState.seenQuestionHashes.add(simpleHash(question));
                gameState.currentStage++;
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                audioManager.play('incorrect');
                selectedBtn.classList.add('incorrect');
                DOM.optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`)?.classList.add('correct');
                DOM.gameFeedback.textContent = "پاسخ اشتباه!";
                DOM.gameFeedback.className = 'text-center text-lg font-semibold my-2 h-8 clash-font text-red-400';
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            
            if (explanation) {
                DOM.questionExplanation.textContent = `توضیح: ${explanation}`;
                DOM.questionExplanation.classList.remove('hidden');
            }
        }
        
        // --- EVENT HANDLERS & SETUP ---
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });

            // Registration
            DOM.displayNameInput.addEventListener('input', () => {
                validateAndSanitizeName(DOM.displayNameInput, DOM.inputErrorMessage);
                if (DOM.displayNameInput.value.length > 2 && !DOM.userIdDisplay.value) {
                    const newId = generateAlphanumericPublicUserId();
                    DOM.userIdDisplay.value = newId;
                    gameState.publicUserId = newId;
                }
            });
            DOM.registerBtn.addEventListener('click', handleRegistration);

            // Modals & Panels
            DOM.modalConfirmBtn.addEventListener('click', () => modalConfirmCallback?.());
            DOM.modalCancelBtn.addEventListener('click', () => modalCancelCallback?.());
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => hidePanel(document.getElementById(btn.dataset.target)));
            });

            // Header & Footer Buttons
            DOM.leaderboardIconBtnHeader.addEventListener('click', showLeaderboardPanel);
            DOM.profileIconBtnHeader.addEventListener('click', () => showPanel(DOM.userProfilePanelContainer));
            DOM.devIntroBtnFooter.addEventListener('click', showDevelopersPanel);

            // User Profile Actions
            DOM.editNameBtn.addEventListener('click', () => {
                hidePanel(DOM.userProfilePanelContainer);
                showModal({
                    title: "تغییر نام",
                    message: "نام نمایشی جدید خود را وارد کنید.",
                    onConfirm: handleChangeDisplayName,
                    onCancel: () => hidePanel(DOM.modalContainer),
                    type: "changeName"
                });
            });
            DOM.changeAvatarBtn.addEventListener('click', () => {
                hidePanel(DOM.userProfilePanelContainer);
                showModal({
                    title: "تغییر آواتار",
                    message: "یک تصویر برای آواتار خود انتخاب کنید (حداکثر 5MB).",
                    confirmText: "آپلود",
                    onConfirm: handleAvatarUpload,
                    onCancel: () => hidePanel(DOM.modalContainer),
                    type: "avatar"
                });
            });
            DOM.selectAvatarFileBtn.addEventListener('click', () => DOM.avatarFileInput.click());
            DOM.avatarFileInput.addEventListener('change', handleAvatarFileSelection);

            // Main Action Buttons
            DOM.startGameBtn.addEventListener('click', handleStartGame);
            DOM.mafiaFactBtn.addEventListener('click', generateMafiaFact);
            DOM.backToMainBtn.addEventListener('click', () => showScreen(DOM.mainScreen));
            
            // Game Screen
            DOM.optionsContainer.addEventListener('click', e => {
                if (e.target.classList.contains('option-btn')) handleAnswerSelection(e);
            });

            // Save data on exit
            window.addEventListener('beforeunload', () => { if (isAuthReady && gameState.displayName) saveUserData(); });
        }
        
        function validateAndSanitizeName(inputEl, errorEl) {
            inputEl.value = inputEl.value.replace(/[^a-zA-Z0-9_.-]/g, '');
            const name = inputEl.value.trim();
            if (name.length > 2 && name.length <= 20) {
                errorEl.classList.add('hidden');
                inputEl.classList.remove('invalid');
                return name;
            }
            errorEl.textContent = "نام باید بین ۳ تا ۲۰ کاراکتر انگلیسی باشد.";
            errorEl.classList.remove('hidden');
            inputEl.classList.add('invalid');
            return null;
        }

        async function handleRegistration() {
            const name = validateAndSanitizeName(DOM.displayNameInput, DOM.inputErrorMessage);
            if (name && gameState.publicUserId) {
                gameState.displayName = name;
                await saveUserData();
                updateUI();
            } else if (!name) {
                DOM.displayNameInput.focus();
            }
        }
        
        async function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(DOM.newDisplayNameInput, DOM.changeNameErrorMessage);
            if (newName && newName !== gameState.displayName) {
                gameState.displayName = newName;
                await saveUserData();
                updateUI();
                hidePanel(DOM.modalContainer);
            } else if (newName === gameState.displayName) {
                DOM.changeNameErrorMessage.textContent = "نام جدید باید متفاوت باشد.";
                DOM.changeNameErrorMessage.classList.remove('hidden');
            }
        }
        
        let selectedAvatarFile = null;
        function handleAvatarFileSelection(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                DOM.avatarErrorMessage.textContent = 'حجم فایل نباید بیشتر از 5 مگابایت باشد.';
                DOM.avatarErrorMessage.classList.remove('hidden');
                return;
            }
            selectedAvatarFile = file;
            DOM.avatarPreviewImage.src = URL.createObjectURL(file);
            DOM.avatarPreviewContainer.classList.remove('hidden');
            DOM.modalConfirmBtn.disabled = false;
        }

        async function handleAvatarUpload() {
            if (!selectedAvatarFile || !currentUserId) return;
            DOM.modalConfirmBtn.disabled = true;
            DOM.selectAvatarFileBtn.disabled = true;
            DOM.avatarUploadProgressContainer.classList.remove('hidden');

            try {
                const filePath = `artifacts/${appId}/user_avatars/${currentUserId}.jpg`;
                const storageRef = ref(storage, filePath);
                const uploadTask = uploadBytesResumable(storageRef, selectedAvatarFile);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        DOM.avatarUploadProgressBar.style.width = `${progress}%`;
                        DOM.avatarUploadStatus.textContent = `درحال آپلود: ${Math.round(progress)}%`;
                    }, 
                    (error) => { throw error; }, 
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        gameState.avatarUrl = downloadURL;
                        await saveUserData();
                        updateUI();
                        hidePanel(DOM.modalContainer);
                    }
                );
            } catch (error) {
                console.error("Avatar Upload Error:", error);
                DOM.avatarErrorMessage.textContent = "خطا در آپلود تصویر.";
                DOM.avatarErrorMessage.classList.remove('hidden');
                DOM.modalConfirmBtn.disabled = false;
                DOM.selectAvatarFileBtn.disabled = false;
            }
        }

        function handleStartGame() {
            audioManager.play('startGame');
            showModal({
                title: "شروع بازی",
                message: "برای بهترین تجربه، از اینترنت پایدار استفاده کنید. آماده‌ای؟",
                onConfirm: () => {
                    hidePanel(DOM.modalContainer);
                    showScreen(DOM.gameScreen);
                    generateQuestion();
                },
                onCancel: () => hidePanel(DOM.modalContainer)
            });
        }
        
        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب و کوتاه (۲-۳ جمله) در مورد دنیای مافیا به زبان فارسی بگو.";
            showModal({
                title: "دانستنی مافیا ✨",
                message: "<div class='loader mx-auto my-3'></div><p>در حال جستجو...</p>",
                onConfirm: () => hidePanel(DOM.modalContainer)
            });
            const fact = await callGeminiAPI(prompt);
            if (fact) {
                DOM.modalMessage.innerHTML = fact.replace(/\n/g, '<br>');
            } else {
                DOM.modalMessage.textContent = "متاسفانه نکته‌ای یافت نشد.";
            }
        }
        
        function populateStaticPanels() {
             const developers = [
                { role: 'برنامه نویس ارشد', name: 'abolfazl1401', desc: 'معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی.' },
                { role: 'طراح گرافیک (UI/UX)', name: 'Vahid', desc: 'خالق هویت بصری جذاب و تم مافیایی بازی.' },
                { role: 'ایده پرداز', name: 'Ali.k', desc: 'خالق ایده‌های نوآورانه برای مراحل و چالش‌ها.' },
                { role: 'توسعه دهنده سرور', name: 'Neda_Tech', desc: 'متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور.'},
                { role: 'توسعه دهنده سرور', name: 'SinaCloud', desc: 'مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده.'},
                { role: 'توسعه دهنده سرور (DevOps)', name: 'ParsaDevOps', desc: 'متمرکز بر فرآیندهای استقرار خودکار و مانیتورینگ.'},
            ];
            const devContainer = DOM.developersPanel.querySelector('.list-panel-content');
            devContainer.innerHTML = developers.map(dev => `
                <div class="list-item">
                    <h4 class="font-bold text-lg text-white">${dev.role}</h4>
                    <p class="clash-font text-yellow-300 text-xl my-1">${dev.name}</p>
                    <p class="text-sm text-gray-300">${dev.desc}</p>
                </div>
            `).join('');
        }

        async function showDevelopersPanel() {
            showPanel(DOM.developersPanelContainer);
        }

        async function showLeaderboardPanel() {
            showPanel(DOM.leaderboardPanelContainer);
            DOM.leaderboardList.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div><p class="mt-3 font-bold">در حال بارگذاری...</p></div>`;
            try {
                const q = query(collection(db, `artifacts/${appId}/publicLeaderboard`), orderBy("currentStage", "desc"), limit(50));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    DOM.leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-gray-300">هنوز کسی در لیست برترین‌ها نیست!</p>`;
                    return;
                }
                const users = snapshot.docs.map(doc => doc.data());
                DOM.leaderboardList.innerHTML = users.map((user, index) => `
                    <div class="list-item flex items-center gap-4">
                        <span class="leaderboard-rank">${index + 1}</span>
                        <img src="${user.avatarUrl || 'https://placehold.co/50x50/2a4166/fff?text=?'}" alt="Avatar" class="leaderboard-avatar">
                        <div class="flex-grow">
                            <div class="leaderboard-name">${user.displayName || "بی‌نام"}</div>
                            <div class="text-sm text-gray-300">مرحله: <span class="leaderboard-stage-value">${user.currentStage || 1}</span></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error("Leaderboard fetch error:", error);
                DOM.leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-red-300">خطا در دریافت اطلاعات.</p>`;
            }
        }
        
        // --- INITIALIZATION ---
        function initializeGame() {
            // Cache all DOM elements
            const ids = [
                'loading-screen', 'loading-message', 'main-screen', 'game-screen',
                'main-screen-header', 'main-title', 'profile-icon-btn-header',
                'main-content-area', 'registration-form', 'display-name-input',
                'user-id-display', 'input-error-message', 'register-btn',
                'main-screen-buttons-layout', 'start-game-btn', 'mafia-fact-btn', 'dev-intro-btn-footer',
                'back-to-main-btn', 'stage-display', 'question-container', 'question-text',
                'options-container', 'question-explanation', 'game-feedback', 'ai-thinking-indicator',
                'modal-container', 'modal-title', 'modal-content-dynamic', 'modal-message',
                'change-name-input-container', 'new-display-name-input', 'change-name-error-message',
                'avatar-upload-ui-container', 'avatar-file-input', 'select-avatar-file-btn',
                'avatar-preview-container', 'avatar-preview-image', 'avatar-upload-progress-container',
                'avatar-upload-progress-bar', 'avatar-upload-status', 'avatar-error-message',
                'modal-actions', 'modal-confirm-btn', 'modal-cancel-btn',
                'user-profile-panel-container', 'user-profile-panel', 'main-avatar-display', 'main-avatar-image',
                'display-name-output', 'public-user-id-output', 'edit-name-btn', 'change-avatar-btn',
                'developers-panel-container', 'developers-panel',
                'leaderboard-panel-container', 'leaderboard-panel', 'leaderboard-list', 'leaderboard-icon-btn-header'
            ];
            ids.forEach(id => DOM[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id));

            audioManager.init();
            populateStaticPanels();
            setupEventListeners();
            initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>
