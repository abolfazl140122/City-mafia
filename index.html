<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - نسخه سینمایی</title>
    
    <!-- کتابخانه‌های گرافیکی و انیمیشن -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <!-- کتابخانه Three.js برای پس‌زمینه سه‌بعدی -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
      }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e0e0e0;
            overflow: hidden; /* جلوگیری از اسکرول کلی صفحه */
            background-color: #0a0a0a; /* رنگ پایه برای مواقعی که گرادیان لود نشده */
        }

        /* ----- پس‌زمینه جدید ----- */
        .mafia-animated-bg {
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
        }

        #three-js-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; /* بین گرادیان و محتوا قرار می‌گیرد */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ----- استایل شیشه‌ای (Glassmorphism) برای پنل‌ها ----- */
        .panel {
            background-color: rgba(30, 30, 30, 0.65); /* نیمه‌شفاف */
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            border: 1px solid rgba(196, 151, 48, 0.5); /* طلایی نیمه‌شفاف */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            /* Transition‌ها حذف و به GSAP منتقل می‌شوند */
        }

        /* ----- کلاس‌های کنترلی GSAP ----- */
        .g-hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* دکمه‌ها و ورودی‌ها (با کمی بهبود برای تم جدید) */
        .btn-mafia {
            background-color: #c49730;
            color: #1a1a1a;
            border: 2px solid transparent;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), inset 0px -2px 2px rgba(0,0,0,0.2);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .btn-mafia:hover {
            background-color: #d4a840;
            box-shadow: 0 6px 12px rgba(196, 151, 48, 0.3), inset 0px -2px 2px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .btn-mafia:disabled {
            background-color: #7e6a3b;
            color: #524425;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-mafia-secondary {
            background-color: rgba(74, 74, 74, 0.5);
            backdrop-filter: blur(5px);
            color: #e0e0e0;
            border: 1px solid #c49730;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
        }
        .btn-mafia-secondary:hover {
            background-color: rgba(89, 89, 89, 0.7);
            color: #c49730;
        }
        
        .input-mafia {
            background-color: rgba(30,30,30, 0.8);
            border: 1px solid #c49730;
            color: #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            transition: box-shadow 0.3s ease;
        }
        .input-mafia:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(200, 150, 50, 0.7);
        }

        .option-btn {
            background-color: rgba(50, 50, 50, 0.7);
            border: 1px solid rgba(196, 151, 48, 0.6);
            color: #e0e0e0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1rem;
            padding: 12px;
        }
        .option-btn:hover {
            background-color: rgba(70, 70, 70, 0.9);
            transform: scale(1.02);
            border-color: #c49730;
        }
        .option-btn.correct { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        .option-btn.incorrect { background-color: #dc3545 !important; border-color: #b02a37 !important; color: white !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .loader {
            border: 8px solid #444;
            border-top: 8px solid #c49730;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* کلاس‌های قبلی visibility حذف و با GSAP کنترل می‌شوند */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh; /* تغییر به vh برای انیمیشن‌های بهتر */
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 1;
        }
        
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin: auto; /* برای وسط‌چین بودن */
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: center; /* پیش‌فرض برای وسط‌چین کردن محتوا */
        }

        #main-screen .screen-content-wrapper {
            justify-content: space-between;
        }

        /* بقیه استایل‌ها (بدون تغییر زیاد) ... */
        #user-profile-area { position: fixed; z-index: 100; display: flex; align-items: flex-start; gap: 10px; transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @media (max-width: 767px) { #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); } #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); } }
        @media (min-width: 768px) { #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; } #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); } }
        #user-info-box { background-color: rgba(15, 15, 15, 0.85); backdrop-filter: blur(8px); border: 1px solid #c49730; border-radius: 10px; padding: 8px 10px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7); display: flex; flex-direction: row; align-items: center; gap: 8px; width: max-content; min-width: 0; }
        @media (min-width: 768px) { #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; border-width: 2px; border-radius: 12px; padding: 12px 15px; min-width: 180px; max-width: 200px; width: auto; } }
        /* ... سایر استایل‌های جزئی ... */

        /* ----- استایل برای انیمیشن Lottie ----- */
        #game-feedback {
            position: relative;
        }
        #lottie-success {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1.5);
            width: 150px;
            height: 150px;
            pointer-events: none;
        }
        
    </style>
</head>
<body>

    <!-- Canvas برای پس‌زمینه سه بعدی -->
    <canvas id="three-js-bg"></canvas>
    
    <div class="mafia-animated-bg"></div>

    <!-- صداهای بازی -->
    <audio id="click-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-modern-click-box-check-1120.mp3" preload="auto"></audio>
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-success-alert-2039.mp3" preload="auto"></audio>
    <audio id="error-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
    <audio id="transition-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-air-woosh-2337.mp3" preload="auto"></audio>
    <audio id="startup-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-dramatic-orchestra-hit-01-482.mp3" preload="auto"></audio>

    <!-- محتوای HTML بازی (تقریبا بدون تغییر) -->
    <div id="user-profile-area" class="hidden">...</div>
    <div id="loading-screen" class="screen active">...</div>
    <div id="main-screen" class="screen g-hidden">...</div>
    <div id="game-screen" class="screen g-hidden">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-2 sm:p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-sm sm:text-base md:text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">بازگشت ⟵</button>
                <div>مرحله: <span id="stage-display" class="font-bold text-[#c49730]">1</span></div>
            </div>
            <div id="question-container" class="panel p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                <p id="question-explanation" class="text-xs sm:text-sm mt-4 text-gray-400 text-center hidden"></p>
            </div>
            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-12">
                <div id="lottie-success" class="hidden"></div>
                <span id="feedback-text"></span>
            </div>
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">...</div>
        </div>
    </div>
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 g-hidden z-50">...</div>
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 g-hidden z-[51]">...</div>
    
    <!-- کد HTML بالا برای کوتاهی خلاصه شده، کد کامل خودتان را در اینجا قرار دهید -->
    <!-- START of your provided HTML content (abbreviated here) -->
    <div id="user-profile-area" class="hidden"> <div id="avatar-container" class="hidden" title="تغییر آواتار"> <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'"> </div> <div id="user-info-box" class="hidden"> <div id="display-name-output-box" class="user-info-item"> <div class="label">بازیکن:</div> <div id="display-name-output-container"> <span id="edit-name-btn" title="تغییر نام">✏️</span> <div id="display-name-output" class="value"></div> </div> </div> <div id="public-user-id-output-box" class="user-info-item"> <div class="label">شناسه کاربری:</div> <div id="public-user-id-output" class="value"></div> </div> </div> </div>
    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center"> <div class="screen-content-wrapper justify-center"> <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-[#c49730]">بارگذاری بازی مافیا...</h1> <div class="loader mb-4"></div> <p id="loading-message" class="text-lg sm:text-xl">در حال بررسی اتصال...</p> </div> </div>
    <div id="main-screen" class="screen g-hidden"> <div class="screen-content-wrapper"> <div> <div id="main-screen-header"> <button id="dev-intro-icon-btn-header" title="معرفی توسعه دهندگان"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path> <circle cx="9" cy="7" r="4"></circle> <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path> <path d="M17 3.13a4 4 0 0 1 0 7.75"></path> </svg> </button> <h1 id="main-title">شهر مافیا</h1> <div style="width: 40px; flex-shrink: 0;"></div> </div> <div id="registration-form" class="mb-4 panel p-6 rounded-lg max-w-md mx-auto"> <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center text-[#c49730]">ثبت نام / ورود</h2> <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1 p-3 text-lg" maxlength="20"> <p id="input-error-message" class=""></p> <div class="mt-3 mb-2"> <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-1">شناسه کاربری (5 رقمی):</label> <div class="flex items-center gap-2"> <input type="text" id="user-id-display" class="input-mafia w-full p-3 text-lg text-center" readonly placeholder="ابتدا بسازید"> <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-4 py-3 text-sm">ساخت شناسه</button> </div> <p id="user-id-error-message" class=""></p> </div> <button id="register-btn" class="btn-mafia w-full p-3 text-lg mt-3">ورود به شهر</button> </div> </div> <div id="main-screen-buttons-layout" class="pb-4 hidden"> <div id="top-action-buttons" class="flex justify-center gap-4"> <button id="start-game-btn" class="btn-mafia">شروع بازی آنلاین</button> <button id="mafia-fact-btn" class="btn-mafia" style="order: 1;">دانستنی‌های مافیا ✨</button> </div> </div> </div> </div>
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 g-hidden z-50"> <div class="panel p-8 rounded-lg max-w-lg w-full text-center"> <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#c49730]">توجه</h3> <div id="modal-content-dynamic"> <p id="modal-message" class="mb-3 text-base"></p> <div id="change-name-input-container" class="hidden mb-2"> <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-mafia w-full mb-1 p-3 text-lg" maxlength="20"> <p id="change-name-error-message" class=""></p> </div> <div id="avatar-generation-container" class="hidden"> <button id="generate-avatar-btn" class="btn-mafia my-4">ساخت آواتار جدید با AI</button> <div id="avatar-ai-loading" class="my-4 hidden"> <div class="loader mx-auto"></div> <p class="mt-2 text-sm text-gray-400">در حال ساخت آواتارهای پیشنهادی...</p> </div> <div id="avatar-suggestions-container"> </div> <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p> </div> </div> <div id="modal-actions" class="flex justify-center gap-4 mt-4"> <button id="modal-confirm-btn" class="btn-mafia">تایید</button> <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button> </div> </div> </div>
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 g-hidden z-[51]"> ... </div>
    <!-- END of your provided HTML content -->


    <script type="module">
        // ----- وارد کردن کتابخانه‌های Firebase و Three.js -----
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import * as THREE from 'three';

        // ... (کد Firebase config شما)
        const firebaseConfig = { apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s", authDomain: "city-mafia.firebaseapp.com", projectId: "city-mafia", storageBucket: "city-mafia.appspot.com",  messagingSenderId: "66458127103", appId: "1:66458127103:web:8bcc2ad470f51b5db45aca", measurementId: "G-8M0M6BJ0GG" };
        const appId = 'mafia-game-default';

        // ----- تعریف متغیرهای اصلی و صداها -----
        let app, auth, db, currentUserId, isAuthReady = false;
        let clickSound, successSound, errorSound, transitionSound, startupSound;
        let lottieSuccessAnimation;
        // ... (سایر متغیرهای gameState و UI شما)
        // ...
        
        // ----- توابع جدید برای کنترل صوت و انیمیشن -----

        function playSound(soundElement, volume = 0.5) {
            if (soundElement) {
                soundElement.currentTime = 0;
                soundElement.volume = volume;
                soundElement.play().catch(e => console.warn("Audio play failed:", e));
            }
        }

        // ----- توابع بازنویسی شده با GSAP -----

        function showScreen(screenElement) {
            if (!screenElement) return;
            const currentScreen = document.querySelector('.screen.active');
            playSound(transitionSound, 0.3);

            const tl = gsap.timeline({
                onComplete: () => {
                    if (currentScreen) {
                        currentScreen.classList.remove('active');
                        currentScreen.classList.add('g-hidden');
                    }
                    screenElement.classList.add('active');
                    screenElement.classList.remove('g-hidden');
                    screenElement.scrollTop = 0;
                    document.body.style.overflow = (screenElement.id === 'main-screen' || screenElement.id === 'loading-screen') ? 'hidden' : 'auto';
                    updateUI();
                }
            });

            if (currentScreen && currentScreen !== screenElement) {
                tl.to(currentScreen, { autoAlpha: 0, scale: 0.98, duration: 0.5, ease: "power3.in" });
            }
            
            screenElement.classList.remove('g-hidden');
            tl.fromTo(screenElement, 
                { autoAlpha: 0, scale: 1.02, y: 20 },
                { autoAlpha: 1, scale: 1, y: 0, duration: 0.6, ease: "power3.out" },
                currentScreen ? "-=0.25" : 0
            );
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            // ... (منطق داخلی showModal شما بدون تغییر باقی می‌ماند) ...
            modalTitle.textContent = title;
            // ...
            
            modalContainer.classList.remove('g-hidden');
            gsap.fromTo(modalContainer, { autoAlpha: 0 }, { autoAlpha: 1, duration: 0.3 });
            gsap.fromTo(modalContainer.querySelector('.panel'), 
                { scale: 0.9, y: -20, autoAlpha: 0 },
                { scale: 1, y: 0, autoAlpha: 1, duration: 0.4, ease: "back.out(1.7)" }
            );
        }

        function hideModal() {
            playSound(clickSound);
            const tl = gsap.timeline({
                onComplete: () => {
                    modalContainer.classList.add('g-hidden');
                    // ... (منطق داخلی hideModal شما)
                }
            });
            tl.to(modalContainer.querySelector('.panel'), { scale: 0.9, y: -20, autoAlpha: 0, duration: 0.3, ease: "power2.in" })
              .to(modalContainer, { autoAlpha: 0, duration: 0.3 }, "-=0.2");
        }
        
        // ----- تابع نمایش سوال با انیمیشن GSAP -----
        function displayQuestion() {
            if (!gameState.currentQuestionData || !questionText || !optionsContainer) return;
            const { question, options } = gameState.currentQuestionData;
            
            // انیمیشن محو شدن سوال قبلی
            gsap.to([questionText, optionsContainer], { autoAlpha: 0, duration: 0.3, onComplete: () => {
                questionText.textContent = question;
                optionsContainer.innerHTML = "";
                options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                    button.textContent = `${index + 1}. ${option}`;
                    button.dataset.index = index;
                    button.addEventListener('click', handleAnswerSelection);
                    optionsContainer.appendChild(button);
                });
                
                // انیمیشن ظاهر شدن سوال و گزینه‌های جدید
                gsap.to(questionText, { autoAlpha: 1, duration: 0.5 });
                gsap.from(optionsContainer.children, {
                    autoAlpha: 0,
                    y: 20,
                    duration: 0.4,
                    stagger: 0.1,
                    ease: "power2.out"
                });

            }});

            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(feedbackText) feedbackText.textContent = "";
            if(lottieSuccess) lottieSuccess.classList.add('hidden');
            gameState.isQuestionActive = true;
        }


        // ----- تابع بازخورد با Lottie -----
        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || !optionsContainer || !feedbackText) return;
            gameState.isQuestionActive = false;

            // ... (منطق انتخاب گزینه شما) ...
            const selectedOptionButton = event.target.closest('.option-btn');
            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { correctAnswerIndex, explanation } = gameState.currentQuestionData;
            
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                playSound(successSound);
                selectedOptionButton.classList.add('correct');
                
                feedbackText.textContent = "";
                lottieSuccess.classList.remove('hidden');
                lottieSuccessAnimation.goToAndPlay(0, true);

                gameState.currentStage++;
                await saveUserData();
                
                // بعد از اتمام انیمیشن، سوال بعدی را لود کن
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);

            } else {
                playSound(errorSound, 0.4);
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');
                feedbackText.textContent = "پاسخ اشتباه!";
                feedbackText.className = 'text-red-400';
                
                setTimeout(() => { generateQuestion(); updateUI(); }, 3000);
            }
             if (explanation && questionExplanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                gsap.fromTo(questionExplanation, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.5, delay: 0.5});
            }
        }
        
        // ----- تابع راه‌اندازی پس‌زمینه Three.js -----
        function initThreeJSBackground() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({
                canvas: document.querySelector('#three-js-bg'),
                alpha: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.setZ(50);

            const particleTexture = new THREE.TextureLoader().load('https://i.imgur.com/UhY5a6a.png'); // یک تکسچر ساده برای ذرات
            const particlesGeometry = new THREE.BufferGeometry();
            const particleCount = 7000;
            const posArray = new Float32Array(particleCount * 3);
            for (let i = 0; i < particleCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 500;
            }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

            const particlesMaterial = new THREE.PointsMaterial({
                size: 0.3,
                map: particleTexture,
                color: 0xc49730,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.6,
                depthWrite: false,
            });

            const particleMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particleMesh);

            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });
            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });

            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const elapsedTime = clock.getElapsedTime();
                particleMesh.rotation.y = -0.05 * elapsedTime;
                camera.position.x += (mouseX * 5 - camera.position.x) * 0.05;
                camera.position.y += (mouseY * 5 - camera.position.y) * 0.05;
                camera.lookAt(scene.position);
                renderer.render(scene, camera);
            };
            animate();
        }

        // ----- تابع اصلی راه‌اندازی بازی -----
        async function initializeGame() {
            // ... (گرفتن تمام المنت‌های UI شما)
            feedbackText = document.getElementById('feedback-text');
            lottieSuccess = document.getElementById('lottie-success');
            
            // مقداردهی صداها
            clickSound = document.getElementById('click-sound');
            successSound = document.getElementById('success-sound');
            errorSound = document.getElementById('error-sound');
            transitionSound = document.getElementById('transition-sound');
            startupSound = document.getElementById('startup-sound');

            // بارگذاری انیمیشن Lottie
            lottieSuccessAnimation = lottie.loadAnimation({
                container: lottieSuccess,
                renderer: 'svg',
                loop: false,
                autoplay: false,
                path: 'https://assets2.lottiefiles.com/packages/lf20_wk1qnfji.json' // یک انیمیشن تیک سبز
            });

            // ... (کد راه‌اندازی اولیه شما)
            // ...

            try {
                // تمام event listenerها را به گونه‌ای تغییر دهید که از playSound استفاده کنند
                // مثال:
                registerBtn.addEventListener('click', async () => {
                    playSound(clickSound);
                    // ... بقیه منطق
                });
                // ...
                
                setupEventListeners(); // تابع اصلی شما برای event listener ها
                initThreeJSBackground(); // راه‌اندازی پس‌زمینه سه بعدی
                await initFirebase();
                
                // انیمیشن ورودی
                if (loadingScreen && loadingScreen.classList.contains('active')) {
                     setTimeout(() => {
                        playSound(startupSound, 0.4);
                        if(mainScreen) showScreen(mainScreen);
                    }, 1000);
                }

            } catch (error) {
                console.error("Error during initializeGame:", error);
            }
        }
        
        // ... (تمام توابع دیگر بازی شما اینجا قرار می‌گیرند)
        // ... (saveUserData, loadUserData, generateQuestion, etc.)
        // ----- کد شما از اینجا به بعد (با تغییرات جزئی برای صدا) -----
        // ...

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>