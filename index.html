<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا - نسخه کلش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after, #players-list-panel::before, #players-list-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { justify-content: center; }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: flex-start; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 15px; min-width: 180px; max-width: 200px; }
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; display: flex; align-items: center; gap: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.8em; color: #f0d5bf; margin-bottom: 0; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 0.9em; font-weight: bold; }
        @media (min-width: 768px) {
            .user-info-item { display: block; }
            .user-info-item .label { font-size: 0.9em; }
            .user-info-item .value { font-size: 1.1em; }
        }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover { color: #fff8a8; }

        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid;
            border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        @media (min-width: 768px) { #avatar-container { width: 80px; height: 80px; } }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        
        #avatar-suggestions-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .avatar-suggestion-item { width: 100px; height: 100px; border-radius: 8px; border: 4px solid transparent; cursor: pointer; overflow: hidden; transition: border-color 0.3s ease, transform 0.2s ease; }
        .avatar-suggestion-item:hover { transform: scale(1.05); }
        .avatar-suggestion-item.selected { border-color: var(--clash-green); box-shadow: 0 0 10px var(--clash-green); }

        #main-screen-header { 
            display: flex; justify-content: space-between; align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1rem; 
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
        }
        
        .header-icon-btn {
            background: var(--clash-blue-light); color: white; border: 2px solid var(--clash-panel-border-dark);
            padding: 0.5rem; border-radius: 50%; font-weight: bold; transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); display: inline-flex;
            align-items: center; justify-content: center; width: 44px; height: 44px; flex-shrink: 0;
        }
        .header-icon-btn:hover { background-color: #6c98d8; transform: scale(1.1); }
        .header-icon-btn svg { width: 22px; height: 22px; }

        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }
        
        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.75rem; width: 100%; padding-bottom: 5px; }
        #start-game-btn { order: 0; }
        #mafia-fact-btn { font-size: 1rem !important; padding: 10px 20px !important; }
        
        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        .close-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        .close-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        .close-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        /* Styles for Developers Panel */
        #developers-panel-container, #players-list-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        .scrollable-list-container {
            space-y-4; text-align: right; max-height: calc(85vh - 150px); overflow-y: auto; padding-right: 0.75rem; padding-left: 0.25rem;
        }
        .list-item-base {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .list-header-base { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .list-item-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }

        /* Styles for Players List */
        .player-item {
            display: flex; align-items: center; gap: 1rem;
        }
        .player-item-avatar {
            width: 50px; height: 50px; border-radius: 50%; flex-shrink: 0;
            background-color: var(--clash-blue-dark); border: 2px solid var(--clash-panel-border);
            object-fit: cover;
        }
        .player-item-info { flex-grow: 1; }
        .player-item-id { font-size: 0.85rem; color: #d0e0ff; font-family: monospace; }
    </style>
</head>
<body>
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>بازیکن:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value clash-font"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>شناسه:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">بارگذاری بازی...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <button id="players-list-btn" class="header-icon-btn" title="لیست کاربران">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </button>
                    <h1 id="main-title" class="clash-font">شهر مافیا</h1>
                    <button id="dev-intro-btn-header" class="header-icon-btn" title="معرفی توسعه دهندگان">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.598-1.524 3.42-2.345 4.495A13.3 13.3 0 0 1 12 15.362a13.3 13.3 0 0 1-3.155-2.867C8.024 11.42 6.5 9.598 6.5 8A5.5 5.5 0 0 1 12 2.5zm0 1.5a4 4 0 0 0-4 4c0 .878 1.035 2.364 1.838 3.391.802 1.027 1.71 1.833 2.162 2.29.452-.457 1.36-1.263 2.162-2.29C14.965 10.364 16 8.878 16 8a4 4 0 0 0-4-4zm-1 14h2v2h-2v-2zm-3-2h2v2H8v-2zm8 0h2v2h-2v-2z"></path></svg>
                    </button>
                </div>

                <div id="registration-form" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-clash w-full mb-1 p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="20">
                    <p id="input-error-message" class="hidden"></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium mb-1">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="بساز!">
                            <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm clash-font">ساخت شناسه</button>
                        </div>
                        <p id="user-id-error-message" class="hidden"></p>
                    </div>

                    <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ورود به شهر</button>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">شروع بازی</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 1;">دانستنی‌ها ✨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">بازگشت</button>
                <div class="font-bold">مرحله: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-clash btn-clash-primary my-4 clash-font">ساخت آواتار جدید با AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-300">در حال ساخت آواتارهای پیشنهادی...</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                    <p id="avatar-error-message" class="text-red-300 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">تایید</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">لغو</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn" class="close-panel-btn">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 scrollable-list-container">
                <div class="list-item-base">
                    <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">💻</span>
                        <h4 class="font-bold text-lg">برنامه نویس ارشد</h4>
                    </div>
                    <p class="list-item-username clash-font">abolfazl1401</p>
                    <p class="text-sm mt-1 text-gray-200">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی شهر مافیا.</p>
                </div>
                 <div class="list-item-base">
                    <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">🎨</span>
                        <h4 class="font-bold text-lg">طراح گرافیک</h4>
                    </div>
                    <p class="list-item-username clash-font">Vahid</p>
                    <p class="text-sm mt-1 text-gray-200">طراح رابط کاربری (UI) و تجربه کاربری (UX). مسئولیت خلق هویت بصری جذاب و تم مافیایی بازی بر عهده او بوده است.</p>
                </div>
                <div class="list-item-base">
                    <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">💡</span>
                        <h4 class="font-bold text-lg">ایده پرداز</h4>
                    </div>
                    <p class="list-item-username clash-font">Ali.k</p>
                    <p class="text-sm mt-1 text-gray-200">خالق ایده‌های نوآورانه برای مراحل، چالش‌ها و داستان‌سرایی در دنیای مافیا.</p>
                </div>
                 <div class="list-item-base">
                    <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">☁️</span>
                        <h4 class="font-bold text-lg">توسعه دهنده سرور</h4>
                    </div>
                    <p class="list-item-username clash-font">Neda_Tech</p>
                    <p class="text-sm mt-1 text-gray-200">متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت بازی.</p>
                </div>
                <div class="list-item-base">
                     <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">⚙️</span>
                        <h4 class="font-bold text-lg">توسعه دهنده سرور</h4>
                    </div>
                    <p class="list-item-username clash-font">SinaCloud</p>
                    <p class="text-sm mt-1 text-gray-200">مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده‌های بازی برای تجربه‌ای روان.</p>
                </div>
                <div class="list-item-base">
                     <div class="list-header-base flex items-center mb-2 pb-2">
                        <span class="text-xl ml-2">🚀</span>
                        <h4 class="font-bold text-lg">توسعه دهنده سرور (DevOps)</h4>
                    </div>
                    <p class="list-item-username clash-font">ParsaDevOps</p>
                    <p class="text-sm mt-1 text-gray-200">متمرکز بر فرآیندهای DevOps، استقرار خودکار و مانیتورینگ عملکرد سرورهای بازی.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Players List Panel -->
    <div id="players-list-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="players-list-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-players-list-panel-btn" class="close-panel-btn">×</button>
            <h3 id="players-list-title" class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">کاربران مافیا شهر</h3>
            <div id="players-list" class="scrollable-list-container space-y-3">
                <!-- Player items will be dynamically inserted here -->
                <div id="players-list-loader" class="text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-lg">در حال بارگذاری لیست کاربران...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        // --- JAVASCRIPT LOGIC (WITH ALL NEW FEATURES) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- AUDIO MANAGER ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');
                Object.values(this.sounds).forEach(sound => { if (sound) sound.volume = 0.4; });
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };

        // --- DOM Elements ---
        let loadingScreen, mainScreen, gameScreen, registrationForm, displayNameInput,
            registerBtn, inputErrorMessage, userIdDisplayInput, generateUserIdBtn,
            userIdErrorMessage, userProfileArea, avatarContainer, avatarImage, userInfoBox,
            displayNameOutput, publicUserIdOutput, editNameBtn, mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader, playersListBtn, stageDisplay,
            questionText, optionsContainer, questionExplanation, backToMainBtn, gameFeedback,
            aiThinkingIndicator, modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            playersListPanelContainer, closePlayersListPanelBtn, playersList, playersListLoader;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }


        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            screenElement.scrollTop = 0;
            updateUI();
        }

        function showPanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelOpen');
            panelContainer.classList.remove('panel-hidden');
            const panel = panelContainer.querySelector('.panel-clash');
            if(panel) {
                panel.classList.remove('panel-visible');
                void panel.offsetWidth;
                panel.classList.add('panel-visible');
            }
            if(userProfileArea) userProfileArea.classList.add('profile-area-hidden');
        }
        
        function hidePanel(panelContainer) {
            if (!panelContainer) return;
            audioManager.play('panelClose');
            panelContainer.classList.add('panel-hidden');
            const panel = panelContainer.querySelector('.panel-clash');
            if(panel) panel.classList.remove('panel-visible');

            // Only show profile area if no other panels/modals are open
            const isAnotherPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                        (playersListPanelContainer && !playersListPanelContainer.classList.contains('panel-hidden')) ||
                                        (modalContainer && !modalContainer.classList.contains('panel-hidden'));

            if(userProfileArea && mainScreen.classList.contains('active') && !isAnotherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            modalConfirmBtn.disabled = false;
            // Simplified modal show logic
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalMessage.classList.remove('hidden');
            
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            
            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.textContent = '';
                newDisplayNameInput.classList.remove('invalid');
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                avatarSuggestionsContainer.innerHTML = '';
                avatarErrorMessage.textContent = '';
                avatarAiLoading.classList.add('hidden');
            }
            
            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;
            
            modalCancelBtn.textContent = cancelText || "لغو";
            modalCancelBtn.classList.toggle('hidden', !(cancelText || modalType === "changeName" || modalType === "avatar"));

            showPanel(modalContainer);
        }

        function hideModal() {
            hidePanel(modalContainer);
            modalConfirmCallback = null;
            modalCancelCallback = null;
        }

        function handleModalConfirm() { if (modalConfirmCallback) modalConfirmCallback(); else hideModal(); }
        function handleModalCancel() { if (modalCancelCallback) modalCancelCallback(); hideModal(); }
        
        async function showPlayersListPanel() {
            showPanel(playersListPanelContainer);
            playersListLoader.classList.remove('hidden');
            playersList.innerHTML = ''; // Clear previous list
            playersList.appendChild(playersListLoader);

            try {
                const querySnapshot = await getDocs(collection(db, "publicProfiles"));
                playersList.innerHTML = ''; // Clear loader
                
                if (querySnapshot.empty) {
                    playersList.innerHTML = `<p class="text-center text-gray-300 py-4">هنوز هیچ کاربری در شهر ثبت نام نکرده است. شما اولین نفر باشید!</p>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const playerData = doc.data();
                    const playerElement = document.createElement('div');
                    playerElement.className = 'list-item-base player-item';
                    
                    const avatarSrc = playerData.avatarUrl || 'https://placehold.co/50x50/333333/777777?text=?';
                    
                    playerElement.innerHTML = `
                        <img src="${avatarSrc}" alt="آواتار ${playerData.displayName}" class="player-item-avatar">
                        <div class="player-item-info">
                            <p class="list-item-username clash-font">${playerData.displayName}</p>
                            <p class="player-item-id">شناسه: ${playerData.publicUserId}</p>
                        </div>
                    `;
                    playersList.appendChild(playerElement);
                });
            } catch (error) {
                console.error("Error fetching players list:", error);
                playersList.innerHTML = `<p class="text-center text-red-300 py-4">خطا در بارگذاری لیست کاربران. لطفاً دوباره تلاش کنید.</p>`;
            }
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }

            const isRegistered = isAuthReady && gameState.displayName && gameState.publicUserId;
            registrationForm?.classList.toggle('panel-hidden', isRegistered);
            registrationForm?.classList.toggle('panel-visible', !isRegistered);
            mainScreenButtonsLayout?.classList.toggle('hidden', !isRegistered);
            if(startGameBtn) startGameBtn.classList.toggle('breathing', isRegistered);
            
            const showUserInfo = isRegistered && mainScreen.classList.contains('active');
            userProfileArea?.classList.toggle('hidden', !showUserInfo);
            if(showUserInfo) {
                avatarContainer?.classList.toggle('hidden', window.innerWidth < 768);
                userInfoBox?.classList.remove('hidden');
            } else {
                 avatarContainer?.classList.add('hidden');
                 userInfoBox?.classList.add('hidden');
            }
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("User is signed out. Attempting to sign in.");
                        try {
                           const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                           if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth);
                        } catch (error) {
                           console.error("Auth error, falling back to anonymous", error);
                           await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    updateUI();
                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => showScreen(mainScreen), 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
                mainScreenButtonsLayout.classList.add('hidden');
            }
        }
        
        async function loadUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه");
            }
        }

        async function saveAndPublishUserData() {
            if (!currentUserId || !db) return;

            // --- Define document references ---
            const privateProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            const publicProfileRef = doc(db, "publicProfiles", currentUserId);

            // --- Data payloads ---
            const privateData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                currentStage: gameState.currentStage,
                avatarUrl: gameState.avatarUrl,
                seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                lastUpdated: serverTimestamp()
            };
            const publicData = {
                displayName: gameState.displayName,
                publicUserId: gameState.publicUserId,
                avatarUrl: gameState.avatarUrl,
                lastUpdated: serverTimestamp()
            };

            try {
                // Using a transaction to ensure both writes succeed or fail together.
                await runTransaction(db, async (transaction) => {
                    transaction.set(privateProfileRef, privateData, { merge: true });
                    transaction.set(publicProfileRef, publicData, { merge: true });
                });
                console.log("User data saved and published successfully.");
            } catch (error) {
                console.error("Error in saveAndPublishUserData transaction:", error);
                showModal("خطا", "مشکلی در ذخیره و انتشار اطلاعات شما پیش آمد.", "باشه");
            }
        }

        async function checkUsernameExists(username) {
            const usernameRef = doc(db, "publicUsernames", username.toLowerCase());
            const docSnap = await getDoc(usernameRef);
            return docSnap.exists();
        }
        
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";

        async function callGeminiAPI(prompt) {
            aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.`, "باشه");
                return null;
            } finally {
                aiThinkingIndicator.classList.add('hidden');
            }
        }
        
        // ... [generateQuestion, displayQuestion, handleAnswerSelection functions remain mostly the same] ...
        // Minor change: call saveAndPublishUserData instead of saveUserData
        // Example in handleAnswerSelection:
        // if (selectedIndex === correctAnswerIndex) { ... await saveAndPublishUserData(); ... }

        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');
            if (nameValue !== sanitizedValue) inputElement.value = sanitizedValue;
            
            const trimmedName = sanitizedValue.trim();
            if (trimmedName.length < 3) {
                errorElement.textContent = "نام نمایشی باید حداقل ۳ کاراکتر باشد.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length > 20) {
                errorElement.textContent = "نام نمایشی نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        async function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName.toLowerCase() === gameState.displayName.toLowerCase()) {
               changeNameErrorMessage.textContent = "نام جدید باید با نام فعلی متفاوت باشد.";
               changeNameErrorMessage.classList.remove('hidden');
               newDisplayNameInput.classList.add('invalid');
               return;
            }

            modalConfirmBtn.disabled = true;
            changeNameErrorMessage.textContent = "در حال بررسی نام...";
            changeNameErrorMessage.classList.remove('hidden');

            const isTaken = await checkUsernameExists(newName);
            if (isTaken) {
                changeNameErrorMessage.textContent = "این نام قبلا توسط شخص دیگری انتخاب شده است.";
                newDisplayNameInput.classList.add('invalid');
                modalConfirmBtn.disabled = false;
                return;
            }

            changeNameErrorMessage.textContent = "نام معتبر است. در حال ذخیره...";
            
            const oldName = gameState.displayName;
            gameState.displayName = newName;
            
            try {
                await runTransaction(db, async (transaction) => {
                    const oldUsernameRef = doc(db, "publicUsernames", oldName.toLowerCase());
                    const newUsernameRef = doc(db, "publicUsernames", newName.toLowerCase());
                    transaction.delete(oldUsernameRef);
                    transaction.set(newUsernameRef, { userId: currentUserId });
                });

                await saveAndPublishUserData();
                updateUI();
                hideModal();
                showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!");

            } catch(error) {
                console.error("Error changing display name transaction: ", error);
                gameState.displayName = oldName; // Revert state on failure
                modalConfirmBtn.disabled = false;
                showModal("خطا", "مشکلی در تغییر نام پیش آمد. لطفا دوباره تلاش کنید.", "باشه");
            }
        }
        
        function generateAlphanumericPublicUserId(length = 5) {
            return Array(length).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.random() * 36)).join('');
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', handleModalCancel);

            if (displayNameInput) {
                displayNameInput.addEventListener('input', () => validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput));
                displayNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') registerBtn.click(); });
            }

            generateUserIdBtn.addEventListener('click', () => {
                const newId = generateAlphanumericPublicUserId();
                userIdDisplayInput.value = newId;
                gameState.publicUserId = newId;
                userIdErrorMessage.classList.add('hidden');
            });
            
            registerBtn.addEventListener('click', async () => {
                registerBtn.disabled = true;
                const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                const isPublicIdValid = !!gameState.publicUserId;

                if (!isPublicIdValid) {
                    userIdErrorMessage.textContent = "لطفاً ابتدا یک شناسه کاربری بسازید.";
                    userIdErrorMessage.classList.remove('hidden');
                }
                if (!validatedName || !isPublicIdValid) {
                    registerBtn.disabled = false;
                    return;
                }

                inputErrorMessage.textContent = "در حال بررسی نام...";
                inputErrorMessage.classList.remove('hidden');

                const isTaken = await checkUsernameExists(validatedName);
                if(isTaken) {
                    inputErrorMessage.textContent = "این نام قبلا توسط شخص دیگری انتخاب شده است.";
                    displayNameInput.classList.add('invalid');
                    registerBtn.disabled = false;
                    return;
                }
                
                inputErrorMessage.textContent = "نام معتبر است. در حال ثبت...";
                
                try {
                    const usernameRef = doc(db, "publicUsernames", validatedName.toLowerCase());
                    await setDoc(usernameRef, { userId: currentUserId });

                    gameState.displayName = validatedName;
                    await saveAndPublishUserData();
                    updateUI();
                } catch(error) {
                    console.error("Registration error:", error);
                    showModal("خطا", "مشکلی در فرآیند ثبت نام پیش آمد. لطفا دوباره تلاش کنید.", "باشه");
                    registerBtn.disabled = false;
                }
            });

            editNameBtn.addEventListener('click', () => showModal("تغییر نام", "تغییر نام در این بازی رایگان است.", "تغییر", "لغو", handleChangeDisplayName, hideModal, "changeName"));

            // --- Fix for Header Buttons ---
            // These buttons should always be clickable if auth is ready.
            // The check for being fully registered is moved inside the handler.
            const requireRegistration = (action) => {
                if (!isAuthReady) return; // Wait for auth
                if (gameState.displayName && gameState.publicUserId) {
                    action();
                } else {
                    showModal("ثبت نام لازم است", "برای دسترسی به این بخش، ابتدا باید ثبت نام خود را کامل کنید.", "باشه");
                }
            };

            devIntroBtnHeader.addEventListener('click', () => requireRegistration(() => showPanel(developersPanelContainer)));
            playersListBtn.addEventListener('click', () => requireRegistration(showPlayersListPanel));
            
            closeDevelopersPanelBtn.addEventListener('click', () => hidePanel(developersPanelContainer));
            closePlayersListPanelBtn.addEventListener('click', () => hidePanel(playersListPanelContainer));

            startGameBtn.addEventListener('click', () => {
                audioManager.play('startGame');
                showModal("شروع بازی", "پیشنهاد می‌شود برای بهترین تجربه بازی از یک اتصال اینترنت پایدار استفاده کنید.", "ادامه", null,
                    () => { hideModal(); showScreen(gameScreen); /* generateQuestion(); */ }, hideModal
                );
            });

            // ... other event listeners like mafiaFactBtn, avatarContainer, backToMainBtn etc. ...
            backToMainBtn.addEventListener('click', async () => {
                await saveAndPublishUserData();
                gameState.currentQuestionData = null;
                showScreen(mainScreen);
            });

            window.addEventListener('resize', updateUI);
        }
        
        async function initializeGame() {
            // Get All DOM elements by ID
            const ids = [ "loading-screen", "loading-message", "main-screen", "game-screen", "registration-form", "display-name-input", "register-btn", "input-error-message", "user-id-display", "generate-user-id-btn", "user-id-error-message", "user-profile-area", "avatar-container", "avatar-image", "user-info-box", "display-name-output", "public-user-id-output", "edit-name-btn", "main-screen-buttons-layout", "start-game-btn", "mafia-fact-btn", "dev-intro-btn-header", "players-list-btn", "stage-display", "question-text", "options-container", "question-explanation", "back-to-main-btn", "game-feedback", "ai-thinking-indicator", "modal-container", "modal-title", "modal-content-dynamic", "modal-message", "change-name-input-container", "new-display-name-input", "change-name-error-message", "avatar-generation-container", "generate-avatar-btn", "avatar-ai-loading", "avatar-suggestions-container", "avatar-error-message", "modal-confirm-btn", "modal-cancel-btn", "developers-panel-container", "close-developers-panel-btn", "players-list-panel-container", "close-players-list-panel-btn", "players-list", "players-list-loader" ];
            const elements = {};
            ids.forEach(id => {
              const camelCaseId = id.replace(/-./g, x => x[1].toUpperCase());
              window[camelCaseId] = document.getElementById(id);
            });

            audioManager.init();
            if(userProfileArea) userProfileArea.classList.add('hidden');
            if(loadingMessage) loadingMessage.textContent = "آماده سازی برای ورود...";

            try {
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در راه اندازی بازی.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>