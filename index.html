<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>شب‌های مافیا: چالش ذهن</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CONFIG & VARIABLES --- */
        :root {
            --bg-dark: #0f172a;
            --accent-gold: #fbbf24;
            --accent-red: #ef4444;
            --accent-green: #10b981;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            overflow: hidden;
            height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(251, 191, 36, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(239, 68, 68, 0.05) 0%, transparent 20%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- UTILITIES --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .glow-gold {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }

        /* --- ANIMATIONS --- */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease;
            position: absolute;
            inset: 0;
            overflow-y: auto;
            padding: 1rem;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }

        /* --- BUTTON STYLES --- */
        .btn-game {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-game::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        .btn-game:hover::after {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #b45309 0%, #fbbf24 100%);
            color: #1a1a1a;
            font-weight: 800;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(251, 191, 36, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .option-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .option-card:hover:not(.disabled) {
            background: rgba(30, 41, 59, 0.8);
            border-color: var(--accent-gold);
            transform: translateX(-5px);
        }
        .option-card.correct {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border-color: var(--accent-green);
        }
        .option-card.wrong {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border-color: var(--accent-red);
        }

        /* Timer Bar */
        .timer-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .timer-bar {
            height: 100%;
            background: var(--accent-gold);
            width: 100%;
            transition: width 1s linear;
        }

        /* Loader */
        .loader-gun {
            width: 48px;
            height: 48px;
            display: inline-block;
            position: relative;
            border: 3px solid white;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        .loader-gun::after {
            content: '';  
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid;
            border-color: var(--accent-gold) transparent;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <!-- AUDIO ELEMENTS (Simple SFX) -->
    <!-- Note: In a real hosted environment, you would link actual mp3 files. 
         Here we just prepare the structure or use minimal base64 if needed, 
         but for this code we rely on Visual Feedback. -->

    <!-- ================= LOADING SCREEN ================= -->
    <div id="screen-loading" class="screen active flex-col justify-center items-center z-50 bg-[#0f172a]">
        <div class="loader-gun mb-6"></div>
        <h1 class="text-3xl font-black text-white tracking-widest mb-2">MAFIA <span class="text-[#fbbf24]">CITY</span></h1>
        <p class="text-gray-400 text-sm animate-pulse">در حال مسلح کردن شهر...</p>
    </div>

    <!-- ================= HOME SCREEN ================= -->
    <div id="screen-home" class="screen flex-col justify-between items-center py-8">
        <div class="w-full max-w-md text-center fade-in-up" style="animation-delay: 0.1s;">
            <div class="inline-block p-4 rounded-full bg-white/5 mb-4 glow-gold">
                <i class="fas fa-user-secret text-5xl text-[#fbbf24]"></i>
            </div>
            <h1 class="text-5xl font-black mb-2 text-shadow text-white">شهر مافیا</h1>
            <p class="text-gray-400 text-lg">آیا می‌توانید حقیقت را کشف کنید؟</p>
        </div>

        <div class="w-full max-w-md space-y-4 px-6 fade-in-up" style="animation-delay: 0.3s;">
            <button onclick="Game.start()" class="btn-game btn-primary w-full py-5 rounded-2xl text-xl shadow-lg flex items-center justify-center gap-3">
                <i class="fas fa-play"></i> شروع بازی
            </button>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="UI.showModal('about')" class="btn-game btn-secondary py-4 rounded-xl font-bold flex flex-col items-center">
                    <i class="fas fa-info-circle mb-1 text-[#fbbf24]"></i> راهنما
                </button>
                <button class="btn-game btn-secondary py-4 rounded-xl font-bold flex flex-col items-center cursor-default">
                    <span id="high-score-display" class="text-xl text-[#fbbf24]">0</span>
                    <span class="text-xs text-gray-400">رکورد شما</span>
                </button>
            </div>
        </div>

        <div class="text-gray-500 text-xs fade-in-up" style="animation-delay: 0.5s;">
            نسخه ۲.۰ • بازطراحی حرفه‌ای
        </div>
    </div>

    <!-- ================= GAME SCREEN ================= -->
    <div id="screen-game" class="screen flex-col justify-center items-center">
        <div class="w-full max-w-lg glass-panel rounded-3xl p-6 relative overflow-hidden fade-in-up">
            
            <!-- Header: Score & Round -->
            <div class="flex justify-between items-center mb-6">
                <button onclick="Game.quit()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-arrow-right text-xl"></i>
                </button>
                <div class="flex gap-4">
                    <div class="bg-black/30 px-3 py-1 rounded-lg">
                        <span class="text-gray-400 text-xs">امتیاز</span>
                        <span id="score-val" class="text-[#fbbf24] font-bold ml-1">0</span>
                    </div>
                    <div class="bg-black/30 px-3 py-1 rounded-lg">
                        <span class="text-gray-400 text-xs">سوال</span>
                        <span id="question-count" class="text-white font-bold ml-1">1/10</span>
                    </div>
                </div>
            </div>

            <!-- Timer -->
            <div class="timer-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>

            <!-- Question -->
            <div class="min-h-[120px] flex items-center justify-center mb-6">
                <h2 id="question-text" class="text-xl md:text-2xl font-bold text-center leading-relaxed">
                    در حال بارگذاری سوال...
                </h2>
            </div>

            <!-- Options -->
            <div id="options-container" class="space-y-3">
                <!-- Options injected by JS -->
            </div>

            <!-- Feedback Message -->
            <div id="feedback-msg" class="mt-4 text-center text-sm font-bold opacity-0 transition-opacity duration-300 min-h-[20px]">
            </div>
        </div>
    </div>

    <!-- ================= RESULT SCREEN ================= -->
    <div id="screen-result" class="screen flex-col justify-center items-center">
        <div class="w-full max-w-md glass-panel rounded-3xl p-8 text-center fade-in-up relative">
            
            <div id="result-icon-container" class="mb-6">
                <!-- Icon injected by JS -->
            </div>

            <h2 id="result-title" class="text-3xl font-bold mb-2">نتیجه بازی</h2>
            <p id="result-desc" class="text-gray-300 mb-8 text-sm leading-6"></p>

            <div class="bg-black/40 rounded-xl p-4 mb-8 flex justify-between items-center border border-white/5">
                <div class="text-center w-1/2 border-l border-white/10">
                    <div class="text-xs text-gray-400">امتیاز نهایی</div>
                    <div id="final-score" class="text-3xl font-bold text-[#fbbf24]">0</div>
                </div>
                <div class="text-center w-1/2">
                    <div class="text-xs text-gray-400">پاسخ صحیح</div>
                    <div id="final-correct" class="text-3xl font-bold text-green-400">0</div>
                </div>
            </div>

            <button onclick="Game.start()" class="btn-game btn-primary w-full py-4 rounded-xl font-bold shadow-lg mb-3">
                <i class="fas fa-redo ml-2"></i> بازی مجدد
            </button>
            <button onclick="UI.navigate('screen-home')" class="btn-game btn-secondary w-full py-4 rounded-xl font-bold text-sm">
                بازگشت به منو
            </button>
        </div>
    </div>

    <!-- ================= MODAL ================= -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#fbbf24]">راهنما</h3>
                <button onclick="UI.hideModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="text-sm text-gray-300 leading-7 text-justify">
                <p class="mb-2">به چالش "شهر مافیا" خوش آمدید. در این بازی شما باید با استفاده از منطق، استدلال و شناخت نقش‌ها، به سوالات پاسخ دهید.</p>
                <ul class="list-disc list-inside space-y-1 text-gray-400">
                    <li>هر سوال ۲۰ ثانیه زمان دارد.</li>
                    <li>پاسخ سریع‌تر = امتیاز بیشتر نیست، دقت مهم است.</li>
                    <li>سوالات بر اساس سناریوهای واقعی مافیا طراحی شده‌اند.</li>
                </ul>
            </div>
            <button onclick="UI.hideModal()" class="mt-6 w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 transition text-sm font-bold">متوجه شدم</button>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script>
        // --- GAME DATA (NEW & LOGICAL) ---
        const QUESTIONS_DB = [
            {
                q: "در یک سناریوی استاندارد، اگر «کارآگاه» استعلام «پدرخوانده» را بگیرد، مدیر بازی چه پاسخی می‌دهد؟",
                options: ["مثبت (مافیا)", "منفی (شهروند)", "بستگی به نظر مدیر دارد", "استعلام پدرخوانده همیشه نامشخص است"],
                a: 1, // Index of correct answer
                desc: "پدرخوانده (رئیس مافیا) معمولاً در استعلام کارآگاه منفی (شهروند) اعلام می‌شود تا شناسایی او سخت‌تر باشد."
            },
            {
                q: "اگر در فاز روز، دو نفر همزمان یکدیگر را متهم کنند و نفر سوم از یکی از آن‌ها دفاع کند، محتمل‌ترین سناریو چیست؟",
                options: ["هر سه شهروند هستند", "نفر سوم یارِ فرد متهم شده است", "نفر سوم مستقل است", "دو نفر اول مافیا هستند"],
                a: 1,
                desc: "در بازی مافیا، دفاع بی‌دلیل (کاور کردن) معمولاً نشانه‌ی یارگیری یا هم‌تیمی بودن است."
            },
            {
                q: "نقش «اسنایپر» یا «تک‌تیرانداز» چه محدودیت مهمی در شلیک به پدرخوانده دارد؟",
                options: ["هیچ محدودیتی ندارد", "اگر شلیک کند، خودش از بازی خارج می‌شود", "تیرش بر پدرخوانده اثر نمی‌کند (مگر در شرایط خاص)", "باید قبلش از کارآگاه اجازه بگیرد"],
                a: 2,
                desc: "در بسیاری از سناریوها، تیر اسنایپر روی پدرخوانده (گادفادر) اثر ندارد مگر اینکه جلیقه پدرخوانده قبلاً زده شده باشد."
            },
            {
                q: "اصطلاح «تارگت بک» (Target Back) به چه معناست؟",
                options: ["رای دادن به نفر قبلی", "متهم کردن کسی که بلافاصله شما را متهم کرده است", "پس گرفتن اتهام", "سکوت در برابر اتهام"],
                a: 1,
                desc: "وقتی بازیکن A به بازیکن B اتهام می‌زند و B بلافاصله بدون استدلال جدید به A اتهام می‌زند، تارگت بک رخ داده است."
            },
            {
                q: "وظیفه اصلی نقش «جان‌سخت» (روئین‌تن) در فاز شب چیست؟",
                options: ["کشتن مافیا", "گرفتن استعلام", "فدایی شدن برای شهر یا استعلام وضعیت خروج‌ها", "انتخاب شهردار"],
                a: 2,
                desc: "جان‌سخت معمولاً می‌تواند استعلام افراد خارج شده از بازی را از مدیر بگیرد تا شهر بفهمد چه نقش‌هایی بیرون رفته‌اند."
            },
            {
                q: "در بازی مافیا، «موج‌سواری» به چه رفتاری گفته می‌شود؟",
                options: ["تکرار حرف‌های دیگران برای امن نشان دادن خود", "حمله به مافیا", "دفاع از شهروند", "رای دادن در ثانیه‌های آخر"],
                a: 0,
                desc: "موج‌سواری یعنی فرد بدون داشتن ایده جدید، صرفاً با تایید حرف‌های دیگران سعی کند خود را همرنگ جماعت نشان دهد."
            },
            {
                q: "اگر دکتر شهر در شب به اشتباه «مافیا» را نجات دهد (سیو کند)، چه اتفاقی می‌افتد؟",
                options: ["دکتر از بازی اخراج می‌شود", "مافیا آن شب نمی‌تواند شلیک کند", "مافیا در آن شب از تیر اسنایپر یا اتفاقات دیگر در امان می‌ماند", "هیچ اتفاقی نمی‌افتد"],
                a: 2,
                desc: "دکتر وظیفه‌اش نجات جان افراد است، فارغ از نقش آن‌ها. اگر مافیا را انتخاب کند، او را از مرگ نجات داده است."
            },
            {
                q: "«ناتویی» چیست؟",
                options: ["حدس دقیق نقش یک شهروند توسط مافیا و حذف او", "خریدن رای شهروندان", "تبدیل شهروند به مافیا", "اخراج بازیکن توسط مدیر"],
                a: 0,
                desc: "ناتو (یا شاه‌کش) نقشی در مافیاست که می‌تواند با حدس صحیح نقش یک بازیکن، او را بدون نیاز به رای‌گیری شبانه حذف کند."
            },
            {
                q: "چرا مافیا در روز سعی می‌کند بین شهروندان اختلاف بیندازد؟",
                options: ["چون تفریح می‌کنند", "تا رای‌گیری انجام نشود", "تا شهروندان به جان هم بیفتند و تمرکز از روی مافیا برداشته شود", "تا شب طولانی‌تر شود"],
                a: 2,
                desc: "تفرقه بینداز و حکومت کن. بهترین استراتژی مافیا، درگیر کردن شهروندان با یکدیگر است."
            },
            {
                q: "کدام واکنش در برابر اتهام، بیشتر نشان‌دهنده «شهروند ناآگاه» است؟",
                options: ["خشم شدید و حمله متقابل", "تلاش برای توضیح منطقی و آرام بودن", "سکوت مطلق", "خندیدن و تمسخر"],
                a: 1,
                desc: "شهروند چون چیزی برای پنهان کردن ندارد، معمولاً سعی می‌کند با استدلال و آرامش (نه پرخاشگری ناشی از ترس) از خود دفاع کند."
            }
        ];

        // --- GAME ENGINE ---
        const Game = {
            state: {
                score: 0,
                currentQIndex: 0,
                timer: 20,
                timerInterval: null,
                isPlaying: false,
                questions: []
            },
            
            // Initialize
            init: function() {
                // Simulate loading
                setTimeout(() => {
                    document.getElementById('screen-loading').classList.remove('active');
                    UI.navigate('screen-home');
                }, 2000);
                
                // Load High Score
                const savedScore = localStorage.getItem('mafiaHighScore') || 0;
                document.getElementById('high-score-display').textContent = savedScore;
            },

            // Start Game
            start: function() {
                this.state.score = 0;
                this.state.currentQIndex = 0;
                this.state.isPlaying = true;
                // Shuffle questions
                this.state.questions = [...QUESTIONS_DB].sort(() => 0.5 - Math.random());
                
                UI.updateScore(0);
                UI.navigate('screen-game');
                this.loadQuestion();
            },

            // Load Question
            loadQuestion: function() {
                if (this.state.currentQIndex >= this.state.questions.length) {
                    this.endGame();
                    return;
                }

                const qData = this.state.questions[this.state.currentQIndex];
                UI.renderQuestion(qData, this.state.currentQIndex + 1, this.state.questions.length);
                this.startTimer();
            },

            // Timer Logic
            startTimer: function() {
                clearInterval(this.state.timerInterval);
                this.state.timer = 20;
                UI.updateTimerBar(100);

                const totalTime = 20;
                this.state.timerInterval = setInterval(() => {
                    this.state.timer -= 0.1;
                    const percent = (this.state.timer / totalTime) * 100;
                    UI.updateTimerBar(percent);

                    if (this.state.timer <= 0) {
                        this.handleAnswer(-1); // Time's up
                    }
                }, 100);
            },

            // Check Answer
            handleAnswer: function(selectedIndex) {
                if (!this.state.isPlaying) return;
                clearInterval(this.state.timerInterval);
                
                const currentQ = this.state.questions[this.state.currentQIndex];
                const isCorrect = selectedIndex === currentQ.a;
                
                // Logic update
                if (isCorrect) this.state.score += 10;
                
                // Visual update
                UI.showResultFeedback(selectedIndex, currentQ.a, currentQ.desc);

                // Delay for next question
                this.state.isPlaying = false; // Block inputs
                setTimeout(() => {
                    this.state.currentQIndex++;
                    this.state.isPlaying = true;
                    UI.updateScore(this.state.score);
                    this.loadQuestion();
                }, 3000);
            },

            // Quit
            quit: function() {
                if(confirm("آیا مطمئن هستید که می‌خواهید خارج شوید؟")) {
                    clearInterval(this.state.timerInterval);
                    UI.navigate('screen-home');
                }
            },

            // End Game
            endGame: function() {
                clearInterval(this.state.timerInterval);
                
                // Save High Score
                const currentHigh = localStorage.getItem('mafiaHighScore') || 0;
                if (this.state.score > currentHigh) {
                    localStorage.setItem('mafiaHighScore', this.state.score);
                    document.getElementById('high-score-display').textContent = this.state.score;
                }

                UI.showEndScreen(this.state.score, this.state.questions.length);
            }
        };

        // --- UI MANAGER ---
        const UI = {
            navigate: function(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            renderQuestion: function(data, current, total) {
                document.getElementById('question-text').textContent = data.q;
                document.getElementById('question-count').textContent = `${current}/${total}`;
                document.getElementById('feedback-msg').style.opacity = '0';
                
                const container = document.getElementById('options-container');
                container.innerHTML = '';

                data.options.forEach((opt, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'option-card p-4 rounded-xl flex items-center';
                    btn.innerHTML = `
                        <div class="w-8 h-8 rounded-full border border-gray-500 flex items-center justify-center ml-3 text-sm font-bold text-gray-400 option-index">
                            ${index + 1}
                        </div>
                        <span class="text-white font-medium text-lg">${opt}</span>
                    `;
                    btn.onclick = () => Game.handleAnswer(index);
                    container.appendChild(btn);
                });
            },

            showResultFeedback: function(selectedIndex, correctIndex, explanation) {
                const options = document.querySelectorAll('.option-card');
                
                options.forEach((opt, idx) => {
                    opt.classList.add('disabled'); // Disable clicks
                    opt.style.pointerEvents = 'none';
                    
                    if (idx === correctIndex) {
                        opt.classList.add('correct');
                        opt.querySelector('.option-index').style.borderColor = '#10b981';
                        opt.querySelector('.option-index').style.color = '#10b981';
                        opt.querySelector('.option-index').innerHTML = '<i class="fas fa-check"></i>';
                    } else if (idx === selectedIndex) {
                        opt.classList.add('wrong');
                        opt.querySelector('.option-index').style.borderColor = '#ef4444';
                        opt.querySelector('.option-index').style.color = '#ef4444';
                        opt.querySelector('.option-index').innerHTML = '<i class="fas fa-times"></i>';
                    } else {
                        opt.style.opacity = '0.5';
                    }
                });

                const feedbackEl = document.getElementById('feedback-msg');
                feedbackEl.innerHTML = `<span class="text-[#fbbf24] block mb-1">توضیح:</span> ${explanation}`;
                feedbackEl.style.opacity = '1';
                feedbackEl.classList.add('fade-in-up');
            },

            updateTimerBar: function(percent) {
                const bar = document.getElementById('timer-bar');
                bar.style.width = `${percent}%`;
                if (percent < 30) bar.style.backgroundColor = '#ef4444'; // Red warning
                else bar.style.backgroundColor = '#fbbf24'; // Gold normal
            },

            updateScore: function(score) {
                const el = document.getElementById('score-val');
                el.textContent = score;
                el.classList.add('scale-125');
                setTimeout(() => el.classList.remove('scale-125'), 200);
            },

            showEndScreen: function(score, totalQs) {
                this.navigate('screen-result');
                const correctCount = score / 10;
                const percentage = (correctCount / totalQs) * 100;
                
                document.getElementById('final-score').textContent = score;
                document.getElementById('final-correct').textContent = correctCount;
                
                const title = document.getElementById('result-title');
                const desc = document.getElementById('result-desc');
                const iconContainer = document.getElementById('result-icon-container');

                if (percentage >= 80) {
                    title.textContent = "گاد فادر!";
                    title.className = "text-4xl font-black mb-2 text-[#fbbf24] glow-gold";
                    desc.textContent = "شما شهر را مثل کف دستتان می‌شناسید. هیچکس نمی‌تواند شما را فریب دهد.";
                    iconContainer.innerHTML = '<i class="fas fa-crown text-6xl text-[#fbbf24] animate-bounce"></i>';
                } else if (percentage >= 50) {
                    title.textContent = "شهروند کاربلد";
                    title.className = "text-3xl font-bold mb-2 text-white";
                    desc.textContent = "اطلاعات خوبی دارید اما هنوز جای پیشرفت هست. مراقب ترفندهای مافیا باشید.";
                    iconContainer.innerHTML = '<i class="fas fa-user-shield text-6xl text-blue-400"></i>';
                } else {
                    title.textContent = "شهروند ساده";
                    title.className = "text-3xl font-bold mb-2 text-gray-400";
                    desc.textContent = "به نظر می‌رسد تازه وارد شهر شده‌اید. نیاز به کسب تجربه بیشتر دارید.";
                    iconContainer.innerHTML = '<i class="fas fa-ghost text-6xl text-gray-500"></i>';
                }
            },

            showModal: function(type) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.remove('hidden');
                // Allow display:block to apply before adding opacity
                requestAnimationFrame(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                });
            },

            hideModal: function() {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.add('opacity-0');
                content.classList.add('scale-95');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            Game.init();
        });

    </script>
</body>
</html>
