<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-primary: #c49730;
            --gold-light: #e7b758;
            --gold-dark: #a57c1a;
            --bg-dark: #121212;
            --panel-bg: rgba(28, 28, 32, 0.75);
            --text-light: #e8e8e8;
            --text-muted: #a0a0a0;
            --red-error: #e53935;
            --green-success: #43a047;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--text-light);
            background-color: var(--bg-dark);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .mafia-animated-bg {
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
        }
        
        /* Subtle noise texture for a more cinematic feel */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXVoaGigpaWlp6ezt7e6urqcnZ2jo6PGxsatra2pqamxt7ejo6N8fHxubm54eHhycnJra2t/f39nZ2d8fHzt7e3Z2dnW1tbY2NixsbG+vr729vaxsbH19fXz8/Lv7+/z8/P29vby8vL09PTs7Ozw8PDx8fH39/fBwcHt7e1CQjVfAAAAI3RSTlOkOx4eOzs+P1A/PEJCQj5AUE9MRkNERENEQ0REREJCQkJCQkJCQkJCQkJCUEamwAAAAW5JREFUSMe1l9tyxSAQROasAbj1GjOO/v/PTq3pEgSBq9x5uAbjQc5Mmv+3iK4bVTZp2M5r4ciIkBEhIAyF4f+4kAMRLEQ+X77gOCGlImfLhTAdABdI0a5+mYARgQjTzMQuhBEAhAhgCgKi0sCGBEMiYBCgSoEMiYBCgSoEMg4GAJgQCICQCICQCICQCICs4gEAkQEiQD2eBMMsEABECBAQYgIYB4IgAwJQIgEwIgA0QYgA0QYgA0QYgA8QIQAcMQAJgIgYwIgY0IgYwIgYwIgYwIga4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgIgYwIgYwIgYwIgYwIgYwIgY0IgYwIgYwIgYwIga4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgIgYwIgYwIgYwIgYwIgYwIga4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgQgAkQAiQCAq4QIAJgIgYwIgYwIgYwIgYwIgYwIgY0IgYwIgYwIgYwIga4QIAJgIQAaIAQAGIAZAgYBCgIQCkBh9z/w/O2gQIBCgYwIgYwIgYwIgYwIga4QI2ATgQCICQCEAKg8u/cACAAQkCgIECBACBAbAb+8QWIQ+fP+Db7zgBwYg+QIAA0QH0wA1D/gAJaK3wMxO8AAAAABJRU5ErkJggg==');
            opacity: 0.04;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* The new "Glassmorphism" panel style */
        .panel {
            background: var(--panel-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(196, 151, 48, 0.4);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }
        
        /* Primary Button Style - The Star of the Show */
        .btn-mafia {
            background: linear-gradient(145deg, var(--gold-light), var(--gold-primary));
            color: #1a1a1a;
            border: 1px solid var(--gold-dark);
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 12px;
            font-weight: bold;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 -2px 2px rgba(0,0,0,0.2), inset 0 2px 2px rgba(255,255,255,0.2);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-mafia:hover {
            background: linear-gradient(145deg, #f0c068, #d4a840);
            box-shadow: 0 6px 20px rgba(196, 151, 48, 0.3), inset 0 -2px 2px rgba(0,0,0,0.2), inset 0 2px 2px rgba(255,255,255,0.2);
            transform: translateY(-3px);
        }
        .btn-mafia:active {
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .btn-mafia:disabled {
            background: #5a5245;
            color: #8c806a;
            border-color: #4a4235;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            text-shadow: none;
        }

        /* Secondary Button Style - Subtle and Clean */
        .btn-mafia-secondary {
            background-color: rgba(40, 40, 40, 0.5);
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 18px;
            font-size: 0.9rem;
            border-radius: 10px;
            transition: all 0.3s ease-in-out;
        }
        .btn-mafia-secondary:hover {
            background-color: rgba(60, 60, 60, 0.7);
            color: var(--gold-light);
            border-color: var(--gold-primary);
            box-shadow: 0 0 15px rgba(196, 151, 48, 0.2);
        }

        /* Input Style - Recessed and Modern */
        .input-mafia {
            background-color: rgba(10, 10, 10, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .input-mafia::placeholder {
            color: var(--text-muted);
        }
        .input-mafia:focus {
            outline: none;
            border-color: var(--gold-primary);
            background-color: rgba(10, 10, 10, 0.7);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 0 2px rgba(196, 151, 48, 0.5);
        }
        .input-mafia.invalid {
            border-color: var(--red-error);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 0 2px rgba(229, 57, 53, 0.5);
        }
        .input-mafia:read-only {
            background-color: rgba(0,0,0,0.4);
            cursor: default;
        }

        /* Game Option Buttons */
        .option-btn {
            background-color: rgba(40, 40, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-size: 1rem;
            padding: 14px;
            border-radius: 12px;
            text-align: right;
        }
        .option-btn:hover:not(:disabled) {
            background-color: rgba(60, 60, 65, 0.9);
            border-color: var(--gold-primary);
            transform: scale(1.02);
        }
        .option-btn.correct { background: linear-gradient(145deg, #57b75a, var(--green-success)) !important; border-color: #388e3c !important; color: white !important; transform: scale(1.03); }
        .option-btn.incorrect { background: linear-gradient(145deg, #f75955, var(--red-error)) !important; border-color: #d32f2f !important; color: white !important; }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        /* Loader */
        .loader {
            border: 6px solid rgba(255,255,255,0.2);
            border-top: 6px solid var(--gold-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-light); }
        
        /* Screen Management */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh;
            padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .screen.active {
            opacity: 1; visibility: visible; position: relative; z-index: 1;
        }
        .screen-content-wrapper {
            width: 100%; max-width: 800px; margin: auto; padding-bottom: 20px;
            display: flex; flex-direction: column; flex-grow: 1;
        }

        /* --- Re-imagined User Profile --- */
        #user-profile-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #user-profile-area.profile-area-hidden {
            opacity: 0;
            transform: translateY(-120%);
        }
        /* Mobile Specific Positioning */
        @media (max-width: 767px) {
            #user-profile-area {
                top: 15px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: 95%;
                max-width: 400px;
            }
             #user-profile-area.profile-area-hidden {
                transform: translateX(-50%) translateY(-120%);
            }
        }
        
        /* The new "Player Card" style */
        #user-info-box {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(196, 151, 48, 0.4);
            border-radius: 14px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        #avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--gold-primary);
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(196, 151, 48, 0.4);
            transition: transform 0.3s ease;
        }
        #avatar-container:hover {
            transform: scale(1.1);
        }
        #avatar-image {
            width: 100%; height: 100%; object-fit: cover;
        }

        #user-details {
            flex-grow: 1;
            overflow: hidden;
        }
        
        #profile-display-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--gold-light);
            text-shadow: 0 0 8px rgba(228, 172, 76, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #edit-name-btn {
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-muted);
            transition: color 0.3s ease, transform 0.3s ease;
            flex-shrink: 0;
        }
        #edit-name-btn:hover {
            color: var(--gold-light);
            transform: rotate(20deg);
        }
        
        #profile-user-id {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'Courier New', Courier, monospace;
        }

        #profile-user-id-icon {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        /* --- Main Screen Redesign --- */
        #main-screen { justify-content: center; }
        
        #main-screen .screen-content-wrapper {
            justify-content: center;
            padding-top: 100px; /* Space for user profile card at the top */
        }
        @media (min-width: 768px) {
            #main-screen .screen-content-wrapper {
                padding-top: 20px;
            }
        }

        #main-screen-header {
            margin-bottom: 2rem;
        }
        
        #main-title {
            text-align: center;
            font-size: clamp(2.5rem, 10vw, 4.5rem); /* Responsive font size */
            font-weight: 800;
            color: var(--gold-primary);
            text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 15px rgba(228, 172, 76, 0.5);
            letter-spacing: -1px;
        }
        
        #registration-form { padding: 1.5rem 2rem; }
        
        #main-screen-buttons-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        #top-action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        #start-game-btn {
             padding: 14px 30px !important;
             font-size: 1.1rem !important;
             box-shadow: 0 6px 25px rgba(196, 151, 48, 0.3), inset 0 -2px 2px rgba(0,0,0,0.2), inset 0 2px 2px rgba(255,255,255,0.2);
        }

        #dev-intro-icon-btn-header {
            position: fixed;
            top: 25px;
            left: 20px;
            z-index: 100;
            width: 44px;
            height: 44px;
            background-color: var(--panel-bg);
            color: var(--gold-primary);
            border: 1px solid rgba(196, 151, 48, 0.4);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #dev-intro-icon-btn-header:hover {
            background-color: rgba(196, 151, 48, 0.2);
            transform: scale(1.1) rotate(-15deg);
            box-shadow: 0 4px 15px rgba(196, 151, 48, 0.3);
        }
        
        /* Game Screen */
        #game-screen .screen-content-wrapper { justify-content: flex-start; }
        #question-text {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.7;
        }

        /* Modal & Developer Panel styling to match */
        #modal-container, #developers-panel-container {
            background-color: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        #close-developers-panel-btn {
            position: absolute; top: 15px; right: 15px; width: 36px; height: 36px;
            background-color: rgba(255, 255, 255, 0.1); border-radius: 50%;
            color: var(--text-light); font-size: 24px; cursor: pointer;
            transition: all 0.3s ease; display:flex; align-items:center; justify-content:center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #close-developers-panel-btn:hover {
            background-color: var(--gold-primary); color: #1a1a1a; transform: rotate(180deg);
        }
        .developer-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .developer-item:hover {
            background-color: rgba(196, 151, 48, 0.1);
            border-color: rgba(196, 151, 48, 0.5);
            transform: translateY(-5px);
        }
        
        /* Avatar Suggestions */
        #avatar-suggestions-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;
        }
        .avatar-suggestion-item {
            border-radius: 8px; border: 3px solid transparent; cursor: pointer; overflow: hidden;
            transition: border-color 0.3s ease, transform 0.2s ease;
        }
        .avatar-suggestion-item:hover { transform: scale(1.05); }
        .avatar-suggestion-item.selected {
            border-color: var(--green-success); box-shadow: 0 0 15px rgba(67, 160, 71, 0.7);
        }
        
        /* Error Messages */
        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: var(--red-error); font-size: 0.875rem; text-align: right; min-height: 1.2rem; margin-top: 0.5rem;
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>

    <!-- Dev Intro Button - Now fixed positioned -->
    <button id="dev-intro-icon-btn-header" title="معرفی توسعه دهندگان">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
    </button>

    <!-- ==== USER PROFILE AREA REFACTORED ==== -->
    <div id="user-profile-area" class="hidden">
        <!-- user-info-box is now the main container -->
        <div id="user-info-box">
             <div id="avatar-container" title="تغییر آواتار">
                <!-- Existing avatar image logic is fine -->
                <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
            </div>
            <div id="user-details">
                <div id="profile-display-name">
                    <!-- The JS will populate this span -->
                    <span id="display-name-output" class="truncate"></span>
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                </div>
                 <div id="profile-user-id">
                    <svg id="profile-user-id-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <!-- The JS will populate this span -->
                    <span id="public-user-id-output"></span>
                </div>
            </div>
        </div>
        <!-- OLD user-info-box structure is removed from here for clarity. JS still targets the old IDs which are preserved inside the new structure -->
    </div>


    <div id="loading-screen" class="screen active">
        <div class="screen-content-wrapper text-center">
            <h1 class="text-4xl font-bold mb-6" style="color: var(--gold-primary);">بارگذاری بازی مافیا...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-xl">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div id="main-screen-header">
                <h1 id="main-title">شهر مافیا</h1>
            </div>

            <div id="registration-form" class="mb-4 panel panel-visible max-w-md mx-auto w-full">
                <h2 class="text-2xl font-semibold mb-4 text-center" style="color: var(--gold-light);">ثبت نام / ورود</h2>
                <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1 text-lg" maxlength="20">
                <p id="input-error-message"></p>

                <div class="mt-3 mb-2">
                    <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-2">شناسه کاربری (5 رقمی):</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="user-id-display" class="input-mafia w-full text-lg text-center tracking-widest" readonly placeholder="---">
                        <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-4 py-3 text-sm">ساخت شناسه</button>
                    </div>
                    <p id="user-id-error-message"></p>
                </div>

                <button id="register-btn" class="btn-mafia w-full text-lg mt-4">ورود به شهر</button>
            </div>

            <div id="main-screen-buttons-layout" class="hidden">
                 <div id="top-action-buttons">
                    <button id="start-game-btn" class="btn-mafia">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        شروع بازی آنلاین
                    </button>
                    <button id="mafia-fact-btn" class="btn-mafia-secondary">دانستنی‌های مافیا ✨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary !text-base !py-2 !px-3">⟵ بازگشت</button>
                <div>مرحله: <span id="stage-display" class="font-bold text-[var(--gold-primary)]">1</span></div>
            </div>

            <div id="question-container" class="panel panel-visible p-6 rounded-lg mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="mb-6 text-center">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-400 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base mt-2">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 p-4 panel-hidden z-50">
        <div class="panel panel-visible p-8 rounded-lg max-w-lg w-full text-center m-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-4" style="color:var(--gold-light);">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-4 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-mafia w-full mb-1 text-lg" maxlength="20">
                    <p id="change-name-error-message"></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                        ساخت آواتار جدید با AI
                    </button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">در حال ساخت آواتارهای پیشنهادی... (ممکن است کمی طول بکشد)</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                    <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-6">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>
    
    <div id="developers-panel-container" class="fixed inset-0 p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel p-7 rounded-xl max-w-xl w-full relative m-auto">
            <button id="close-developers-panel-btn">×</button>
            <h3 class="text-3xl font-bold mb-8 text-center" style="color:var(--gold-light);">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">💻</span>
                        <h4 class="text-lg font-bold">برنامه نویس ارشد</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">abolfazl1401</p>
                    <p class="text-sm text-gray-300 leading-relaxed">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی شهر مافیا.</p>
                </div>
                <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">🎨</span>
                        <h4 class="text-lg font-bold">طراح گرافیک</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">Vahid</p>
                    <p class="text-sm text-gray-300 leading-relaxed">طراح رابط کاربری (UI) و تجربه کاربری (UX). مسئولیت خلق هویت بصری جذاب و تم مافیایی بازی بر عهده او بوده است.</p>
                </div>
                 <!-- Other developers here, following the same new structure -->
                 <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">💡</span>
                        <h4 class="text-lg font-bold">ایده پرداز</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">Ali.k</p>
                    <p class="text-sm text-gray-300 leading-relaxed">خالق ایده‌های نوآورانه برای مراحل، چالش‌ها و داستان‌سرایی در دنیای مافیا.</p>
                </div>
                <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">☁️</span>
                        <h4 class="text-lg font-bold">توسعه دهنده سرور</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">Neda_Tech</p>
                    <p class="text-sm text-gray-300 leading-relaxed">متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت بازی.</p>
                </div>
                <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">⚙️</span>
                        <h4 class="text-lg font-bold">توسعه دهنده سرور</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">SinaCloud</p>
                    <p class="text-sm text-gray-300 leading-relaxed">مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده‌های بازی برای تجربه‌ای روان.</p>
                </div>
                <div class="developer-item p-5 rounded-lg">
                    <div class="dev-header flex items-center mb-2 pb-2 border-b border-white/10">
                        <span class="text-2xl ml-3">🚀</span>
                        <h4 class="text-lg font-bold">توسعه دهنده سرور (DevOps)</h4>
                    </div>
                    <p class="font-bold text-xl mb-2" style="color:var(--gold-light);">ParsaDevOps</p>
                    <p class="text-sm text-gray-300 leading-relaxed">متمرکز بر فرآیندهای DevOps، استقرار خودکار و مانیتورینگ عملکرد سرورهای بازی.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCRIPT (UNCHANGED) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(), // <<--- NEW: To store hashes of seen questions
        };

        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;

        // <<--- NEW: Simple non-cryptographic hash function
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return `h${Math.abs(hash)}`;
        }


        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');

            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflow = isControllingOverflow ? 'hidden' : 'auto';

            screenElement.scrollTop = 0;
            updateUI();
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) {
                console.error("[showModal] Modal elements not found, cannot show modal.");
                return;
            }

            modalTitle.textContent = title;

            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');

            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName;
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = '';
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                if(avatarSuggestionsContainer) avatarSuggestionsContainer.innerHTML = '';
                if(avatarErrorMessage) avatarErrorMessage.textContent = '';
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "لغو";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
            modalContainer.classList.add('panel-visible');
        }

        function hideModal() {
            if (!modalContainer || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer) {
                return;
            }
            modalContainer.classList.add('panel-hidden');
            modalContainer.classList.remove('panel-visible');
            modalConfirmCallback = null;
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            modalMessage.classList.add('hidden');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') &&
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("[handleModalConfirm] Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) {
                    console.error("[handleModalCancel] Error in modal cancel callback:", e);
                }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.add('panel-hidden');
            developersPanelContainer.classList.remove('panel-visible');
             if(userProfileArea && mainScreen && mainScreen.classList.contains('active') &&
               (!modalContainer || modalContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }

            let showRegistration = true;
            let showActionButtons = false;
            let showUserInfoAndAvatar = false;

            if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                showRegistration = false;
                showActionButtons = true;
                if (mainScreen && mainScreen.classList.contains('active')) {
                    showUserInfoAndAvatar = true;
                }
            } else if (isAuthReady && (!gameState.displayName || !gameState.publicUserId)) {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            } else {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            }

            if(registrationForm){
                if (showRegistration) {
                    registrationForm.classList.remove('panel-hidden');
                    registrationForm.classList.add('panel-visible');
                } else {
                    registrationForm.classList.add('panel-hidden');
                    registrationForm.classList.remove('panel-visible');
                }
            }

            if(mainScreenButtonsLayout){
                if (showActionButtons) {
                    mainScreenButtonsLayout.classList.remove('hidden');
                } else {
                    mainScreenButtonsLayout.classList.add('hidden');
                }
            }

            if(userProfileArea){
                const isAnyPanelVisible = (modalContainer && modalContainer.classList.contains('panel-visible')) ||
                                        (developersPanelContainer && developersPanelContainer.classList.contains('panel-visible'));
                if (showUserInfoAndAvatar && !isAnyPanelVisible) {
                    userProfileArea.classList.remove('profile-area-hidden');
                    userProfileArea.classList.remove('hidden');
                    if(avatarContainer) avatarContainer.classList.remove('hidden');
                    if(userInfoBox) userInfoBox.classList.remove('hidden');

                } else if (!showUserInfoAndAvatar) {
                    userProfileArea.classList.add('hidden');
                    if(avatarContainer) avatarContainer.classList.add('hidden');
                    if(userInfoBox) userInfoBox.classList.add('hidden');
                } else if (isAnyPanelVisible) {
                    userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("User is signed out. Attempting to sign in.");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("[onAuthStateChanged] Custom token sign-in error, trying anonymous:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                        gameState.displayName = '';
                        gameState.publicUserId = '';
                        gameState.avatarUrl = '';
                        gameState.seenQuestionHashes.clear();
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        if(loadingMessage) loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen);
                        }, 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }

        async function loadUserData() {
            if (!currentUserId || !db) {
                console.log("Cannot load user data: no currentUserId or db connection.");
                gameState.displayName = '';
                gameState.publicUserId = '';
                gameState.avatarUrl = '';
                gameState.seenQuestionHashes = new Set();
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    console.log("User data found, loading profile.");
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    // <<--- MODIFIED: Load seen questions and convert to a Set for efficient lookup
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                    console.log(`Loaded ${gameState.seenQuestionHashes.size} seen questions.`);
                } else {
                    console.log("No user profile found, setting default values.");
                    gameState.displayName = "";
                    gameState.publicUserId = "";
                    gameState.avatarUrl = '';
                    gameState.seenQuestionHashes = new Set();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
                gameState.displayName = '';
                gameState.publicUserId = '';
                gameState.avatarUrl = '';
                gameState.seenQuestionHashes = new Set();
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    // <<--- MODIFIED: Convert Set to Array for Firestore storage
                    seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                 console.log("User data saved successfully.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
            }
        }

        // --- Gemini API Functions ---
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash"; // Using a slightly more advanced model for better quality
        const IMAGEN_MODEL = "imagen-3.0-generate-002";

        async function callGeminiAPI(prompt, isJsonOutput = false, schema = null) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            if (isJsonOutput) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                };
                if (schema) {
                    payload.generationConfig.responseSchema = schema;
                }
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJsonOutput ? JSON.parse(text) : text;
                } else {
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                         throw new Error(`پاسخ نامعتبر از سرویس هوش مصنوعی (دلیل: ${result.candidates[0].finishReason})`);
                    }
                    throw new Error("پاسخ نامعتبر از سرویس هوش مصنوعی دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (!prompt.includes("offensive, hateful, or contain profanity")) {
                    showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.<br><br><small>جزئیات خطا: ${error.message}</small>`, "باشه", null, () => hideModal());
                }
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function callImagenAPI(prompt, sampleCount = 1) {
            if(avatarAiLoading) avatarAiLoading.classList.remove('hidden');
            if(avatarErrorMessage) avatarErrorMessage.textContent = '';

            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": sampleCount }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed: ${response.status} ${errorBody}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                } else {
                    throw new Error("پاسخ نامعتبر از سرویس ساخت تصویر دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = `خطا در ساخت آواتار: ${error.message}`;
                return null;
            } finally {
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
            }
        }

        // --- Game Logic Functions ---

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            if (questionText) questionText.textContent = "در حال تولید سوال جدید و غیرتکراری...";
            if (optionsContainer) optionsContainer.innerHTML = "";
            if (questionExplanation) questionExplanation.classList.add('hidden');
            if (gameFeedback) gameFeedback.textContent = "";
            
            let attempts = 0;
            const maxAttempts = 3;
            let questionData = null;

            while (attempts < maxAttempts) {
                // <<--- NEW: Determine difficulty based on stage
                let difficulty = "آسان";
                if (gameState.currentStage > 20) {
                    difficulty = "بسیار سخت";
                } else if (gameState.currentStage > 10) {
                    difficulty = "سخت";
                } else if (gameState.currentStage > 5) {
                    difficulty = "متوسط";
                }

                // <<--- NEW: Professional and enhanced prompt
                const prompt = `
                شما یک طراح بازی حرفه‌ای و خلاق هستید که مسئول طراحی سوالات برای یک بازی مافیایی پیشرفته هستید. هدف شما ایجاد سوالاتی چالش‌برانگیز، متنوع و غیرتکراری است.
                
                وظیفه: یک سوال چند گزینه‌ای (۴ گزینه‌ای) جدید و منحصربه‌فرد به زبان فارسی با موضوع مافیا ایجاد کن.
                سطح دشواری سوال باید "${difficulty}" باشد چون کاربر در مرحله ${gameState.currentStage} است.
                
                موضوعات پیشنهادی (برای تنوع):
                - تاریخچه و ساختار مافیای سیسیل (Cosa Nostra)، کامورا یا اندرانگتا.
                - شخصیت‌ها، وقایع و اصطلاحات دوران ممنوعیت الکل در آمریکا.
                - سازمان‌های جنایی دیگر مانند یاکوزای ژاپن، کارتل‌های کلمبیا یا مکزیک.
                - جزئیات دقیق از فیلم‌ها و سریال‌های معروف مانند "پدرخوانده"، "رفقای خوب"، "کازینو"، "سوپرانوها" یا "پیکی بلایندرز".
                - اصطلاحات تخصصی و نقش‌های پیچیده در سناریوهای مختلف بازی "شهر مافیا" (مانند دکتر لکتر، روانپزشک، مذاکره‌کننده، ناتاشا).
                - سناریوهای فرضی و چالش‌های تاکتیکی در بازی مافیا.
                
                مهم: سوال نباید کلیشه‌ای یا تکراری باشد. خلاقیت به خرج بده و سوالی طرح کن که دانش کاربر را به چالش بکشد.
                
                خروجی: پاسخ شما باید فقط و فقط یک آبجکت JSON خام، بدون هیچ متن اضافی یا بک‌تیک (\`\`\`) باشد.
                ساختار JSON باید دقیقا به این صورت باشد:
                {
                  "question": "متن سوال به فارسی",
                  "options": ["گزینه ۱", "گزینه ۲", "گزینه ۳", "گزینه ۴"],
                  "correctAnswerIndex": 0,
                  "explanation": "توضیح کوتاه و جالب در مورد پاسخ صحیح به زبان فارسی"
                }
                `;

                const data = await callGeminiAPI(prompt, true);

                if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    const questionHash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(questionHash)) {
                        questionData = data;
                        break; // Found a new, unique question
                    } else {
                        console.warn(`Duplicate question received (hash: ${questionHash}), retrying... Attempt ${attempts + 1}`);
                        attempts++;
                    }
                } else {
                    console.error("Invalid question data structure received from AI:", data);
                    attempts++; // Count as a failed attempt
                }
            }

            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                console.error("Failed to generate a unique question after multiple attempts.");
                if (questionText) questionText.textContent = "خطا در بارگذاری سوال غیرتکراری.";
                showModal("خطا در تولید سوال", `متاسفانه نتوانستیم یک سوال جدید و غیرتکراری برای شما بسازیم. این ممکن است به دلیل ترافیک بالا یا پاسخ ندادن سرور هوش مصنوعی باشد. آیا می‌خواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); if (mainScreen) showScreen(mainScreen); }
                );
            }
            
            gameState.isLoadingNextQuestion = false;
            gameState.isQuestionActive = true;
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData || !questionText || !optionsContainer) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = `${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(questionExplanation) questionExplanation.textContent = "";
            if(gameFeedback) gameFeedback.textContent = "";
            gameState.isQuestionActive = true;
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion || !optionsContainer || !gameFeedback) return;
            gameState.isQuestionActive = false;

            const selectedOptionButton = event.target.closest('.option-btn');
            if (!selectedOptionButton) return;

            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                selectedOptionButton.classList.add('correct');
                gameFeedback.textContent = "پاسخ صحیح!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-green-400';
                
                // <<--- MODIFIED: Add question hash to seen list and increment stage
                const questionHash = simpleHash(question);
                gameState.seenQuestionHashes.add(questionHash);
                gameState.currentStage++;
                
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');

                const selectedOptionText = options[selectedIndex];
                const correctAnswerText = options[correctAnswerIndex];
                const tauntPrompt = `شما یک رئیس مافیای شوخ طبع هستید. بازیکن به این سوال پاسخ اشتباه داده است:
                سوال: "${question}"
                پاسخ اشتباه بازیکن: "${selectedOptionText}"
                پاسخ صحیح: "${correctAnswerText}"
                یک طعنه کوتاه و بامزه (۱ تا ۲ جمله) به زبان فارسی در مورد اشتباه بازیکن یا موضوع سوال بگویید. طعنه باید مناسب فضای بازی و نه چندان توهین آمیز باشد.`;

                const taunt = await callGeminiAPI(tauntPrompt);
                if (taunt) {
                    gameFeedback.innerHTML = taunt.replace(/\n/g, '<br>');
                } else {
                    gameFeedback.textContent = "پاسخ اشتباه!";
                }
                gameFeedback.className = 'text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-auto text-red-400';
                // Note: We do NOT add the hash to the seen list on wrong answers, so they might see it again to learn.
                // Or we could add it to prevent farming wrong answers, but for now, let's keep it this way.
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            if (explanation && questionExplanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }

        async function generateAndDisplayAvatars() {
            if(!avatarAiLoading || !avatarSuggestionsContainer || !modalConfirmBtn) return;
            avatarAiLoading.classList.remove('hidden');
            const prompt = "Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons";
            const suggestions = await callImagenAPI(prompt, 4);

            avatarSuggestionsContainer.innerHTML = '';
            selectedAvatarForConfirmation = null;

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(base64Url => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'avatar-suggestion-item';
                    const img = document.createElement('img');
                    img.src = base64Url;
                    img.alt = "پیشنهاد آواتار";
                    imgWrapper.appendChild(img);
                    imgWrapper.addEventListener('click', () => {
                        const currentSelected = avatarSuggestionsContainer.querySelector('.selected');
                        if (currentSelected) {
                            currentSelected.classList.remove('selected');
                        }
                        imgWrapper.classList.add('selected');
                        selectedAvatarForConfirmation = base64Url;
                        modalConfirmBtn.disabled = false;
                    });
                    avatarSuggestionsContainer.appendChild(imgWrapper);
                });
                modalConfirmBtn.textContent = "انتخاب این آواتار";
                modalConfirmBtn.disabled = true;
            } else {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "متاسفانه نتوانستیم آواتاری بسازیم. دوباره تلاش کنید.";
                modalConfirmBtn.textContent = "تایید";
                modalConfirmBtn.disabled = true;
            }
        }

        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("موفقیت", "آواتار شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
            } else {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "لطفا ابتدا یک آواتار را انتخاب کنید.";
            }
        }

        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            if (!inputElement || !errorElement) return null;
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');

            if (nameValue !== sanitizedValue) {
                inputElement.value = sanitizedValue;
            }

            const trimmedName = sanitizedValue.trim();

            if (trimmedName === '') {
                errorElement.textContent = "نام نمایشی نمی‌تواند خالی باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length < 3) {
                errorElement.textContent = "نام نمایشی باید حداقل ۳ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length > 20) {
                errorElement.textContent = "نام نمایشی نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.textContent = '';
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName === gameState.displayName) {
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = "نام جدید باید با نام فعلی متفاوت باشد.";
                if(newDisplayNameInput) newDisplayNameInput.classList.add('invalid');
                return;
            }

            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
        }

        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب، نکته تاریخی کمتر شنیده شده، یا یک داستانک کوتاه و غافلگیرکننده (حدود ۲-۴ جمله) در مورد دنیای مافیا (تاریخچه، فیلم‌ها، شخصیت‌های معروف، یا اصطلاحات رایج) به زبان فارسی برای من تعریف کن. سعی کن هر بار یک مطلب جدید ارائه دهی.";
            showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو در آرشیوهای مخفی...</p>", "باشه", null, () => hideModal());

            const fact = await callGeminiAPI(prompt);
            if (fact) {
                showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!", null, () => hideModal());
            } else {
                showModal("خطا", "متاسفانه در حال حاضر نکته‌ای برای گفتن نیست. لطفاً بعداً تلاش کنید.", "باشه", null, () => hideModal());
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        function setupEventListeners() {
            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            if (displayNameInput) {
                displayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                });
                displayNameInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if(registerBtn) registerBtn.click();
                    }
                });
            }

            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', () => {
                    const newPublicId = generateAlphanumericPublicUserId();
                    if (userIdDisplayInput) userIdDisplayInput.value = newPublicId;
                    gameState.publicUserId = newPublicId;
                    if (userIdErrorMessage) userIdErrorMessage.textContent = '';
                });
            }


            if (newDisplayNameInput) {
                newDisplayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
                });
                newDisplayNameInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (modalConfirmCallback === handleChangeDisplayName && modalTitle && modalTitle.textContent.includes("تغییر نام نمایشی")) {
                            if(modalConfirmBtn) modalConfirmBtn.click();
                        }
                    }
                });
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', async () => {
                    const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);

                    let isPublicIdValid = false;
                    if (!gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "لطفاً ابتدا یک شناسه کاربری بسازید.";
                        isPublicIdValid = false;
                    } else if (userIdDisplayInput && userIdDisplayInput.value !== gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "خطا: شناسه کاربری نمایش داده شده با شناسه ساخته شده مغایرت دارد.";
                        isPublicIdValid = false;
                    }
                    else {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "";
                        isPublicIdValid = true;
                    }

                    if (!validatedName || !isPublicIdValid) return;

                    gameState.displayName = validatedName;

                    await saveUserData();
                    updateUI();
                });
            }

            if (editNameBtn) {
                editNameBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return;
                    showModal(
                        "تغییر نام نمایشی",
                        "تغییر نام در این بازی رایگان است.",
                        "تغییر نام",
                        "لغو",
                        handleChangeDisplayName,
                        hideModal,
                        "changeName"
                    );
                });
            }

            if (avatarContainer) {
                avatarContainer.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return;
                    selectedAvatarForConfirmation = null;
                    showModal(
                        "تغییر آواتار",
                        "",
                        "انتخاب این آواتار",
                        "لغو",
                        confirmAvatarSelection,
                        hideModal,
                        "avatar"
                    );
                    if(modalConfirmBtn) modalConfirmBtn.disabled = true;
                });
            }

            if (generateAvatarBtn) {
                generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);
            }

            const allActionButtons = [startGameBtn, mafiaFactBtn, devIntroBtnHeader].filter(btn => btn !== null);
            allActionButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) {
                        event.stopPropagation();
                        showModal(
                            "ثبت نام لازم است",
                            "برای دسترسی به این بخش، ابتدا باید با وارد کردن نام نمایشی و ساخت شناسه کاربری، ثبت نام خود را کامل کنید.",
                            "باشه",
                            null,
                            () => hideModal()
                        );
                    }
                }, true);
            });


            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return;
                    showModal(
                        "شروع بازی",
                        "برای تجربه بهتر بازی لطفا از فیلترشکن در کشور ایالات‌متحده (آمریکا) استفاده کنید.",
                        "متوجه شدم، ادامه بده", null,
                        () => {
                            hideModal();
                            if(gameScreen) showScreen(gameScreen);
                            generateQuestion();
                        }
                    );
                });
            }

            if (mafiaFactBtn) {
                mafiaFactBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return;
                    generateMafiaFact();
                });
            }

            if (devIntroBtnHeader) {
                devIntroBtnHeader.addEventListener('click', () => {
                    if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                        showDevelopersPanel();
                    }
                });
            }

            if (closeDevelopersPanelBtn) {
                closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            }

            if(backToMainBtn) {
                backToMainBtn.addEventListener('click', async () => {
                    try {
                        await saveUserData();
                        gameState.currentQuestionData = null;
                        if(mainScreen) {
                            showScreen(mainScreen);
                        }
                    }
                    catch (e) {
                        console.error("Error in backToMainBtn click listener (game screen):", e);
                    }
                });
            }

            window.addEventListener('resize', () => {
                updateUI();
            });
        }

        async function initializeGame() {
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            registrationForm = document.getElementById('registration-form');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');

            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            devIntroBtnHeader = document.getElementById('dev-intro-icon-btn-header');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarGenerationContainer = document.getElementById('avatar-generation-container');
            generateAvatarBtn = document.getElementById('generate-avatar-btn');
            avatarAiLoading = document.getElementById('avatar-ai-loading');
            avatarSuggestionsContainer = document.getElementById('avatar-suggestions-container');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');

            if(userProfileArea) userProfileArea.classList.add('hidden');

            if(loadingMessage) loadingMessage.textContent = "در حال بررسی اتصال به اینترنت...";
            if (!navigator.onLine) {
                showModal("عدم اتصال به اینترنت", "لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.", "تلاش مجدد", null, () => {
                    hideModal();
                    if (navigator.onLine) initializeGame(); else showModal("عدم اتصال", "همچنان به اینترنت متصل نیستید.", "باشه", null, () => hideModal());
                });
                return;
            }
            if(loadingMessage) loadingMessage.textContent = "در حال آماده سازی اولین ورود...";

            try {
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در راه اندازی بازی.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>
