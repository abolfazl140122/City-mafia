<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا - نسخه کلش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            /* Android Fix: Improve touch responsiveness */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after, #leaderboard-panel::before, #leaderboard-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
            /* Android Fix: Improve touch interaction */
            -webkit-user-select: auto;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: auto;
            touch-action: manipulation;
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { justify-content: center; }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: center; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 15px; min-width: 180px; max-width: 200px; }
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; display: flex; align-items: center; gap: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.8em; color: #f0d5bf; margin-bottom: 0; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 0.9em; font-weight: bold; }
        @media (min-width: 768px) {
            .user-info-item { display: block; }
            .user-info-item .label { font-size: 0.9em; }
            .user-info-item .value { font-size: 1.1em; }
        }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn, #logout-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover, #logout-btn:hover { color: #fff8a8; }

        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid;
            border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Prevents avatar from shrinking */
        }
        @media (min-width: 768px) { #avatar-container { width: 80px; height: 80px; } }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        
        #main-screen-header { 
            display: flex; justify-content: center;
            align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1.5rem;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
        }
        
        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }

        .header-icon-btn {
            background: var(--clash-blue-light); color: white; border: 2px solid var(--clash-panel-border-dark);
            padding: 0.5rem; border-radius: 50%; font-weight: bold; transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); display: inline-flex;
            align-items: center; justify-content: center; width: 44px; height: 44px; flex-shrink: 0;
        }
        .header-icon-btn:hover { background-color: #6c98d8; transform: scale(1.1); }
        .header-icon-btn svg { width: 24px; height: 24px; pointer-events: none; }
        
        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; width: 100%; padding-bottom: 5px; }
        #start-game-btn { order: 0; }
        #mafia-fact-btn { font-size: 1rem !important; padding: 10px 20px !important; order: 3; }
        
        .error-message {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        /* Styles for Pop-up Panels */
        #developers-panel-container, #leaderboard-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        #developers-panel, #leaderboard-panel {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
        }
        #close-developers-panel-btn, #close-leaderboard-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        #close-developers-panel-btn:hover, #close-leaderboard-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        #close-developers-panel-btn:active, #close-leaderboard-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        .developer-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .dev-header { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .dev-role-icon { font-size: 1.7em; color: var(--clash-gold); margin-left: 10px; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; font-family: 'Vazirmatn'; }
        .dev-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }
        .dev-description { font-size: 0.9rem; color: #d0e0ff; line-height: 1.65; font-family: 'Vazirmatn'; }

        /* Styles for Leaderboard Panel */
        .leaderboard-item {
            display: flex;
            align-items: center;
            background-color: rgba(42, 65, 102, 0.9);
            padding: 0.75rem;
            border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
            gap: 1rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .leaderboard-item:hover {
            background-color: rgba(60, 85, 122, 0.9);
            transform: scale(1.02);
        }
        .leaderboard-rank {
            font-family: 'Lilita One', cursive;
            font-size: 1.75rem;
            color: var(--clash-gold);
            -webkit-text-stroke: 1.5px var(--clash-brown-dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--clash-gold-dark);
            object-fit: cover;
            background-color: #2a4166;
            flex-shrink: 0;
        }
        .leaderboard-info {
            flex-grow: 1;
        }
        .leaderboard-name {
            font-family: 'Lilita One', cursive;
            font-size: 1.2rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px #000;
        }
        .leaderboard-stage {
            font-size: 0.9rem;
            color: #d0e0ff;
            font-weight: bold;
        }
        .leaderboard-stage-value {
            color: var(--clash-gold);
            font-family: 'Lilita One', cursive;
            font-size: 1.1em;
            margin-right: 4px;
        }

        #avatar-preview-container {
            margin: 1rem auto;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--clash-gold);
            overflow: hidden;
            background-color: var(--clash-panel-border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #avatar-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .auth-toggle-link {
            color: var(--clash-gold);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .auth-toggle-link:hover {
            color: #fff8a8;
        }

    </style>
</head>
<body>
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>بازیکن:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="logout-btn" title="خروج از حساب">🚪</span>
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value clash-font"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>شناسه:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">بارگذاری بازی...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <h1 id="main-title" class="clash-font">شهر مافیا</h1>
                </div>

                <div id="auth-panel" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <!-- Registration Form (DEFAULT VIEW) -->
                    <div id="registration-form">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ایجاد حساب کاربری</h2>
                        <div class="space-y-3">
                             <input type="text" id="register-display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-clash w-full clash-font" maxlength="20">
                             <input type="email" id="register-email-input" placeholder="ایمیل" class="input-clash w-full" style="direction: ltr; text-align: left;">
                             <input type="password" id="register-password-input" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="input-clash w-full" style="direction: ltr; text-align: left;">
                            <div class="flex items-center gap-2">
                                <input type="text" id="user-id-display" class="input-clash w-full text-center" readonly placeholder="شناسه کاربری (بسازید)">
                                <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary whitespace-nowrap px-3 py-2 text-xs sm:text-sm clash-font">ساخت شناسه</button>
                            </div>
                        </div>
                        <p id="register-error-message" class="error-message hidden mt-3"></p>
                        <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ثبت نام</button>
                        <p class="text-center mt-3 text-sm">
                            <span class="auth-toggle-link" id="show-login-link">حساب کاربری دارید؟ وارد شوید</span>
                        </p>
                    </div>
                    
                    <!-- Login Form (HIDDEN BY DEFAULT) -->
                    <div id="login-form" class="hidden">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ورود به حساب</h2>
                        <div class="space-y-3">
                             <input type="email" id="login-email-input" placeholder="ایمیل" class="input-clash w-full" style="direction: ltr; text-align: left;">
                             <input type="password" id="login-password-input" placeholder="رمز عبور" class="input-clash w-full" style="direction: ltr; text-align: left;">
                        </div>
                        <p id="login-error-message" class="error-message hidden mt-3"></p>
                        <button id="login-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ورود به شهر</button>
                        <p class="text-center mt-3 text-sm">
                            <span class="auth-toggle-link" id="show-register-link">حساب کاربری ندارید؟ ثبت نام کنید</span>
                        </p>
                    </div>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">شروع بازی</button>
                    <button id="leaderboard-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 1;">🏆 رتبه‌بندی</button>
                    <button id="developers-btn" class="btn-clash btn-clash-secondary clash-font" style="order: 2;">👥 سازندگان</button>
                    <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font">دانستنی‌ها ✨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ... (game-screen, modal-container, developers-panel, leaderboard-panel, audio elements remain unchanged) ... -->
    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">بازگشت</button>
                <div class="font-bold">مرحله: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base font-bold">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="error-message hidden"></p>
                </div>
                <div id="avatar-upload-ui-container" class="hidden">
                    <div class="flex flex-col sm:flex-row items-stretch gap-2 my-4">
                        <input type="url" id="avatar-url-input" placeholder="لینک مستقیم تصویر را اینجا وارد کنید" class="input-clash w-full p-3 text-base" style="direction: ltr; text-align: left;">
                        <button id="preview-avatar-btn" class="btn-clash btn-clash-secondary clash-font whitespace-nowrap px-4">پیش‌نمایش</button>
                    </div>
                    <div id="avatar-preview-container" class="hidden">
                        <img id="avatar-preview-image" src="#" alt="پیش نمایش آواتار">
                    </div>
                    <p id="avatar-error-message" class="error-message hidden"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">تایید</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">لغو</button>
            </div>
        </div>
    </div>
    
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">💻</span>
                        <h4 class="dev-role">برنامه نویس ارشد</h4>
                    </div>
                    <p class="dev-username clash-font">abolfazl1401</p>
                    <p class="dev-description">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی شهر مافیا.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">🎨</span>
                        <h4 class="dev-role">طراح گرافیک</h4>
                    </div>
                    <p class="dev-username clash-font">Vahid</p>
                    <p class="dev-description">طراح رابط کاربری (UI) و تجربه کاربری (UX). مسئولیت خلق هویت بصری جذاب و تم مافیایی بازی بر عهده او بوده است.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">💡</span>
                        <h4 class="dev-role">ایده پرداز</h4>
                    </div>
                    <p class="dev-username clash-font">Ali.k</p>
                    <p class="dev-description">خالق ایده‌های نوآورانه برای مراحل، چالش‌ها و داستان‌سرایی در دنیای مافیا.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">☁️</span>
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username clash-font">Neda_Tech</p>
                    <p class="dev-description">متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت بازی.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">⚙️</span>
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username clash-font">SinaCloud</p>
                    <p class="dev-description">مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده‌های بازی برای تجربه‌ای روان.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">🚀</span>
                        <h4 class="dev-role">توسعه دهنده سرور (DevOps)</h4>
                    </div>
                    <p class="dev-username clash-font">ParsaDevOps</p>
                    <p class="dev-description">متمرکز بر فرآیندهای DevOps، استقرار خودکار و مانیتورینگ عملکرد سرورهای بازی.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboard-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-2xl w-full relative">
            <button id="close-leaderboard-panel-btn">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">کاربران برتر شهر</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-3 font-bold">در حال بارگذاری لیست کاربران برتر...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- MODIFIED: Import new auth functions and transaction functions ---
        import { 
            getAuth, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, serverTimestamp, 
            collection, query, orderBy, limit, getDocs, runTransaction, deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- AUDIO MANAGER (Unchanged) ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');
                Object.values(this.sounds).forEach(sound => { if (sound) sound.volume = 0.4; });
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) { sound.currentTime = 0; sound.play().catch(e => console.warn("Audio play failed:", e)); }
            }
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app, auth, db;
        let currentUserId = null;
        let isAuthReady = false;

        // --- MODIFIED: gameState is now reset on logout ---
        const initialGameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };
        let gameState = { ...initialGameState };
        
        // --- Variables ---
        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            authPanel, 
            registrationForm, registerDisplayNameInput, registerEmailInput, registerPasswordInput, registerBtn, registerErrorMessage,
            loginForm, loginEmailInput, loginPasswordInput, loginBtn, loginErrorMessage,
            showLoginLink, showRegisterLink,
            userIdDisplayInput, generateUserIdBtn, 
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput, editNameBtn, logoutBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, developersBtn, leaderboardBtn,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            leaderboardPanelContainer, leaderboardList, closeLeaderboardPanelBtn,
            avatarUploadUiContainer, avatarUrlInput, previewAvatarBtn,
            avatarPreviewContainer, avatarPreviewImage, avatarErrorMessage;
        
        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }

        // --- All UI and Game Logic functions (showScreen, showModal, etc.) remain largely the same, but will be called by new auth logic ---
        // ... [The existing functions like showScreen, showModal, hideModal, generateQuestion, etc., are kept here, they are correct] ...
        // [For brevity, I'm omitting the exact copy of those functions as they don't need major changes, only their callers change.]
        // START of copied functions (no major changes needed)
        function showScreen(screenElement) { if (!screenElement) return; document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); screenElement.classList.add('active'); const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen'; document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto'; document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto'; screenElement.scrollTop = 0; updateUI(); }
        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") { if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarUploadUiContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) { console.error("[showModal] Modal elements not found."); return; } audioManager.play('panelOpen'); modalContainer.classList.remove('panel-hidden'); modalContainer.querySelector('.panel-clash').classList.add('panel-visible'); modalTitle.textContent = title; modalMessage.classList.add('hidden'); changeNameInputContainer.classList.add('hidden'); avatarUploadUiContainer.classList.add('hidden'); if(changeNameErrorMessage) changeNameErrorMessage.classList.add('hidden'); if(avatarErrorMessage) avatarErrorMessage.classList.add('hidden'); const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')); if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) { userProfileArea.classList.add('profile-area-hidden'); } if (modalType === "changeName") { changeNameInputContainer.classList.remove('hidden'); if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName; if(changeNameErrorMessage) changeNameErrorMessage.textContent = ''; if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid'); if (message && message.trim() !== "") { modalMessage.innerHTML = message; modalMessage.classList.remove('hidden'); } } else if (modalType === "avatar") { avatarUploadUiContainer.classList.remove('hidden'); if(avatarUrlInput) avatarUrlInput.value = ''; if(avatarPreviewContainer) avatarPreviewContainer.classList.add('hidden'); if(avatarErrorMessage) avatarErrorMessage.classList.add('hidden'); if (message && message.trim() !== "") { modalMessage.innerHTML = message; modalMessage.classList.remove('hidden'); } } else { modalMessage.innerHTML = message; modalMessage.classList.remove('hidden'); } modalConfirmBtn.textContent = confirmText; modalConfirmBtn.disabled = (modalType === 'avatar'); modalConfirmCallback = onConfirm; modalCancelCallback = onCancel; if (cancelText || modalType === "changeName" || modalType === "avatar") { modalCancelBtn.textContent = cancelText || "لغو"; modalCancelBtn.classList.remove('hidden'); } else { modalCancelBtn.classList.add('hidden'); } }
        function hideModal() { if (!modalContainer) return; audioManager.play('panelClose'); modalContainer.classList.add('panel-hidden'); modalContainer.querySelector('.panel-clash').classList.remove('panel-visible'); modalConfirmCallback = null; modalCancelCallback = null; if(changeNameInputContainer) changeNameInputContainer.classList.add('hidden'); if(avatarUploadUiContainer) avatarUploadUiContainer.classList.add('hidden'); if(modalMessage) modalMessage.classList.add('hidden'); const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')); if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) { userProfileArea.classList.remove('profile-area-hidden'); } }
        function handleModalConfirm() { if (modalConfirmCallback) { try { modalConfirmCallback(); } catch (e) { console.error("Error in modal confirm callback:", e); hideModal(); } } else { hideModal(); } }
        function handleModalCancel() { if (modalCancelCallback) { try { modalCancelCallback(); } catch (e) { console.error("Error in modal cancel callback:", e); } } hideModal(); }
        function showDevelopersPanel() { if (!developersPanelContainer) return; audioManager.play('panelOpen'); developersPanelContainer.classList.remove('panel-hidden'); developersPanelContainer.querySelector('.panel-clash').classList.add('panel-visible'); if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) { userProfileArea.classList.add('profile-area-hidden'); } }
        function hideDevelopersPanel() { if (!developersPanelContainer) return; audioManager.play('panelClose'); developersPanelContainer.classList.add('panel-hidden'); developersPanelContainer.querySelector('.panel-clash').classList.remove('panel-visible'); const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden')); if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) { userProfileArea.classList.remove('profile-area-hidden'); } }
        function showLeaderboardPanel() { if (!leaderboardPanelContainer) return; audioManager.play('panelOpen'); leaderboardPanelContainer.classList.remove('panel-hidden'); leaderboardPanelContainer.querySelector('.panel-clash').classList.add('panel-visible'); if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) { userProfileArea.classList.add('profile-area-hidden'); } fetchAndDisplayLeaderboard(); }
        function hideLeaderboardPanel() { if (!leaderboardPanelContainer) return; audioManager.play('panelClose'); leaderboardPanelContainer.classList.add('panel-hidden'); leaderboardPanelContainer.querySelector('.panel-clash').classList.remove('panel-visible'); const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')); if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) { userProfileArea.classList.remove('profile-area-hidden'); } }
        // END of copied functions

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;
            if(avatarImage) avatarImage.src = gameState.avatarUrl || `https://placehold.co/80x80/333333/777777?text=?`;

            const isLoggedIn = isAuthReady && currentUserId && gameState.displayName;

            if(authPanel){
                authPanel.classList.toggle('panel-hidden', isLoggedIn);
                authPanel.classList.toggle('panel-visible', !isLoggedIn);
            }
            if(mainScreenButtonsLayout){
                mainScreenButtonsLayout.classList.toggle('hidden', !isLoggedIn);
                if(startGameBtn) startGameBtn.classList.toggle('breathing', isLoggedIn);
            }
            if(userProfileArea){
                const isAnyPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                        (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                        (leaderboardPanelContainer && !leaderboardPanelContainer.classList.contains('panel-hidden'));
                
                userProfileArea.classList.toggle('hidden', !isLoggedIn);

                if (isLoggedIn && !isAnyPanelVisible) {
                    userProfileArea.classList.remove('profile-area-hidden');
                    if(avatarContainer) avatarContainer.classList.remove('hidden');
                    if(userInfoBox) userInfoBox.classList.remove('hidden');
                } else {
                     userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized (Auth, Firestore).");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        console.log("User is signed in:", user.uid);
                        if (currentUserId !== user.uid) { // Prevent re-loading on minor auth token changes
                            currentUserId = user.uid;
                            await loadUserData(user.uid);
                        }
                    } else {
                        // User is signed out
                        console.log("User is signed out.");
                        currentUserId = null;
                        gameState = { ...initialGameState, seenQuestionHashes: new Set() }; // Reset state
                    }
                    
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        if(loadingMessage) loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen);
                        }, 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }
        
        async function loadUserData(userIdToLoad) {
            // ... (This function is largely correct, no changes needed)
            if (!userIdToLoad || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToLoad}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    console.log("User data found, loading profile for", userIdToLoad);
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                } else {
                    console.error("Profile not found for logged-in user:", userIdToLoad);
                    // This case might happen if registration fails after user creation.
                    // We should probably log them out to force re-registration.
                    handleLogout();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه");
            } finally {
                updateUI();
            }
        }

        async function saveUserData() {
            // ... (This function is largely correct, no changes needed)
            const userIdToSave = currentUserId; if (!userIdToSave || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToSave}/mafiaGameData/profile`);
            const privateData = { displayName: gameState.displayName, publicUserId: gameState.publicUserId, currentStage: gameState.currentStage, avatarUrl: gameState.avatarUrl, seenQuestionHashes: Array.from(gameState.seenQuestionHashes), lastUpdated: serverTimestamp() };
            const leaderboardDocRef = doc(db, `artifacts/${appId}/publicLeaderboard/${userIdToSave}`);
            const publicData = { displayName: gameState.displayName, publicUserId: gameState.publicUserId, currentStage: gameState.currentStage, avatarUrl: gameState.avatarUrl, lastUpdated: serverTimestamp() };
            try {
                await Promise.all([ setDoc(userDocRef, privateData, { merge: true }), setDoc(leaderboardDocRef, publicData, { merge: true }) ]);
                console.log("User data saved successfully for", userIdToSave);
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه");
            }
        }

        // --- NEW: Function to check if a display name is taken ---
        async function isDisplayNameTaken(name) {
            const nameRef = doc(db, `artifacts/${appId}/displayNames`, name.toLowerCase());
            const docSnap = await getDoc(nameRef);
            return docSnap.exists();
        }
        
        // --- All AI and Game Logic functions (callGeminiAPI, generateQuestion, etc.) remain the same ---
        // ... [Again, for brevity, omitting the exact copy of these functions] ...
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        async function callGeminiAPI(prompt, isJsonOutput = false, schema = null) { if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden'); const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`; let chatHistory = [{ role: "user", parts: [{ text: prompt }] }]; const payload = { contents: chatHistory }; if (isJsonOutput) { payload.generationConfig = { responseMimeType: "application/json" }; if (schema) { payload.generationConfig.responseSchema = schema; } } try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.text(); throw new Error(`API request failed with status ${response.status}: ${errorBody}`); } const result = await response.json(); if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts[0]) { const text = result.candidates[0].content.parts[0].text; return isJsonOutput ? JSON.parse(text) : text; } else { if (result.candidates && result.candidates[0] && result.candidates[0].finishReason) { throw new Error(`پاسخ نامعتبر از سرویس هوش مصنوعی (دلیل: ${result.candidates[0].finishReason})`); } throw new Error("پاسخ نامعتبر از سرویس هوش مصنوعی دریافت شد."); } } catch (error) { console.error("Error calling Gemini API:", error); if (!prompt.includes("offensive, hateful, or contain profanity")) { showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.<br><br><small>جزئیات خطا: ${error.message}</small>`, "باشه"); } return null; } finally { if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden'); } }
        async function generateQuestion() { if (gameState.isLoadingNextQuestion) return; gameState.isLoadingNextQuestion = true; if (questionText) questionText.textContent = "در حال تولید سوال جدید..."; if (optionsContainer) optionsContainer.innerHTML = ""; if (questionExplanation) questionExplanation.classList.add('hidden'); if (gameFeedback) gameFeedback.textContent = ""; let attempts = 0; const maxAttempts = 3; let questionData = null; while (attempts < maxAttempts) { let difficulty = "آسان"; if (gameState.currentStage > 20) { difficulty = "بسیار سخت"; } else if (gameState.currentStage > 10) { difficulty = "سخت"; } else if (gameState.currentStage > 5) { difficulty = "متوسط"; } const prompt = `شما یک طراح بازی حرفه‌ای و خلاق هستید. یک سوال چند گزینه‌ای (۴ گزینه‌ای) جدید به زبان فارسی با موضوع مافیا ایجاد کن. سطح دشواری سوال باید "${difficulty}" باشد. خروجی باید فقط و فقط یک آبجکت JSON خام با ساختار {"question": "...", "options": ["...", "...", "...", "..."], "correctAnswerIndex": 0, "explanation": "..."} باشد.`; const data = await callGeminiAPI(prompt, true); if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) { const questionHash = simpleHash(data.question); if (!gameState.seenQuestionHashes.has(questionHash)) { questionData = data; break; } else { attempts++; } } else { attempts++; } } if (questionData) { gameState.currentQuestionData = questionData; displayQuestion(); } else { if (questionText) questionText.textContent = "خطا در بارگذاری سوال."; showModal("خطا در تولید سوال", `نتوانستیم سوال جدید بسازیم. آیا می‌خواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی", () => { hideModal(); generateQuestion(); }, () => { hideModal(); if (mainScreen) showScreen(mainScreen); }); } gameState.isLoadingNextQuestion = false; gameState.isQuestionActive = true; }
        function displayQuestion() { if (!gameState.currentQuestionData || !questionText || !optionsContainer) return; const { question, options } = gameState.currentQuestionData; questionText.textContent = question; optionsContainer.innerHTML = ""; options.forEach((option, index) => { const button = document.createElement('button'); button.className = 'option-btn'; button.textContent = `${index + 1}. ${option}`; button.dataset.index = index; button.addEventListener('click', handleAnswerSelection); optionsContainer.appendChild(button); }); if(questionExplanation) questionExplanation.classList.add('hidden'); if(gameFeedback) gameFeedback.textContent = ""; gameState.isQuestionActive = true; }
        async function handleAnswerSelection(event) { if (!gameState.isQuestionActive) return; gameState.isQuestionActive = false; const selectedOptionButton = event.target.closest('.option-btn'); if (!selectedOptionButton) return; const selectedIndex = parseInt(selectedOptionButton.dataset.index); const { question, correctAnswerIndex, explanation } = gameState.currentQuestionData; optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; }); if (selectedIndex === correctAnswerIndex) { audioManager.play('correct'); selectedOptionButton.classList.add('correct'); gameFeedback.textContent = "پاسخ صحیح!"; gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#aaffaa] clash-font'; const questionHash = simpleHash(question); gameState.seenQuestionHashes.add(questionHash); gameState.currentStage++; await saveUserData(); setTimeout(() => { generateQuestion(); updateUI(); }, 2000); } else { audioManager.play('incorrect'); selectedOptionButton.classList.add('incorrect'); const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`); if (correctButton) correctButton.classList.add('correct'); gameFeedback.textContent = "پاسخ اشتباه!"; gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#ffaaaa] clash-font'; setTimeout(() => { generateQuestion(); updateUI(); }, 4000); } if (explanation && questionExplanation) { questionExplanation.textContent = `توضیح: ${explanation}`; questionExplanation.classList.remove('hidden'); } }
        async function generateMafiaFact() { const prompt = "یک حقیقت جالب در مورد دنیای مافیا به زبان فارسی بگو."; showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو...</p>", "باشه"); const fact = await callGeminiAPI(prompt); if (fact) { showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!"); } else { showModal("خطا", "نکته‌ای یافت نشد.", "باشه"); } }
        function isValidImageUrl(url) { if (!url) return false; const imageRegex = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))(?:\?.*)?$/i; return imageRegex.test(url); }
        function previewAvatarFromUrl() { if (!avatarUrlInput || !avatarPreviewImage || !avatarPreviewContainer || !avatarErrorMessage || !modalConfirmBtn) return; const url = avatarUrlInput.value.trim(); avatarErrorMessage.classList.add('hidden'); modalConfirmBtn.disabled = true; if (!isValidImageUrl(url)) { avatarErrorMessage.textContent = 'لینک وارد شده معتبر نیست.'; avatarErrorMessage.classList.remove('hidden'); avatarPreviewContainer.classList.add('hidden'); return; } avatarPreviewImage.src = url; avatarPreviewImage.onerror = () => { avatarErrorMessage.textContent = 'خطا در بارگذاری تصویر.'; avatarErrorMessage.classList.remove('hidden'); avatarPreviewContainer.classList.add('hidden'); }; avatarPreviewImage.onload = () => { avatarPreviewContainer.classList.remove('hidden'); modalConfirmBtn.disabled = false; }; }
        async function saveAvatarFromUrl() { const newUrl = avatarUrlInput.value.trim(); if (!isValidImageUrl(newUrl)) { if(avatarErrorMessage) { avatarErrorMessage.textContent = 'لینک وارد شده معتبر نیست.'; avatarErrorMessage.classList.remove('hidden'); } return; } modalConfirmBtn.disabled = true; modalCancelBtn.disabled = true; try { gameState.avatarUrl = newUrl; await saveUserData(); updateUI(); hideModal(); showModal("موفقیت", "آواتار شما با موفقیت به‌روز شد!", "عالی!"); } catch(error) { console.error("Error saving avatar URL:", error); if(avatarErrorMessage) { avatarErrorMessage.textContent = 'خطا در ذخیره سازی آواتار.'; avatarErrorMessage.classList.remove('hidden'); } } finally { if(modalConfirmBtn) modalConfirmBtn.disabled = false; if(modalCancelBtn) modalCancelBtn.disabled = false; } }
        // Leaderboard functions are also correct
        async function fetchAndDisplayLeaderboard() { if (!db || !leaderboardList) return; leaderboardList.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div><p class="mt-3 font-bold">در حال بارگذاری...</p></div>`; try { const q = query(collection(db, `artifacts/${appId}/publicLeaderboard`), orderBy("currentStage", "desc"), limit(50)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-gray-300">هنوز کسی در لیست برترین‌ها نیست.</p>`; return; } const users = []; querySnapshot.forEach(doc => users.push(doc.data())); renderLeaderboardList(users); } catch (error) { console.error("Error fetching leaderboard:", error); leaderboardList.innerHTML = `<p class="text-center py-8 font-bold text-red-300">خطا در دریافت اطلاعات.</p>`; } }
        function renderLeaderboardList(users) { if (!leaderboardList) return; leaderboardList.innerHTML = users.map((user, index) => { const rank = index + 1; const avatarSrc = user.avatarUrl || 'https://placehold.co/50x50/2a4166/ffffff?text=?'; return `<div class="leaderboard-item"><span class="leaderboard-rank">${rank}</span><img src="${avatarSrc}" alt="Avatar" class="leaderboard-avatar" onerror="this.src='https.placehold.co/50x50/2a4166/ffffff?text=?'"><div class="leaderboard-info"><div class="leaderboard-name">${user.displayName || "بی‌نام"}</div><div class="leaderboard-stage"><span>مرحله:</span><span class="leaderboard-stage-value">${user.currentStage || 1}</span></div></div></div>`; }).join(''); }

        function validateAndSanitizeName(nameValue) {
            const regex = /[^a-zA-Z0-9_.-]/g;
            const sanitizedValue = nameValue.replace(regex, '');
            const trimmedName = sanitizedValue.trim();

            if (trimmedName.length < 3) return { valid: false, message: "نام نمایشی باید حداقل ۳ کاراکتر باشد." };
            if (trimmedName.length > 20) return { valid: false, message: "نام نمایشی نمی‌تواند بیشتر از ۲۰ کاراکتر باشد." };
            return { valid: true, name: trimmedName };
        }
        
        // --- NEW: Handle Logout ---
        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the rest
                console.log("User signed out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
                showModal("خطا", "خطایی در هنگام خروج از حساب رخ داد.");
            }
        }
        
        // --- MODIFIED & NEW: Functions for new auth flow ---
        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const { valid, name: newName, message } = validateAndSanitizeName(newDisplayNameInput.value);

            if (!valid) {
                changeNameErrorMessage.textContent = message;
                changeNameErrorMessage.classList.remove('hidden');
                newDisplayNameInput.classList.add('invalid');
                return;
            }

            if (newName.toLowerCase() === gameState.displayName.toLowerCase()) {
                changeNameErrorMessage.textContent = "نام جدید باید با نام فعلی متفاوت باشد.";
                changeNameErrorMessage.classList.remove('hidden');
                newDisplayNameInput.classList.add('invalid');
                return;
            }
            
            modalConfirmBtn.disabled = true;

            try {
                // Use a transaction to ensure atomicity
                await runTransaction(db, async (transaction) => {
                    const newNameRef = doc(db, `artifacts/${appId}/displayNames`, newName.toLowerCase());
                    const newNameDoc = await transaction.get(newNameRef);

                    if (newNameDoc.exists()) {
                        throw new Error("این نام نمایشی قبلا توسط کاربر دیگری انتخاب شده است.");
                    }

                    // Get old name to delete its reference
                    const oldName = gameState.displayName;
                    const oldNameRef = doc(db, `artifacts/${appId}/displayNames`, oldName.toLowerCase());
                    
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                    const leaderboardRef = doc(db, `artifacts/${appId}/publicLeaderboard/${currentUserId}`);

                    // Perform writes
                    transaction.delete(oldNameRef);
                    transaction.set(newNameRef, { userId: currentUserId });
                    transaction.update(userProfileRef, { displayName: newName });
                    transaction.update(leaderboardRef, { displayName: newName });
                });

                gameState.displayName = newName; // Update local state
                updateUI();
                hideModal();
                showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!");

            } catch (e) {
                console.error("Transaction failed: ", e);
                changeNameErrorMessage.textContent = e.message;
                changeNameErrorMessage.classList.remove('hidden');
                newDisplayNameInput.classList.add('invalid');
            } finally {
                modalConfirmBtn.disabled = false;
            }
        }
        
        function getFirebaseErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'فرمت ایمیل وارد شده صحیح نیست.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'ایمیل یا رمز عبور وارد شده اشتباه است.';
                case 'auth/email-already-in-use': return 'این ایمیل قبلاً برای ساخت حساب استفاده شده است.';
                case 'auth/weak-password': return 'رمز عبور ضعیف است. باید حداقل ۶ کاراکتر باشد.';
                default: return 'یک خطای ناشناخته رخ داد. لطفاً دوباره تلاش کنید.';
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', (event) => { if (event.target.closest('.btn-clash:not(:disabled)')) { audioManager.play('click'); } });
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', handleModalCancel);

            // --- NEW: Auth form toggling ---
            showLoginLink.addEventListener('click', () => {
                registrationForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            showRegisterLink.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registrationForm.classList.remove('hidden');
            });

            // --- NEW: Login and Register button listeners ---
            loginBtn.addEventListener('click', async () => {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value;
                loginErrorMessage.classList.add('hidden');

                if (!email || !password) {
                    loginErrorMessage.textContent = 'لطفاً ایمیل و رمز عبور را وارد کنید.';
                    loginErrorMessage.classList.remove('hidden');
                    return;
                }
                
                loginBtn.disabled = true;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    loginErrorMessage.textContent = getFirebaseErrorMessage(error.code);
                    loginErrorMessage.classList.remove('hidden');
                    console.error("Login failed:", error);
                } finally {
                    loginBtn.disabled = false;
                }
            });

            registerBtn.addEventListener('click', async () => {
                const { valid, name: displayName, message } = validateAndSanitizeName(registerDisplayNameInput.value);
                const email = registerEmailInput.value.trim();
                const password = registerPasswordInput.value;
                const publicUserId = userIdDisplayInput.value;
                registerErrorMessage.classList.add('hidden');

                if (!valid) { registerErrorMessage.textContent = message; registerErrorMessage.classList.remove('hidden'); return; }
                if (!email || !/^\S+@\S+\.\S+$/.test(email)) { registerErrorMessage.textContent = 'لطفا یک ایمیل معتبر وارد کنید.'; registerErrorMessage.classList.remove('hidden'); return; }
                if (password.length < 6) { registerErrorMessage.textContent = 'رمز عبور باید حداقل ۶ کاراکتر باشد.'; registerErrorMessage.classList.remove('hidden'); return; }
                if (!publicUserId) { registerErrorMessage.textContent = 'لطفاً یک شناسه کاربری بسازید.'; registerErrorMessage.classList.remove('hidden'); return; }
                
                registerBtn.disabled = true;

                // --- NEW: Transactional Registration ---
                try {
                    // Step 1: Check if display name is taken BEFORE creating user
                    if (await isDisplayNameTaken(displayName)) {
                        throw { customError: true, message: "این نام نمایشی قبلا توسط کاربر دیگری انتخاب شده است." };
                    }

                    // Step 2: Create user in Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;

                    // Step 3: Create profile and name reservation in Firestore
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${newUser.uid}/mafiaGameData/profile`);
                    const leaderboardRef = doc(db, `artifacts/${appId}/publicLeaderboard/${newUser.uid}`);
                    const nameRef = doc(db, `artifacts/${appId}/displayNames`, displayName.toLowerCase());

                    const profileData = { ...initialGameState, displayName, publicUserId, lastUpdated: serverTimestamp(), avatarUrl: '' };
                    delete profileData.seenQuestionHashes; // No need to store empty set

                    await Promise.all([
                        setDoc(userProfileRef, { ...profileData, seenQuestionHashes: [] }),
                        setDoc(leaderboardRef, { displayName, publicUserId, currentStage: 1, avatarUrl: '', lastUpdated: serverTimestamp() }),
                        setDoc(nameRef, { userId: newUser.uid })
                    ]);
                    
                    // onAuthStateChanged will load the new data
                } catch (error) {
                    if (error.customError) {
                        registerErrorMessage.textContent = error.message;
                    } else {
                        registerErrorMessage.textContent = getFirebaseErrorMessage(error.code);
                    }
                    registerErrorMessage.classList.remove('hidden');
                    console.error("Registration failed:", error);
                } finally {
                    registerBtn.disabled = false;
                }
            });
            
            // Other Listeners (mostly unchanged logic, just with auth checks)
            generateUserIdBtn.addEventListener('click', () => { userIdDisplayInput.value = generateAlphanumericPublicUserId(); });
            
            logoutBtn.addEventListener('click', handleLogout);

            editNameBtn.addEventListener('click', () => { showModal( "تغییر نام", "تغییر نام در این بازی رایگان است.", "تغییر", "لغو", handleChangeDisplayName, hideModal, "changeName"); });
            
            avatarContainer.addEventListener('click', () => { showModal( "تغییر آواتار", "لینک مستقیم یک تصویر را وارد کنید.", "ذخیره", "لغو", saveAvatarFromUrl, hideModal, "avatar"); });

            if(previewAvatarBtn) { previewAvatarBtn.addEventListener('click', previewAvatarFromUrl); }
            if(avatarUrlInput) { avatarUrlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); previewAvatarFromUrl(); } }); }

            startGameBtn.addEventListener('click', () => { audioManager.play('startGame'); showModal( "شروع بازی", "پیشنهاد می‌شود از اتصال اینترنت پایدار استفاده کنید.", "ادامه", null, () => { hideModal(); showScreen(gameScreen); generateQuestion(); }); });
            mafiaFactBtn.addEventListener('click', generateMafiaFact);
            developersBtn.addEventListener('click', showDevelopersPanel);
            closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            leaderboardBtn.addEventListener('click', showLeaderboardPanel);
            closeLeaderboardPanelBtn.addEventListener('click', hideLeaderboardPanel);
            backToMainBtn.addEventListener('click', async () => { await saveUserData(); gameState.currentQuestionData = null; showScreen(mainScreen); });

            window.addEventListener('resize', updateUI);
        }
        
        async function initializeGame() {
            // --- DOM Element Querying (extensive list) ---
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            authPanel = document.getElementById('auth-panel');
            registrationForm = document.getElementById('registration-form');
            registerDisplayNameInput = document.getElementById('register-display-name-input');
            registerEmailInput = document.getElementById('register-email-input');
            registerPasswordInput = document.getElementById('register-password-input');
            registerBtn = document.getElementById('register-btn');
            registerErrorMessage = document.getElementById('register-error-message');
            loginForm = document.getElementById('login-form');
            loginEmailInput = document.getElementById('login-email-input');
            loginPasswordInput = document.getElementById('login-password-input');
            loginBtn = document.getElementById('login-btn');
            loginErrorMessage = document.getElementById('login-error-message');
            showLoginLink = document.getElementById('show-login-link');
            showRegisterLink = document.getElementById('show-register-link');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            logoutBtn = document.getElementById('logout-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            developersBtn = document.getElementById('developers-btn');
            leaderboardBtn = document.getElementById('leaderboard-btn');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarUploadUiContainer = document.getElementById('avatar-upload-ui-container');
            avatarUrlInput = document.getElementById('avatar-url-input');
            previewAvatarBtn = document.getElementById('preview-avatar-btn');
            avatarPreviewContainer = document.getElementById('avatar-preview-container');
            avatarPreviewImage = document.getElementById('avatar-preview-image');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');
            leaderboardPanelContainer = document.getElementById('leaderboard-panel-container');
            leaderboardList = document.getElementById('leaderboard-list');
            closeLeaderboardPanelBtn = document.getElementById('close-leaderboard-panel-btn');

            audioManager.init();
            if(loadingMessage) loadingMessage.textContent = "در حال آماده سازی...";

            try {
                setupEventListeners();
                await initFirebase(); // This will trigger onAuthStateChanged
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در راه اندازی بازی.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>
