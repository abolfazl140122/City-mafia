<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #c49730;
            --mouse-x: 50vw;
            --mouse-y: 50vh;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e0e0e0;
            background-color: #050507;
            overflow: hidden; /* Hide scrollbars on the body itself */
        }

        /* --- Modern Background & Spotlight Effect --- */
        .mafia-animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            overflow: hidden;
            background: #050507;
        }
        .mafia-animated-bg::before, .mafia-animated-bg::after {
            content: '';
            position: absolute;
            width: 120vmax;
            height: 120vmax;
            border-radius: 50%;
            background-image: radial-gradient(circle at center, rgba(196, 151, 48, 0.1), transparent 50%),
                                radial-gradient(circle at center, rgba(40, 50, 100, 0.1), transparent 50%);
            animation: moveGradient 25s linear infinite;
            filter: blur(80px);
        }
        .mafia-animated-bg::after {
            animation-delay: -12.5s;
            animation-direction: reverse;
        }
        
        #spotlight {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: radial-gradient(
                circle at var(--mouse-x) var(--mouse-y),
                rgba(212, 168, 64, 0.15) 0%,
                transparent 25%
            );
            transition: background 0.1s ease-out;
        }

        @keyframes moveGradient {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
        }
        
        /* --- Glassmorphism Panels --- */
        .panel {
            background-color: rgba(20, 20, 22, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(196, 151, 48, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        /* --- Modern Buttons --- */
        .btn-mafia {
            background: linear-gradient(145deg, #d4a840, #a57c1a);
            color: #111;
            border: none;
            padding: 10px 24px;
            font-size: 1rem;
            border-radius: 10px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 -2px 2px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        .btn-mafia:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(var(--glow-color), 0.3), inset 0 -1px 1px rgba(0, 0, 0, 0.1);
        }
        .btn-mafia:active {
            transform: translateY(-1px) scale(1);
        }
        .btn-mafia:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-mafia-secondary {
            background-color: rgba(30, 30, 30, 0.3);
            color: #c49730;
            border: 1px solid #c49730;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .btn-mafia-secondary:hover {
            background-color: rgba(196, 151, 48, 0.2);
            color: #e0e0e0;
            box-shadow: 0 0 15px rgba(196, 151, 48, 0.4);
            transform: translateY(-2px);
        }

        /* --- Modern Inputs --- */
        .input-mafia {
            background-color: rgba(10, 10, 12, 0.7);
            border: 1px solid rgba(196, 151, 48, 0.3);
            color: #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .input-mafia:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 15px rgba(var(--glow-color), 0.5);
        }
        .input-mafia.invalid {
            border-color: #e53e3e;
            box-shadow: 0 0 10px rgba(229, 62, 62, 0.5);
        }
        .input-mafia::placeholder {
            color: #718096;
        }

        /* --- Option Buttons in Game --- */
        .option-btn {
            background-color: rgba(30, 30, 30, 0.5);
            border: 1px solid rgba(196, 151, 48, 0.3);
            color: #e0e0e0;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 8px;
        }
        .option-btn:hover:not(:disabled) {
            background-color: rgba(196, 151, 48, 0.1);
            border-color: rgba(196, 151, 48, 0.7);
            transform: scale(1.02);
        }
        .option-btn.correct { background: linear-gradient(45deg, #1f7d3d, #28a745) !important; border-color: #38c172 !important; color: white !important; }
        .option-btn.incorrect { background: linear-gradient(45deg, #b02a37, #dc3545) !important; border-color: #e3342f !important; color: white !important; }
        .option-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .loader {
            border: 6px solid #444;
            border-top: 6px solid var(--glow-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite, pulse 1.5s ease-in-out infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--glow-color), 0.4); } 70% { box-shadow: 0 0 0 15px rgba(var(--glow-color), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--glow-color), 0); } }
        
        /* --- Screens & Layout --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
        }
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin: auto;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: center;
        }
        #main-screen .screen-content-wrapper {
             justify-content: space-between;
        }

        /* --- Main Title --- */
        #main-title {
            font-size: 3.5rem;
            font-weight: 800;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            background: linear-gradient(125deg, #f5dca8, #c49730, #e0a938);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-fill-color: transparent;
            padding: 1rem 0;
        }
        @media (min-width: 768px) { #main-title { font-size: 5rem; } }

        /* --- User Profile Area --- */
        #user-profile-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        #user-info-box {
            background-color: rgba(20, 20, 22, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 15px;
            border: 1px solid rgba(196, 151, 48, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info-item {
            background: none;
            padding: 0;
            border: none;
        }
        #avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--glow-color);
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(var(--glow-color), 0.5);
            transition: transform 0.3s ease;
        }
        #avatar-container:hover {
            transform: scale(1.1);
        }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }

        /* --- General Helper Classes --- */
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: var(--glow-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>
    <div id="spotlight"></div>

    <div id="user-profile-area" class="hidden">
        <div id="user-info-box" class="panel panel-hidden">
            <div id="avatar-container" title="تغییر آواتار">
                <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
            </div>
            <div>
                 <div id="display-name-output-box" class="user-info-item">
                    <div id="display-name-output-container" class="flex items-center gap-2">
                        <div id="display-name-output" class="text-lg font-bold value"></div>
                        <span id="edit-name-btn" title="تغییر نام" class="cursor-pointer text-xl text-yellow-400 hover:text-yellow-200 transition-colors">✏️</span>
                    </div>
                </div>
                <div id="public-user-id-output-box" class="user-info-item">
                    <div class="text-xs text-gray-400 label">شناسه:</div>
                    <div id="public-user-id-output" class="value font-mono text-gray-400"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active">
        <div class="screen-content-wrapper items-center">
            <h1 class="text-4xl font-bold mb-6 text-yellow-300">بارگذاری بازی مافیا...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-xl text-gray-300">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
             <header class="text-center pt-8">
                 <h1 id="main-title">شهر مافیا</h1>
             </header>

            <div id="registration-form-container" class="w-full max-w-md mx-auto">
                 <div id="registration-form" class="panel panel-visible p-6 rounded-2xl">
                    <h2 class="text-2xl font-semibold mb-5 text-center text-yellow-300">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1" maxlength="20">
                    <p id="input-error-message" class="text-red-400 text-sm h-6"></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-2">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-3">
                            <input type="text" id="user-id-display" class="input-mafia w-full text-center tracking-widest" readonly placeholder="---">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-4 py-2.5">ساخت شناسه</button>
                        </div>
                        <p id="user-id-error-message" class="text-red-400 text-sm h-6"></p>
                    </div>

                    <button id="register-btn" class="btn-mafia w-full py-3 text-lg mt-4">ورود به شهر</button>
                </div>
            </div>

            <footer id="main-screen-buttons-layout" class="pb-4 hidden">
                <div id="top-action-buttons" class="flex justify-center items-center gap-4">
                    <button id="start-game-btn" class="btn-mafia text-xl py-4 px-8">شروع بازی</button>
                    <button id="mafia-fact-btn" class="btn-mafia-secondary">دانستنی‌های مافیا ✨</button>
                    <button id="dev-intro-icon-btn-header" class="btn-mafia-secondary" title="معرفی توسعه دهندگان">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M17 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start py-6">
            <div class="flex justify-between items-center mb-6 p-3 panel rounded-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">⟵ بازگشت</button>
                <div class="text-lg">مرحله: <span id="stage-display" class="font-bold text-yellow-300 text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel p-6 rounded-2xl mb-6 min-h-[250px] flex flex-col justify-center">
                <p id="question-text" class="text-2xl md:text-3xl mb-8 text-center leading-relaxed">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="question-explanation" class="text-sm mt-6 text-gray-300 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-12"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-base mt-2">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel p-8 rounded-2xl max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-5 text-yellow-300">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-4 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-mafia w-full" maxlength="20">
                    <p id="change-name-error-message" class="text-red-400 text-sm h-6"></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">ساخت آواتار جدید با AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">در حال ساخت آواتار... (ممکن است طول بکشد)</p>
                    </div>
                    <div id="avatar-suggestions-container" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4 max-h-60 overflow-y-auto"></div>
                    <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-6">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>
    
    <div id="developers-panel-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 panel-hidden z-[51]">
         <!-- Same developers panel HTML as before -->
    </div>

    <script type="module">
        // The entire JavaScript logic remains THE SAME as the previous step.
        // No changes are needed in the <script> block.
        // You can copy-paste the script from the previous response.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
        };

        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationFormContainer, registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            screenElement.classList.add('active');
            updateUI();
        }

        function showPanel(panel) {
            if (!panel) return;
            panel.classList.remove('panel-hidden');
            panel.classList.add('panel-visible');
        }

        function hidePanel(panel) {
            if (!panel) return;
            panel.classList.add('panel-hidden');
            panel.classList.remove('panel-visible');
        }


        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalContainer || !modalTitle) return;
            
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            
            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.textContent = '';
                newDisplayNameInput.classList.remove('invalid');
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                avatarSuggestionsContainer.innerHTML = '';
                avatarErrorMessage.textContent = '';
                avatarAiLoading.classList.add('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            modalCancelBtn.classList.toggle('hidden', !(cancelText || modalType === "changeName" || modalType === "avatar"));
            if (!modalCancelBtn.classList.contains('hidden')) {
                modalCancelBtn.textContent = cancelText || "لغو";
            }

            showPanel(modalContainer.querySelector('.panel'));
            modalContainer.classList.remove('panel-hidden');
        }

        function hideModal() {
            if (!modalContainer) return;
            hidePanel(modalContainer.querySelector('.panel'));
            modalContainer.classList.add('panel-hidden');
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                modalConfirmCallback();
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                modalCancelCallback();
            }
            hideModal();
        }
        
        // Spotlight Effect JS
        const spotlight = document.getElementById('spotlight');
        if (spotlight) {
             document.addEventListener('mousemove', (e) => {
                requestAnimationFrame(() => {
                    document.documentElement.style.setProperty('--mouse-x', e.clientX + 'px');
                    document.documentElement.style.setProperty('--mouse-y', e.clientY + 'px');
                });
            });
        }

        function updateUI() {
            if (displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان";
            if (publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if (stageDisplay) stageDisplay.textContent = gameState.currentStage;
            if (avatarImage) {
                avatarImage.src = gameState.avatarUrl || `https://placehold.co/80x80/333333/777777?text=?`;
            }

            const isLoggedIn = isAuthReady && gameState.displayName && gameState.publicUserId;
            
            if (isLoggedIn) {
                hidePanel(registrationFormContainer);
                mainScreenButtonsLayout.classList.remove('hidden');
                userProfileArea.classList.remove('hidden');
                showPanel(userInfoBox);
            } else {
                showPanel(registrationFormContainer);
                mainScreenButtonsLayout.classList.add('hidden');
                userProfileArea.classList.add('hidden');
                hidePanel(userInfoBox);
            }
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        await signInAnonymously(auth);
                        gameState.displayName = '';
                        gameState.publicUserId = '';
                        gameState.avatarUrl = '';
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen.classList.contains('active')) {
                        loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => showScreen(mainScreen), 800);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
            }
        }

        async function loadUserData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                } else {
                    // New user, defaults are already set
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه");
            }
        }
        
        async function saveUserData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه");
            }
        }

        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";
        
        async function callGeminiAPI(prompt, isJsonOutput = false) {
            aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJsonOutput) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Invalid AI response.");
                return isJsonOutput ? JSON.parse(text) : text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. از خاموش بودن فیلترشکن مطمئن شوید.`, "باشه");
                return null;
            } finally {
                aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function callImagenAPI(prompt, sampleCount = 4) {
             avatarAiLoading.classList.remove('hidden');
             avatarErrorMessage.textContent = '';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;
             const payload = { instances: [{ prompt }], parameters: { sampleCount } };
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                const result = await response.json();
                if (result.predictions?.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                }
                throw new Error("Invalid image response.");
            } catch (error) {
                console.error("Imagen API Error:", error);
                avatarErrorMessage.textContent = "خطا در ساخت آواتار.";
                return null;
            } finally {
                avatarAiLoading.classList.add('hidden');
            }
        }

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            questionText.textContent = "در حال تولید سوال جدید...";
            optionsContainer.innerHTML = "";
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            
            const prompt = `یک سوال چند گزینه ای با موضوع مافیا (تاریخچه، فیلم ها، اصطلاحات، یا سناریوهای مرتبط با مافیا) به زبان فارسی ایجاد کن. پاسخ شما باید فقط و فقط یک آبجکت JSON خام باشد و هیچ چیز دیگری در پاسخ نباشد. ساختار JSON باید دقیقا به این صورت باشد: { "question": "متن سوال به فارسی", "options": ["گزینه ۱", "گزینه ۲", "گزینه ۳", "گزینه ۴"], "correctAnswerIndex": 0, "explanation": "توضیح مختصر در مورد پاسخ صحیح به فارسی" }`;

            try {
                const data = await callGeminiAPI(prompt, true);
                if (data?.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    gameState.currentQuestionData = data;
                    displayQuestion();
                } else {
                    throw new Error("Invalid question structure from AI.");
                }
            } catch (error) {
                console.error("Error generating question:", error);
                questionText.textContent = "خطا در بارگذاری سوال.";
                showModal("خطا در سوال", `مشکلی در تولید سوال جدید پیش آمد. آیا میخواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); showScreen(mainScreen); }
                );
            } finally {
                gameState.isLoadingNextQuestion = false;
                gameState.isQuestionActive = true;
            }
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            gameState.isQuestionActive = true;
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive) return;
            gameState.isQuestionActive = false;

            const selectedBtn = event.target.closest('.option-btn');
            const selectedIndex = parseInt(selectedBtn.dataset.index);
            const { correctAnswerIndex, explanation } = gameState.currentQuestionData;
            
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if(parseInt(btn.dataset.index) === correctAnswerIndex) btn.classList.add('correct');
            });

            if (selectedIndex === correctAnswerIndex) {
                selectedBtn.classList.add('correct');
                gameFeedback.textContent = "پاسخ صحیح!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-12 text-green-400';
                gameState.currentStage++;
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedBtn.classList.add('incorrect');
                const tauntPrompt = `شما یک رئیس مافیای شوخ طبع هستید. بازیکن به یک سوال پاسخ اشتباه داده است. یک طعنه کوتاه و بامزه (۱ تا ۲ جمله) به زبان فارسی بگویید.`;
                const taunt = await callGeminiAPI(tauntPrompt);
                gameFeedback.innerHTML = taunt || "پاسخ اشتباه!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-12 text-red-400';
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            if (explanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }
        
        async function generateAndDisplayAvatars() {
            const prompt = "Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons";
            const suggestions = await callImagenAPI(prompt, 4);
            avatarSuggestionsContainer.innerHTML = '';
            selectedAvatarForConfirmation = null;
            if (suggestions?.length > 0) {
                suggestions.forEach(base64Url => {
                    const img = document.createElement('img');
                    img.src = base64Url;
                    img.className = 'w-full h-full object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-yellow-400 transition-all';
                    img.addEventListener('click', () => {
                        avatarSuggestionsContainer.querySelectorAll('img').forEach(i => i.classList.remove('border-green-500', 'scale-105'));
                        img.classList.add('border-green-500', 'scale-105');
                        selectedAvatarForConfirmation = base64Url;
                        modalConfirmBtn.disabled = false;
                    });
                    avatarSuggestionsContainer.appendChild(img);
                });
                modalConfirmBtn.textContent = "انتخاب آواتار";
                modalConfirmBtn.disabled = true;
            } else {
                avatarErrorMessage.textContent = "ساخت آواتار ممکن نشد. دوباره تلاش کنید.";
            }
        }
        
        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("موفقیت", "آواتار شما با موفقیت تغییر کرد!", "عالی!");
            }
        }

        function validateAndSanitizeName(name, errorEl, inputEl) {
            const sanitized = name.replace(/[^a-zA-Z0-9_.-]/g, '');
            if (name !== sanitized) inputEl.value = sanitized;
            const trimmed = sanitized.trim();
            if (trimmed.length < 3) {
                errorEl.textContent = "نام باید حداقل ۳ کاراکتر باشد.";
                inputEl.classList.add('invalid');
                return null;
            }
            errorEl.textContent = '';
            inputEl.classList.remove('invalid');
            return trimmed;
        }
        
        async function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName || newName === gameState.displayName) {
                if(newName === gameState.displayName) changeNameErrorMessage.textContent = "نام جدید باید متفاوت باشد.";
                return;
            }
            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!");
        }

        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب و کوتاه (۲-۴ جمله) در مورد دنیای مافیا به زبان فارسی برای من تعریف کن.";
            showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو...</p>", "باشه", null, hideModal);
            const fact = await callGeminiAPI(prompt);
            if (fact) {
                showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!", null, hideModal);
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            return Array(length).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]).join('');
        }
        
        function setupEventListeners() {
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', handleModalCancel);

            registerBtn.addEventListener('click', async () => {
                const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                const isPublicIdValid = !!gameState.publicUserId;
                if (!isPublicIdValid) userIdErrorMessage.textContent = "لطفاً ابتدا شناسه بسازید.";
                if (!validatedName || !isPublicIdValid) return;
                gameState.displayName = validatedName;
                await saveUserData();
                updateUI();
            });

            generateUserIdBtn.addEventListener('click', () => {
                gameState.publicUserId = generateAlphanumericPublicUserId();
                userIdDisplayInput.value = gameState.publicUserId;
                userIdErrorMessage.textContent = '';
            });

            editNameBtn.addEventListener('click', () => showModal("تغییر نام نمایشی", "تغییر نام رایگان است.", "تغییر نام", "لغو", handleChangeDisplayName, hideModal, "changeName"));
            avatarContainer.addEventListener('click', () => showModal("تغییر آواتار", "", "انتخاب", "لغو", confirmAvatarSelection, hideModal, "avatar"));
            generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);
            
            const actionButtons = [startGameBtn, mafiaFactBtn, devIntroBtnHeader];
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!gameState.displayName) {
                        e.stopPropagation();
                        showModal("ثبت نام لازم است", "برای دسترسی به این بخش، ابتدا ثبت نام خود را کامل کنید.", "باشه");
                    }
                }, true);
            });
            
            startGameBtn.addEventListener('click', () => {
                if(!gameState.displayName) return;
                showModal("شروع بازی", "برای تجربه بهتر، از فیلترشکن آمریکا استفاده کنید.", "متوجه شدم", null, () => {
                    hideModal();
                    showScreen(gameScreen);
                    generateQuestion();
                });
            });

            mafiaFactBtn.addEventListener('click', () => gameState.displayName && generateMafiaFact());
            // devIntroBtnHeader listener will be added later for its own panel
            
            backToMainBtn.addEventListener('click', async () => {
                await saveUserData();
                gameState.currentQuestionData = null;
                showScreen(mainScreen);
            });
            
            window.addEventListener('resize', updateUI);
        }

        function initializeGame() {
            // Assign all element variables
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            registrationFormContainer = document.getElementById('registration-form-container');
            registrationForm = document.getElementById('registration-form');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');
            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            devIntroBtnHeader = document.getElementById('dev-intro-icon-btn-header');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarGenerationContainer = document.getElementById('avatar-generation-container');
            generateAvatarBtn = document.getElementById('generate-avatar-btn');
            avatarAiLoading = document.getElementById('avatar-ai-loading');
            avatarSuggestionsContainer = document.getElementById('avatar-suggestions-container');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            // closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');

            if (!navigator.onLine) {
                showModal("عدم اتصال", "لطفاً اتصال اینترنت خود را بررسی کنید.", "تلاش مجدد", null, () => navigator.onLine && location.reload());
                return;
            }
            
            setupEventListeners();
            initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>