<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا - نسخه سایبری</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-blue-bg: #050d2e;
            --mid-blue-panel: rgba(15, 22, 60, 0.92);
            --primary-glow: #00f5d4; /* Cyan */
            --secondary-glow: #f72585; /* Magenta */
            --text-primary: #e0f7fa;
            --text-secondary: #a7d9e4;
            --error-color: #ff4d4d;
            --success-color: #00ff9f;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--text-primary);
            background-color: var(--dark-blue-bg);
            overflow-x: hidden;
        }

        .mafia-animated-bg {
            background: radial-gradient(circle at center, rgba(30, 10, 60, 0.3) 0%, rgba(10, 5, 25, 1) 70%), 
                        linear-gradient(300deg, #1d2b64, #f8cdda, #00f5d4, #050d2e);
            background-size: 250% 250%;
            animation: gradientAnimation 25s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .panel {
            background-color: var(--mid-blue-panel);
            border: 1px solid var(--primary-glow);
            backdrop-filter: blur(8px);
            box-shadow: 0 0 20px rgba(0, 245, 212, 0.3), inset 0 0 10px rgba(0, 245, 212, 0.2);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            border-radius: 8px;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        .btn-mafia {
            background-color: var(--secondary-glow);
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 6px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px var(--secondary-glow), 0 0 15px var(--secondary-glow), inset 0 0 5px rgba(255,255,255,0.4);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        @media (min-width: 640px) {
            .btn-mafia {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
        .btn-mafia:hover {
            background-color: #ff45a1;
            box-shadow: 0 0 12px var(--secondary-glow), 0 0 25px var(--secondary-glow), inset 0 0 8px rgba(255,255,255,0.5);
            transform: translateY(-2px) scale(1.02);
        }
        .btn-mafia:disabled {
            background-color: #7d1343;
            color: #a8a8a8;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-mafia-secondary {
            background-color: transparent;
            color: var(--primary-glow);
            border: 2px solid var(--primary-glow);
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 5px var(--primary-glow);
        }
        @media (min-width: 640px) {
            .btn-mafia-secondary {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        .btn-mafia-secondary:hover {
            background-color: rgba(0, 245, 212, 0.1);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--primary-glow), 0 0 15px var(--primary-glow);
        }

        .input-mafia {
            background-color: rgba(5, 13, 46, 0.8);
            border: 1px solid var(--primary-glow);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 10px;
            font-size: 1rem;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        @media (max-width: 639px) {
            .input-mafia {
                font-size: 0.9rem;
                padding: 8px;
            }
        }
        .input-mafia:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 245, 212, 0.7);
            border-color: #6efff1;
        }
        .input-mafia.invalid {
            border-color: var(--error-color);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }
        .input-mafia:read-only {
            background-color: rgba(5, 13, 46, 0.5);
            cursor: default;
        }

        .option-btn {
            background-color: rgba(36, 47, 94, 0.8);
            border: 1px solid var(--primary-glow);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 4px;
        }
        @media (min-width: 768px) {
            .option-btn { font-size: 1rem; padding: 12px; }
        }
        .option-btn:hover:not(:disabled) {
            background-color: rgba(50, 65, 130, 0.9);
            transform: scale(1.02);
            box-shadow: 0 0 8px var(--primary-glow);
        }
        .option-btn.correct { background-color: var(--success-color) !important; border-color: #00ff9f !important; color: var(--dark-blue-bg) !important; font-weight: bold; }
        .option-btn.incorrect { background-color: var(--error-color) !important; border-color: #ff4d4d !important; color: #fff !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .loader {
            border: 8px solid rgba(0, 245, 212, 0.2);
            border-top: 8px solid var(--primary-glow);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @media (min-width: 640px) {
            .loader { width: 60px; height: 60px; }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark-blue-bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary-glow); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5ffff1; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh;
            padding: 10px; box-sizing: border-box; opacity: 0; visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex; flex-direction: column; align-items: center; overflow-y: auto;
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { justify-content: center; }
        .screen.active { opacity: 1; visibility: visible; position: relative; z-index: 1; }
        
        .screen-content-wrapper {
            width: 100%; max-width: 800px; margin-left: auto; margin-right: auto;
            padding-bottom: 10px; position: relative; z-index: 2;
            display: flex; flex-direction: column; flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between; min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling - Futuristic HUD */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: flex-start;
            gap: 10px; transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) {
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) {
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: var(--mid-blue-panel);
            border: 1px solid var(--primary-glow);
            padding: 8px 10px; box-shadow: 0 0 15px rgba(0, 245, 212, 0.3);
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            width: max-content; min-width: 0;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
        }
        @media (min-width: 768px) {
            #user-info-box {
                flex-direction: column; align-items: stretch; gap: 10px;
                border-width: 1px; padding: 12px 15px; min-width: 180px; max-width: 200px;
                clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
            }
        }
        #user-info-box.hidden, #avatar-container.hidden {
            opacity: 0; transform: translateY(-20px); pointer-events: none;
        }
        @media (max-width: 767px) { #user-info-box.hidden { transform: translateX(-50%) translateY(-20px); } }

        .user-info-item {
            background-color: rgba(5, 13, 46, 0.7); padding: 4px 7px;
            border-radius: 2px; border-left: 0px solid var(--secondary-glow);
            display: flex; align-items: center; gap: 4px;
        }
        @media (min-width: 768px) {
            .user-info-item { padding: 6px 10px; border-radius: 4px; border-left-width: 3px; display: block; }
        }
        .user-info-item .label { font-size: 0.7em; color: var(--text-secondary); margin-bottom: 0; }
        @media (min-width: 768px) { .user-info-item .label { font-size: 0.85em; margin-bottom: 1px; } }
        .user-info-item .value { font-size: 0.85em; font-weight: bold; font-family: 'Rajdhani', sans-serif; }
        @media (min-width: 768px) { .user-info-item .value { font-size: 1em; } }

        #display-name-output-container { display: flex; align-items: center; gap: 6px; }
        @media (max-width: 767px) { #display-name-output-container { flex-direction: row-reverse; } }
        
        #edit-name-btn { cursor: pointer; font-size: 0.85em; color: var(--primary-glow); transition: color 0.3s ease, text-shadow 0.3s ease; }
        #edit-name-btn:hover { color: #fff; text-shadow: 0 0 5px var(--primary-glow); }
        @media (min-width: 768px) { #edit-name-btn { font-size: 0.95em; } }
        
        #display-name-output-box .value { color: var(--text-primary); text-shadow: 0 0 5px var(--primary-glow); }
        #public-user-id-output-box .value { color: var(--text-secondary); font-family: 'Rajdhani', monospace; font-size: 1.1em; letter-spacing: 1px; }

        #avatar-container {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary-glow);
            background-color: var(--dark-blue-bg); cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 245, 212, 0.5);
        }
        #avatar-container:hover {
             box-shadow: 0 0 15px rgba(0, 245, 212, 0.8), 0 0 25px rgba(0, 245, 212, 0.5);
             transform: scale(1.05);
        }
        @media (min-width: 768px) {
            #avatar-container { width: 70px; height: 70px; margin-right: 10px; }
        }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        #avatar-placeholder-icon { font-size: 1.8rem; color: #777; }
        @media (min-width: 768px) { #avatar-placeholder-icon { font-size: 2.2rem; } }

        #avatar-suggestions-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px; margin-top: 15px; max-height: 300px; overflow-y: auto;
        }
        .avatar-suggestion-item {
            width: 100px; height: 100px; border-radius: 4px; border: 2px solid transparent;
            cursor: pointer; overflow: hidden; transition: all 0.3s ease;
        }
        .avatar-suggestion-item:hover { border-color: var(--primary-glow); transform: scale(1.05); }
        .avatar-suggestion-item.selected {
            border-color: var(--success-color);
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.7);
        }

        /* Main Screen Header Styling */
        #main-screen-header {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
            padding-top: 0.5rem; padding-bottom: 1rem; margin-bottom: 1rem;
        }
        @media (min-width: 768px) { #main-screen-header { padding-top: 1rem; } }

        #main-title {
            text-align: center; flex-grow: 1; font-family: 'Rajdhani', sans-serif;
            font-size: 2.5rem; font-weight: bold; color: var(--text-primary);
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--primary-glow), 0 0 35px var(--primary-glow), 0 0 40px var(--primary-glow);
            margin-right: auto; margin-left: auto;
        }
        @media (min-width: 640px) { #main-title { font-size: 3.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 4.5rem; } }

        #dev-intro-icon-btn-header {
            background-color: transparent; color: var(--primary-glow);
            border: 2px solid var(--primary-glow); padding: 0.5rem; border-radius: 50%;
            font-weight: bold; transition: all 0.3s ease; box-shadow: 0 0 8px rgba(0, 245, 212, 0.5);
            display: inline-flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; flex-shrink: 0;
        }
        #dev-intro-icon-btn-header:hover {
            background-color: rgba(0, 245, 212, 0.1); color: #fff; border-color: #fff;
            box-shadow: 0 0 12px rgba(0, 245, 212, 0.8), 0 0 20px rgba(0, 245, 212, 0.5);
            transform: scale(1.1);
        }
        #dev-intro-icon-btn-header svg { width: 20px; height: 20px; }
        @media (min-width: 640px) {
            #dev-intro-icon-btn-header { width: 44px; height: 44px; padding: 0.6rem; }
            #dev-intro-icon-btn-header svg { width: 22px; height: 22px; }
        }

        /* Bottom Action Buttons Layout */
        #main-screen-buttons-layout {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; margin-top: auto; padding-top: 1rem;
        }
        #top-action-buttons {
            display: flex; flex-wrap: wrap; justify-content: center;
            align-items: center; gap: 0.75rem; width: 100%; padding-bottom: 5px;
        }
        @media (min-width: 640px) { #top-action-buttons { gap: 1rem; flex-wrap: nowrap; } }
        
        #start-game-btn { order: 0; } /* Keep as primary */

        /* Error Message Styles */
        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: var(--error-color); font-size: 0.8rem; text-align: right; min-height: 1.2rem;
            margin-top: 0.25rem; margin-bottom: 0.5rem;
            text-shadow: 0 0 5px var(--error-color);
        }
        @media (min-width: 640px) { #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error { font-size: 0.875rem; } }
        .hidden { display: none !important; }

        /* Styles for Developers Panel */
        #developers-panel-container { background-color: rgba(5, 13, 46, 0.85); backdrop-filter: blur(10px); }
        #developers-panel {
            background: var(--mid-blue-panel);
            border: 1px solid var(--primary-glow);
            box-shadow: 0 0 35px rgba(0, 245, 212, 0.4), inset 0 0 15px rgba(0, 245, 212, 0.2);
            max-height: 85vh; overflow-y: auto; border-radius: 12px;
        }
        #close-developers-panel-btn {
            position: absolute; top: 15px; right: 15px; width: 34px; height: 34px;
            background-color: rgba(247, 37, 133, 0.8); color: #fff; border-radius: 50%;
            border: none; display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: bold; line-height: 1; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 0 10px var(--secondary-glow); z-index: 10;
        }
        #close-developers-panel-btn:hover {
            background-color: var(--secondary-glow); transform: scale(1.1) rotate(180deg);
            box-shadow: 0 0 15px var(--secondary-glow), 0 0 25px var(--secondary-glow);
        }
        .developer-item {
            background-color: rgba(5, 13, 46, 0.8); padding: 1rem 1.2rem;
            border-radius: 4px; border-left: 4px solid var(--primary-glow);
            transition: all 0.3s ease; text-align: right; margin-bottom: 1rem;
        }
        .developer-item:last-child { margin-bottom: 0; }
        .developer-item:hover {
            transform: translateX(-5px);
            background-color: rgba(15, 22, 60, 1);
            border-left-color: #fff;
            box-shadow: 5px 0 15px rgba(0, 245, 212, 0.3);
        }
        .dev-header {
            display: flex; align-items: center; margin-bottom: 0.6rem;
            border-bottom: 1px solid rgba(0, 245, 212, 0.2); padding-bottom: 0.6rem;
        }
        .dev-role-icon { font-size: 1.7em; color: var(--primary-glow); margin-left: 10px; width: 28px; text-align: center; line-height: 1; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; }
        .dev-username {
            color: var(--secondary-glow); font-family: 'Rajdhani', monospace;
            font-weight: bold; font-size: 1.25rem; display: block;
            margin-bottom: 0.5rem; margin-top: 0.2rem;
            text-shadow: 0 0 4px var(--secondary-glow);
        }
        .dev-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.65; }

    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>

    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/050d2e/a7d9e4?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/050d2e/a7d9e4?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label">AGENT:</div>
                <div id="display-name-output-container">
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label">USER ID:</div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6" style="color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">بارگذاری سیستم...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl text-gray-300">برقراری اتصال امن...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <button id="dev-intro-icon-btn-header" title="معرفی توسعه دهندگان">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                    <h1 id="main-title">شهر مافیا</h1>
                    <div style="width: 40px; flex-shrink: 0;"></div>
                </div>

                <div id="registration-form" class="mb-4 panel panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center" style="color: var(--primary-glow);">ورود به شبکه</h2>
                    <input type="text" id="display-name-input" placeholder="کد ایجنت (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="input-error-message" class=""></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-1">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-mafia w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="ایجاد شناسه">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm">ایجاد</button>
                        </div>
                        <p id="user-id-error-message" class=""></p>
                    </div>

                    <button id="register-btn" class="btn-mafia w-full p-2 sm:p-3 text-base sm:text-lg mt-3">اتصال به سیستم</button>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons" class="">
                    <button id="start-game-btn" class="btn-mafia">شروع عملیات</button>
                    <button id="mafia-fact-btn" class="btn-mafia-secondary" style="order: 1;">داده‌های محرمانه ✨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-2 sm:p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-sm sm:text-base md:text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">بازگشت ⟵</button>
                <div>مرحله: <span id="stage-display" class="font-bold" style="color: var(--primary-glow);">1</span></div>
            </div>

            <div id="question-container" class="panel panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[150px] sm:min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed">دریافت ماموریت...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                <p id="question-explanation" class="text-xs sm:text-sm mt-3 sm:mt-4 text-gray-400 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-8"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-3 sm:mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-sm sm:text-base">پردازش اطلاعات توسط هوش مصنوعی...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-3 sm:p-4 panel-hidden z-50" style="backdrop-filter: blur(5px);">
        <div class="panel panel-visible p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4" style="color: var(--primary-glow); text-shadow: 0 0 8px var(--primary-glow);">هشدار سیستم</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-2 sm:mb-3 text-sm sm:text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="کد ایجنت جدید (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="change-name-error-message" class=""></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">تولید آواتار با هوش مصنوعی</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">در حال ساخت چهره‌های پیشنهادی... (ممکن است زمان‌بر باشد)</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                    <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-3 sm:gap-4 mt-4">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>

    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-developers-panel-btn">×</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center" style="color:var(--primary-glow); text-shadow: 0 0 8px var(--primary-glow);">تیم توسعه</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💻</span>
                        <h4 class="dev-role">معمار سیستم</h4>
                    </div>
                    <p class="dev-username">abolfazl1401</p>
                    <p class="dev-description">توسعه‌دهنده اصلی و طراح منطق مرکزی بازی شهر مافیا.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">🎨</span>
                        <h4 class="dev-role">طراح رابط بصری</h4>
                    </div>
                    <p class="dev-username">Vahid</p>
                    <p class="dev-description">خالق هویت بصری، طراح رابط کاربری (UI) و تجربه کاربری (UX) سیستم.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💡</span>
                        <h4 class="dev-role">استراتژیست محتوا</h4>
                    </div>
                    <p class="dev-username">Ali.k</p>
                    <p class="dev-description">ایده‌پرداز مراحل، چالش‌ها و روایت داستانی در دنیای سایبری مافیا.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">☁️</span>
                        <h4 class="dev-role">مهندس زیرساخت</h4>
                    </div>
                    <p class="dev-username">Neda_Tech</p>
                    <p class="dev-description">متخصص پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">⚙️</span>
                        <h4 class="dev-role">مهندس زیرساخت</h4>
                    </div>
                    <p class="dev-username">SinaCloud</p>
                    <p class="dev-description">مسئول بهینه‌سازی شبکه و مدیریت پایگاه داده برای تجربه‌ای بدون تاخیر.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">🚀</span>
                        <h4 class="dev-role">مهندس DevOps</h4>
                    </div>
                    <p class="dev-username">ParsaDevOps</p>
                    <p class="dev-description">متمرکز بر فرآیندهای استقرار خودکار و مانیتورینگ عملکرد سرورها.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // The entire JavaScript code remains unchanged as the request was for a graphical overhaul.
        // All class names and IDs used by this script are preserved in the new CSS.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(),
        };

        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');

            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflow = isControllingOverflow ? 'hidden' : 'auto';

            screenElement.scrollTop = 0;
            updateUI();
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) {
                console.error("[showModal] Modal elements not found, cannot show modal.");
                return;
            }

            modalTitle.textContent = title;

            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');

            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName;
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = '';
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                if(avatarSuggestionsContainer) avatarSuggestionsContainer.innerHTML = '';
                if(avatarErrorMessage) avatarErrorMessage.textContent = '';
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "لغو";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
            modalContainer.classList.add('panel-visible');
        }

        function hideModal() {
            if (!modalContainer || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer) {
                return;
            }
            modalContainer.classList.add('panel-hidden');
            modalContainer.classList.remove('panel-visible');
            modalConfirmCallback = null;
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            modalMessage.classList.add('hidden');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') &&
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("[handleModalConfirm] Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) {
                    console.error("[handleModalCancel] Error in modal cancel callback:", e);
                }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.add('panel-hidden');
            developersPanelContainer.classList.remove('panel-visible');
             if(userProfileArea && mainScreen && mainScreen.classList.contains('active') &&
               (!modalContainer || modalContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/050d2e/a7d9e4?text=?`;
            }

            let showRegistration = true;
            let showActionButtons = false;
            let showUserInfoAndAvatar = false;

            if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                showRegistration = false;
                showActionButtons = true;
                if (mainScreen && mainScreen.classList.contains('active')) {
                    showUserInfoAndAvatar = true;
                }
            } else if (isAuthReady && (!gameState.displayName || !gameState.publicUserId)) {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            } else {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            }

            if(registrationForm){
                if (showRegistration) {
                    registrationForm.classList.remove('panel-hidden');
                    registrationForm.classList.add('panel-visible');
                } else {
                    registrationForm.classList.add('panel-hidden');
                    registrationForm.classList.remove('panel-visible');
                }
            }

            if(mainScreenButtonsLayout){
                if (showActionButtons) {
                    mainScreenButtonsLayout.classList.remove('hidden');
                } else {
                    mainScreenButtonsLayout.classList.add('hidden');
                }
            }

            if(userProfileArea){
                const isAnyPanelVisible = (modalContainer && modalContainer.classList.contains('panel-visible')) ||
                                        (developersPanelContainer && developersPanelContainer.classList.contains('panel-visible'));
                if (showUserInfoAndAvatar && !isAnyPanelVisible) {
                    userProfileArea.classList.remove('profile-area-hidden');
                    userProfileArea.classList.remove('hidden');
                    if(avatarContainer){
                        if(window.innerWidth >= 768) {
                            avatarContainer.classList.remove('hidden');
                        } else {
                            avatarContainer.classList.add('hidden');
                        }
                    }
                    if(userInfoBox) userInfoBox.classList.remove('hidden');

                } else if (!showUserInfoAndAvatar) {
                    userProfileArea.classList.add('hidden');
                    if(avatarContainer) avatarContainer.classList.add('hidden');
                    if(userInfoBox) userInfoBox.classList.add('hidden');
                } else if (isAnyPanelVisible) {
                    userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("User is signed out. Attempting to sign in.");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("[onAuthStateChanged] Custom token sign-in error, trying anonymous:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                        gameState.displayName = '';
                        gameState.publicUserId = '';
                        gameState.avatarUrl = '';
                        gameState.seenQuestionHashes.clear();
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        if(loadingMessage) loadingMessage.textContent = "اتصال برقرار شد. خوش آمدید!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen);
                        }, 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در اتصال به سرورهای بازی.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }

        async function loadUserData() {
            if (!currentUserId || !db) {
                console.log("Cannot load user data: no currentUserId or db connection.");
                gameState.displayName = '';
                gameState.publicUserId = '';
                gameState.avatarUrl = '';
                gameState.seenQuestionHashes = new Set();
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    console.log("User data found, loading profile.");
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                    console.log(`Loaded ${gameState.seenQuestionHashes.size} seen questions.`);
                } else {
                    console.log("No user profile found, setting default values.");
                    gameState.displayName = "";
                    gameState.publicUserId = "";
                    gameState.avatarUrl = '';
                    gameState.seenQuestionHashes = new Set();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
                gameState.displayName = '';
                gameState.publicUserId = '';
                gameState.avatarUrl = '';
                gameState.seenQuestionHashes = new Set();
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    seenQuestionHashes: Array.from(gameState.seenQuestionHashes),
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                 console.log("User data saved successfully.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
            }
        }

        // --- Gemini API Functions ---
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";

        async function callGeminiAPI(prompt, isJsonOutput = false, schema = null) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            if (isJsonOutput) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                };
                if (schema) {
                    payload.generationConfig.responseSchema = schema;
                }
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJsonOutput ? JSON.parse(text) : text;
                } else {
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                         throw new Error(`پاسخ نامعتبر از سرویس هوش مصنوعی (دلیل: ${result.candidates[0].finishReason})`);
                    }
                    throw new Error("پاسخ نامعتبر از سرویس هوش مصنوعی دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (!prompt.includes("offensive, hateful, or contain profanity")) {
                    showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.<br><br><small>جزئیات خطا: ${error.message}</small>`, "باشه", null, () => hideModal());
                }
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function callImagenAPI(prompt, sampleCount = 1) {
            if(avatarAiLoading) avatarAiLoading.classList.remove('hidden');
            if(avatarErrorMessage) avatarErrorMessage.textContent = '';

            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": sampleCount }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed: ${response.status} ${errorBody}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                } else {
                    throw new Error("پاسخ نامعتبر از سرویس ساخت تصویر دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = `خطا در ساخت آواتار: ${error.message}`;
                return null;
            } finally {
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
            }
        }

        // --- Game Logic Functions ---

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            if (questionText) questionText.textContent = "در حال تولید سوال جدید و غیرتکراری...";
            if (optionsContainer) optionsContainer.innerHTML = "";
            if (questionExplanation) questionExplanation.classList.add('hidden');
            if (gameFeedback) gameFeedback.textContent = "";
            
            let attempts = 0;
            const maxAttempts = 3;
            let questionData = null;

            while (attempts < maxAttempts) {
                let difficulty = "آسان";
                if (gameState.currentStage > 20) {
                    difficulty = "بسیار سخت";
                } else if (gameState.currentStage > 10) {
                    difficulty = "سخت";
                } else if (gameState.currentStage > 5) {
                    difficulty = "متوسط";
                }

                const prompt = `
                شما یک طراح بازی حرفه‌ای و خلاق هستید که مسئول طراحی سوالات برای یک بازی مافیایی پیشرفته هستید. هدف شما ایجاد سوالاتی چالش‌برانگیز، متنوع و غیرتکراری است.
                
                وظیفه: یک سوال چند گزینه‌ای (۴ گزینه‌ای) جدید و منحصربه‌فرد به زبان فارسی با موضوع مافیا ایجاد کن.
                سطح دشواری سوال باید "${difficulty}" باشد چون کاربر در مرحله ${gameState.currentStage} است.
                
                موضوعات پیشنهادی (برای تنوع):
                - تاریخچه و ساختار مافیای سیسیل (Cosa Nostra)، کامورا یا اندرانگتا.
                - شخصیت‌ها، وقایع و اصطلاحات دوران ممنوعیت الکل در آمریکا.
                - سازمان‌های جنایی دیگر مانند یاکوزای ژاپن، کارتل‌های کلمبیا یا مکزیک.
                - جزئیات دقیق از فیلم‌ها و سریال‌های معروف مانند "پدرخوانده"، "رفقای خوب"، "کازینو"، "سوپرانوها" یا "پیکی بلایندرز".
                - اصطلاحات تخصصی و نقش‌های پیچیده در سناریوهای مختلف بازی "شهر مافیا" (مانند دکتر لکتر، روانپزشک، مذاکره‌کننده، ناتاشا).
                - سناریوهای فرضی و چالش‌های تاکتیکی در بازی مافیا.
                
                مهم: سوال نباید کلیشه‌ای یا تکراری باشد. خلاقیت به خرج بده و سوالی طرح کن که دانش کاربر را به چالش بکشد.
                
                خروجی: پاسخ شما باید فقط و فقط یک آبجکت JSON خام، بدون هیچ متن اضافی یا بک‌تیک (\`\`\`) باشد.
                ساختار JSON باید دقیقا به این صورت باشد:
                {
                  "question": "متن سوال به فارسی",
                  "options": ["گزینه ۱", "گزینه ۲", "گزینه ۳", "گزینه ۴"],
                  "correctAnswerIndex": 0,
                  "explanation": "توضیح کوتاه و جالب در مورد پاسخ صحیح به زبان فارسی"
                }
                `;

                const data = await callGeminiAPI(prompt, true);

                if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    const questionHash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(questionHash)) {
                        questionData = data;
                        break;
                    } else {
                        console.warn(`Duplicate question received (hash: ${questionHash}), retrying... Attempt ${attempts + 1}`);
                        attempts++;
                    }
                } else {
                    console.error("Invalid question data structure received from AI:", data);
                    attempts++;
                }
            }

            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                console.error("Failed to generate a unique question after multiple attempts.");
                if (questionText) questionText.textContent = "خطا در بارگذاری سوال غیرتکراری.";
                showModal("خطا در تولید سوال", `متاسفانه نتوانستیم یک سوال جدید و غیرتکراری برای شما بسازیم. این ممکن است به دلیل ترافیک بالا یا پاسخ ندادن سرور هوش مصنوعی باشد. آیا می‌خواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); if (mainScreen) showScreen(mainScreen); }
                );
            }
            
            gameState.isLoadingNextQuestion = false;
            gameState.isQuestionActive = true;
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData || !questionText || !optionsContainer) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(questionExplanation) questionExplanation.textContent = "";
            if(gameFeedback) gameFeedback.textContent = "";
            gameState.isQuestionActive = true;
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion || !optionsContainer || !gameFeedback) return;
            gameState.isQuestionActive = false;

            const selectedOptionButton = event.target.closest('.option-btn');
            if (!selectedOptionButton) return;

            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                selectedOptionButton.classList.add('correct');
                gameFeedback.textContent = "پاسخ صحیح!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-green-400';
                
                const questionHash = simpleHash(question);
                gameState.seenQuestionHashes.add(questionHash);
                gameState.currentStage++;
                
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');

                const selectedOptionText = options[selectedIndex];
                const correctAnswerText = options[correctAnswerIndex];
                const tauntPrompt = `شما یک رئیس مافیای شوخ طبع هستید. بازیکن به این سوال پاسخ اشتباه داده است:
                سوال: "${question}"
                پاسخ اشتباه بازیکن: "${selectedOptionText}"
                پاسخ صحیح: "${correctAnswerText}"
                یک طعنه کوتاه و بامزه (۱ تا ۲ جمله) به زبان فارسی در مورد اشتباه بازیکن یا موضوع سوال بگویید. طعنه باید مناسب فضای بازی و نه چندان توهین آمیز باشد.`;

                const taunt = await callGeminiAPI(tauntPrompt);
                if (taunt) {
                    gameFeedback.innerHTML = taunt.replace(/\n/g, '<br>');
                } else {
                    gameFeedback.textContent = "پاسخ اشتباه!";
                }
                gameFeedback.className = 'text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-auto text-red-400';
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            if (explanation && questionExplanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }

        async function generateAndDisplayAvatars() {
            if(!avatarAiLoading || !avatarSuggestionsContainer || !modalConfirmBtn) return;
            avatarAiLoading.classList.remove('hidden');
            const prompt = "Cool futuristic neon cyberpunk character avatar, portrait, dark blue and magenta theme, high detail, cinematic lighting, no text, no weapons, noir style";
            const suggestions = await callImagenAPI(prompt, 4);

            avatarSuggestionsContainer.innerHTML = '';
            selectedAvatarForConfirmation = null;

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(base64Url => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'avatar-suggestion-item';
                    const img = document.createElement('img');
                    img.src = base64Url;
                    img.alt = "پیشنهاد آواتار";
                    imgWrapper.appendChild(img);
                    imgWrapper.addEventListener('click', () => {
                        const currentSelected = avatarSuggestionsContainer.querySelector('.selected');
                        if (currentSelected) {
                            currentSelected.classList.remove('selected');
                        }
                        imgWrapper.classList.add('selected');
                        selectedAvatarForConfirmation = base64Url;
                        modalConfirmBtn.disabled = false;
                    });
                    avatarSuggestionsContainer.appendChild(imgWrapper);
                });
                modalConfirmBtn.textContent = "انتخاب این آواتار";
                modalConfirmBtn.disabled = true;
            } else {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "متاسفانه نتوانستیم آواتاری بسازیم. دوباره تلاش کنید.";
                modalConfirmBtn.textContent = "تایید";
                modalConfirmBtn.disabled = true;
            }
        }

        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("موفقیت", "آواتار شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
            } else {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "لطفا ابتدا یک آواتار را انتخاب کنید.";
            }
        }

        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            if (!inputElement || !errorElement) return null;
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');

            if (nameValue !== sanitizedValue) {
                inputElement.value = sanitizedValue;
            }

            const trimmedName = sanitizedValue.trim();

            if (trimmedName === '') {
                errorElement.textContent = "کد ایجنت نمی‌تواند خالی باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length < 3) {
                errorElement.textContent = "کد ایجنت باید حداقل ۳ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length > 20) {
                errorElement.textContent = "کد ایجنت نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.textContent = '';
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName === gameState.displayName) {
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = "کد جدید باید با کد فعلی متفاوت باشد.";
                if(newDisplayNameInput) newDisplayNameInput.classList.add('invalid');
                return;
            }

            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("موفقیت", "کد ایجنت شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
        }

        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب، نکته تاریخی کمتر شنیده شده، یا یک داستانک کوتاه و غافلگیرکننده (حدود ۲-۴ جمله) در مورد دنیای مافیا (تاریخچه، فیلم‌ها، شخصیت‌های معروف، یا اصطلاحات رایج) به زبان فارسی برای من تعریف کن. سعی کن هر بار یک مطلب جدید ارائه دهی.";
            showModal("داده‌های محرمانه ✨", "<div class='loader mx-auto my-3'></div><p>جستجو در آرشیوهای رمزنگاری شده...</p>", "باشه", null, () => hideModal());

            const fact = await callGeminiAPI(prompt);
            if (fact) {
                showModal("داده‌های محرمانه ✨", fact.replace(/\n/g, '<br>'), "جالب بود!", null, () => hideModal());
            } else {
                showModal("خطا", "متاسفانه در حال حاضر نکته‌ای برای گفتن نیست. لطفاً بعداً تلاش کنید.", "باشه", null, () => hideModal());
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        function setupEventListeners() {
            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            if (displayNameInput) {
                displayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                });
                displayNameInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if(registerBtn) registerBtn.click();
                    }
                });
            }

            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', () => {
                    const newPublicId = generateAlphanumericPublicUserId();
                    if (userIdDisplayInput) userIdDisplayInput.value = newPublicId;
                    gameState.publicUserId = newPublicId;
                    if (userIdErrorMessage) userIdErrorMessage.textContent = '';
                });
            }

            if (newDisplayNameInput) {
                newDisplayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
                });
                newDisplayNameInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (modalConfirmCallback === handleChangeDisplayName && modalTitle && modalTitle.textContent.includes("تغییر نام نمایشی")) {
                            if(modalConfirmBtn) modalConfirmBtn.click();
                        }
                    }
                });
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', async () => {
                    const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);

                    let isPublicIdValid = false;
                    if (!gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "لطفاً ابتدا یک شناسه کاربری ایجاد کنید.";
                        isPublicIdValid = false;
                    } else if (userIdDisplayInput && userIdDisplayInput.value !== gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "خطا: شناسه کاربری نمایش داده شده با شناسه ساخته شده مغایرت دارد.";
                        isPublicIdValid = false;
                    }
                    else {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "";
                        isPublicIdValid = true;
                    }

                    if (!validatedName || !isPublicIdValid) return;

                    gameState.displayName = validatedName;

                    await saveUserData();
                    updateUI();
                });
            }

            if (editNameBtn) {
                editNameBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return;
                    showModal(
                        "تغییر کد ایجنت",
                        "تغییر کد ایجنت در این سیستم رایگان است.",
                        "تغییر کد",
                        "لغو",
                        handleChangeDisplayName,
                        hideModal,
                        "changeName"
                    );
                });
            }

            if (avatarContainer) {
                avatarContainer.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return;
                    selectedAvatarForConfirmation = null;
                    showModal(
                        "تغییر چهره (آواتار)",
                        "",
                        "انتخاب این چهره",
                        "لغو",
                        confirmAvatarSelection,
                        hideModal,
                        "avatar"
                    );
                    if(modalConfirmBtn) modalConfirmBtn.disabled = true;
                });
            }

            if (generateAvatarBtn) {
                generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);
            }

            const allActionButtons = [startGameBtn, mafiaFactBtn, devIntroBtnHeader].filter(btn => btn !== null);
            allActionButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) {
                        event.stopPropagation();
                        showModal(
                            "احراز هویت لازم است",
                            "برای دسترسی به این بخش، ابتدا باید با وارد کردن کد ایجنت و ایجاد شناسه، به سیستم متصل شوید.",
                            "متوجه شدم",
                            null,
                            () => hideModal()
                        );
                    }
                }, true);
            });


            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return;
                    showModal(
                        "شروع عملیات",
                        "برای بهترین عملکرد و اتصال به سرورهای هوش مصنوعی، توصیه می‌شود از یک اتصال پایدار (در صورت امکان VPN با سرور آمریکا) استفاده کنید.",
                        "متوجه شدم، ادامه بده", null,
                        () => {
                            hideModal();
                            if(gameScreen) showScreen(gameScreen);
                            generateQuestion();
                        }
                    );
                });
            }

            if (mafiaFactBtn) {
                mafiaFactBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return;
                    generateMafiaFact();
                });
            }

            if (devIntroBtnHeader) {
                devIntroBtnHeader.addEventListener('click', () => {
                    if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                        showDevelopersPanel();
                    }
                });
            }

            if (closeDevelopersPanelBtn) {
                closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            }

            if(backToMainBtn) {
                backToMainBtn.addEventListener('click', async () => {
                    try {
                        await saveUserData();
                        gameState.currentQuestionData = null;
                        if(mainScreen) {
                            showScreen(mainScreen);
                        }
                    }
                    catch (e) {
                        console.error("Error in backToMainBtn click listener (game screen):", e);
                    }
                });
            }

            window.addEventListener('resize', () => {
                updateUI();
            });
        }

        async function initializeGame() {
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            registrationForm = document.getElementById('registration-form');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');
            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            devIntroBtnHeader = document.getElementById('dev-intro-icon-btn-header');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarGenerationContainer = document.getElementById('avatar-generation-container');
            generateAvatarBtn = document.getElementById('generate-avatar-btn');
            avatarAiLoading = document.getElementById('avatar-ai-loading');
            avatarSuggestionsContainer = document.getElementById('avatar-suggestions-container');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');

            if(userProfileArea) userProfileArea.classList.add('hidden');
            if(loadingMessage) loadingMessage.textContent = "بررسی اتصال به شبکه...";
            if (!navigator.onLine) {
                showModal("قطع اتصال", "اتصال به اینترنت برقرار نیست. لطفاً شبکه خود را بررسی و مجدداً تلاش کنید.", "تلاش مجدد", null, () => {
                    hideModal();
                    if (navigator.onLine) initializeGame(); else showModal("عدم اتصال", "همچنان به اینترنت متصل نیستید.", "باشه", null, () => hideModal());
                });
                return;
            }
            if(loadingMessage) loadingMessage.textContent = "آماده‌سازی برای ورود اولیه...";

            try {
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در راه‌اندازی سیستم.";
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>
