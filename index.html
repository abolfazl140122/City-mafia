<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>شهر مافیا - نسخه کلش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */
        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }
        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- GENERAL BODY & FONT STYLES --- */
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body.modal-open {
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- SCREEN & LAYOUT --- */
        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 1rem;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, visibility 0.4s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 10;
        }
        @media (min-width: 640px) { .screen { padding: 1.5rem; } }
        
        .screen.active { opacity: 1; visibility: visible; }
        #loading-screen { justify-content: center; }

        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0; /* Fix for flexbox in some browsers */
        }
        
        /* MOBILE-FIRST MAIN SCREEN LAYOUT */
        #main-screen .screen-content-wrapper {
            justify-content: flex-start;
        }
        #main-screen-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #main-screen-buttons-layout {
            padding-top: 1rem;
            margin-top: auto; /* Pushes buttons to the bottom */
        }

        /* --- PANELS & CARDS --- */
        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: relative;
        }
        .panel-clash::before, .panel-clash::after {
            content: ''; position: absolute; width: 12px; height: 12px;
            background: var(--clash-gold); border-radius: 50%;
            border: 2px solid var(--clash-brown-dark); box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }

        /* --- BUTTONS & INPUTS --- */
        .btn-clash {
            border-radius: 12px; font-weight: bold; text-transform: uppercase;
            transition: all 0.1s ease-out; cursor: pointer; position: relative;
            white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
            color: var(--clash-text-dark); text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%); cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important; transform: translateY(0) !important;
        }
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark); box-shadow: 0 6px 0 #a07200;
            padding: 12px 24px; font-size: 1.2rem;
        }
        .btn-clash-primary:hover:not(:disabled) {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px); box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active:not(:disabled) {
            transform: translateY(4px) !important; box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        #start-game-btn.breathing { animation: breathe 2.5s ease-in-out infinite; }

        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark); box-shadow: 0 5px 0 #2e5185;
            padding: 10px 18px; font-size: 1rem; color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .btn-clash-secondary:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px); box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active:not(:disabled) {
            transform: translateY(3px) !important; box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark); border: 2px solid #2a4166;
            color: #fff; border-radius: 10px; padding: 12px; font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
        }
        .input-clash:focus {
            outline: none; border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid { border-color: var(--clash-red); }
        .input-clash:read-only { background-color: #314a70; cursor: default; }

        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166; box-shadow: 0 4px 0 #2e5185; color: white;
            transition: all 0.15s ease; font-size: 1rem; padding: 12px;
            border-radius: 12px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px); box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important; box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important; box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        /* --- COMPONENTS --- */
        .loader {
            border: 8px solid #3a5b8a; border-top: 8px solid var(--clash-gold);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        
        .hidden { display: none !important; }
        
        #error-message-box {
            color: #ffdddd; font-size: 0.9rem; text-align: center;
            min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold;
            background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px;
            border-radius: 6px; border: 1px solid var(--clash-red);
        }
        
        /* User Profile Area (Mobile-First) */
        #user-profile-header {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20; border-top-color: #c89673; border-left-color: #c89673;
            border-radius: 12px; padding: 0.75rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; gap: 1rem;
            width: 100%; margin-bottom: 1.5rem;
        }
        #avatar-container {
            width: 70px; height: 70px; border-radius: 50%; flex-shrink: 0;
            border: 5px solid; border-image: linear-gradient(to bottom, #ffd700, #c89820) 1;
            background-color: #333; cursor: pointer; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        #user-info-box { flex-grow: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .user-info-item .label { font-size: 0.9em; color: #f0d5bf; }
        #display-name-output-container { color: var(--clash-gold); font-size: 1.3em; }
        #public-user-id-output { color: #eee; font-family: monospace; font-size: 1em; }
        #edit-name-btn { cursor: pointer; font-size: 1em; margin-left: 0.5rem; transition: transform 0.2s; }
        #edit-name-btn:hover { transform: scale(1.2); }
        
        #main-title {
            text-align: center;
            font-size: clamp(2.5rem, 10vw, 4rem); /* Responsive font size */
            color: var(--clash-gold);
            text-shadow: -2px -2px 0 var(--clash-brown-dark), 2px -2px 0 var(--clash-brown-dark), -2px 2px 0 var(--clash-brown-dark), 2px 2px 0 var(--clash-brown-dark), 4px 4px 6px rgba(0,0,0,0.7);
            margin-bottom: 1rem;
        }
        @media (min-width: 768px) { #main-title { font-size: 5rem; } }

        /* Developers Panel & Modals */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(10, 10, 10, 0.85);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-overlay .panel-clash {
            max-width: 90vw; width: 500px;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.visible .panel-clash { transform: scale(1); }
        #close-developers-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425; box-shadow: 0 4px 0 #8f2a2b; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer;
            transition: all 0.2s ease;
        }
        #close-developers-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        #close-developers-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        .developer-item {
            background-color: rgba(42, 65, 102, 0.9); padding: 1rem 1.2rem;
            border-radius: 12px; border: 2px solid rgba(157, 194, 255, 0.4);
        }
        /* Avatar Suggestions */
        #avatar-suggestions-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; max-height: 200px; overflow-y: auto; padding: 5px; }
        .avatar-suggestion-item { width: 100%; aspect-ratio: 1/1; border-radius: 8px; border: 4px solid transparent; cursor: pointer; overflow: hidden; transition: border-color 0.3s, transform 0.2s; }
        .avatar-suggestion-item:hover { transform: scale(1.05); }
        .avatar-suggestion-item.selected { border-color: var(--clash-green); box-shadow: 0 0 10px var(--clash-green); }
        .avatar-suggestion-item img { width: 100%; height: 100%; object-fit: cover; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div class="screen-content-wrapper justify-center items-center text-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">بارگذاری بازی...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl font-bold">در حال برقراری ارتباط با شهر...</p>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <!-- Logged-in User Profile Header -->
            <div id="user-profile-header" class="hidden">
                <div id="avatar-container" title="تغییر آواتار">
                    <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر">
                </div>
                <div id="user-info-box">
                    <div class="user-info-item">
                        <div id="display-name-output-container" class="flex items-center gap-2 clash-font">
                            <span id="display-name-output"></span>
                            <span id="edit-name-btn" title="تغییر نام">✏️</span>
                        </div>
                    </div>
                    <div class="user-info-item">
                        <div class="label flex items-center gap-1 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                            <span>شناسه:</span>
                            <span id="public-user-id-output" class="mr-1"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area (Title or Registration) -->
            <div id="main-screen-content">
                <h1 id="main-title" class="clash-font">شهر مافیا</h1>

                <!-- Registration Form -->
                <div id="registration-form" class="panel-clash p-4 sm:p-6 max-w-md mx-auto w-full">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium mb-1">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-clash w-full p-3 text-lg text-center" readonly placeholder="بساز!">
                            <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary clash-font px-4 py-3 text-sm">ساخت</button>
                        </div>
                    </div>
                    <p id="error-message-box" class="hidden"></p>
                    <button id="register-btn" class="btn-clash btn-clash-primary w-full p-3 text-lg mt-4 clash-font">ورود به شهر</button>
                </div>
            </div>
            
            <!-- Action Buttons Area -->
            <div id="main-screen-buttons-layout" class="hidden">
                 <div class="flex flex-col items-center w-full gap-3">
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font w-full max-w-xs">شروع بازی</button>
                    <div class="flex gap-3 justify-center w-full max-w-xs">
                        <button id="mafia-fact-btn" class="btn-clash btn-clash-secondary clash-font flex-1">دانستنی‌ها ✨</button>
                        <button id="dev-intro-btn" class="btn-clash btn-clash-secondary clash-font flex-1">سازندگان</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">بازگشت</button>
                <div class="font-bold">مرحله: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
            </div>

            <div id="question-container" class="panel-clash p-4 sm:p-6 rounded-lg mb-4 flex-grow flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-2 h-16 clash-font flex items-center justify-center"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-2 hidden">
                <div class="loader inline-block w-8 h-8 border-4"></div>
                <p class="text-sm font-bold mt-1">دستیار AI در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal-container" class="modal-overlay">
        <div class="panel-clash p-6 sm:p-8 text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <!-- Change Name Form -->
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                </div>
                <!-- Avatar Generation Form -->
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-clash btn-clash-primary my-4 clash-font">ساخت آواتار جدید با AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto !w-12 !h-12 !border-4"></div>
                        <p class="mt-2 text-sm text-gray-300">در حال ساخت آواتارهای پیشنهادی...</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                </div>
                 <p id="modal-error-message" class="hidden"></p>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">تایید</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">لغو</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="modal-overlay">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 relative">
            <button id="close-developers-panel-btn">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-6 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(80vh-120px)] overflow-y-auto pr-3 pl-1">
                <!-- Developer items will be injected here if needed, or kept static -->
                <div class="developer-item">
                    <div class="flex items-center mb-2 pb-2 border-b-2 border-[rgba(157,194,255,0.3)]">
                        <span class="text-2xl ml-2">💻</span> <h4 class="font-bold text-lg">برنامه نویس ارشد</h4>
                    </div>
                    <p class="clash-font text-xl text-[#fff8a8]">abolfazl1401</p>
                    <p class="text-sm mt-1 text-[#d0e0ff]">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی.</p>
                </div>
                 <div class="developer-item">
                    <div class="flex items-center mb-2 pb-2 border-b-2 border-[rgba(157,194,255,0.3)]">
                        <span class="text-2xl ml-2">🎨</span> <h4 class="font-bold text-lg">طراح گرافیک</h4>
                    </div>
                    <p class="clash-font text-xl text-[#fff8a8]">Vahid</p>
                    <p class="text-sm mt-1 text-[#d0e0ff]">خالق هویت بصری جذاب و تم مافیایی بازی.</p>
                </div>
                <div class="developer-item">
                    <div class="flex items-center mb-2 pb-2 border-b-2 border-[rgba(157,194,255,0.3)]">
                        <span class="text-2xl ml-2">💡</span> <h4 class="font-bold text-lg">ایده پرداز</h4>
                    </div>
                    <p class="clash-font text-xl text-[#fff8a8]">Ali.k</p>
                    <p class="text-sm mt-1 text-[#d0e0ff]">خالق ایده‌های نوآورانه برای مراحل و چالش‌ها.</p>
                </div>
                 <div class="developer-item">
                    <div class="flex items-center mb-2 pb-2 border-b-2 border-[rgba(157,194,255,0.3)]">
                        <span class="text-2xl ml-2">☁️</span> <h4 class="font-bold text-lg">توسعه دهنده سرور</h4>
                    </div>
                    <p class="clash-font text-xl text-[#fff8a8]">Neda_Tech</p>
                    <p class="text-sm mt-1 text-[#d0e0ff]">متخصص پیاده‌سازی و نگهداری زیرساخت‌های سرور.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * Main application object to encapsulate all game logic, state, and DOM elements.
         * This prevents global scope pollution and makes the code more organized and maintainable.
         */
        const App = {
            // --- CONFIGURATION ---
            config: {
                firebase: typeof __firebase_config !== 'undefined'
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                        authDomain: "city-mafia.firebaseapp.com",
                        projectId: "city-mafia",
                        storageBucket: "city-mafia.appspot.com", 
                        messagingSenderId: "66458127103",
                        appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                        measurementId: "G-8M0M6BJ0GG"
                      },
                appId: typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default',
                geminiApiKey: "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw",
                geminiTextModel: "gemini-1.5-flash",
                imagenModel: "imagen-3.0-generate-002",
                constants: {
                    HIDDEN_CLASS: 'hidden',
                    VISIBLE_CLASS: 'visible',
                    ACTIVE_CLASS: 'active',
                    INVALID_CLASS: 'invalid',
                }
            },

            // --- SERVICES (Firebase, etc.) ---
            services: {
                firebaseApp: null,
                auth: null,
                db: null,
            },

            // --- GAME STATE ---
            state: {
                isAuthReady: false,
                isBusy: false, // Global flag to prevent multiple async operations
                currentUserId: null,
                displayName: '',
                publicUserId: '',
                avatarUrl: '',
                currentStage: 1,
                seenQuestionHashes: new Set(),
                currentQuestionData: null,
                isQuestionActive: false,
                modalConfirmCallback: null,
                modalCancelCallback: null,
                selectedAvatarForConfirmation: null,
            },

            // --- DOM ELEMENTS CACHE ---
            dom: {},

            // --- AUDIO MANAGER ---
            sfx: {
                sounds: {},
                init() {
                    this.sounds.click = document.getElementById('sfx-click');
                    this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                    this.sounds.panelClose = document.getElementById('sfx-panel-close');
                    this.sounds.correct = document.getElementById('sfx-correct');
                    this.sounds.incorrect = document.getElementById('sfx-incorrect');
                    this.sounds.startGame = document.getElementById('sfx-start-game');
                    Object.values(this.sounds).forEach(s => s && (s.volume = 0.4));
                },
                play(soundName) {
                    const sound = this.sounds[soundName];
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.warn("Audio play failed:", e));
                    }
                }
            },

            // --- METHODS ---
            methods: {
                // --- INITIALIZATION ---
                /**
                 * Main entry point to initialize the game.
                 */
                async init() {
                    this._queryDOMElements();
                    this.sfx.init();
                    this._setupEventListeners();
                    
                    this.dom.loadingMessage.textContent = "بررسی اتصال...";
                    if (!navigator.onLine) {
                        this.methods.showModal("عدم اتصال", "لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.", "باشه");
                        return;
                    }

                    this.dom.loadingMessage.textContent = "آماده سازی برای ورود...";
                    await this._initFirebase();
                },

                /**
                 * Queries all necessary DOM elements and caches them in App.dom.
                 * @private
                 */
                _queryDOMElements() {
                    const ids = [
                        'loading-screen', 'loading-message', 'main-screen', 'game-screen',
                        'registration-form', 'display-name-input', 'user-id-display',
                        'generate-user-id-btn', 'register-btn', 'error-message-box',
                        'user-profile-header', 'avatar-container', 'avatar-image',
                        'user-info-box', 'display-name-output', 'edit-name-btn', 'public-user-id-output',
                        'main-screen-content', 'main-title', 'main-screen-buttons-layout',
                        'start-game-btn', 'mafia-fact-btn', 'dev-intro-btn',
                        'back-to-main-btn', 'stage-display', 'question-container', 'question-text',
                        'options-container', 'question-explanation', 'game-feedback', 'ai-thinking-indicator',
                        'modal-container', 'modal-title', 'modal-content-dynamic', 'modal-message',
                        'change-name-input-container', 'new-display-name-input', 'avatar-generation-container',
                        'generate-avatar-btn', 'avatar-ai-loading', 'avatar-suggestions-container',
                        'modal-error-message', 'modal-actions', 'modal-confirm-btn', 'modal-cancel-btn',
                        'developers-panel-container', 'close-developers-panel-btn'
                    ];
                    ids.forEach(id => {
                        const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                        this.dom[camelCaseId] = document.getElementById(id);
                    });
                },
                
                /**
                 * Sets up all event listeners for the application.
                 * @private
                 */
                _setupEventListeners() {
                    // Global click sound
                    document.body.addEventListener('click', (e) => {
                        if (e.target.closest('.btn-clash:not(:disabled)')) this.sfx.play('click');
                    });

                    // Registration
                    this.dom.generateUserIdBtn.addEventListener('click', () => this.methods.generatePublicUserId());
                    this.dom.registerBtn.addEventListener('click', () => this.methods.handleRegistration());
                    this.dom.displayNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.methods.handleRegistration() });
                    
                    // Main Screen Actions
                    this.dom.startGameBtn.addEventListener('click', () => this.methods.handleStartGame());
                    this.dom.mafiaFactBtn.addEventListener('click', () => this.methods.generateMafiaFact());
                    this.dom.devIntroBtn.addEventListener('click', () => this.methods.showDevelopersPanel());
                    
                    // User Profile Actions
                    this.dom.editNameBtn.addEventListener('click', () => this.methods.promptChangeDisplayName());
                    this.dom.avatarContainer.addEventListener('click', () => this.methods.promptChangeAvatar());

                    // Game Screen
                    this.dom.backToMainBtn.addEventListener('click', () => this.methods.returnToMainScreen());

                    // Modals & Panels
                    this.dom.modalConfirmBtn.addEventListener('click', () => this.methods.handleModalConfirm());
                    this.dom.modalCancelBtn.addEventListener('click', () => this.methods.hideModal());
                    this.dom.closeDevelopersPanelBtn.addEventListener('click', () => this.methods.hideDevelopersPanel());
                    this.dom.generateAvatarBtn.addEventListener('click', () => this.methods.generateAndDisplayAvatars());
                },
                
                /**
                 * Initializes Firebase services (Auth, Firestore).
                 * @private
                 */
                async _initFirebase() {
                    try {
                        this.services.firebaseApp = initializeApp(this.config.firebase);
                        this.services.auth = getAuth(this.services.firebaseApp);
                        this.services.db = getFirestore(this.services.firebaseApp);
                        
                        onAuthStateChanged(this.services.auth, async (user) => {
                            if (user) {
                                this.state.currentUserId = user.uid;
                                await this.methods._loadUserData();
                            } else {
                                await signInAnonymously(this.services.auth);
                            }
                            this.state.isAuthReady = true;
                            this.methods.updateUI();

                            if (this.dom.loadingScreen.classList.contains(this.config.constants.ACTIVE_CLASS)) {
                                this.dom.loadingMessage.textContent = "خوش آمدید!";
                                setTimeout(() => this.methods.showScreen('main-screen'), 500);
                            }
                        });
                    } catch (error) {
                        console.error("Firebase init error:", error);
                        this.dom.loadingMessage.textContent = "خطا در اتصال به سرور!";
                    }
                },
                
                // --- DATA HANDLING ---
                /**
                 * Loads user data from Firestore.
                 * @private
                 */
                async _loadUserData() {
                    if (!this.state.currentUserId) return;
                    const docRef = doc(this.services.db, `artifacts/${this.config.appId}/users/${this.state.currentUserId}/mafiaGameData/profile`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.state.displayName = data.displayName || "";
                        this.state.publicUserId = data.publicUserId || "";
                        this.state.avatarUrl = data.avatarUrl || "";
                        this.state.currentStage = data.currentStage || 1;
                        this.state.seenQuestionHashes = new Set(data.seenQuestionHashes || []);
                    }
                },

                /**
                 * Saves user data to Firestore.
                 * @private
                 */
                async _saveUserData() {
                    if (!this.state.currentUserId) return;
                    const docRef = doc(this.services.db, `artifacts/${this.config.appId}/users/${this.state.currentUserId}/mafiaGameData/profile`);
                    const dataToSave = {
                        displayName: this.state.displayName,
                        publicUserId: this.state.publicUserId,
                        avatarUrl: this.state.avatarUrl,
                        currentStage: this.state.currentStage,
                        seenQuestionHashes: Array.from(this.state.seenQuestionHashes),
                        lastUpdated: serverTimestamp()
                    };
                    await setDoc(docRef, dataToSave, { merge: true });
                },

                // --- UI & UX ---
                /**
                 * Updates the entire UI based on the current App.state.
                 */
                updateUI() {
                    const C = this.config.constants;
                    const isRegistered = this.state.isAuthReady && this.state.displayName && this.state.publicUserId;

                    // Registration Form vs. Main Content
                    this.dom.registrationForm.classList.toggle(C.HIDDEN_CLASS, isRegistered);
                    this.dom.mainTitle.classList.toggle(C.HIDDEN_CLASS, isRegistered);
                    this.dom.userProfileHeader.classList.toggle(C.HIDDEN_CLASS, !isRegistered);
                    this.dom.mainScreenButtonsLayout.classList.toggle(C.HIDDEN_CLASS, !isRegistered);

                    if (isRegistered) {
                        // Update Profile Header
                        this.dom.displayNameOutput.textContent = this.state.displayName;
                        this.dom.publicUserIdOutput.textContent = this.state.publicUserId;
                        this.dom.avatarImage.src = this.state.avatarUrl || `https://placehold.co/80x80/333333/777777?text=?`;
                        this.dom.startGameBtn.classList.add('breathing');
                    } else {
                        this.dom.startGameBtn.classList.remove('breathing');
                    }
                    
                    // Game screen stage
                    this.dom.stageDisplay.textContent = this.state.currentStage;
                },

                /**
                 * Displays a specific screen and hides others.
                 * @param {string} screenId - The ID of the screen to show.
                 */
                showScreen(screenId) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove(this.config.constants.ACTIVE_CLASS));
                    const screenElement = this.dom[screenId.replace(/-/g, '')];
                    if (screenElement) {
                        screenElement.classList.add(this.config.constants.ACTIVE_CLASS);
                        screenElement.scrollTop = 0;
                    }
                    this.methods.updateUI();
                },

                /**
                 * Displays a modal dialog.
                 * @param {string} title - The modal title.
                 * @param {string} message - The modal message (HTML allowed).
                 * @param {string} [confirmText="تایید"] - The text for the confirm button.
                 * @param {string|null} [cancelText="لغو"] - The text for the cancel button. If null, hides it.
                 * @param {Function|null} [onConfirm=null] - Callback for confirm button.
                 * @param {'generic'|'changeName'|'avatar'} [modalType='generic'] - The type of modal to configure inputs.
                 */
                showModal(title, message, confirmText = "تایید", cancelText = "لغو", onConfirm = null, modalType = 'generic') {
                    this.sfx.play('panelOpen');
                    const C = this.config.constants;
                    
                    this.dom.modalTitle.textContent = title;
                    this.dom.modalMessage.innerHTML = message;

                    // Reset all inputs/containers
                    [this.dom.changeNameInputContainer, this.dom.avatarGenerationContainer, this.dom.modalErrorMessage].forEach(el => el.classList.add(C.HIDDEN_CLASS));
                    this.dom.modalErrorMessage.textContent = '';

                    // Configure based on type
                    if (modalType === 'changeName') {
                        this.dom.changeNameInputContainer.classList.remove(C.HIDDEN_CLASS);
                        this.dom.newDisplayNameInput.value = this.state.displayName;
                    } else if (modalType === 'avatar') {
                        this.dom.avatarGenerationContainer.classList.remove(C.HIDDEN_CLASS);
                        this.dom.avatarSuggestionsContainer.innerHTML = '';
                        this.dom.avatarAiLoading.classList.add(C.HIDDEN_CLASS);
                    }

                    this.dom.modalConfirmBtn.textContent = confirmText;
                    this.state.modalConfirmCallback = onConfirm || (() => this.methods.hideModal());

                    if (cancelText) {
                        this.dom.modalCancelBtn.textContent = cancelText;
                        this.dom.modalCancelBtn.classList.remove(C.HIDDEN_CLASS);
                    } else {
                        this.dom.modalCancelBtn.classList.add(C.HIDDEN_CLASS);
                    }

                    this.dom.modalContainer.classList.add(C.VISIBLE_CLASS);
                    document.body.classList.add('modal-open');
                },

                hideModal() {
                    this.sfx.play('panelClose');
                    this.dom.modalContainer.classList.remove(this.config.constants.VISIBLE_CLASS);
                    document.body.classList.remove('modal-open');
                    this.state.modalConfirmCallback = null;
                },

                showDevelopersPanel() {
                    this.sfx.play('panelOpen');
                    this.dom.developersPanelContainer.classList.add(this.config.constants.VISIBLE_CLASS);
                    document.body.classList.add('modal-open');
                },

                hideDevelopersPanel() {
                    this.sfx.play('panelClose');
                    this.dom.developersPanelContainer.classList.remove(this.config.constants.VISIBLE_CLASS);
                    document.body.classList.remove('modal-open');
                },
                
                /**
                 * Sets the loading/disabled state of a button.
                 * @param {HTMLButtonElement} button - The button element.
                 * @param {boolean} isLoading - True to disable, false to enable.
                 * @param {string} [loadingText] - Optional text to show while loading.
                 */
                setButtonState(button, isLoading, loadingText) {
                    if (!button) return;
                    if (isLoading) {
                        button.disabled = true;
                        button.dataset.originalText = button.innerHTML;
                        if (loadingText) button.innerHTML = `<div class="loader !w-6 !h-6 !border-4 mx-auto"></div>`;
                    } else {
                        button.disabled = false;
                        if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
                    }
                },
                
                showError(message, element = this.dom.errorMessagebox) {
                    if(!element) return;
                    element.textContent = message;
                    element.classList.remove(this.config.constants.HIDDEN_CLASS);
                },

                hideError(element = this.dom.errorMessagebox) {
                    if(!element) return;
                    element.classList.add(this.config.constants.HIDDEN_CLASS);
                },

                // --- EVENT HANDLERS & ACTIONS ---
                generatePublicUserId() {
                    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    let result = '';
                    for (let i = 0; i < 5; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    this.dom.userIdDisplay.value = result;
                    this.state.publicUserId = result;
                },

                validateName(name) {
                    const trimmed = name.trim();
                    if (trimmed.length < 3) return "نام باید حداقل ۳ کاراکتر باشد.";
                    if (trimmed.length > 20) return "نام نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
                    if (!/^[a-zA-Z0-9_.-]+$/.test(trimmed)) return "نام فقط می‌تواند شامل حروف انگلیسی، اعداد و ._- باشد.";
                    return null; // valid
                },

                async handleRegistration() {
                    if (this.state.isBusy) return;
                    this.state.isBusy = true;
                    this.methods.setButtonState(this.dom.registerBtn, true, '...');
                    this.methods.hideError();
                    
                    const name = this.dom.displayNameInput.value;
                    const nameError = this.methods.validateName(name);

                    if (nameError) {
                        this.methods.showError(nameError);
                    } else if (!this.state.publicUserId) {
                        this.methods.showError("لطفاً یک شناسه کاربری بسازید.");
                    } else {
                        this.state.displayName = name.trim();
                        await this.methods._saveUserData();
                        this.methods.updateUI();
                    }
                    
                    this.methods.setButtonState(this.dom.registerBtn, false);
                    this.state.isBusy = false;
                },
                
                handleStartGame() {
                    this.sfx.play('startGame');
                    this.methods.showModal("شروع بازی", "پیشنهاد می‌شود برای بهترین تجربه از اینترنت پایدار استفاده کنید.", "ادامه", "بازگشت", () => {
                        this.methods.hideModal();
                        this.methods.showScreen('game-screen');
                        this.methods.generateQuestion();
                    });
                },

                async returnToMainScreen() {
                    await this.methods._saveUserData();
                    this.state.currentQuestionData = null;
                    this.methods.showScreen('main-screen');
                },

                handleModalConfirm() {
                    if (this.state.modalConfirmCallback) {
                        this.state.modalConfirmCallback();
                    }
                },
                
                // --- AI & GAME LOGIC ---
                /**
                 * Calls the Gemini API to generate text or JSON content.
                 * @param {string} prompt - The prompt to send to the API.
                 * @param {boolean} [isJsonOutput=false] - Whether to request JSON output.
                 * @returns {Promise<any|null>} - The parsed response or null on error.
                 */
                async callGeminiAPI(prompt, isJsonOutput = false) {
                    this.dom.aiThinkingIndicator.classList.remove(this.config.constants.HIDDEN_CLASS);
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.geminiTextModel}:generateContent?key=${this.config.geminiApiKey}`;
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: isJsonOutput ? { responseMimeType: "application/json" } : {}
                    };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API Error ${response.status}`);
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("پاسخ نامعتبر از هوش مصنوعی");
                        return isJsonOutput ? JSON.parse(text) : text;
                    } catch (error) {
                        console.error("Gemini API Error:", error);
                        this.methods.showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار AI پیش آمد. لطفاً از خاموش بودن فیلترشکن مطمئن شوید و دوباره تلاش کنید.`);
                        return null;
                    } finally {
                        this.dom.aiThinkingIndicator.classList.add(this.config.constants.HIDDEN_CLASS);
                    }
                },
                
                async generateQuestion() {
                    if (this.state.isBusy) return;
                    this.state.isBusy = true;
                    this.dom.questionText.textContent = "در حال تولید سوال جدید و غیرتکراری...";
                    this.dom.optionsContainer.innerHTML = "";
                    this.dom.questionExplanation.classList.add(this.config.constants.HIDDEN_CLASS);
                    this.dom.gameFeedback.textContent = "";

                    let questionData = null;
                    for (let i = 0; i < 3; i++) { // Max 3 retries for unique question
                        let difficulty = "آسان";
                        if (this.state.currentStage > 10) difficulty = "سخت";
                        else if (this.state.currentStage > 5) difficulty = "متوسط";
                        
                        const prompt = `یک سوال 4 گزینه‌ای جدید و غیرتکراری به زبان فارسی با موضوع مافیا (تاریخچه، فیلم‌ها، اصطلاحات بازی) با سطح دشواری "${difficulty}" برای بازیکن در مرحله ${this.state.currentStage} طراحی کن. خروجی باید فقط یک آبجکت JSON خام با این ساختار باشد: {"question": "...", "options": ["...", "...", "...", "..."], "correctAnswerIndex": 0, "explanation": "..."}`;
                        
                        const data = await this.methods.callGeminiAPI(prompt, true);
                        if (data?.question) {
                            const hash = this.methods.simpleHash(data.question);
                            if (!this.state.seenQuestionHashes.has(hash)) {
                                questionData = data;
                                break;
                            }
                        }
                    }

                    if (questionData) {
                        this.state.currentQuestionData = questionData;
                        this.methods.displayQuestion();
                    } else {
                        this.dom.questionText.textContent = "خطا در بارگذاری سوال.";
                        this.methods.showModal("خطا", "نتوانستیم سوال جدیدی بسازیم. آیا مایل به تلاش مجدد هستید؟", "تلاش مجدد", "بازگشت", () => {
                            this.methods.hideModal();
                            this.methods.generateQuestion();
                        });
                    }
                    this.state.isBusy = false;
                },

                displayQuestion() {
                    const { question, options } = this.state.currentQuestionData;
                    this.dom.questionText.textContent = question;
                    this.dom.optionsContainer.innerHTML = "";
                    options.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.className = 'option-btn w-full text-right';
                        button.textContent = `${index + 1}. ${option}`;
                        button.dataset.index = index;
                        button.onclick = (e) => this.methods.handleAnswerSelection(e);
                        this.dom.optionsContainer.appendChild(button);
                    });
                    this.state.isQuestionActive = true;
                },
                
                async handleAnswerSelection(event) {
                    if (!this.state.isQuestionActive || this.state.isBusy) return;
                    this.state.isQuestionActive = false;
                    this.state.isBusy = true;

                    const selectedBtn = event.target.closest('.option-btn');
                    const selectedIndex = parseInt(selectedBtn.dataset.index);
                    const { question, correctAnswerIndex, explanation } = this.state.currentQuestionData;

                    document.querySelectorAll('#options-container .option-btn').forEach(btn => btn.disabled = true);
                    
                    if (selectedIndex === correctAnswerIndex) {
                        this.sfx.play('correct');
                        selectedBtn.classList.add('correct');
                        this.dom.gameFeedback.textContent = "پاسخ صحیح!";
                        this.dom.gameFeedback.style.color = '#aaffaa';
                        this.state.currentStage++;
                        this.state.seenQuestionHashes.add(this.methods.simpleHash(question));
                        await this.methods._saveUserData();
                        setTimeout(() => { this.methods.generateQuestion(); this.methods.updateUI(); }, 2000);
                    } else {
                        this.sfx.play('incorrect');
                        selectedBtn.classList.add('incorrect');
                        this.dom.optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`).classList.add('correct');
                        this.dom.gameFeedback.textContent = "پاسخ اشتباه!";
                        this.dom.gameFeedback.style.color = '#ffaaaa';
                        setTimeout(() => this.methods.generateQuestion(), 4000);
                    }
                    
                    if (explanation) {
                        this.dom.questionExplanation.textContent = `توضیح: ${explanation}`;
                        this.dom.questionExplanation.classList.remove(this.config.constants.HIDDEN_CLASS);
                    }
                    this.state.isBusy = false;
                },

                async generateMafiaFact() {
                    this.methods.showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو...</p>", "باشه", null);
                    const prompt = "یک حقیقت جالب و کوتاه (۲-۴ جمله) در مورد دنیای مافیا به زبان فارسی بگو.";
                    const fact = await this.methods.callGeminiAPI(prompt);
                    if (fact) {
                        this.methods.showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!");
                    }
                },
                
                promptChangeDisplayName() {
                    const C = this.config.constants;
                    this.methods.showModal("تغییر نام", "نام جدید خود را وارد کنید.", "تغییر", "لغو", async () => {
                        const newName = this.dom.newDisplayNameInput.value;
                        const error = this.methods.validateName(newName);
                        if (error) {
                            this.methods.showError(error, this.dom.modalErrorMessage);
                            return;
                        }
                        if (newName.trim() === this.state.displayName) {
                             this.methods.showError("نام جدید باید متفاوت باشد.", this.dom.modalErrorMessage);
                             return;
                        }
                        this.state.displayName = newName.trim();
                        await this.methods._saveUserData();
                        this.methods.updateUI();
                        this.methods.hideModal();
                        this.methods.showModal("موفقیت", "نام شما با موفقیت تغییر کرد.", "عالی!");
                    }, 'changeName');
                },

                promptChangeAvatar() {
                    this.state.selectedAvatarForConfirmation = null;
                    this.methods.showModal("تغییر آواتار", "می‌توانید یک آواتار جدید با هوش مصنوعی بسازید.", "انتخاب", "لغو", async () => {
                        if (!this.state.selectedAvatarForConfirmation) {
                            this.methods.showError("لطفا یک آواتار انتخاب کنید.", this.dom.modalErrorMessage);
                            return;
                        }
                        this.state.avatarUrl = this.state.selectedAvatarForConfirmation;
                        await this.methods._saveUserData();
                        this.methods.updateUI();
                        this.methods.hideModal();
                    }, 'avatar');
                    this.dom.modalConfirmBtn.disabled = true;
                },

                async generateAndDisplayAvatars() {
                    if (this.state.isBusy) return;
                    this.state.isBusy = true;
                    this.dom.avatarAiLoading.classList.remove(this.config.constants.HIDDEN_CLASS);
                    this.methods.setButtonState(this.dom.generateAvatarBtn, true, '...');
                    this.dom.modalConfirmBtn.disabled = true;
                    this.dom.avatarSuggestionsContainer.innerHTML = '';
                    this.methods.hideError(this.dom.modalErrorMessage);

                    // For now, using placeholders as Imagen API can be slow/costly
                    // In a real scenario, you'd call the Imagen API here.
                    const placeholders = Array.from({length: 4}, (_, i) => `https://picsum.photos/seed/${Math.random()}/100`);
                    
                    placeholders.forEach(url => {
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = 'avatar-suggestion-item';
                        const img = document.createElement('img');
                        img.src = url; // In real use: `data:image/png;base64,...`
                        imgWrapper.append(img);
                        imgWrapper.onclick = () => {
                            this.sfx.play('click');
                            const current = this.dom.avatarSuggestionsContainer.querySelector('.selected');
                            if (current) current.classList.remove('selected');
                            imgWrapper.classList.add('selected');
                            this.state.selectedAvatarForConfirmation = url; // or the base64 string
                            this.dom.modalConfirmBtn.disabled = false;
                        };
                        this.dom.avatarSuggestionsContainer.append(imgWrapper);
                    });

                    this.dom.avatarAiLoading.classList.add(this.config.constants.HIDDEN_CLASS);
                    this.methods.setButtonState(this.dom.generateAvatarBtn, false);
                    this.state.isBusy = false;
                },

                // --- UTILITIES ---
                simpleHash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = ((hash << 5) - hash) + str.charCodeAt(i);
                        hash |= 0;
                    }
                    return `h${Math.abs(hash)}`;
                }
            }
        };

        // --- GAME START ---
        document.addEventListener('DOMContentLoaded', () => App.methods.init());

    </script>
</body>
</html>