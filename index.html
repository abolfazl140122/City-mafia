<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§ | Mafia City</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Global Styles */
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
            direction: rtl;
            text-align: right;
            line-height: 1.8;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, #c49730, #a57c1a);
            border-radius: 10px;
            border: 1px solid #333;
        }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, #d4a840, #c49730); }

        /* Animated Background */
        .mafia-animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            z-index: -1;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Panels */
        .panel {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(196, 151, 48, 0.4);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            padding: 24px;
            transition: all 0.4s ease;
        }
        .panel:hover {
            border-color: rgba(196, 151, 48, 0.7);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        }

        /* Buttons */
        .btn-mafia {
            background: linear-gradient(145deg, #c49730, #a57c1a);
            color: #1a1a1a;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
        }
        .btn-mafia:hover {
            background: linear-gradient(145deg, #d4a840, #c49730);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        .btn-mafia:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-mafia-secondary {
            background: rgba(60, 60, 60, 0.9);
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .btn-mafia-secondary:hover {
            background: rgba(80, 80, 80, 0.95);
            color: #c49730;
            border-color: #c49730;
            transform: scale(1.05);
        }

        /* Inputs */
        .input-mafia {
            background: rgba(40, 40, 40, 0.9);
            border: 1px solid #c49730;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .input-mafia:focus {
            outline: none;
            border-color: #d4a840;
            box-shadow: 0 0 12px rgba(196, 151, 48, 0.5);
        }
        .input-mafia.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
        }

        /* Loading Animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 6px solid #444;
            border-top: 6px solid #c49730;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        #modal-container {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.7);
        }
        #modal-container .panel {
            animation: modalPop 0.4s ease;
        }
        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* User Profile */
        #user-profile-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.4s ease;
        }
        #user-info-box {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(196, 151, 48, 0.3);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .user-info-item {
            background: rgba(40, 40, 40, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            border-right: 3px solid #c49730;
        }

        /* Responsive Typography */
        @media (max-width: 640px) {
            html { font-size: 14px; }
            .panel { padding: 16px; }
            .btn-mafia { padding: 10px 18px; font-size: 0.9rem; }
        }
        @media (min-width: 1024px) {
            html { font-size: 18px; }
            .panel { padding: 32px; }
        }

        /* Developer Panel */
        #developers-panel-container {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }
        #developers-panel {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border: 2px solid #c49730;
            border-radius: 20px;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .developer-item {
            background: rgba(40, 40, 40, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(196, 151, 48, 0.2);
            transition: all 0.3s ease;
        }
        .developer-item:hover {
            transform: translateY(-5px);
            border-color: #c49730;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* Question Options */
        .option-btn {
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #555;
            color: #e0e0e0;
            padding: 14px;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            text-align: right;
        }
        .option-btn:hover {
            background: rgba(70, 70, 70, 0.95);
            border-color: #c49730;
            transform: scale(1.02);
        }
        .option-btn.correct {
            background: linear-gradient(145deg, #28a745, #1e7e34) !important;
            color: white;
            border-color: #28a745 !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(145deg, #dc3545, #b02a37) !important;
            color: white;
            border-color: #dc3545 !important;
        }
    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>

    <!-- User Profile Area -->
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" title="ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±">
            <img id="avatar-image" src="" alt="Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±" class="w-16 h-16 rounded-full border-2 border-[#c49730]">
        </div>
        <div id="user-info-box">
            <div class="user-info-item">
                <span class="text-sm text-gray-300">Ø¨Ø§Ø²ÛŒÚ©Ù†:</span>
                <span id="display-name-output" class="font-bold text-lg text-[#e0e0e0]"></span>
            </div>
            <div class="user-info-item">
                <span class="text-sm text-gray-300">Ø´Ù†Ø§Ø³Ù‡:</span>
                <span id="public-user-id-output" class="font-mono text-[#a0a0a0]"></span>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
        <div class="text-center">
            <div class="loader mx-auto mb-6"></div>
            <h1 class="text-3xl sm:text-5xl font-bold text-[#c49730] animate-pulse">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h1>
            <p id="loading-message" class="text-lg mt-4 text-gray-400">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...</p>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4 sm:p-8">
        <div class="panel max-w-md w-full mb-8">
            <h1 class="text-4xl font-bold text-center mb-6 text-[#c49730]">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
            <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-mafia w-full mb-3">
            <p id="input-error-message" class="text-red-400 text-sm mb-2"></p>
            
            <div class="flex items-center gap-3 mb-4">
                <input type="text" id="user-id-display" readonly placeholder="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ" class="input-mafia w-full text-center">
                <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap">Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡</button>
            </div>
            <p id="user-id-error-message" class="text-red-400 text-sm mb-3"></p>

            <button id="register-btn" class="btn-mafia w-full py-3">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
        </div>

        <div id="main-screen-buttons-layout" class="hidden flex flex-wrap justify-center gap-4">
            <button id="start-game-btn" class="btn-mafia px-8 py-3 text-lg">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
            <button id="mafia-fact-btn" class="btn-mafia-secondary px-6 py-2">Ø¯Ø§Ù†Ø³ØªÙ†ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨</button>
            <button id="dev-intro-icon-btn-header" class="btn-mafia-secondary p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden min-h-screen p-4 sm:p-8">
        <div class="flex justify-between items-center mb-6">
            <button id="back-to-main-btn" class="btn-mafia-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <h2 class="text-2xl font-bold text-[#c49730]">Ù…Ø±Ø­Ù„Ù‡: <span id="stage-display">1</span></h2>
        </div>
        <div class="panel mb-6">
            <p id="question-text" class="text-xl sm:text-2xl text-center mb-8 leading-relaxed">Ø³ÙˆØ§Ù„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            <div id="options-container" class="grid grid-cols-1 gap-4"></div>
            <p id="question-explanation" class="text-sm text-gray-400 mt-4 text-center hidden"></p>
        </div>
        <div id="game-feedback" class="text-center text-lg font-bold h-8"></div>
        <div id="ai-thinking-indicator" class="text-center mt-4 hidden">
            <div class="loader inline-block"></div>
            <p class="mt-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="panel max-w-lg w-full mx-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#c49730]"></h3>
            <p id="modal-message" class="mb-6"></p>
            <!-- Dynamic Content Here -->
            <div class="flex justify-center gap-3">
                <button id="modal-confirm-btn" class="btn-mafia px-6 py-2">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary px-6 py-2">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div id="developers-panel" class="max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-[#c49730]">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h2>
                <button id="close-developers-panel-btn" class="text-2xl text-gray-400 hover:text-white transition">
                    âœ•
                </button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div class="developer-item">
                    <h4 class="text-lg font-bold text-[#c49730] mb-2">ğŸ’» Ø§Ø¨ÙˆØ§Ù„ÙØ¶Ù„ - Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    <p class="text-gray-300">Ù…Ø¹Ù…Ø§Ø± Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ùˆ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ</p>
                </div>
                <div class="developer-item">
                    <h4 class="text-lg font-bold text-[#c49730] mb-2">ğŸ¨ ÙˆØ­ÛŒØ¯ - Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    <p class="text-gray-300">Ø·Ø±Ø§Ø­ UI/UX Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¨Ø§Ø²ÛŒ</p>
                </div>
                <div class="developer-item">
                    <h4 class="text-lg font-bold text-[#c49730] mb-2">â˜ï¸ Ù†Ø¯Ø§ - ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    <p class="text-gray-300">Ù…Ø³Ø¦ÙˆÙ„ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
            authDomain: "city-mafia.firebaseapp.com",
            projectId: "city-mafia",
            storageBucket: "city-mafia.appspot.com", 
            messagingSenderId: "66458127103",
            appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
            measurementId: "G-8M0M6BJ0GG"
        };

        const appId = 'mafia-game-default';
        let app, auth, db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
        };

        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalMessage,
            modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function showScreen(screenElement) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            screenElement.classList.remove('hidden');
            updateUI();
        }

        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalConfirmBtn.textContent = confirmText;
            modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;
            modalContainer.classList.remove('hidden');
        }

        function hideModal() {
            modalContainer.classList.add('hidden');
            modalConfirmCallback = null;
            modalCancelCallback = null;
        }

        function updateUI() {
            displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
            publicUserIdOutput.textContent = gameState.publicUserId || "---";
            stageDisplay.textContent = gameState.currentStage;

            if (gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }

            const showRegistration = !gameState.displayName || !gameState.publicUserId;
            registrationForm.classList.toggle('hidden', !showRegistration);
            mainScreenButtonsLayout.classList.toggle('hidden', showRegistration);
            userProfileArea.classList.toggle('hidden', showRegistration);
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        await signInAnonymously(auth);
                    }
                    isAuthReady = true;
                    updateUI();
                    loadingScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                });
            } catch (error) {
                console.error("Firebase Error:", error);
                loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±";
            }
        }

        async function loadUserData() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function saveUserData() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error saving user data:", error);
            }
        }

        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash";

        async function callGeminiAPI(prompt) {
            aiThinkingIndicator.classList.remove('hidden');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.");
                return null;
            } finally {
                aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            questionText.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯...";
            optionsContainer.innerHTML = "";

            const prompt = `ÛŒÚ© Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ÙÛŒØ§ Ø¨Ø§ Û´ Ú¯Ø²ÛŒÙ†Ù‡ Ùˆ ÛŒÚ© Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†.`;
            const questionData = await callGeminiAPI(prompt);
            if (questionData) {
                gameState.currentQuestionData = JSON.parse(questionData);
                displayQuestion();
            }
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full p-3 rounded-md text-lg';
                btn.textContent = `${index + 1}. ${option}`;
                btn.onclick = () => checkAnswer(index);
                optionsContainer.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex) {
            const { correctAnswerIndex } = gameState.currentQuestionData;
            const buttons = optionsContainer.children;
            for (let btn of buttons) btn.disabled = true;

            if (selectedIndex === correctAnswerIndex) {
                buttons[selectedIndex].classList.add('correct');
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­!";
                gameFeedback.style.color = "green";
                gameState.currentStage++;
                saveUserData();
                setTimeout(generateQuestion, 2000);
            } else {
                buttons[selectedIndex].classList.add('incorrect');
                buttons[correctAnswerIndex].classList.add('correct');
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡!";
                gameFeedback.style.color = "red";
                setTimeout(generateQuestion, 4000);
            }
        }

        function setupEventListeners() {
            registerBtn.addEventListener('click', async () => {
                gameState.displayName = displayNameInput.value.trim();
                gameState.publicUserId = userIdDisplayInput.value.trim();
                if (gameState.displayName && gameState.publicUserId) {
                    await saveUserData();
                    updateUI();
                }
            });

            generateUserIdBtn.addEventListener('click', () => {
                userIdDisplayInput.value = Math.random().toString(36).substring(2, 7).toUpperCase();
            });

            startGameBtn.addEventListener('click', () => {
                showScreen(gameScreen);
                generateQuestion();
            });

            backToMainBtn.addEventListener('click', () => {
                showScreen(mainScreen);
            });

            modalConfirmBtn.addEventListener('click', () => {
                if (modalConfirmCallback) modalConfirmCallback();
                hideModal();
            });

            modalCancelBtn.addEventListener('click', () => {
                if (modalCancelCallback) modalCancelCallback();
                hideModal();
            });

            devIntroBtnHeader.addEventListener('click', () => {
                developersPanelContainer.classList.remove('hidden');
            });

            closeDevelopersPanelBtn.addEventListener('click', () => {
                developersPanelContainer.classList.add('hidden');
            });
        }

        function initializeGame() {
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            registrationForm = document.querySelector('#main-screen .panel');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userProfileArea = document.getElementById('user-profile-area');
            avatarImage = document.getElementById('avatar-image');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');

            setupEventListeners();
            initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
