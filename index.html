<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ - Ù†Ø³Ø®Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME --- */

        :root {
            --clash-blue-dark: #3a5b8a;
            --clash-blue-light: #5c88c8;
            --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500;
            --clash-brown-dark: #5b3a29;
            --clash-text-light: #ffffff;
            --clash-text-dark: #333333;
            --clash-green: #59a845;
            --clash-green-dark: #3a752b;
            --clash-red: #c74243;
            --clash-red-dark: #8f2a2b;
            --clash-panel-bg: #4468a0;
            --clØ§Ø´-panel-border: #9dc2ff;
            --clash-panel-border-dark: #2a4166;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes clash-panel-intro {
            0% { opacity: 0; transform: scale(0.8) translateY(-30px); }
            70% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; }
            50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; }
        }

        @keyframes subtle-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 200%; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- NEW LOADING SCREEN ANIMATIONS --- */
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 200, 58, 0.4)); }
            50% { filter: drop-shadow(0 0 16px rgba(255, 200, 58, 0.8)); }
        }
        
        @keyframes tipFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }


        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--clash-text-light);
            background-color: #1a283e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; /* Changed to hidden for better control with screens */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            /* Android Fix: Improve touch responsiveness */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animated Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.15;
            z-index: 0;
            animation: subtle-pan 120s linear infinite;
        }

        .clash-font {
            font-family: 'Lilita One', cursive;
            letter-spacing: 1px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .panel-clash {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
        }
        
        /* Panel Corner Rivets */
        .panel-clash::before, .panel-clash::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--clash-gold);
            border-radius: 50%;
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 0 3px #000;
        }
        .panel-clash::before { top: 10px; left: 10px; }
        .panel-clash::after { top: 10px; right: 10px; }
        
        #developers-panel::before, #developers-panel::after, #game-mode-panel::before, #game-mode-panel::after { top: 15px; }


        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-clash {
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s ease-out; /* Faster transition */
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--clash-text-dark);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.4);
        }
        .btn-clash:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            box-shadow: 0 4px 0 #555 !important;
            transform: translateY(0) !important;
        }

        /* --- Primary Button (Gold) --- */
        .btn-clash-primary {
            background: linear-gradient(to bottom, #ffe47a, var(--clash-gold));
            border: 2px solid var(--clash-brown-dark);
            box-shadow: 0 6px 0 #a07200;
            padding: 10px 24px;
            font-size: 1.1rem;
        }
        @media (min-width: 640px) { .btn-clash-primary { padding: 12px 30px; font-size: 1.25rem; } }

        .btn-clash-primary:hover {
            background: linear-gradient(to bottom, #fff0a0, #ffda5a);
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #a07200;
        }
        .btn-clash-primary:active {
            transform: translateY(4px) !important;
            box-shadow: 0 2px 0 #a07200 !important;
            transition-duration: 0.05s;
        }
        
        /* Breathing animation for start button */
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }
        
        /* --- Secondary Button (Blue) --- */
        .btn-clash-secondary {
            background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light));
            border: 2px solid var(--clash-panel-border-dark);
            box-shadow: 0 5px 0 #2e5185;
            padding: 8px 18px;
            font-size: 0.9rem;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { .btn-clash-secondary { padding: 10px 22px; font-size: 1rem; } }

        .btn-clash-secondary:hover {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2e5185;
        }
        .btn-clash-secondary:active {
            transform: translateY(3px) !important;
            box-shadow: 0 2px 0 #2e5185 !important;
            transition-duration: 0.05s;
        }

        .input-clash {
            background-color: var(--clash-panel-border-dark);
            border: 2px solid #2a4166;
            color: #fff;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4);
            /* Android Fix: Improve touch interaction */
            -webkit-user-select: auto;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: auto;
            touch-action: manipulation;
        }
        .input-clash:focus {
            outline: none;
            border-color: var(--clash-gold);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold);
        }
        .input-clash.invalid {
            border-color: var(--clash-red);
        }
        .input-clash:read-only {
            background-color: #314a70;
            cursor: default;
        }
        
        /* --- Option Buttons (Game Screen) --- */
        .option-btn {
            background: linear-gradient(to bottom, #7da8e8, #5c88c8);
            border: 2px solid #2a4166;
            box-shadow: 0 4px 0 #2e5185;
            color: white;
            transition: all 0.15s ease;
            font-size: 1rem;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .option-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #9dc2ff, #6c98d8);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2e5185;
        }
        .option-btn.correct {
            background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important;
            border-color: #2e6221 !important;
            box-shadow: 0 4px 0 var(--clash-green-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn.incorrect {
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important;
            border-color: #7c2425 !important;
            box-shadow: 0 4px 0 var(--clash-red-dark) !important;
            transform: translateY(0) !important;
        }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        .loader {
            border: 8px solid #3a5b8a;
            border-top: 8px solid var(--clash-gold);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb { background: var(--clash-gold); border-radius: 5px; border: 2px solid var(--clash-blue-dark); }
        ::-webkit-scrollbar-thumb:hover { background: var(--clash-gold-dark); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1; /* Ensure screens are on top of the background */
        }
        @media (min-width: 640px) { .screen { padding: 20px; } }
        #main-screen { justify-content: flex-start; }
        #loading-screen { 
            justify-content: center; 
            background: radial-gradient(circle, rgba(42,65,102,0.5) 0%, rgba(26,40,62,0.8) 70%);
        }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        /* --- NEW: Professional Loading Screen Styles --- */
        #loading-content-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 450px;
        }
        #loading-logo {
            max-width: 280px;
            width: 70%;
            margin-bottom: 1.5rem;
            animation: fadeInScaleUp 1s ease-out, pulseGlow 3s infinite 1s;
        }
        #loading-progress-bar-container {
            width: 100%;
            background-color: var(--clash-panel-border-dark);
            border: 3px solid #2a4166;
            border-radius: 12px;
            padding: 4px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        #loading-progress-bar-fill {
            height: 18px;
            width: 0%; /* Starts at 0, controlled by JS */
            background: linear-gradient(to right, var(--clash-gold-dark), var(--clash-gold));
            border-radius: 8px;
            transition: width 0.5s ease-out;
            box-shadow: 0 0 10px var(--clash-gold);
        }
        #loading-message {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--clash-text-light);
            text-shadow: 1px 1px 2px #000;
            min-height: 28px; /* Prevent layout shift */
        }
        #loading-tip {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #d0e0ff;
            font-style: italic;
            background-color: rgba(0,0,0,0.25);
            padding: 8px 12px;
            border-radius: 8px;
            min-height: 50px; /* Prevent layout shift */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: tipFadeIn 0.8s ease-out;
        }

        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) { .screen-content-wrapper { padding-bottom: 20px; } }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px);
            padding-top: 60px;
        }
        @media (min-width: 640px) { #main-screen .screen-content-wrapper { min-height: calc(100vh - 40px); padding-top: 80px; } }
        @media (min-width: 768px) { #main-screen .screen-content-wrapper { padding-top: 20px; } }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed; z-index: 100; display: flex; align-items: center; gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area { top: 10px; left: 50%; transform: translateX(-50%) translateY(0); }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateX(-50%) translateY(-150%); }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area { top: 20px; right: 20px; left: auto; transform: translateY(0); align-items: center; }
            #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        }

        #user-info-box {
            background-color: rgba(91, 58, 41, 0.85); /* Wood color */
            border: 4px solid #4a2f20;
            border-top-color: #c89673;
            border-left-color: #c89673;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; /* MODIFIED: Always column */
            align-items: stretch; gap: 10px;
            width: max-content;
            min-width: 180px;
            max-width: 200px;
        }
        #user-info-box.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.9em; color: #f0d5bf; font-family: 'Vazirmatn'; }
        .user-info-item .value { font-size: 1.1em; font-weight: bold; }

        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.1em; }
        #public-user-id-output-box .value { color: #eee; font-family: monospace; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; }
        #edit-name-btn:hover { color: #fff8a8; }

        /* DELETED AVATAR STYLES */
        
        #main-screen-header { 
            display: flex; justify-content: center; /* MODIFIED: Center the title */
            align-items: center; width: 100%; 
            padding: 0.5rem; margin-bottom: 1.5rem; /* MODIFIED: Increased margin bottom */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-color: #6e4a31;
            border-radius: 12px;
            border: 4px solid #4a2f20;
            box-shadow: 0 6px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
        }
        
        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 3rem;
            color: var(--clash-gold);
            text-shadow: 
                -3px -3px 0 var(--clash-brown-dark),  
                 3px -3px 0 var(--clash-brown-dark),
                -3px  3px 0 var(--clash-brown-dark),
                 3px  3px 0 var(--clash-brown-dark),
                 -3px 0 0 var(--clash-brown-dark),
                 3px 0 0 var(--clash-brown-dark),
                 0 -3px 0 var(--clash-brown-dark),
                 0 3px 0 var(--clash-brown-dark),
                 6px 6px 8px rgba(0,0,0,0.7);
        }
        @media (min-width: 640px) { #main-title { font-size: 4.5rem; } }
        @media (min-width: 768px) { #main-title { font-size: 5.5rem; } }

        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; width: 100%; padding-bottom: 5px; }
        
        #input-error-message, #user-id-error-message, #change-name-error-message, #login-error-message {
            color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red);
        }
        .hidden { display: none !important; }

        /* Styles for Pop-up Panels */
        #developers-panel-container, #game-mode-panel-container { background-color: rgba(10, 10, 10, 0.85); }
        #developers-panel, #game-mode-panel {
            background-color: var(--clash-panel-bg);
            border: 4px solid var(--clash-panel-border-dark);
            border-top-color: var(--clash-panel-border);
            border-left-color: var(--clash-panel-border);
        }
        #close-developers-panel-btn, #close-game-mode-panel-btn {
            position: absolute; top: 12px; right: 12px; width: 40px; height: 40px;
            background: linear-gradient(to bottom, #e87b7c, var(--clash-red));
            border: 2px solid #7c2425;
            box-shadow: 0 4px 0 #8f2a2b;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
            font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease;
        }
        #close-developers-panel-btn:hover, #close-game-mode-panel-btn:hover { transform: scale(1.1) rotate(90deg); }
        #close-developers-panel-btn:active, #close-game-mode-panel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8f2a2b; }

        .developer-item {
            background-color: rgba(42, 65, 102, 0.9);
            padding: 1rem 1.2rem; border-radius: 12px;
            border: 2px solid rgba(157, 194, 255, 0.4);
        }
        .dev-header { border-bottom: 2px solid rgba(157, 194, 255, 0.3); }
        .dev-role-icon { font-size: 1.7em; color: var(--clash-gold); margin-left: 10px; }
        .dev-role { font-size: 1.15rem; font-weight: 700; color: #fff; font-family: 'Vazirmatn'; }
        .dev-username { color: #fff8a8; font-weight: bold; font-size: 1.25rem; }
        .dev-description { font-size: 0.9rem; color: #d0e0ff; line-height: 1.65; font-family: 'Vazirmatn'; }

        /* --- NEW STYLES for Game Mode Panel --- */
        #game-mode-panel .btn-clash-primary {
            padding: 16px 32px;
            font-size: 1.5rem;
            width: 100%;
            max-width: 300px;
        }
        #game-mode-panel .btn-clash-primary .icon {
            font-size: 2rem;
            margin-left: 12px;
        }
        
        /* --- NEW STYLES for Question Timer --- */
        #timer-container {
            position: relative;
            width: 60px;
            height: 60px;
        }
        #timer-svg {
            transform: rotate(-90deg); /* Start from the top */
        }
        .timer-circle {
            fill: none;
            stroke-width: 8;
        }
        .timer-bg {
            stroke: var(--clash-panel-border-dark);
        }
        .timer-progress {
            stroke: var(--clash-gold);
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }
        #timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Lilita One', cursive;
            font-size: 1.8rem;
            color: var(--clash-gold);
            text-shadow: 2px 2px 2px #000;
        }

    </style>
</head>
<body>
    <div id="user-profile-area" class="hidden">
        <!-- DELETED AVATAR CONTAINER -->
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>Ø¨Ø§Ø²ÛŒÚ©Ù†:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="ØªØºÛŒÛŒØ± Ù†Ø§Ù…">âœï¸</span>
                    <div id="display-name-output" class="value clash-font"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M10.681 5.438 1.48 11.644a1.001 1.001 0 0 0 0 1.503l8.948 6.039a.998.998 0 0 0 1.474-.343l.15-.345-4.437-4.321 4.437-4.321-.15-.345a.998.998 0 0 0-1.221-.574zM22.52 11.644 13.319 5.438a.998.998 0 0 0-1.474.343l-.15.345 4.437 4.321-4.437 4.321.15.345a.998.998 0 0 0 1.474.343l9.201-6.206a1 1 0 0 0 0-1.503z"></path></svg>
                    <span>Ø´Ù†Ø§Ø³Ù‡:</span>
                </div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div id="loading-content-box">
            <img id="loading-logo" src="https://up.20script.ir/file/7e7a-Copilot-20250812-110015-removebg-preview.png" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§">
            <h1 class="text-4xl sm:text-5xl font-bold clash-font text-[var(--clash-gold)]" style="text-shadow: 3px 3px 4px #000;">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
            
            <div id="loading-progress-bar-container">
                <div id="loading-progress-bar-fill"></div>
            </div>
            
            <p id="loading-message" class="text-lg">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ...</p>
            
            <p id="loading-tip">âœ¨ Ø¨Ù‡ Ø¯Ù†ÛŒØ§ÛŒ Ø±Ù…Ø²Ø¢Ù„ÙˆØ¯ Ù…Ø§ÙÛŒØ§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯... âœ¨</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <div id="main-screen-header">
                    <h1 id="main-title" class="clash-font">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                </div>

                <div id="auth-panel" class="mb-4 panel-clash panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <!-- Registration Form -->
                    <div id="registration-form">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 2px #000;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
                        <label for="display-name-input" class="block mb-1">
                            <span class="text-sm font-medium mb-1 inline-block">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ):</span>
                            <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg clash-font" maxlength="20">
                        </label>
                        <p id="input-error-message" class="hidden"></p>

                        <div class="mt-3 mb-2">
                            <label for="user-id-display" class="block text-sm font-medium mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (5 Ø±Ù‚Ù…ÛŒ):</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="user-id-display" class="input-clash w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="Ø¨Ø³Ø§Ø²!">
                                <button id="generate-user-id-btn" class="btn-clash btn-clash-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm clash-font">Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡</button>
                            </div>
                            <p id="user-id-error-message" class="hidden"></p>
                        </div>

                        <button id="register-btn" class="btn-clash btn-clash-primary w-full p-2 sm:p-3 text-base sm:text-lg mt-4 clash-font">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±</button>
                    </div>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons">
                    <!-- MODIFIED: Removed Leaderboard and Facts buttons -->
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
                    <button id="developers-btn" class="btn-clash btn-clash-secondary clash-font">ğŸ‘¥ Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù†</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-lg">
                <button id="back-to-main-btn" class="btn-clash btn-clash-secondary clash-font text-sm">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <div class="font-bold">Ù…Ø±Ø­Ù„Ù‡: <span id="stage-display" class="clash-font text-[var(--clash-gold)] text-2xl">1</span></div>
                <div id="timer-container">
                    <svg id="timer-svg" width="60" height="60" viewBox="0 0 60 60">
                        <circle class="timer-circle timer-bg" cx="30" cy="30" r="26"></circle>
                        <circle id="timer-progress-circle" class="timer-circle timer-progress" cx="30" cy="30" r="26"></circle>
                    </svg>
                    <span id="timer-text">20</span>
                </div>
            </div>

            <div id="question-container" class="panel-clash panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed font-bold">Ø³ÙˆØ§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4"></div>
                <p id="question-explanation" class="text-sm mt-4 text-gray-200 bg-black/30 p-2 rounded-md text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-lg font-semibold my-4 h-8 clash-font"></div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">ØªÙˆØ¬Ù‡</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <!-- DELETED AVATAR UPLOAD UI -->
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative">
            <button id="close-developers-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’»</span>
                        <h4 class="dev-role">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    </div>
                    <p class="dev-username clash-font">abolfazl1401</p>
                    <p class="dev-description">Ù…Ø¹Ù…Ø§Ø± Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ú¯ÛŒÙ…â€ŒÙ¾Ù„ÛŒØŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ¨</span>
                        <h4 class="dev-role">Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    </div>
                    <p class="dev-username clash-font">Vahid</p>
                    <p class="dev-description">Ø·Ø±Ø§Ø­ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (UX). Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®Ù„Ù‚ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¬Ø°Ø§Ø¨ Ùˆ ØªÙ… Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø§Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸ’¡</span>
                        <h4 class="dev-role">Ø§ÛŒØ¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²</h4>
                    </div>
                    <p class="dev-username clash-font">Ali.k</p>
                    <p class="dev-description">Ø®Ø§Ù„Ù‚ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø³ØªØ§Ù†â€ŒØ³Ø±Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§.</p>
                </div>
                 <div class="developer-item">
                    <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">â˜ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">Neda_Tech</p>
                    <p class="dev-description">Ù…ØªØ®ØµØµ Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ØŒ ØªØ¶Ù…ÛŒÙ† Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ø²ÛŒ.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">âš™ï¸</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="dev-username clash-font">SinaCloud</p>
                    <p class="dev-description">Ù…Ø³Ø¦ÙˆÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø´Ø¨Ú©Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ§Ù†.</p>
                </div>
                <div class="developer-item">
                     <div class="dev-header flex items-center mb-2 pb-2">
                        <span class="dev-role-icon">ğŸš€</span>
                        <h4 class="dev-role">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ± (DevOps)</h4>
                    </div>
                    <p class="dev-username clash-font">ParsaDevOps</p>
                    <p class="dev-description">Ù…ØªÙ…Ø±Ú©Ø² Ø¨Ø± ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ DevOpsØŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Mode Selection Panel -->
    <div id="game-mode-panel-container" class="fixed inset-0 flex items-center justify-center p-4 panel-hidden z-[51]">
        <div id="game-mode-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg w-full relative">
            <button id="close-game-mode-panel-btn">Ã—</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-6 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</h3>
            <p class="text-center text-gray-200 mb-8">Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
            <div class="flex flex-col items-center justify-center gap-6">
                <button id="single-player-btn" class="btn-clash btn-clash-primary clash-font">
                    <span class="icon">ğŸ‘¤</span>
                    <span>Ø¨Ø§Ø²ÛŒ ØªÚ©â€ŒÙ†ÙØ±Ù‡</span>
                </button>
                <button id="multiplayer-btn" class="btn-clash btn-clash-primary clash-font" disabled title="Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.">
                    <span class="icon">ğŸ‘¥</span>
                    <span>Ø¨Ø§Ø²ÛŒ Ú†Ù†Ø¯Ù†ÙØ±Ù‡</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <div id="audio-container" class="hidden">
        <audio id="sfx-click" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
        <audio id="sfx-panel-open" src="https://assets.mixkit.co/sfx/preview/mixkit-stone-slab-sliding-1950.mp3" preload="auto"></audio>
        <audio id="sfx-panel-close" src="https://assets.mixkit.co/sfx/preview/mixkit-gate-latch-click-1929.mp3" preload="auto"></audio>
        <audio id="sfx-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
        <audio id="sfx-start-game" src="https://assets.mixkit.co/sfx/preview/mixkit-epic-orchestra-transition-2290.mp3" preload="auto"></audio>
        <audio id="sfx-time-tick" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3" preload="auto"></audio>
    </div>

    <script>
        // --- OFFLINE JAVASCRIPT LOGIC ---
        // --- ALL FIREBASE AND AI-API CALLS HAVE BEEN REMOVED ---

        // --- AUDIO MANAGER ---
        const audioManager = {
            sounds: {},
            init() {
                this.sounds.click = document.getElementById('sfx-click');
                this.sounds.panelOpen = document.getElementById('sfx-panel-open');
                this.sounds.panelClose = document.getElementById('sfx-panel-close');
                this.sounds.correct = document.getElementById('sfx-correct');
                this.sounds.incorrect = document.getElementById('sfx-incorrect');
                this.sounds.startGame = document.getElementById('sfx-start-game');
                this.sounds.timeTick = document.getElementById('sfx-time-tick');

                Object.values(this.sounds).forEach(sound => {
                    if (sound) sound.volume = 0.4;
                });
                if (this.sounds.timeTick) this.sounds.timeTick.volume = 0.2;
            },
            play(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.warn("Audio play failed:", e));
                }
            }
        };
        
        // --- NEW: Hardcoded local questions array (Replaces Questions.json) ---
        const localQuestions = [
            {
                "question": "Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ØŒ Ù†Ù‚Ø´ Â«Ú¯Ø§Ø¯ÙØ§Ø¯Ø±Â» Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø´ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡ Ú†ÛŒØ³ØªØŸ",
                "options": ["Ù…Ø§ÙÛŒØ§", "Ø´Ù‡Ø±ÙˆÙ†Ø¯", "Ù†Ø§Ù…Ø´Ø®Øµ", "Ù…Ù†ÙÛŒ"],
                "correctAnswerIndex": 1,
                "explanation": "Ú¯Ø§Ø¯ÙØ§Ø¯Ø± ÛŒØ§ Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡ØŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ØªØ±ÛŒÙ† Ø¹Ø¶Ùˆ Ù…Ø§ÙÛŒØ§ Ø§Ø³Øª Ú©Ù‡ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø´ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø«Ø¨Øª (Ø´Ù‡Ø±ÙˆÙ†Ø¯) Ø§Ø³Øª ØªØ§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´ÙˆØ¯."
            },
            {
                "question": "Ú©Ø¯Ø§Ù… ÛŒÚ© Ø§Ø² Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¯Ø± Ø¯Ø³ØªÙ‡ Ø´Ù‡Ø±ÙˆÙ†Ø¯Ø§Ù† Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ØŸ",
                "options": ["Ø¯Ú©ØªØ± Ù„Ú©ØªØ±", "Ù†Ø§ØªØ§Ø´Ø§", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "ØªØ±ÙˆØ±ÛŒØ³Øª"],
                "correctAnswerIndex": 2,
                "explanation": "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ú©Ù„ÛŒØ¯ÛŒâ€ŒØªØ±ÛŒÙ† Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù‡Ø±ÙˆÙ†Ø¯ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù‡Ø± Ø´Ø¨ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯."
            },
            {
                "question": "ÙÛŒÙ„Ù… Ù…Ø´Ù‡ÙˆØ± Â«Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡Â» (The Godfather) ØªÙˆØ³Ø· Ú©Ø¯Ø§Ù… Ú©Ø§Ø±Ú¯Ø±Ø¯Ø§Ù† Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ",
                "options": ["Ù…Ø§Ø±ØªÛŒÙ† Ø§Ø³Ú©ÙˆØ±Ø³ÛŒØ²ÛŒ", "Ú©ÙˆØ¦Ù†ØªÛŒÙ† ØªØ§Ø±Ø§Ù†ØªÛŒÙ†Ùˆ", "ÙØ±Ø§Ù†Ø³ÛŒØ³ ÙÙˆØ±Ø¯ Ú©ÙˆÙ¾ÙˆÙ„Ø§", "Ø¢Ù„ÙØ±Ø¯ Ù‡ÛŒÚ†Ú©Ø§Ú©"],
                "correctAnswerIndex": 2,
                "explanation": "ÙØ±Ø§Ù†Ø³ÛŒØ³ ÙÙˆØ±Ø¯ Ú©ÙˆÙ¾ÙˆÙ„Ø§ Ú©Ø§Ø±Ú¯Ø±Ø¯Ø§Ù† Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø± Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø§Ø³Øª Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¨Ø±ØªØ±ÛŒÙ† Ø¢Ø«Ø§Ø± ØªØ§Ø±ÛŒØ® Ø³ÛŒÙ†Ù…Ø§ Ù…Ø­Ø³ÙˆØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
            },
            {
                "question": "Ø§ØµØ·Ù„Ø§Ø­ Â«OmertÃ Â» Ø¯Ø± ÙØ±Ù‡Ù†Ú¯ Ù…Ø§ÙÛŒØ§ Ø¨Ù‡ Ú†Ù‡ Ù…Ø¹Ù†Ø§Ø³ØªØŸ",
                "options": ["Ù‚Ø§Ù†ÙˆÙ† Ø§Ù†ØªÙ‚Ø§Ù…", "Ù‚Ø§Ù†ÙˆÙ† Ø³Ú©ÙˆØª", "ØªÙ‚Ø³ÛŒÙ… ØºÙ†Ø§Ø¦Ù…", "Ø¬Ù„Ø³Ù‡ Ø´Ø¨Ø§Ù†Ù‡"],
                "correctAnswerIndex": 1,
                "explanation": "Ø§ÙˆÙ…Ø±ØªØ§ (OmertÃ ) Ù‚Ø§Ù†ÙˆÙ† Ù†Ø§Ù†ÙˆØ´ØªÙ‡â€ŒØ§ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ Ù…Ø§ÙÛŒØ§ Ø±Ø§ Ø¨Ù‡ Ø³Ú©ÙˆØª Ùˆ Ø¹Ø¯Ù… Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ Ù…Ù‚Ø§Ù…Ø§Øª Ù‚Ø¶Ø§ÛŒÛŒ Ù…Ù„Ø²Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯."
            },
            {
                "question": "Ù†Ù‚Ø´ Â«Ø­Ø±ÙÙ‡â€ŒØ§ÛŒÂ» Ø¯Ø± Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø´Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø§ÙÛŒØ§ Ú†Ù‡ Ù‚Ø§Ø¨Ù„ÛŒØªÛŒ Ø¯Ø§Ø±Ø¯ØŸ",
                "options": ["Ø¯Ùˆ Ø¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ù„ÛŒÚ© Ú©Ù†Ø¯", "Ù‡Ø± Ø´Ø¨ ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ø´Ø¯", "ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ø§ÙÛŒØ§ Ø±Ø§ Ø¨Ø²Ù†Ø¯", "ÛŒÚ© Ø¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ù†Ø¬Ø§Øª Ø¯Ù‡Ø¯"],
                "correctAnswerIndex": 0,
                "explanation": "Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÛŒØ§ Ù‡ÛŒØªÙ…Ù†ØŒ ÛŒÚ© Ù‚Ø§ØªÙ„ Ø³Ø±ÛŒØ§Ù„ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø·ÙˆÙ„ Ú©Ù„ Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ ØªÛŒØ± Ø¯Ø§Ø±Ø¯ Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ù‡Ø±Ú©Ø³ÛŒ Ø´Ù„ÛŒÚ© Ú©Ù†Ø¯."
            },
            {
                "question": "Â«Ø¢Ù„ Ú©Ø§Ù¾ÙˆÙ†Â»ØŒ Ú¯Ù†Ú¯Ø³ØªØ± Ù…Ø¹Ø±ÙˆÙ Ø´ÛŒÚ©Ø§Ú¯ÙˆØŒ Ø³Ø±Ø§Ù†Ø¬Ø§Ù… Ø¨Ù‡ Ú†Ù‡ Ø¬Ø±Ù…ÛŒ Ø¯Ø³ØªÚ¯ÛŒØ± Ùˆ Ø²Ù†Ø¯Ø§Ù†ÛŒ Ø´Ø¯ØŸ",
                "options": ["Ù‚ØªÙ„", "Ø³Ø±Ù‚Øª Ù…Ø³Ù„Ø­Ø§Ù†Ù‡", "Ù‚Ø§Ú†Ø§Ù‚", "ÙØ±Ø§Ø± Ù…Ø§Ù„ÛŒØ§ØªÛŒ"],
                "correctAnswerIndex": 3,
                "explanation": "Ø¨Ø§ ÙˆØ¬ÙˆØ¯ Ø¬Ø±Ø§ÛŒÙ… Ù…ØªØ¹Ø¯Ø¯ØŒ Ù¾Ù„ÛŒØ³ ØªÙ†Ù‡Ø§ ØªÙˆØ§Ù†Ø³Øª Ø¢Ù„ Ú©Ø§Ù¾ÙˆÙ† Ø±Ø§ Ø¨Ù‡ Ø¬Ø±Ù… ÙØ±Ø§Ø± Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø§Ù„ÛŒØ§Øª Ù…Ø­Ú©ÙˆÙ… Ú©Ù†Ø¯."
            },
            {
                "question": "Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§ØŒ Ø§Ú¯Ø± Ø¯Ú©ØªØ± Ø¯Ø± Ø´Ø¨ Ø§ÙˆÙ„ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ù†Ø¬Ø§Øª Ø¯Ù‡Ø¯ (Save)ØŒ Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ù…ÛŒâ€ŒØ§ÙØªØ¯ØŸ",
                "options": ["Ù‡ÛŒÚ† Ø§ØªÙØ§Ù‚ÛŒ Ù†Ù…ÛŒâ€ŒØ§ÙØªØ¯", "Ø§Ø² Ø¨Ø§Ø²ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯", "Ù‚Ø§Ø¨Ù„ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø¯Ø³Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯", "ÛŒÚ© Ø¬Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯"],
                "correctAnswerIndex": 2,
                "explanation": "Ø¯Ø± Ø¨Ø³ÛŒØ§Ø±ÛŒ Ø§Ø² Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ØŒ Ø¯Ú©ØªØ± ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ù†Ø¬Ø§Øª Ø¯Ù‡Ø¯ Ùˆ Ù¾Ø³ Ø§Ø² Ø¢Ù† Ø¯ÛŒÚ¯Ø± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ ØªÚ©Ø±Ø§Ø± Ú©Ù†Ø¯."
            }
        ];
        
        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            // DELETED: avatarUrl property removed
            seenQuestionHashes: new Set(),
        };
        
        let loadingScreen, mainScreen, gameScreen,
            authPanel, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, userInfoBox, displayNameOutput,
            publicUserIdOutput, editNameBtn, mainScreenButtonsLayout,
            startGameBtn, developersBtn,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback,
            modalContainer, modalTitle, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            gameModePanelContainer, closeGameModePanelBtn, singlePlayerBtn;
        
        // DELETED: All avatar-related variables
        
        let timerText, timerProgressCircle, timerInterval;
        const TOTAL_TIME_PER_QUESTION = 20;
        let timeRemaining;
        const TIMER_CIRCLE_RADIUS = 26;
        const TIMER_CIRCUMFERENCE = 2 * Math.PI * TIMER_CIRCLE_RADIUS;

        let loadingProgressBarFill, loadingTip;
        let modalConfirmCallback = null;
        let modalCancelCallback = null;

        function simpleHash(str) {
            let hash = 0;
            if (!str || str.length === 0) return 'h0';
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return `h${Math.abs(hash)}`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            if(audioManager.sounds.timeTick) audioManager.sounds.timeTick.pause();
        }

        function updateTimerVisuals() {
            if (!timerText || !timerProgressCircle) return;
            timerText.textContent = timeRemaining;
            const progress = timeRemaining / TOTAL_TIME_PER_QUESTION;
            const offset = TIMER_CIRCUMFERENCE * (1 - progress);
            timerProgressCircle.style.strokeDashoffset = offset;
            
            if (timeRemaining <= 5) {
                timerProgressCircle.style.stroke = 'var(--clash-red)';
                timerText.style.color = 'var(--clash-red)';
                if(timeRemaining > 0) audioManager.play('timeTick');
            } else {
                timerProgressCircle.style.stroke = 'var(--clash-gold)';
                timerText.style.color = 'var(--clash-gold)';
            }
        }
        
        function handleTimeUp() {
            stopTimer();
            if (!gameState.isQuestionActive) return;
            gameState.isQuestionActive = false;

            const { correctAnswerIndex, explanation } = gameState.currentQuestionData;
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
            if (correctButton) correctButton.classList.add('correct');

            gameFeedback.textContent = "Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!";
            gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#ffaaaa] clash-font';
            audioManager.play('incorrect');
            
            if (explanation && questionExplanation) {
                questionExplanation.textContent = `ØªÙˆØ¶ÛŒØ­: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }

            setTimeout(() => { generateQuestion(); }, 3000);
        }

        function startTimer() {
            stopTimer();
            timeRemaining = TOTAL_TIME_PER_QUESTION;
            if (timerProgressCircle) {
                timerProgressCircle.style.transition = 'none';
                timerProgressCircle.style.strokeDasharray = TIMER_CIRCUMFERENCE;
                timerProgressCircle.style.strokeDashoffset = 0;
                void timerProgressCircle.offsetWidth;
                timerProgressCircle.style.transition = 'stroke-dashoffset 1s linear';
            }
            
            updateTimerVisuals();

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerVisuals();
                if (timeRemaining <= 0) {
                    handleTimeUp();
                }
            }, 1000);
        }

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');

            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflowY = isControllingOverflow ? 'hidden' : 'auto';
            
            screenElement.scrollTop = 0;
            updateUI();
        }
        
        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalContainer) return;

            audioManager.play('panelOpen');

            modalContainer.classList.remove('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible'); 
            void modalContainer.offsetWidth; 
            modalContainer.querySelector('.panel-clash').classList.add('panel-visible'); 
            
            modalTitle.textContent = title;

            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            // DELETED: Avatar UI handling
            if (inputErrorMessage) inputErrorMessage.classList.add('hidden');
            if (userIdErrorMessage) userIdErrorMessage.classList.add('hidden');
            if (changeNameErrorMessage) changeNameErrorMessage.classList.add('hidden');
            
            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) || 
                                      (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));

            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.textContent = '';
                newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.disabled = false;
            modalCancelBtn.disabled = false;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName") {
                modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function hideModal() {
            if (!modalContainer) return;
            
            audioManager.play('panelClose');
            modalContainer.classList.add('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.remove('panel-visible');

            modalConfirmCallback = null;
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            modalMessage.classList.add('hidden');

            const isAnyPanelVisible = (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                      (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
            
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) {
                    console.error("Error in modal cancel callback:", e);
                }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelOpen');
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            audioManager.play('panelClose');
            developersPanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                           (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
             if(userProfileArea && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function showGameModePanel() {
            if (!gameModePanelContainer) return;
            audioManager.play('panelOpen');
            gameModePanelContainer.classList.remove('panel-hidden');
            gameModePanelContainer.querySelector('.panel-clash').classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideGameModePanel() {
            if (!gameModePanelContainer) return;
            audioManager.play('panelClose');
            gameModePanelContainer.classList.add('panel-hidden');
            const isAnyOtherPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) || 
                                           (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden'));
            if(userProfileArea && mainScreen.classList.contains('active') && !isAnyOtherPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function updateUI() {
            displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
            publicUserIdOutput.textContent = gameState.publicUserId || "---";
            stageDisplay.textContent = gameState.currentStage;

            // DELETED: Avatar update logic
            
            let showAuthPanel = !gameState.displayName || !gameState.publicUserId;
            let showActionButtons = !showAuthPanel;
            let showUserInfo = showActionButtons && mainScreen.classList.contains('active');

            if (showActionButtons) {
                startGameBtn.classList.add('breathing');
            } else {
                startGameBtn.classList.remove('breathing');
            }

            authPanel.classList.toggle('panel-hidden', !showAuthPanel);
            authPanel.classList.toggle('panel-visible', showAuthPanel);
            mainScreenButtonsLayout.classList.toggle('hidden', !showActionButtons);

            const isAnyPanelVisible = (modalContainer && !modalContainer.classList.contains('panel-hidden')) ||
                                    (developersPanelContainer && !developersPanelContainer.classList.contains('panel-hidden')) ||
                                    (gameModePanelContainer && !gameModePanelContainer.classList.contains('panel-hidden'));
            if (showUserInfo && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden', 'hidden');
                userInfoBox.classList.remove('hidden');
            } else if (!showUserInfo) {
                userProfileArea.classList.add('hidden');
            } else if (isAnyPanelVisible) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }
        
        function simulateLoading() {
            setTimeout(() => {
                loadingProgressBarFill.style.width = '30%';
                loadingMessage.textContent = 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ø§Ø²ÛŒ...';
            }, 500);
            setTimeout(() => {
                loadingProgressBarFill.style.width = '65%';
                loadingMessage.textContent = 'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ...';
            }, 1200);
            setTimeout(() => {
                loadingProgressBarFill.style.width = '100%';
                loadingMessage.textContent = 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!';
            }, 1800);
            setTimeout(() => {
                showScreen(mainScreen);
            }, 2300);
        }

        // --- NEW: Local Storage Functions ---
        function saveUserData() {
            try {
                const dataToSave = {
                    ...gameState,
                    seenQuestionHashes: Array.from(gameState.seenQuestionHashes) // Convert Set to Array for JSON
                };
                localStorage.setItem('mafiaGameUserData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error("Error saving data to localStorage:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
            }
        }
        
        function loadUserData() {
            try {
                const savedData = localStorage.getItem('mafiaGameUserData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Ensure we don't load the avatarUrl if it exists in old data
                    const { avatarUrl, ...restOfData } = parsedData; 
                    Object.assign(gameState, restOfData);
                    
                    // Convert Array back to Set
                    gameState.seenQuestionHashes = new Set(parsedData.seenQuestionHashes || []);
                    console.log("User data loaded from localStorage.");
                } else {
                    console.log("No saved data found in localStorage. Starting fresh.");
                }
            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                // If there's an error, just start fresh
                localStorage.removeItem('mafiaGameUserData');
            }
        }

        function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            questionText.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙˆØ§Ù„...";
            optionsContainer.innerHTML = "";
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            
            let unseenQuestions = localQuestions.filter(q => !gameState.seenQuestionHashes.has(simpleHash(q.question)));
            
            // NEW: Handle running out of questions by resetting progress
            if (unseenQuestions.length === 0) {
                showModal("ØªØ¨Ø±ÛŒÚ©!", "Ø´Ù…Ø§ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯! Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ØŒ Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª Ø¯ÛŒØ¯Ù‡â€ŒØ´Ø¯Ù‡ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.", "Ø¹Ø§Ù„ÛŒ!", null, () => {
                    gameState.seenQuestionHashes.clear();
                    saveUserData();
                    hideModal();
                    generateQuestion(); // Retry generating a question
                });
                gameState.isLoadingNextQuestion = false;
                return;
            }

            const randomIndex = Math.floor(Math.random() * unseenQuestions.length);
            const questionData = unseenQuestions[randomIndex];
            
            gameState.currentQuestionData = questionData;
            displayQuestion();
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            gameState.isQuestionActive = true;
            startTimer();
        }
        
        function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion) return;
            
            stopTimer();
            gameState.isQuestionActive = false;

            const selectedOptionButton = event.target.closest('.option-btn');
            if (!selectedOptionButton) return;

            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { question, correctAnswerIndex, explanation } = gameState.currentQuestionData;

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                audioManager.play('correct');
                selectedOptionButton.classList.add('correct');
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#aaffaa] clash-font';
                
                gameState.seenQuestionHashes.add(simpleHash(question));
                gameState.currentStage++;
                
                saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                audioManager.play('incorrect');
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');
                
                gameFeedback.textContent = "Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-[#ffaaaa] clash-font';
                
                setTimeout(() => { generateQuestion(); updateUI(); }, 3000);
            }
            if (explanation) {
                questionExplanation.textContent = `ØªÙˆØ¶ÛŒØ­: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }
        
        // DELETED: All avatar-related functions
        
        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');

            if (nameValue !== sanitizedValue) inputElement.value = sanitizedValue;

            const trimmedName = sanitizedValue.trim();

            if (trimmedName.length < 3) {
                errorElement.textContent = "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
                errorElement.classList.remove('hidden');
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.classList.add('hidden');
            inputElement.classList.remove('invalid');
            return trimmedName;
        }

        function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;

            if (newName === gameState.displayName) {
               changeNameErrorMessage.textContent = "Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… ÙØ¹Ù„ÛŒ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.";
               return;
            }
            
            // MODIFIED: No need to check if name is taken in offline mode
            gameState.displayName = newName;
            saveUserData();
            updateUI();
            hideModal();
            showModal("Ù…ÙˆÙÙ‚ÛŒØª", "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!", "Ø¹Ø§Ù„ÛŒ!");
        }
        
        function generateAlphanumericPublicUserId(length = 5) {
            return Array(length).fill(0).map(() => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.random() * 36)).join('');
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', (event) => {
                if (event.target.closest('.btn-clash:not(:disabled)')) audioManager.play('click');
            });

            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', handleModalCancel);

            displayNameInput.addEventListener('input', () => validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput));

            generateUserIdBtn.addEventListener('click', () => {
                userIdDisplayInput.value = generateAlphanumericPublicUserId();
                gameState.publicUserId = userIdDisplayInput.value;
                userIdErrorMessage.classList.add('hidden');
            });

            registerBtn.addEventListener('click', () => {
                const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                if (!gameState.publicUserId) {
                    userIdErrorMessage.textContent = "Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯.";
                    return;
                }
                if (!validatedName) return;

                // MODIFIED: No need to check if name is taken
                gameState.displayName = validatedName;
                saveUserData();
                updateUI();
            });

            editNameBtn.addEventListener('click', () => showModal("ØªØºÛŒÛŒØ± Ù†Ø§Ù…", "ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.", "ØªØºÛŒÛŒØ±", "Ù„ØºÙˆ", handleChangeDisplayName, hideModal, "changeName"));
            
            // DELETED: avatarContainer event listener
            
            startGameBtn.addEventListener('click', showGameModePanel);
            closeGameModePanelBtn.addEventListener('click', hideGameModePanel);
            singlePlayerBtn.addEventListener('click', () => { hideGameModePanel(); showScreen(gameScreen); generateQuestion(); });

            developersBtn.addEventListener('click', showDevelopersPanel);
            closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            backToMainBtn.addEventListener('click', () => { stopTimer(); saveUserData(); gameState.currentQuestionData = null; showScreen(mainScreen); });
        }
        
        function initializeGame() {
            // Query DOM elements
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            authPanel = document.getElementById('auth-panel');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');
            userProfileArea = document.getElementById('user-profile-area');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output');
            publicUserIdOutput = document.getElementById('public-user-id-output');
            editNameBtn = document.getElementById('edit-name-btn');
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            developersBtn = document.getElementById('developers-btn');
            stageDisplay = document.getElementById('stage-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container');
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn');
            gameModePanelContainer = document.getElementById('game-mode-panel-container');
            closeGameModePanelBtn = document.getElementById('close-game-mode-panel-btn');
            singlePlayerBtn = document.getElementById('single-player-btn');
            loadingProgressBarFill = document.getElementById('loading-progress-bar-fill');
            loadingTip = document.getElementById('loading-tip');
            timerText = document.getElementById('timer-text');
            timerProgressCircle = document.getElementById('timer-progress-circle');

            // Initialize game logic
            audioManager.init();
            userProfileArea.classList.add('hidden');
            
            // --- MODIFIED: Offline initialization flow ---
            loadUserData(); // Load from localStorage first
            setupEventListeners();
            simulateLoading(); // Then show loading animation
        }

        // --- MODIFIED: Start the game when the DOM is fully ready (More robust for mobile) ---
        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>
