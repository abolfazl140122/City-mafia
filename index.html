<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .mafia-animated-bg {
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .panel {
            background-color: rgba(30, 30, 30, 0.95);
            border: 1px solid #c49730;
            box-shadow: 0 0 20px rgba(200, 150, 50, 0.5);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden; /* Ensure it's not interactive when hidden */
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        .btn-mafia {
            background-color: #c49730;
            color: #1a1a1a;
            border: 2px solid #a57c1a;
            padding: 8px 16px; /* Base padding */
            font-size: 0.9rem; /* Base font size */
            border-radius: 8px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: nowrap; /* Prevent text wrapping inside buttons */
            display: inline-flex; /* For aligning icon and text if any */
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 640px) {
            .btn-mafia {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }

        .btn-mafia:hover {
            background-color: #d4a840;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
         .btn-mafia:disabled {
            background-color: #7e6a3b;
            color: #524425;
            border-color: #6a531f;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        .btn-mafia-secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 2px solid #333333;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
         @media (min-width: 640px) {
            .btn-mafia-secondary {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        .btn-mafia-secondary:hover {
            background-color: #5a5a5a;
            color: #c49730;
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .input-mafia {
            background-color: #333;
            border: 1px solid #c49730;
            color: #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
        }
        @media (max-width: 639px) {
            .input-mafia {
                font-size: 0.9rem;
                padding: 8px;
            }
        }

        .input-mafia:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(200, 150, 50, 0.7);
        }
        .input-mafia.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.7);
        }
        .input-mafia:read-only {
            background-color: #444;
            cursor: default;
        }


        .option-btn {
            background-color: rgba(50, 50, 50, 0.8);
            border: 1px solid #c49730;
            color: #e0e0e0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 0.9rem;
            padding: 10px;
        }
        @media (min-width: 768px) {
            .option-btn {
                font-size: 1rem;
                padding: 12px;
            }
        }

        .option-btn:hover {
            background-color: rgba(70, 70, 70, 0.9);
            transform: scale(1.02);
        }
        .option-btn.correct { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        .option-btn.incorrect { background-color: #dc3545 !important; border-color: #b02a37 !important; color: white !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .loader {
            border: 8px solid #444;
            border-top: 8px solid #c49730;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @media (min-width: 640px) {
            .loader {
                width: 60px;
                height: 60px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; } 
        ::-webkit-scrollbar-thumb { background: #c49730; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a57c1a; }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        @media (min-width: 640px) { /* sm */
            .screen {
                padding: 20px; /* Increased padding for larger screens */
            }
        }

        #main-screen {
            justify-content: flex-start;
        }
        #loading-screen {
             justify-content: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            position: relative; 
            z-index: 1;
            overflow-y: auto; 
        }
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) {
            .screen-content-wrapper {
                 padding-bottom: 20px;
            }
        }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px); /* Base min-height */
            padding-top: 60px; /* Initial padding for mobile to avoid user profile */
        }
        @media (min-width: 640px) { /* sm */
            #main-screen .screen-content-wrapper {
                min-height: calc(100vh - 40px); /* Adjusted min-height for sm screens */
                padding-top: 80px; /* Increased padding for sm screens */
            }
        }
         @media (min-width: 768px) { /* md, user profile moves to top-right */
            #main-screen .screen-content-wrapper {
                padding-top: 20px; /* Reset padding-top as user profile is no longer in the way */
            }
        }


        .shop-item { transition: all 0.3s ease; }
        .shop-item:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 30px rgba(200, 150, 50, 0.6); }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed;
            z-index: 100;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area {
                top: 10px;
                left: 50%;
                transform: translateX(-50%) translateY(0);
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateX(-50%) translateY(-150%);
            }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area {
                top: 20px;
                right: 20px; /* Changed from left: auto to ensure it's on the right */
                left: auto; 
                transform: translateY(0);
                align-items: center;
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateY(-150%);
            }
        }

        #user-info-box {
            background-color: rgba(15, 15, 15, 0.85);
            border: 1px solid #c49730;
            border-radius: 10px;
            padding: 8px 10px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: row; 
            align-items: center;
            gap: 8px; 
            width: max-content;
            min-width: 0;
        }
        @media (min-width: 768px) { 
            #user-info-box {
                flex-direction: column;
                align-items: stretch;
                gap: 10px; 
                border-width: 2px;
                border-radius: 12px;
                padding: 12px 15px; 
                min-width: 180px; 
                max-width: 200px; 
                width: auto;
            }
        }


        #user-info-box.hidden, #avatar-container.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
        @media (max-width: 767px) {
            #user-info-box.hidden {
                transform: translateX(-50%) translateY(-20px);
            }
        }

        .user-info-item {
            background-color: rgba(40, 40, 40, 0.7);
            padding: 4px 7px; 
            border-radius: 6px;
            border-left: 0px solid #c49730; 
            display: flex;
            align-items: center;
            gap: 4px; 
        }
        @media (min-width: 768px) {
            .user-info-item {
                padding: 6px 10px; 
                border-radius: 8px;
                border-left-width: 3px; 
                display: block; 
            }
        }

        .user-info-item .label {
            font-size: 0.7em; 
            color: #a0a0a0;
            margin-bottom: 0; 
        }
        @media (min-width: 768px) {
            .user-info-item .label {
                font-size: 0.85em; 
                margin-bottom: 1px; 
            }
        }

        .user-info-item .value {
            font-size: 0.85em; 
            font-weight: bold;
        }
        @media (min-width: 768px) {
            .user-info-item .value {
                font-size: 1em; 
            }
        }

        #display-name-output-container {
            display: flex;
            align-items: center;
            gap: 6px; 
        }
        @media (max-width: 767px) {
             #display-name-output-container {
                flex-direction: row-reverse; 
            }
        }

        #edit-name-btn {
            cursor: pointer;
            font-size: 0.85em; 
            color: #c49730;
            transition: color 0.3s ease;
        }
        #edit-name-btn:hover {
            color: #d4a840;
        }
        @media (min-width: 768px) {
            #edit-name-btn {
                font-size: 0.95em; 
            }
        }

        #display-name-output-box .value {
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(200, 150, 50, 0.5); 
        }
        @media (min-width: 768px) {
            #display-name-output-box .value {
                text-shadow: 0 0 7px rgba(200, 150, 50, 0.6); 
            }
        }
        #coins-output-box .value {
            color: #ffd700;
        }
        #public-user-id-output-box .value {
            color: #a0a0a0;
            font-family: monospace;
            font-size: 0.95em; 
        }
        @media (min-width: 768px) {
            #public-user-id-output-box .value {
                font-size: 1em; 
            }
        }


        #avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #c49730;
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        @media (min-width: 768px) {
            #avatar-container {
                width: 70px; 
                height: 70px; 
                margin-right: 10px; 
            }
        }

        #avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #avatar-placeholder-icon {
            font-size: 1.8rem; 
            color: #777;
        }
        @media (min-width: 768px) {
            #avatar-placeholder-icon {
                font-size: 2.2rem; 
            }
        }

        #avatar-suggestions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .avatar-suggestion-item {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.3s ease, transform 0.2s ease;
        }
        .avatar-suggestion-item:hover {
            border-color: #c49730;
            transform: scale(1.05);
        }
        .avatar-suggestion-item.selected {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
        }

        /* Main Screen Header Styling */
        #main-screen-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            width: 100%;
            padding-top: 0.5rem; /* Reduced top padding for header itself */
            padding-bottom: 1rem; 
            margin-bottom: 1rem; 
        }
         @media (min-width: 768px) { /* md */
             #main-screen-header {
                padding-top: 1rem; /* Adjust for desktop if needed */
             }
        }


        #main-title {
            text-align: center;
            flex-grow: 1; 
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold;
            color: #c49730;
            text-shadow: 0 2px 2px rgba(0,0,0,0.8);
            margin-right: auto; /* Pushes title towards center if icon is on left */
            margin-left: auto; /* Pushes title towards center if icon is on right */
        }
        @media (min-width: 640px) { /* sm */
            #main-title {
                font-size: 3rem; /* text-5xl */
            }
        }
        @media (min-width: 768px) { /* md */
            #main-title {
                font-size: 3.75rem; /* text-6xl */
            }
        }
        
        /* Developer Intro Icon Button - Header Position */
        #dev-intro-icon-btn-header {
            background-color: transparent; 
            color: #c49730;
            border: 2px solid #c49730;
            padding: 0.5rem; 
            border-radius: 50%; 
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px; 
            height: 40px; 
            flex-shrink: 0; /* Prevent shrinking */
        }
        #dev-intro-icon-btn-header:hover {
            background-color: rgba(196, 151, 48, 0.2);
            color: #d4a840;
            border-color: #d4a840;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        #dev-intro-icon-btn-header svg {
            width: 20px;
            height: 20px;
        }
         @media (min-width: 640px) {
            #dev-intro-icon-btn-header {
                width: 44px;
                height: 44px;
                padding: 0.6rem;
            }
            #dev-intro-icon-btn-header svg {
                width: 22px;
                height: 22px;
            }
        }

        /* Bottom Action Buttons Layout */
        #main-screen-buttons-layout { 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: auto; 
            padding-top: 1rem; 
        }

        #top-action-buttons {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center; 
            gap: 0.5rem; 
            width: 100%;
            padding-bottom: 5px; 
        }
        @media (min-width: 640px) {
            #top-action-buttons {
                gap: 0.75rem; 
                flex-wrap: nowrap; 
                overflow-x: auto; 
            }
        }
        @media (min-width: 768px) {
            #top-action-buttons {
                gap: 1rem; 
            }
        }

        #top-action-buttons .btn-mafia:not(#start-game-btn) {
            font-size: 0.8rem; 
            padding: 0.4rem 0.8rem; 
        }
        @media (min-width: 640px) {
            #top-action-buttons .btn-mafia:not(#start-game-btn) {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
        }
        @media (min-width: 768px) {
            #top-action-buttons .btn-mafia:not(#start-game-btn) {
                font-size: 0.9rem;
                padding: 0.6rem 1.2rem;
            }
        }
        
        #start-game-btn {
             padding: 0.6rem 1.2rem !important; 
             font-size: 0.95rem !important; 
             order: 0; 
        }
        @media (min-width: 640px) {
            #start-game-btn {
                padding: 0.7rem 1.5rem !important;
                font-size: 1.05rem !important;
            }
        }
        @media (min-width: 768px) {
            #start-game-btn {
                padding: 0.8rem 1.8rem !important;
                font-size: 1.15rem !important;
            }
        }


        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: #dc3545;
            font-size: 0.8rem;
            text-align: right;
            min-height: 1.2rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) {
            #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
                font-size: 0.875rem;
            }
        }
        .hidden {
            display: none !important;
        }

        /* Styles for Developers Panel */
        #developers-panel-container {
            background-color: rgba(10, 10, 10, 0.92); 
        }
        #developers-panel {
            background: radial-gradient(circle at top center, rgba(45, 45, 55, 0.98), rgba(15, 15, 20, 0.99));
            border: 2px solid #c49730;
            box-shadow: 0 0 35px rgba(200, 150, 50, 0.65), 0 0 10px rgba(200, 150, 50, 0.4) inset;
            max-height: 85vh; 
            overflow-y: auto; 
            border-radius: 15px; 
        }
        #close-developers-panel-btn {
            position: absolute;
            top: 18px; 
            right: 18px; 
            width: 34px;
            height: 34px;
            background-color: rgba(196, 151, 48, 0.85); 
            color: #101010; 
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 7px rgba(0,0,0,0.5);
            z-index: 10;
        }
        #close-developers-panel-btn:hover {
            background-color: #d4a840; 
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        
        .developer-item {
            background-color: rgba(28, 28, 35, 0.92);
            padding: 1.2rem 1.5rem; 
            border-radius: 12px; 
            border: 1px solid rgba(196, 151, 48, 0.25);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.55);
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); 
            text-align: right; 
            margin-bottom: 1rem; 
        }
        .developer-item:last-child {
            margin-bottom: 0;
        }
        .developer-item:hover {
            transform: translateY(-5px) scale(1.015);
            box-shadow: 0 10px 28px rgba(196, 151, 48, 0.45);
            border-color: rgba(196, 151, 48, 0.6);
        }
        
        .dev-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
            border-bottom: 1px solid rgba(196, 151, 48, 0.2);
            padding-bottom: 0.6rem;
        }
        .dev-role-icon {
            font-size: 1.7em; 
            color: #c49730;
            margin-left: 10px; 
            width: 28px; 
            text-align: center;
            line-height: 1; 
        }
        .dev-role { 
            font-size: 1.15rem; 
            font-weight: 700; 
            color: #e8e8e8; 
        }
        .dev-username { 
            color: #efbe5a; 
            font-family: 'Vazirmatn', 'Courier New', Courier, monospace; 
            font-weight: bold;
            font-size: 1.25rem;
            display: block; 
            margin-bottom: 0.5rem; 
            margin-top: 0.2rem; 
        }
        .dev-description { 
            font-size: 0.9rem; 
            color: #b8b8b8; 
            line-height: 1.65;
        }

    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>

    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" class="hidden" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label">بازیکن:</div>
                <div id="display-name-output-container">
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value"></div>
                </div>
            </div>
            <div id="coins-output-box" class="user-info-item">
                <div class="label">سکه:</div>
                <div id="coins-output" class="value">0</div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label">شناسه کاربری:</div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-[#c49730]">بارگذاری بازی مافیا...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper"> <!-- Increased padding-top here -->
            <div> 
                <div id="main-screen-header">
                    <!-- Developer Intro Icon Button - Moved to the left (visual right in RTL) -->
                    <button id="dev-intro-icon-btn-header" title="معرفی توسعه دهندگان">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                    <h1 id="main-title">شهر مافیا</h1>
                     <!-- Spacer on the right (visual left in RTL) to balance the icon button -->
                    <div style="width: 40px; flex-shrink: 0;"></div>
                </div>

                <div id="registration-form" class="mb-4 panel panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center text-[#c49730]">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="input-error-message" class=""></p>
                    
                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-1">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-mafia w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="ابتدا بسازید">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm">ساخت شناسه</button>
                        </div>
                        <p id="user-id-error-message" class=""></p>
                    </div>
                    
                    <button id="register-btn" class="btn-mafia w-full p-2 sm:p-3 text-base sm:text-lg mt-3">ورود به شهر</button>
                </div>
            </div>
            
            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons" class="">
                    <button id="shop-btn" class="btn-mafia" style="order: -1;">فروشگاه</button> 
                    <button id="start-game-btn" class="btn-mafia">شروع بازی آنلاین</button> 
                    <button id="mafia-fact-btn" class="btn-mafia" style="order: 1;">دانستنی‌های مافیا ✨</button> 
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start"> <!-- Default padding-top for game screen -->
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-2 sm:p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-sm sm:text-base md:text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">بازگشت ⟵</button>
                <div>مرحله: <span id="stage-display" class="font-bold text-[#c49730]">1</span></div>
                <div>سکه: <span id="game-coins-display" class="font-bold text-[#ffd700]">0</span> 🪙</div>
            </div>

            <div id="question-container" class="panel panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[150px] sm:min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                <p id="question-explanation" class="text-xs sm:text-sm mt-3 sm:mt-4 text-gray-400 text-center hidden"></p>
            </div>
            
            <div id="game-feedback" class="text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-8"></div>

            <div class="flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4 mt-4 sm:mt-6">
                <button id="hint-btn" class="btn-mafia w-full sm:w-auto text-xs sm:text-sm">راهنمایی (۱۰۰ سکه 🪙)</button>
                <button id="skip-stage-btn" class="btn-mafia w-full sm:w-auto text-xs sm:text-sm">رد کردن مرحله (۲۵۰ سکه 🪙)</button>
            </div>
            <div id="ai-thinking-indicator" class="text-center mt-3 sm:mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-sm sm:text-base">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="screen">
        <div class="screen-content-wrapper justify-start"> <!-- Default padding-top for shop screen -->
            <div class="flex justify-between items-center mb-6 sm:mb-8 p-2 sm:p-3 bg-[rgba(0,0,0,0.4)] rounded-lg shadow-lg">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">فروشگاه سکه</h1>
                <button id="back-to-main-from-shop-btn" class="btn-mafia-secondary">بازگشت</button>
            </div>
            <div id="shop-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                </div>
        </div>
    </div>


    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-3 sm:p-4 panel-hidden z-50">
        <div class="panel panel-visible p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-[#c49730]">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-2 sm:mb-3 text-sm sm:text-base"></p> 
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="change-name-error-message" class=""></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">ساخت آواتار جدید با AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">در حال ساخت آواتارهای پیشنهادی... (ممکن است کمی طول بکشد)</p>
                    </div>
                    <div id="avatar-suggestions-container">
                        </div>
                    <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-3 sm:gap-4 mt-4">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>

    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-developers-panel-btn">&times;</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💻</span>
                        <h4 class="dev-role">برنامه نویس ارشد</h4>
                    </div>
                    <p class="dev-username">abolfazl1401</p>
                    <p class="dev-description">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی شهر مافیا.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💡</span>
                        <h4 class="dev-role">ایده پرداز</h4>
                    </div>
                    <p class="dev-username">Ali.k</p>
                    <p class="dev-description">خالق ایده‌های نوآورانه برای مراحل، چالش‌ها و داستان‌سرایی در دنیای مافیا.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">☁️</span>
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username">Neda_Tech</p>
                    <p class="dev-description">متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت بازی.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">⚙️</span> 
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username">SinaCloud</p>
                    <p class="dev-description">مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده‌های بازی برای تجربه‌ای روان.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">🚀</span> 
                        <h4 class="dev-role">توسعه دهنده سرور (DevOps)</h4>
                    </div>
                    <p class="dev-username">ParsaDevOps</p>
                    <p class="dev-description">متمرکز بر فرآیندهای DevOps، استقرار خودکار و مانیتورینگ عملکرد سرورهای بازی.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        // NOTE: In a production GitHub repository, NEVER expose your API keys directly.
        // Use environment variables or a secure backend to manage them.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
            authDomain: "city-mafia.firebaseapp.com",
            projectId: "city-mafia",
            storageBucket: "city-mafia.firebasestorage.app",
            messagingSenderId: "66458127103",
            appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
            measurementId: "G-8M0M6BJ0GG" // Added measurementId from your provided config
        };
        // This `appId` is used for structuring Firestore paths (e.g., artifacts/mafia-game-default/users/...)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null; 
        let isAuthReady = false; 

        // Game state object
        const gameState = {
            displayName: '',
            publicUserId: '', 
            coins: 0,
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false, 
            isLoadingNextQuestion: false, 
            avatarUrl: '', 
            nameChangeCount: 0, 
        };

        // DOM Element Selectors
        let loadingScreen, loadingMessage, mainScreen, gameScreen, shopScreen, 
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage, 
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput, 
            publicUserIdOutput, 
            editNameBtn, coinsOutput, 
            mainScreenButtonsLayout, 
            startGameBtn, shopBtn, mafiaFactBtn, devIntroBtnHeader, 
            stageDisplay, gameCoinsDisplay, questionText, 
            optionsContainer, questionExplanation, hintBtn, skipStageBtn, backToMainBtn,
            gameFeedback, aiThinkingIndicator, backToMainFromShopBtn, shopItemsContainer,
            modalContainer, modalTitle, modalContentDynamic, modalMessage, 
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading, 
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;
        
        let modalConfirmCallback = null; 
        let modalCancelCallback = null; 
        let selectedAvatarForConfirmation = null; 

        // --- Utility Functions ---

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            
            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            
            screenElement.scrollTop = 0; 
            updateUI(); 
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") { 
            if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) {
                console.error("[showModal] Modal elements not found, cannot show modal.");
                return;
            }

            modalTitle.textContent = title;
            
            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) { 
                userProfileArea.classList.add('profile-area-hidden'); 
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName; 
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = ''; 
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                if(avatarSuggestionsContainer) avatarSuggestionsContainer.innerHTML = ''; 
                if(avatarErrorMessage) avatarErrorMessage.textContent = '';
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") { 
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else { 
                modalMessage.innerHTML = message; 
                modalMessage.classList.remove('hidden');
            }
            
            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm; 
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") { 
                modalCancelBtn.textContent = cancelText || "لغو";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
            modalContainer.classList.add('panel-visible');
        }

        function hideModal() {
            if (!modalContainer || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer) {
                return;
            }
            modalContainer.classList.add('panel-hidden');
            modalContainer.classList.remove('panel-visible');
            modalConfirmCallback = null; 
            modalCancelCallback = null;
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            modalMessage.classList.add('hidden'); 
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && 
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden'))) { 
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback(); 
                } catch (e) {
                    console.error("[handleModalConfirm] Error in modal confirm callback:", e);
                    hideModal(); 
                }
            } else {
                hideModal(); 
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback(); 
                } catch (e) {
                    console.error("[handleModalCancel] Error in modal cancel callback:", e);
                }
            }
            hideModal(); 
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.classList.add('panel-visible');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) { 
                userProfileArea.classList.add('profile-area-hidden'); 
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.add('panel-hidden');
            developersPanelContainer.classList.remove('panel-visible');
             if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && 
               (!modalContainer || modalContainer.classList.contains('panel-hidden'))) { 
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "مهمان"; 
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---"; 
            if(coinsOutput) coinsOutput.textContent = gameState.coins;
            if(gameCoinsDisplay) gameCoinsDisplay.textContent = gameState.coins; 
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage; 

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`; 
            }

            let showRegistration = true;
            let showActionButtons = false;
            let showUserInfoAndAvatar = false;

            if (isAuthReady && gameState.displayName && gameState.publicUserId) { 
                showRegistration = false;
                showActionButtons = true;
                if (mainScreen && mainScreen.classList.contains('active')) { 
                    showUserInfoAndAvatar = true;
                }
            } else if (isAuthReady && (!gameState.displayName || !gameState.publicUserId)) { 
                // User is authenticated, but hasn't completed registration (display name/public ID)
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false; 
            } else { 
                // Not authenticated or other states, fallback to registration
                showRegistration = true; 
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            }

            if(registrationForm){
                if (showRegistration) {
                    registrationForm.classList.remove('panel-hidden');
                    registrationForm.classList.add('panel-visible');
                } else {
                    registrationForm.classList.add('panel-hidden');
                    registrationForm.classList.remove('panel-visible');
                }
            }
            
            if(mainScreenButtonsLayout){ 
                if (showActionButtons) {
                    mainScreenButtonsLayout.classList.remove('hidden');
                } else {
                    mainScreenButtonsLayout.classList.add('hidden');
                }
            }
            
            if(userProfileArea){ 
                const isAnyPanelVisible = (modalContainer && modalContainer.classList.contains('panel-visible')) || 
                                        (developersPanelContainer && developersPanelContainer.classList.contains('panel-visible'));
                if (showUserInfoAndAvatar && !isAnyPanelVisible) { 
                    userProfileArea.classList.remove('profile-area-hidden'); 
                    userProfileArea.classList.remove('hidden'); 
                    if(avatarContainer){
                        // Only show avatar on larger screens to save space on mobile
                        if(window.innerWidth >= 768) { 
                            avatarContainer.classList.remove('hidden');
                        } else {
                            avatarContainer.classList.add('hidden'); 
                        }
                    }
                    if(userInfoBox) userInfoBox.classList.remove('hidden');

                } else if (!showUserInfoAndAvatar) { 
                    userProfileArea.classList.add('hidden'); 
                    if(avatarContainer) avatarContainer.classList.add('hidden');
                    if(userInfoBox) userInfoBox.classList.add('hidden');
                } else if (isAnyPanelVisible) { 
                    userProfileArea.classList.add('profile-area-hidden');
                }
            }
        }

        // --- Firebase Functions ---
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        currentUserId = user.uid;
                        await loadUserData(); 
                    } else { 
                        // Try custom token first for persistence if available, otherwise anonymous sign-in
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("[onAuthStateChanged] Custom token sign-in error, trying anonymous:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                        // Reset gameState if no user or anonymous sign-in failed
                        gameState.displayName = ''; 
                        gameState.publicUserId = ''; 
                        gameState.coins = 0; 
                        gameState.avatarUrl = ''; 
                        gameState.nameChangeCount = 0; 
                    }
                    isAuthReady = true; 
                    updateUI(); 
                    
                    if (loadingScreen && loadingScreen.classList.contains('active')) { 
                        if(loadingMessage) loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen); 
                        }, 500); 
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden'); 
            }
        }
        
        async function loadUserData() {
            if (!currentUserId || !db) {
                // If no user or db not ready, ensure gameState is reset to default values
                gameState.displayName = ''; 
                gameState.publicUserId = ''; 
                gameState.coins = 0; 
                gameState.avatarUrl = ''; 
                gameState.nameChangeCount = 0; 
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) { 
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || ""; 
                    gameState.coins = data.coins !== undefined ? data.coins : 0; // Default to 0 if exists but no coins field
                    gameState.currentStage = data.currentStage || 1;
                    gameState.nameChangeCount = data.nameChangeCount !== undefined ? data.nameChangeCount : 0; 
                    gameState.avatarUrl = data.avatarUrl || ''; 
                } else { 
                    // New profile for an authenticated but unregistered user
                    gameState.displayName = ""; 
                    gameState.publicUserId = ""; 
                    gameState.coins = 0; // Coins will be granted on first registration
                    gameState.avatarUrl = ''; 
                    gameState.nameChangeCount = 0;
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
                // Fallback to empty state if load fails
                gameState.displayName = ''; 
                gameState.publicUserId = '';
                gameState.coins = 0;
                gameState.avatarUrl = ''; 
                gameState.nameChangeCount = 0;
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db) return; 
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId, 
                    coins: gameState.coins,
                    currentStage: gameState.currentStage,
                    nameChangeCount: gameState.nameChangeCount, 
                    avatarUrl: gameState.avatarUrl, 
                    lastUpdated: serverTimestamp() 
                }, { merge: true }); // Use merge: true to only update specified fields
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه", null, () => hideModal());
            }
        }

        async function updateCoins(amount, bypassModal = false) {
            const newCoins = gameState.coins + amount;
            if (newCoins < 0) { 
                if (!bypassModal) showModal("اعتبار ناکافی", "سکه کافی برای این عملیات ندارید.", "باشه", null, () => hideModal());
                return false; 
            }
            gameState.coins = newCoins; 
            updateUI(); 
            await saveUserData(); 
            return true; 
        }

        // --- Gemini API Functions ---
        // IMPORTANT: Replace this with your actual Gemini API Key.
        // For production, never expose API keys directly in client-side code.
        // Use environment variables or a secure backend proxy.
        const GEMINI_API_KEY = ""; 
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash"; 
        const IMAGEN_MODEL = "imagen-3.0-generate-002"; 

        async function callGeminiAPI(prompt, isJsonOutput = false, schema = null) {
            if (!GEMINI_API_KEY) {
                showModal("خطای API", "کلید Gemini API تنظیم نشده است. قابلیت‌های هوش مصنوعی فعال نیستند.", "باشه", null, () => hideModal());
                return null;
            }
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden'); 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            if (isJsonOutput) { 
                payload.generationConfig = {
                    responseMimeType: "application/json",
                };
                if (schema) {
                    payload.generationConfig.responseSchema = schema;
                }
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { 
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJsonOutput ? JSON.parse(text) : text; 
                } else {
                    throw new Error("پاسخ نامعتبر از سرویس هوش مصنوعی دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                // Avoid showing error modal for "offensive content" as it's a safety feature response
                if (!error.message.includes("offensive, hateful, or contain profanity")) { 
                    showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد: ${error.message}`, "باشه", null, () => hideModal());
                }
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden'); 
            }
        }

        async function callImagenAPI(prompt, sampleCount = 1) {
            if (!GEMINI_API_KEY) {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "کلید Gemini API تنظیم نشده است. قابلیت‌های هوش مصنوعی فعال نیستند.";
                return null;
            }
            if(avatarAiLoading) avatarAiLoading.classList.remove('hidden'); 
            if(avatarErrorMessage) avatarErrorMessage.textContent = '';
            
            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { "sampleCount": sampleCount } 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { 
                    const errorBody = await response.text();
                    throw new Error(`API request failed: ${response.status} ${errorBody}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                } else {
                    throw new Error("پاسخ نامعتبر از سرویس ساخت تصویر دریافت شد.");
                }
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = `خطا در ساخت آواتار: ${error.message}`;
                return null;
            } finally {
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden'); 
            }
        }
        
        // --- Game Logic Functions ---

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return; 
            gameState.isLoadingNextQuestion = true;
            if(questionText) questionText.textContent = "در حال تولید سوال جدید...";
            if(optionsContainer) optionsContainer.innerHTML = "";
            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(gameFeedback) gameFeedback.textContent = "";

            const prompt = `یک سوال چند گزینه ای با موضوع مافیا (تاریخچه، فیلم ها، اصطلاحات، یا سناریوهای مرتبط با مافیا) به زبان فارسی ایجاد کن. سوال باید دارای 4 گزینه باشد و گزینه صحیح مشخص شود. پاسخ را در قالب JSON با ساختار زیر ارائه بده:
            {
              "question": "متن سوال به فارسی",
              "options": ["گزینه ۱", "گزینه ۲", "گزینه ۳", "گزینه ۴"],
              "correctAnswerIndex": 0, 
              "explanation": "توضیح مختصر در مورد پاسخ صحیح به فارسی"
            }
            مطمئن شو که ایندکس پاسخ صحیح معتبر و بین 0 تا 3 باشد.`;
            
            try {
                const data = await callGeminiAPI(prompt, true); 
                if (data && data.question && data.options?.length === 4 && data.correctAnswerIndex !== undefined) {
                    gameState.currentQuestionData = data;
                    displayQuestion(); 
                } else {
                    throw new Error("ساختار سوال از AI معتبر نیست.");
                }
            } catch (error) {
                console.error("Error generating question:", error);
                if(questionText) questionText.textContent = "خطا در بارگذاری سوال.";
                showModal("خطا در سوال", `مشکلی در تولید سوال جدید پیش آمد. (${error.message}) آیا میخواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی", 
                    () => { hideModal(); generateQuestion(); }, 
                    () => { hideModal(); if(mainScreen) showScreen(mainScreen); }
                );
            } finally {
                gameState.isLoadingNextQuestion = false;
                gameState.isQuestionActive = true; 
            }
        }

        async function generateHint() {
            if (!gameState.currentQuestionData) return null; 
            
            const hintCost = 100;
            if (gameState.coins < hintCost) { 
                showModal("سکه ناکافی", `برای دریافت راهنمایی ${hintCost} سکه نیاز دارید.`, "باشه", null, () => hideModal());
                return null;
            }

            showModal(
                "درخواست راهنمایی",
                `آیا مایلید ${hintCost} سکه برای دریافت راهنمایی خرج کنید؟`,
                "بله، راهنمایی بده",
                "خیر",
                async () => { 
                    hideModal(); 
                    const coinUpdateSuccess = await updateCoins(-hintCost); 
                    if (coinUpdateSuccess) {
                        const { question, options, correctAnswerIndex } = gameState.currentQuestionData;
                        const correctAnswerText = options[correctAnswerIndex];
                        const prompt = `برای سوال مافیایی زیر یک راهنمایی کوتاه و غیر مستقیم به زبان فارسی ارائه بده. راهنمایی نباید پاسخ را مستقیما لو بدهد.
                        سوال: "${question}"
                        گزینه ها: ${options.join(", ")}
                        پاسح صحیح: "${correctAnswerText}"
                        راهنمایی شما:`;

                        const hintText = await callGeminiAPI(prompt);
                        if (hintText) { 
                            showModal("راهنمایی ✨", hintText.replace(/\n/g, '<br>'), "متوجه شدم", null, () => hideModal());
                        } else { 
                            await updateCoins(hintCost); // Refund coins if API call fails
                            showModal("خطا", "متاسفانه دستیار نتوانست راهنمایی ارائه دهد. سکه‌های شما بازگردانده شد.", "باشه", null, () => hideModal());
                        }
                    }
                },
                () => hideModal() 
            );
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData || !questionText || !optionsContainer) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = ""; 
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right'; 
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index; 
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            if(questionExplanation) questionExplanation.classList.add('hidden');
            if(questionExplanation) questionExplanation.textContent = "";
            if(gameFeedback) gameFeedback.textContent = "";
            gameState.isQuestionActive = true; 
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion || !optionsContainer || !gameFeedback) return;
            gameState.isQuestionActive = false; 

            const selectedOptionButton = event.target.closest('.option-btn');
            if (!selectedOptionButton) return;

            const selectedIndex = parseInt(selectedOptionButton.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData; 

            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) { 
                selectedOptionButton.classList.add('correct');
                gameFeedback.textContent = "پاسخ صحیح! +۵ سکه";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 h-8 text-green-400';
                await updateCoins(5); 
                gameState.currentStage++; 
                await saveUserData(); 
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000); 
            } else { 
                selectedOptionButton.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct'); 
                
                const selectedOptionText = options[selectedIndex];
                const correctAnswerText = options[correctAnswerIndex];
                const tauntPrompt = `شما یک رئیس مافیای شوخ طبع هستید. بازیکن به این سوال پاسخ اشتباه داده است:
                سوال: "${question}"
                پاسخ اشتباه بازیکن: "${selectedOptionText}"
                پاسخ صحیح: "${correctAnswerText}"
                یک طعنه کوتاه و بامزه (۱ تا ۲ جمله) به زبان فارسی در مورد اشتباه بازیکن یا موضوع سوال بگویید. طعنه باید مناسب فضای بازی و نه چندان توهین آمیز باشد. همچنین ۵ سکه از او کم کن.`;

                const taunt = await callGeminiAPI(tauntPrompt);
                if (taunt) { 
                    gameFeedback.innerHTML = `${taunt.replace(/\n/g, '<br>')} <br> (-۵ سکه)`;
                } else { 
                    gameFeedback.textContent = "پاسخ اشتباه! -۵ سکه";
                }
                gameFeedback.className = 'text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-auto text-red-400'; 
                await updateCoins(-5); 
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000); 
            }
            if (explanation && questionExplanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }

        async function skipStage() {
            if (gameState.isLoadingNextQuestion) return;
            const skipCost = 250;
            if (gameState.coins < skipCost) { 
                showModal("سکه ناکافی", `برای رد کردن مرحله ${skipCost} سکه نیاز دارید.`, "باشه", null, () => hideModal());
                return;
            }
            
            showModal("رد کردن مرحله", `آیا مطمئن هستید که می‌خواهید این مرحله را با ${skipCost} سکه رد کنید؟`, "بله، رد کن", "خیر", 
            async () => { 
                hideModal(); 
                const coinUpdateSuccess = await updateCoins(-skipCost); 
                if (coinUpdateSuccess) {
                    gameState.currentStage++; 
                    await saveUserData();
                    updateUI();
                    generateQuestion(); 
                }
            }, 
            () => hideModal() 
            );
        }
        
        const shopItems = [
            { id: 'coins_1000', name: '۱۰۰۰ سکه', price: '۱۰,۰۰۰ تومان', icon: '🪙', description: 'یک شروع خوب برای تازه واردها!' },
            { id: 'coins_5000', name: '۵۵۰۰ سکه', price: '۵۰,۰۰۰ تومان', icon: '💰', description: 'بسته ویژه با ۵۰۰ سکه اضافه!' },
            { id: 'coins_12000', name: '۱۲۰۰۰ سکه', price: '۱۰۰,۰۰۰ تومان', icon: '💎', description: 'برای حرفه‌ای‌ها، با ۲۰۰۰ سکه جایزه!' },
            { id: 'respect_pack', name: 'بسته احترام', price: '۲۵,۰۰۰ تومان', icon: '🎩', description: '۲۵۰۰ سکه + نشان افتخار (نمایشی)' }
        ];

        function displayShopItems() {
            if(!shopItemsContainer) return;
            shopItemsContainer.innerHTML = ''; 
            shopItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `shop-item panel panel-visible p-3 sm:p-5 rounded-lg text-center flex flex-col items-center justify-between shadow-md bg-[rgba(40,40,40,0.9)]`;
                itemDiv.innerHTML = `
                    <div class="text-4xl sm:text-6xl mb-2 sm:mb-3">${item.icon}</div>
                    <h3 class="text-lg sm:text-xl font-semibold text-[#c49730] mb-1">${item.name}</h3>
                    <p class="text-xs sm:text-sm text-gray-400 mb-2 sm:mb-3 min-h-[30px] sm:min-h-[40px]">${item.description || ''}</p>
                    <p class="text-base sm:text-lg font-bold text-green-300 mb-3 sm:mb-4">${item.price}</p>
                    <button class="btn-mafia w-full buy-item-btn text-xs sm:text-sm py-1.5 sm:py-2" data-item-id="${item.id}">خرید</button>
                `;
                shopItemsContainer.appendChild(itemDiv);
            });

            document.querySelectorAll('.buy-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const selectedItem = shopItems.find(i => i.id === itemId);
                    showModal("خرید آیتم", `شما در حال خرید "${selectedItem.name}" به قیمت ${selectedItem.price} هستید.<br><br><strong class="text-yellow-400">توجه: این بخش در حال حاضر کاملاً نمایشی است و هیچ تراکنش مالی واقعی انجام نخواهد شد.</strong>`, "متوجه شدم", null, () => hideModal());
                });
            });
        }
        
        async function generateAndDisplayAvatars() {
            if(!avatarAiLoading || !avatarSuggestionsContainer || !modalConfirmBtn) return;
            avatarAiLoading.classList.remove('hidden'); 
            // Generic prompt for mafia-themed avatars
            const prompt = "Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons";
            const suggestions = await callImagenAPI(prompt, 4); // Request 4 suggestions

            avatarSuggestionsContainer.innerHTML = ''; 
            selectedAvatarForConfirmation = null; 

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(base64Url => { 
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'avatar-suggestion-item';
                    const img = document.createElement('img');
                    img.src = base64Url;
                    img.alt = "پیشنهاد آواتار";
                    imgWrapper.appendChild(img);
                    imgWrapper.addEventListener('click', () => {
                        const currentSelected = avatarSuggestionsContainer.querySelector('.selected');
                        if (currentSelected) {
                            currentSelected.classList.remove('selected');
                        }
                        imgWrapper.classList.add('selected');
                        selectedAvatarForConfirmation = base64Url; 
                        modalConfirmBtn.disabled = false; // Enable confirm button once an avatar is selected
                    });
                    avatarSuggestionsContainer.appendChild(imgWrapper);
                });
                modalConfirmBtn.textContent = "انتخاب این آواتار"; 
                modalConfirmBtn.disabled = true; // Disable until an avatar is selected
            } else { 
                if(avatarErrorMessage) avatarErrorMessage.textContent = "متاسفانه نتوانستیم آواتاری بسازیم. دوباره تلاش کنید.";
                modalConfirmBtn.textContent = "تایید"; // Reset button text
                modalConfirmBtn.disabled = true; // Keep disabled if no avatars
            }
        }
        
        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation; 
                await saveUserData(); 
                updateUI(); 
                hideModal();
                showModal("موفقیت", "آواتار شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
            } else {
                if(avatarErrorMessage) avatarErrorMessage.textContent = "لطفا ابتدا یک آواتار را انتخاب کنید.";
            }
        }
        
        function validateAndSanitizeName(nameValue, errorElement, inputElement) {
            if (!inputElement || !errorElement) return null; 
            // Allow only English letters, numbers, underscore, hyphen, and period
            const regex = /[^a-zA-Z0-9_.-]/g;
            let sanitizedValue = nameValue.replace(regex, '');
            
            if (nameValue !== sanitizedValue) {
                inputElement.value = sanitizedValue; // Update input field with sanitized value
            }
            
            const trimmedName = sanitizedValue.trim();

            if (trimmedName === '') {
                errorElement.textContent = "نام نمایشی نمی‌تواند خالی باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length < 3) {
                errorElement.textContent = "نام نمایشی باید حداقل ۳ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            if (trimmedName.length > 20) { 
                errorElement.textContent = "نام نمایشی نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
                inputElement.classList.add('invalid');
                return null;
            }
            errorElement.textContent = ''; // Clear error message
            inputElement.classList.remove('invalid');
            return trimmedName;
        }
        
        async function handleChangeDisplayName() {
            if(!newDisplayNameInput || !changeNameErrorMessage) return;
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return; 

            if (newName === gameState.displayName) { 
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = "نام جدید باید با نام فعلی متفاوت باشد.";
                if(newDisplayNameInput) newDisplayNameInput.classList.add('invalid');
                return;
            }

            const changeNameCost = gameState.nameChangeCount === 0 ? 0 : 900; // First change is free, subsequent cost 900 coins
            
            if (gameState.coins < changeNameCost) { 
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = `برای تغییر نام ${changeNameCost === 0 ? ' (بار اول رایگان)' : changeNameCost + ' سکه'} نیاز دارید. سکه شما: ${gameState.coins}`;
                if(newDisplayNameInput) newDisplayNameInput.classList.add('invalid');
                return;
            }

            if (changeNameCost > 0) { 
                const coinDeducted = await updateCoins(-changeNameCost, true); // true to bypass modal for insufficient funds as we already checked
                if (!coinDeducted) {
                    if(changeNameErrorMessage) changeNameErrorMessage.textContent = "خطا در کسر سکه. لطفاً دوباره تلاش کنید.";
                    return; 
                }
            }
            
            gameState.displayName = newName;
            gameState.nameChangeCount++; 
            await saveUserData();
            updateUI();
            hideModal();
            showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!", null, () => hideModal());
        }
        
        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب، نکته تاریخی کمتر شنیده شده، یا یک داستانک کوتاه و غافلگیرکننده (حدود ۲-۴ جمله) در مورد دنیای مافیا (تاریخچه، فیلم‌ها، شخصیت‌های معروف، یا اصطلاحات رایج) به زبان فارسی برای من تعریف کن. سعی کن هر بار یک مطلب جدید ارائه دهی.";
            showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو در آرشیوهای مخفی...</p>", "باشه", null, () => hideModal());
            
            const fact = await callGeminiAPI(prompt);
            if (fact) { 
                showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!", null, () => hideModal());
            } else { 
                showModal("خطا", "متاسفانه در حال حاضر نکته‌ای برای گفتن نیست. لطفاً بعداً تلاش کنید.", "باشه", null, () => hideModal());
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; 
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        // --- Event Listener Setup ---
        function setupEventListeners() {
            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', handleModalConfirm);
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', handleModalCancel);

            if (displayNameInput) {
                displayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                });
                displayNameInput.addEventListener('keydown', (event) => { 
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        if(registerBtn) registerBtn.click(); 
                    }
                });
            }

            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', () => {
                    const newPublicId = generateAlphanumericPublicUserId();
                    if (userIdDisplayInput) userIdDisplayInput.value = newPublicId;
                    gameState.publicUserId = newPublicId; 
                    if (userIdErrorMessage) userIdErrorMessage.textContent = ''; 
                });
            }


            if (newDisplayNameInput) {
                newDisplayNameInput.addEventListener('input', () => {
                    validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
                });
                newDisplayNameInput.addEventListener('keydown', (event) => { 
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (modalConfirmCallback === handleChangeDisplayName && modalTitle && modalTitle.textContent.includes("تغییر نام نمایشی")) {
                            if(modalConfirmBtn) modalConfirmBtn.click();
                        }
                    }
                });
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', async () => {
                    const validatedName = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                    
                    let isPublicIdValid = false;
                    if (!gameState.publicUserId) {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "لطفاً ابتدا یک شناسه کاربری بسازید.";
                        isPublicIdValid = false;
                    } else if (userIdDisplayInput && userIdDisplayInput.value !== gameState.publicUserId) {
                        // This case should ideally not happen if generateUserIdBtn sets gameState.publicUserId correctly
                        if(userIdErrorMessage) userIdErrorMessage.textContent = "خطا: شناسه کاربری نمایش داده شده با شناسه ساخته شده مغایرت دارد.";
                        isPublicIdValid = false;
                    }
                    else {
                        if(userIdErrorMessage) userIdErrorMessage.textContent = ""; 
                        isPublicIdValid = true;
                    }

                    if (!validatedName || !isPublicIdValid) return; 

                    // Check if user already has a profile with name and ID (existing Firebase user)
                    let userHadProfileWithNameAndId = false;
                    if(isAuthReady && currentUserId && db){ 
                        const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
                        try {
                            const docSnap = await getDoc(userDocRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                // If display name AND public ID existed, then it's not a "first time" registration
                                if (data.displayName && data.publicUserId) { 
                                     userHadProfileWithNameAndId = true;
                                }
                            }
                        } catch(e) { 
                            console.error("Error checking existing profile during registration:", e); 
                            // Treat as no existing profile for safety in case of error
                            userHadProfileWithNameAndId = false;
                        }
                    }

                    gameState.displayName = validatedName; 
                    
                    // Only grant initial coins and reset nameChangeCount if this is the first time a name/ID is set for this user
                    if (!userHadProfileWithNameAndId) { 
                        gameState.coins = 500; // Initial coins for new registration
                        gameState.nameChangeCount = 0; 
                    }
                    await saveUserData(); 
                    updateUI(); 
                });
            }

            if (editNameBtn) {
                editNameBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return; // Must be authenticated and have a name to edit
                    
                    let modalMessageText = "";
                    let confirmButtonText = `تغییر نام`; // Base text

                    if (gameState.nameChangeCount === 0) {
                        modalMessageText = "اولین تغییر نام شما رایگان است. تغییرات بعدی شامل هزینه سکه خواهد بود.";
                        confirmButtonText = "تغییر نام (رایگان - فقط یکبار)";
                    } else {
                        modalMessageText = `تغییر نام ${900} سکه هزینه دارد. سکه‌های شما: ${gameState.coins}.`;
                        confirmButtonText = `تغییر نام (${900} سکه)`;
                        // Add warning if not enough coins
                        if (gameState.coins < 900) {
                             modalMessageText += `<br><span class="text-red-400">سکه کافی برای تغییر نام ندارید.</span>`;
                             confirmButtonText = "تغییر نام (سکه ناکافی)";
                        }
                    }


                    showModal(
                        "تغییر نام نمایشی",
                        modalMessageText, 
                        confirmButtonText,
                        "لغو",
                        handleChangeDisplayName, // The function to call on confirm
                        hideModal, 
                        "changeName" // Custom modal type for name change
                    );
                    // Disable confirm button if not enough coins
                    if (gameState.nameChangeCount > 0 && gameState.coins < 900) {
                        if(modalConfirmBtn) modalConfirmBtn.disabled = true;
                    } else {
                        if(modalConfirmBtn) modalConfirmBtn.disabled = false;
                    }
                });
            }
            
            if (avatarContainer) {
                avatarContainer.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName) return; // Must be authenticated and registered to change avatar
                    selectedAvatarForConfirmation = null; 
                    showModal(
                        "تغییر آواتار",
                        "یک آواتار از لیست زیر انتخاب کنید یا یک آواتار جدید بسازید.", 
                        "انتخاب این آواتار", // This text will be updated after suggestions are generated
                        "لغو",
                        confirmAvatarSelection, 
                        hideModal,  
                        "avatar"    // Custom modal type for avatar selection
                    );
                    if(modalConfirmBtn) modalConfirmBtn.disabled = true; // Initially disable confirm button
                });
            }

            if (generateAvatarBtn) {
                generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);
            }
            
            // Centralized check for main action buttons to ensure user is registered
            const allActionButtons = [startGameBtn, shopBtn, mafiaFactBtn, devIntroBtnHeader].filter(btn => btn !== null); 
            allActionButtons.forEach(button => {
                // Use capture phase for the event listener to intercept clicks before they reach the button's own handler
                button.addEventListener('click', (event) => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) { 
                        event.stopPropagation(); // Stop the event from propagating to the button's own click handler
                        showModal(
                            "ثبت نام لازم است",
                            "برای دسترسی به این بخش، ابتدا باید با وارد کردن نام نمایشی و ساخت شناسه کاربری، ثبت نام خود را کامل کنید.",
                            "باشه",
                            null,
                            () => hideModal()
                        );
                    }
                }, true); // The 'true' argument makes it a capturing listener
            });


            if (startGameBtn) {
                startGameBtn.addEventListener('click', () => {
                    // Actual game start logic, this part runs IF the centralized check above passed
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return; 
                    showModal(
                        "هشدار VPN", 
                        "دوست عزیز، برای تجربه بهتر و بدون اختلال در بازی، پیشنهاد می‌شود VPN خود را روشن کنید. اتصال پایدار برای بازی آنلاین ضروری است.",
                        "متوجه شدم، ادامه بده", null,
                        () => { 
                            hideModal();
                            if(gameScreen) showScreen(gameScreen);
                            // Generate new question or display current one based on state
                            if (!gameState.currentQuestionData || gameState.currentQuestionData.stage !== gameState.currentStage) {
                                generateQuestion();
                            } else {
                                displayQuestion(); 
                            }
                        }
                    );
                });
            }
            
            if (shopBtn) {
                shopBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return; 
                    displayShopItems(); 
                    if(shopScreen) showScreen(shopScreen);
                });
            }

            if (mafiaFactBtn) { 
                mafiaFactBtn.addEventListener('click', () => {
                    if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) return; 
                    generateMafiaFact();
                });
            }
            
            if (devIntroBtnHeader) { 
                devIntroBtnHeader.addEventListener('click', () => {
                    if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                        showDevelopersPanel();
                    }
                });
            }

            if (closeDevelopersPanelBtn) { 
                closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            }


            if(backToMainFromShopBtn) {
                backToMainFromShopBtn.addEventListener('click', () => {
                    if(mainScreen) showScreen(mainScreen);
                });
            }
            if(hintBtn) {
                hintBtn.addEventListener('click', generateHint);
            }
            if(skipStageBtn) {
                skipStageBtn.addEventListener('click', skipStage);
            }
            if(backToMainBtn) {
                backToMainBtn.addEventListener('click', async () => {
                    try {
                        await saveUserData(); // Save game state before returning to main
                        gameState.currentQuestionData = null; // Clear question data to ensure a new one is loaded next time
                        if(mainScreen) {
                            showScreen(mainScreen);
                        }
                    }
                    catch (e) {
                        console.error("Error in backToMainBtn click listener (game screen):", e);
                    }
                });
            }

            window.addEventListener('resize', () => {
                updateUI(); // Update UI on resize, especially for avatar visibility
            });
        }

        // --- Game Initialization ---
        async function initializeGame() {
            // Get all DOM elements
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            mainScreen = document.getElementById('main-screen');
            gameScreen = document.getElementById('game-screen');
            shopScreen = document.getElementById('shop-screen'); 
            registrationForm = document.getElementById('registration-form');
            displayNameInput = document.getElementById('display-name-input');
            registerBtn = document.getElementById('register-btn');
            inputErrorMessage = document.getElementById('input-error-message');
            userIdDisplayInput = document.getElementById('user-id-display');
            generateUserIdBtn = document.getElementById('generate-user-id-btn');
            userIdErrorMessage = document.getElementById('user-id-error-message');

            userProfileArea = document.getElementById('user-profile-area');
            avatarContainer = document.getElementById('avatar-container');
            avatarImage = document.getElementById('avatar-image');
            userInfoBox = document.getElementById('user-info-box');
            displayNameOutput = document.getElementById('display-name-output'); 
            publicUserIdOutput = document.getElementById('public-user-id-output'); 
            editNameBtn = document.getElementById('edit-name-btn');
            coinsOutput = document.getElementById('coins-output'); 
            mainScreenButtonsLayout = document.getElementById('main-screen-buttons-layout');
            startGameBtn = document.getElementById('start-game-btn');
            shopBtn = document.getElementById('shop-btn'); 
            mafiaFactBtn = document.getElementById('mafia-fact-btn');
            devIntroBtnHeader = document.getElementById('dev-intro-icon-btn-header'); 
            stageDisplay = document.getElementById('stage-display');
            gameCoinsDisplay = document.getElementById('game-coins-display');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            questionExplanation = document.getElementById('question-explanation');
            hintBtn = document.getElementById('hint-btn');
            skipStageBtn = document.getElementById('skip-stage-btn');
            backToMainBtn = document.getElementById('back-to-main-btn');
            gameFeedback = document.getElementById('game-feedback');
            aiThinkingIndicator = document.getElementById('ai-thinking-indicator');
            backToMainFromShopBtn = document.getElementById('back-to-main-from-shop-btn'); 
            shopItemsContainer = document.getElementById('shop-items-container'); 
            modalContainer = document.getElementById('modal-container');
            modalTitle = document.getElementById('modal-title');
            modalContentDynamic = document.getElementById('modal-content-dynamic');
            modalMessage = document.getElementById('modal-message');
            changeNameInputContainer = document.getElementById('change-name-input-container');
            newDisplayNameInput = document.getElementById('new-display-name-input');
            changeNameErrorMessage = document.getElementById('change-name-error-message');
            avatarGenerationContainer = document.getElementById('avatar-generation-container');
            generateAvatarBtn = document.getElementById('generate-avatar-btn');
            avatarAiLoading = document.getElementById('avatar-ai-loading');
            avatarSuggestionsContainer = document.getElementById('avatar-suggestions-container');
            avatarErrorMessage = document.getElementById('avatar-error-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            developersPanelContainer = document.getElementById('developers-panel-container'); 
            closeDevelopersPanelBtn = document.getElementById('close-developers-panel-btn'); 

            // Initially hide user profile area
            if(userProfileArea) userProfileArea.classList.add('hidden'); 

            if(loadingMessage) loadingMessage.textContent = "در حال بررسی اتصال به اینترنت...";
            if (!navigator.onLine) {
                showModal("عدم اتصال به اینترنت", "لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.", "تلاش مجدد", null, () => {
                    hideModal();
                    if (navigator.onLine) initializeGame(); else showModal("عدم اتصال", "همچنان به اینترنت متصل نیستید.", "باشه", null, () => hideModal());
                });
                return; 
            }
            if(loadingMessage) loadingMessage.textContent = "در حال آماده سازی اولین ورود...";
            
            try {
                setupEventListeners(); // Setup all event listeners first
                await initFirebase(); // Initialize Firebase and authentication
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "خطا در راه اندازی بازی.";
            }
        }
        
        // Start game initialization when the DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame(); 
        }

    </script>
</body>
</html>
