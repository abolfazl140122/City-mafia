<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .mafia-animated-bg {
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .panel {
            background-color: rgba(30, 30, 30, 0.95);
            border: 1px solid #c49730;
            box-shadow: 0 0 20px rgba(200, 150, 50, 0.5);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden; /* Ensure it's not interactive when hidden */
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        .btn-mafia {
            background-color: #c49730;
            color: #1a1a1a;
            border: 2px solid #a57c1a;
            padding: 8px 16px; /* Base padding */
            font-size: 0.9rem; /* Base font size */
            border-radius: 8px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: nowrap; /* Prevent text wrapping inside buttons */
            display: inline-flex; /* For aligning icon and text if any */
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 640px) {
            .btn-mafia {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }

        .btn-mafia:hover {
            background-color: #d4a840;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
         .btn-mafia:disabled {
            background-color: #7e6a3b;
            color: #524425;
            border-color: #6a531f;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        .btn-mafia-secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 2px solid #333333;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
         @media (min-width: 640px) {
            .btn-mafia-secondary {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        .btn-mafia-secondary:hover {
            background-color: #5a5a5a;
            color: #c49730;
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .input-mafia {
            background-color: #333;
            border: 1px solid #c49730;
            color: #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
        }
        @media (max-width: 639px) {
            .input-mafia {
                font-size: 0.9rem;
                padding: 8px;
            }
        }

        .input-mafia:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(200, 150, 50, 0.7);
        }
        .input-mafia.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.7);
        }
        .input-mafia:read-only {
            background-color: #444;
            cursor: default;
        }


        .option-btn {
            background-color: rgba(50, 50, 50, 0.8);
            border: 1px solid #c49730;
            color: #e0e0e0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 0.9rem;
            padding: 10px;
        }
        @media (min-width: 768px) {
            .option-btn {
                font-size: 1rem;
                padding: 12px;
            }
        }

        .option-btn:hover {
            background-color: rgba(70, 70, 70, 0.9);
            transform: scale(1.02);
        }
        .option-btn.correct { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        .option-btn.incorrect { background-color: #dc3545 !important; border-color: #b02a37 !important; color: white !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .loader {
            border: 8px solid #444;
            border-top: 8px solid #c49730;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @media (min-width: 640px) {
            .loader {
                width: 60px;
                height: 60px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #c49730; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a57c1a; }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        @media (min-width: 640px) { /* sm */
            .screen {
                padding: 20px; /* Increased padding for larger screens */
            }
        }

        #main-screen {
            justify-content: center;
        }
        #loading-screen {
             justify-content: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            position: relative;
            z-index: 1;
        }
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) {
            .screen-content-wrapper {
                 padding-bottom: 20px;
            }
        }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 40px);
        }
        @media (max-width: 639px) {
             #main-screen .screen-content-wrapper {
                padding-top: 60px; /* Space for mobile user profile */
             }
        }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area {
                top: 10px;
                left: 50%;
                transform: translateX(-50%) translateY(0);
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateX(-50%) translateY(-150%);
            }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area {
                top: 20px;
                right: 20px;
                transform: translateY(0);
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateY(-150%);
            }
        }

        #user-info-box {
            background-color: rgba(15, 15, 15, 0.85);
            border: 1px solid #c49730;
            border-radius: 10px;
            padding: 8px 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        @media (min-width: 768px) {
            #user-info-box {
                border-width: 2px;
                border-radius: 12px;
                padding: 10px 15px;
                gap: 6px;
                min-width: 180px;
            }
        }

        #user-info-box.hidden, #avatar-container.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .user-info-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
            width: 100%;
        }

        .user-info-item .label {
            font-size: 0.75em;
            color: #a0a0a0;
            white-space: nowrap;
        }
        @media (min-width: 768px) {
            .user-info-item .label {
                font-size: 0.8em;
            }
        }

        .user-info-item .value {
            font-size: 0.9em;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media (min-width: 768px) {
            .user-info-item .value {
                font-size: 1em;
            }
        }

        #display-name-output-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #edit-name-btn {
            cursor: pointer;
            font-size: 0.85em;
            color: #c49730;
            transition: color 0.3s ease;
        }
        #edit-name-btn:hover {
            color: #d4a840;
        }
        
        #display-name-output-box .value {
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(200, 150, 50, 0.5);
        }
        
        #public-user-id-output-box .value {
            color: #a0a0a0;
            font-family: monospace;
        }

        #avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #c49730;
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(200, 150, 50, 0.5);
        }
        #avatar-container:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(200, 150, 50, 0.7);
        }
        @media (min-width: 768px) {
            #avatar-container {
                width: 70px;
                height: 70px;
            }
        }

        #avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #avatar-suggestions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .avatar-suggestion-item {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.3s ease, transform 0.2s ease;
            position: relative;
        }
        .avatar-suggestion-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-suggestion-item:hover {
            border-color: #c49730;
            transform: scale(1.05);
        }
        .avatar-suggestion-item.selected {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
            transform: scale(1.05);
        }

        /* Main Screen Header Styling */
        #main-screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold;
            color: #c49730;
            text-shadow: 0 2px 2px rgba(0,0,0,0.8);
            margin-right: auto; /* Pushes title towards center if icon is on left */
            margin-left: auto; /* Pushes title towards center if icon is on right */
        }
        @media (min-width: 640px) { /* sm */
            #main-title {
                font-size: 3rem; /* text-5xl */
            }
        }
        @media (min-width: 768px) { /* md */
            #main-title {
                font-size: 3.75rem; /* text-6xl */
            }
        }

        /* Developer Intro Icon Button - Header Position */
        #dev-intro-icon-btn-header {
            background-color: transparent;
            color: #c49730;
            border: 2px solid #c49730;
            padding: 0.5rem;
            border-radius: 50%;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #dev-intro-icon-btn-header:hover {
            background-color: rgba(196, 151, 48, 0.2);
            color: #d4a840;
            border-color: #d4a840;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        #dev-intro-icon-btn-header svg {
            width: 20px;
            height: 20px;
        }
         @media (min-width: 640px) {
            #dev-intro-icon-btn-header {
                width: 44px;
                height: 44px;
                padding: 0.6rem;
            }
            #dev-intro-icon-btn-header svg {
                width: 22px;
                height: 22px;
            }
        }

        /* Bottom Action Buttons Layout */
        #main-screen-buttons-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: auto;
            padding-top: 1rem;
        }

        #top-action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }
        @media (min-width: 768px) {
            #top-action-buttons {
                gap: 1rem;
            }
        }

        #start-game-btn {
             padding: 0.7rem 1.5rem !important;
             font-size: 1.05rem !important;
             order: 0;
        }
        @media (min-width: 768px) {
            #start-game-btn {
                padding: 0.8rem 1.8rem !important;
                font-size: 1.15rem !important;
            }
        }
        
        #input-error-message, #user-id-error-message, #change-name-error-message, #avatar-error-message {
            color: #dc3545;
            font-size: 0.8rem;
            text-align: right;
            min-height: 1.2rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .hidden {
            display: none !important;
        }

        /* Styles for Developers Panel */
        #developers-panel-container {
            background-color: rgba(10, 10, 10, 0.92);
        }
        #developers-panel {
            background: radial-gradient(circle at top center, rgba(45, 45, 55, 0.98), rgba(15, 15, 20, 0.99));
            border: 2px solid #c49730;
            box-shadow: 0 0 35px rgba(200, 150, 50, 0.65), 0 0 10px rgba(200, 150, 50, 0.4) inset;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 15px;
        }
        #close-developers-panel-btn {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 34px;
            height: 34px;
            background-color: rgba(196, 151, 48, 0.85);
            color: #101010;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 7px rgba(0,0,0,0.5);
            z-index: 10;
        }
        #close-developers-panel-btn:hover {
            background-color: #d4a840;
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }

        .developer-item {
            background-color: rgba(28, 28, 35, 0.92);
            padding: 1.2rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(196, 151, 48, 0.25);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.55);
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: right;
            margin-bottom: 1rem;
        }
        .developer-item:last-child {
            margin-bottom: 0;
        }
        .developer-item:hover {
            transform: translateY(-5px) scale(1.015);
            box-shadow: 0 10px 28px rgba(196, 151, 48, 0.45);
            border-color: rgba(196, 151, 48, 0.6);
        }

        .dev-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
            border-bottom: 1px solid rgba(196, 151, 48, 0.2);
            padding-bottom: 0.6rem;
        }
        .dev-role-icon {
            font-size: 1.7em;
            color: #c49730;
            margin-left: 10px;
            width: 28px;
            text-align: center;
            line-height: 1;
        }
        .dev-role {
            font-size: 1.15rem;
            font-weight: 700;
            color: #e8e8e8;
        }
        .dev-username {
            color: #efbe5a;
            font-family: 'Vazirmatn', 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.25rem;
            display: block;
            margin-bottom: 0.5rem;
            margin-top: 0.2rem;
        }
        .dev-description {
            font-size: 0.9rem;
            color: #b8b8b8;
            line-height: 1.65;
        }

    </style>
</head>
<body>
    <div class="mafia-animated-bg"></div>

    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label">بازیکن:</div>
                <div id="display-name-output-container">
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label">شناسه:</div>
                <div id="public-user-id-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-[#c49730]">بارگذاری بازی مافیا...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl">در حال بررسی اتصال...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper">
            <div id="main-content-area">
                <div id="main-screen-header">
                    <button id="dev-intro-icon-btn-header" title="معرفی توسعه دهندگان">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                    <h1 id="main-title">شهر مافیا</h1>
                     <div style="width: 44px; flex-shrink: 0;"></div>
                </div>

                <div id="registration-form" class="mb-4 panel panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center text-[#c49730]">ثبت نام / ورود</h2>
                    <input type="text" id="display-name-input" placeholder="نام نمایشی (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="input-error-message" class=""></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-1">شناسه کاربری (5 رقمی):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-mafia w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="ابتدا بسازید">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm">ساخت شناسه</button>
                        </div>
                        <p id="user-id-error-message" class=""></p>
                    </div>

                    <button id="register-btn" class="btn-mafia w-full p-2 sm:p-3 text-base sm:text-lg mt-3">ورود به شهر</button>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons" class="">
                    <button id="start-game-btn" class="btn-mafia">شروع بازی آنلاین</button>
                    <button id="mafia-fact-btn" class="btn-mafia" style="order: 1;">دانستنی‌های مافیا ✨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start">
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-2 sm:p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-sm sm:text-base md:text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">بازگشت ⟵</button>
                <div>مرحله: <span id="stage-display" class="font-bold text-[#c49730]">1</span></div>
            </div>

            <div id="question-container" class="panel panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[150px] sm:min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed">سوال بارگذاری می‌شود...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                <p id="question-explanation" class="text-xs sm:text-sm mt-3 sm:mt-4 text-gray-400 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-auto min-h-[2rem]"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-3 sm:mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-sm sm:text-base">دستیار هوش مصنوعی در حال فکر کردن است...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-3 sm:p-4 panel-hidden z-50">
        <div class="panel panel-visible p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-[#c49730]">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-2 sm:mb-3 text-sm sm:text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="change-name-error-message" class=""></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">ساخت آواتار جدید با AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">در حال ساخت آواتارهای پیشنهادی... (ممکن است کمی طول بکشد)</p>
                    </div>
                    <div id="avatar-suggestions-container"></div>
                    <p id="avatar-error-message" class=""></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-3 sm:gap-4 mt-4">
                <button id="modal-confirm-btn" class="btn-mafia">تایید</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">لغو</button>
            </div>
        </div>
    </div>

    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51]">
        <div id="developers-panel" class="panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-developers-panel-btn">×</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">سازندگان شهر مافیا</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💻</span>
                        <h4 class="dev-role">برنامه نویس ارشد</h4>
                    </div>
                    <p class="dev-username">abolfazl1401</p>
                    <p class="dev-description">معمار و توسعه‌دهنده اصلی گیم‌پلی، رابط کاربری و منطق بازی شهر مافیا.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">🎨</span>
                        <h4 class="dev-role">طراح گرافیک</h4>
                    </div>
                    <p class="dev-username">Vahid</p>
                    <p class="dev-description">طراح رابط کاربری (UI) و تجربه کاربری (UX). مسئولیت خلق هویت بصری جذاب و تم مافیایی بازی بر عهده او بوده است.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">💡</span>
                        <h4 class="dev-role">ایده پرداز</h4>
                    </div>
                    <p class="dev-username">Ali.k</p>
                    <p class="dev-description">خالق ایده‌های نوآورانه برای مراحل، چالش‌ها و داستان‌سرایی در دنیای مافیا.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">☁️</span>
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username">Neda_Tech</p>
                    <p class="dev-description">متخصص در پیاده‌سازی و نگهداری زیرساخت‌های سرور، تضمین پایداری و امنیت بازی.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">⚙️</span>
                        <h4 class="dev-role">توسعه دهنده سرور</h4>
                    </div>
                    <p class="dev-username">SinaCloud</p>
                    <p class="dev-description">مسئول بهینه‌سازی ارتباطات شبکه و مدیریت پایگاه داده‌های بازی برای تجربه‌ای روان.</p>
                </div>
                <div class="developer-item">
                    <div class="dev-header">
                        <span class="dev-role-icon">🚀</span>
                        <h4 class="dev-role">توسعه دهنده سرور (DevOps)</h4>
                    </div>
                    <p class="dev-username">ParsaDevOps</p>
                    <p class="dev-description">متمرکز بر فرآیندهای DevOps، استقرار خودکار و مانیتورینگ عملکرد سرورهای بازی.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
            avatarUrl: '',
            seenQuestionHashes: new Set(), // <<--- NEW: To store hashes of seen questions
        };

        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;

        // <<--- NEW: Simple non-cryptographic hash function
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return `h${Math.abs(hash)}`;
        }

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            screenElement.scrollTop = 0;
            updateUI();
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalContainer) return;

            modalTitle.textContent = title;

            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');

            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }

            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.textContent = '';
                newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                avatarSuggestionsContainer.innerHTML = '';
                avatarErrorMessage.textContent = '';
                avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }

            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "لغو";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
            modalContainer.classList.add('panel-visible');
        }

        function hideModal() {
            if (!modalContainer) return;
            modalContainer.classList.add('panel-hidden');
            modalContainer.classList.remove('panel-visible');
            modalConfirmCallback = null;
            modalCancelCallback = null;
            
            if(userProfileArea && mainScreen.classList.contains('active') &&
               (!developersPanelContainer || developersPanelContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) { console.error("Error in modal cancel callback:", e); }
            }
            hideModal();
        }

        function showDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.remove('panel-hidden');
            developersPanelContainer.classList.add('panel-visible');
            if(userProfileArea && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hideDevelopersPanel() {
            if (!developersPanelContainer) return;
            developersPanelContainer.classList.add('panel-hidden');
            developersPanelContainer.classList.remove('panel-visible');
             if(userProfileArea && mainScreen.classList.contains('active') &&
               (!modalContainer || modalContainer.classList.contains('panel-hidden'))) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }
        
        function updateUI() {
            displayNameOutput.textContent = gameState.displayName || "مهمان";
            publicUserIdOutput.textContent = gameState.publicUserId || "---";
            stageDisplay.textContent = gameState.currentStage;

            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }

            let showRegistration = !isAuthReady || !gameState.displayName || !gameState.publicUserId;
            
            registrationForm.classList.toggle('panel-hidden', !showRegistration);
            registrationForm.classList.toggle('panel-visible', showRegistration);
            mainScreenButtonsLayout.classList.toggle('hidden', showRegistration);

            const isAnyPanelVisible = (modalContainer && modalContainer.classList.contains('panel-visible')) ||
                                    (developersPanelContainer && developersPanelContainer.classList.contains('panel-visible'));

            const showUserInfo = isAuthReady && gameState.displayName && mainScreen.classList.contains('active');

            if (showUserInfo && !isAnyPanelVisible) {
                userProfileArea.classList.remove('hidden', 'profile-area-hidden');
            } else if (!showUserInfo) {
                userProfileArea.classList.add('hidden');
            } else if (isAnyPanelVisible) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("Custom token sign-in error, trying anonymous:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen.classList.contains('active')) {
                        loadingMessage.textContent = "خوش آمدید!";
                        setTimeout(() => showScreen(mainScreen), 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingMessage.textContent = "خطا در اتصال به سرور بازی.";
                mainScreenButtonsLayout.classList.add('hidden');
            }
        }

        async function loadUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.seenQuestionHashes = new Set(data.seenQuestionHashes || []); // <<--- MODIFIED
                    console.log(`Loaded ${gameState.seenQuestionHashes.size} seen questions.`);
                } else {
                    Object.assign(gameState, { displayName: "", publicUserId: "", avatarUrl: '', seenQuestionHashes: new Set() });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.", "باشه");
            }
        }

        async function saveUserData() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/mafiaGameData/profile`);
            try {
                await setDoc(userDocRef, {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    seenQuestionHashes: Array.from(gameState.seenQuestionHashes), // <<--- MODIFIED
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                 console.log("User data saved successfully.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("خطا", "مشکلی در ذخیره اطلاعات شما پیش آمد.", "باشه");
            }
        }

        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";

        async function callGeminiAPI(prompt, isJsonOutput = false) {
            aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (isJsonOutput) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJsonOutput ? JSON.parse(text) : text;
                }
                throw new Error(`پاسخ نامعتبر از سرویس هوش مصنوعی (دلیل: ${result.candidates?.[0]?.finishReason || 'نامشخص'})`);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("خطای هوش مصنوعی", `مشکلی در ارتباط با دستیار هوش مصنوعی پیش آمد. لطفاً از خاموش بودن فیلترشکن خود مطمئن شوید و دوباره تلاش کنید.<br><br><small>جزئیات: ${error.message}</small>`, "باشه");
                return null;
            } finally {
                aiThinkingIndicator.classList.add('hidden');
            }
        }

        async function callImagenAPI(prompt, sampleCount = 4) {
            avatarAiLoading.classList.remove('hidden');
            avatarErrorMessage.textContent = '';
            const payload = { instances: [{ prompt }], parameters: { sampleCount } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.status} ${await response.text()}`);
                const result = await response.json();
                if (result.predictions?.length > 0) {
                    return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                }
                throw new Error("پاسخ نامعتبر از سرویس ساخت تصویر دریافت شد.");
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                avatarErrorMessage.textContent = `خطا در ساخت آواتار: ${error.message}`;
                return null;
            } finally {
                avatarAiLoading.classList.add('hidden');
            }
        }

        async function generateQuestion() {
            if (gameState.isLoadingNextQuestion) return;
            gameState.isLoadingNextQuestion = true;
            questionText.textContent = "در حال تولید سوال جدید و غیرتکراری...";
            optionsContainer.innerHTML = "";
            questionExplanation.classList.add('hidden');
            gameFeedback.textContent = "";
            
            let attempts = 0;
            const maxAttempts = 5;
            let questionData = null;

            while (attempts < maxAttempts) {
                let difficulty = gameState.currentStage > 20 ? "بسیار سخت" : gameState.currentStage > 10 ? "سخت" : gameState.currentStage > 5 ? "متوسط" : "آسان";
                const prompt = `شما یک طراح بازی خلاق برای یک بازی مافیایی هستید. یک سوال چند گزینه‌ای (۴ گزینه‌ای) جدید و منحصربه‌فرد به زبان فارسی با موضوع مافیا ایجاد کن. سطح دشواری سوال باید "${difficulty}" باشد چون کاربر در مرحله ${gameState.currentStage} است. موضوعات می‌تواند شامل تاریخچه مافیا، فیلم‌های معروف، اصطلاحات بازی مافیا و... باشد. خروجی باید فقط و فقط یک آبجکت JSON خام با ساختار {"question": "...", "options": ["...", "...", "...", "..."], "correctAnswerIndex": 0, "explanation": "..."} باشد.`;
                const data = await callGeminiAPI(prompt, true);
                if (data?.question) {
                    const questionHash = simpleHash(data.question);
                    if (!gameState.seenQuestionHashes.has(questionHash)) {
                        questionData = data;
                        break;
                    } else {
                        console.warn(`Duplicate question (hash: ${questionHash}), retrying...`);
                        attempts++;
                    }
                } else {
                    console.error("Invalid question data received:", data);
                    attempts++;
                }
            }
            if (questionData) {
                gameState.currentQuestionData = questionData;
                displayQuestion();
            } else {
                questionText.textContent = "خطا در بارگذاری سوال غیرتکراری.";
                showModal("خطا در تولید سوال", `نتوانستیم یک سوال جدید بسازیم. آیا می‌خواهید دوباره تلاش کنید؟`, "تلاش مجدد", "صفحه اصلی",
                    () => { hideModal(); generateQuestion(); },
                    () => { hideModal(); showScreen(mainScreen); }
                );
            }
            gameState.isLoadingNextQuestion = false;
        }

        function displayQuestion() {
            if (!gameState.currentQuestionData) return;
            const { question, options } = gameState.currentQuestionData;
            questionText.textContent = question;
            optionsContainer.innerHTML = "";
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn w-full p-3 rounded-md text-lg text-right';
                button.textContent = `${index + 1}. ${option}`;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            gameState.isQuestionActive = true;
        }

        async function handleAnswerSelection(event) {
            if (!gameState.isQuestionActive || gameState.isLoadingNextQuestion) return;
            gameState.isQuestionActive = false;

            const selectedBtn = event.target.closest('.option-btn');
            if (!selectedBtn) return;
            const selectedIndex = parseInt(selectedBtn.dataset.index);
            const { question, options, correctAnswerIndex, explanation } = gameState.currentQuestionData;
            
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

            if (selectedIndex === correctAnswerIndex) {
                selectedBtn.classList.add('correct');
                gameFeedback.textContent = "پاسخ صحیح!";
                gameFeedback.className = 'text-center text-lg font-semibold my-4 text-green-400';
                
                gameState.seenQuestionHashes.add(simpleHash(question)); // <<--- MODIFIED
                gameState.currentStage++;
                await saveUserData();
                setTimeout(() => { generateQuestion(); updateUI(); }, 2000);
            } else {
                selectedBtn.classList.add('incorrect');
                const correctButton = optionsContainer.querySelector(`.option-btn[data-index="${correctAnswerIndex}"]`);
                if (correctButton) correctButton.classList.add('correct');
                
                const tauntPrompt = `شما یک رئیس مافیای شوخ طبع هستید. بازیکن به این سوال پاسخ اشتباه داده: سوال: "${question}" پاسخ اشتباه: "${options[selectedIndex]}". یک طعنه کوتاه و بامزه (۱-۲ جمله) به فارسی بگو.`;
                const taunt = await callGeminiAPI(tauntPrompt);
                gameFeedback.innerHTML = taunt?.replace(/\n/g, '<br>') || "پاسخ اشتباه!";
                gameFeedback.className = 'text-center text-base sm:text-lg font-semibold my-3 sm:my-4 text-red-400';
                setTimeout(() => { generateQuestion(); updateUI(); }, 4000);
            }
            if (explanation) {
                questionExplanation.textContent = `توضیح: ${explanation}`;
                questionExplanation.classList.remove('hidden');
            }
        }

        async function generateAndDisplayAvatars() {
            const prompt = "Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons, photorealistic style";
            const suggestions = await callImagenAPI(prompt, 4);
            avatarSuggestionsContainer.innerHTML = '';
            selectedAvatarForConfirmation = null;

            if (suggestions?.length > 0) {
                suggestions.forEach(base64Url => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'avatar-suggestion-item';
                    const img = document.createElement('img');
                    img.src = base64Url;
                    img.alt = "پیشنهاد آواتار";
                    imgWrapper.appendChild(img);
                    imgWrapper.addEventListener('click', () => {
                        avatarSuggestionsContainer.querySelector('.selected')?.classList.remove('selected');
                        imgWrapper.classList.add('selected');
                        selectedAvatarForConfirmation = base64Url;
                        modalConfirmBtn.disabled = false;
                    });
                    avatarSuggestionsContainer.appendChild(imgWrapper);
                });
                modalConfirmBtn.textContent = "انتخاب این آواتار";
                modalConfirmBtn.disabled = true;
            } else {
                avatarErrorMessage.textContent = "متاسفانه نتوانستیم آواتاری بسازیم. دوباره تلاش کنید.";
                modalConfirmBtn.disabled = true;
            }
        }

        async function confirmAvatarSelection() {
            if (selectedAvatarForConfirmation) {
                gameState.avatarUrl = selectedAvatarForConfirmation;
                await saveUserData();
                updateUI();
                hideModal();
                showModal("موفقیت", "آواتار شما با موفقیت تغییر کرد!", "عالی!");
            } else {
                avatarErrorMessage.textContent = "لطفا ابتدا یک آواتار را انتخاب کنید.";
            }
        }

        function validateAndSanitizeName(name, errorEl, inputEl) {
            const sanitized = name.replace(/[^a-zA-Z0-9_.-]/g, '').trim();
            if (name !== sanitized) inputEl.value = sanitized;
            if (sanitized.length < 3) {
                errorEl.textContent = "نام باید حداقل ۳ کاراکتر انگلیسی باشد.";
                inputEl.classList.add('invalid'); return null;
            }
            errorEl.textContent = ''; inputEl.classList.remove('invalid');
            return sanitized;
        }

        async function handleChangeDisplayName() {
            const newName = validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput);
            if (!newName) return;
            if (newName === gameState.displayName) {
                changeNameErrorMessage.textContent = "نام جدید باید متفاوت باشد.";
                newDisplayNameInput.classList.add('invalid'); return;
            }
            gameState.displayName = newName;
            await saveUserData();
            updateUI();
            hideModal();
            showModal("موفقیت", "نام نمایشی شما با موفقیت تغییر کرد!", "عالی!");
        }

        async function generateMafiaFact() {
            const prompt = "یک حقیقت جالب، نکته تاریخی کمتر شنیده شده، یا یک داستانک کوتاه و غافلگیرکننده (حدود ۲-۴ جمله) در مورد دنیای مافیا به زبان فارسی برای من تعریف کن.";
            showModal("دانستنی مافیا ✨", "<div class='loader mx-auto my-3'></div><p>در حال جستجو در آرشیوهای مخفی...</p>", "باشه", null, hideModal);
            const fact = await callGeminiAPI(prompt);
            if (fact) {
                showModal("دانستنی مافیا ✨", fact.replace(/\n/g, '<br>'), "جالب بود!");
            } else {
                showModal("خطا", "متاسفانه نکته‌ای برای گفتن نیست. بعداً تلاش کنید.", "باشه");
            }
        }

        function generateAlphanumericPublicUserId(length = 5) {
            return Array.from({length}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.floor(Math.random() * 36))).join('');
        }

        function setupEventListeners() {
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', handleModalCancel);
            
            displayNameInput.addEventListener('input', () => validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput));
            newDisplayNameInput.addEventListener('input', () => validateAndSanitizeName(newDisplayNameInput.value, changeNameErrorMessage, newDisplayNameInput));
            
            [displayNameInput, newDisplayNameInput].forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const btn = input === displayNameInput ? registerBtn : modalConfirmBtn;
                        btn.click();
                    }
                });
            });

            generateUserIdBtn.addEventListener('click', () => {
                const newId = generateAlphanumericPublicUserId();
                userIdDisplayInput.value = newId;
                gameState.publicUserId = newId;
                userIdErrorMessage.textContent = '';
            });

            registerBtn.addEventListener('click', async () => {
                const name = validateAndSanitizeName(displayNameInput.value, inputErrorMessage, displayNameInput);
                const idValid = !!gameState.publicUserId;
                if (!idValid) userIdErrorMessage.textContent = "لطفاً ابتدا شناسه بسازید.";
                if (!name || !idValid) return;

                gameState.displayName = name;
                await saveUserData();
                updateUI();
            });

            editNameBtn.addEventListener('click', () => showModal("تغییر نام نمایشی", "تغییر نام در این بازی رایگان است.", "تغییر نام", "لغو", handleChangeDisplayName, hideModal, "changeName"));

            avatarContainer.addEventListener('click', () => {
                selectedAvatarForConfirmation = null;
                showModal("تغییر آواتار", "", "انتخاب این آواتار", "لغو", confirmAvatarSelection, hideModal, "avatar");
                modalConfirmBtn.disabled = true;
            });

            generateAvatarBtn.addEventListener('click', generateAndDisplayAvatars);
            
            const requireAuth = (e, action) => {
                if (!isAuthReady || !gameState.displayName || !gameState.publicUserId) {
                    e.stopImmediatePropagation();
                    showModal("ثبت نام لازم است", "برای دسترسی به این بخش، ابتدا ثبت نام خود را کامل کنید.", "باشه");
                } else if (action) {
                    action();
                }
            };
            
            startGameBtn.addEventListener('click', (e) => requireAuth(e, () => {
                showModal("شروع بازی", "برای تجربه بهتر، استفاده از VPN با سرور آمریکا پیشنهاد می‌شود.", "ادامه", null, () => {
                    hideModal();
                    showScreen(gameScreen);
                    generateQuestion();
                });
            }));
            
            mafiaFactBtn.addEventListener('click', (e) => requireAuth(e, generateMafiaFact));
            devIntroBtnHeader.addEventListener('click', (e) => requireAuth(e, showDevelopersPanel));
            
            closeDevelopersPanelBtn.addEventListener('click', hideDevelopersPanel);
            
            backToMainBtn.addEventListener('click', async () => {
                await saveUserData();
                gameState.currentQuestionData = null;
                showScreen(mainScreen);
            });
            
            window.addEventListener('resize', updateUI);
        }

        async function initializeGame() {
            // DOM element assignments
            const ids = [
                'loading-screen', 'loading-message', 'main-screen', 'game-screen', 'registration-form',
                'display-name-input', 'register-btn', 'input-error-message', 'user-id-display',
                'generate-user-id-btn', 'user-id-error-message', 'user-profile-area', 'avatar-container',
                'avatar-image', 'user-info-box', 'display-name-output', 'public-user-id-output',
                'edit-name-btn', 'main-screen-buttons-layout', 'start-game-btn', 'mafia-fact-btn',
                'dev-intro-icon-btn-header', 'stage-display', 'question-text', 'options-container',
                'question-explanation', 'back-to-main-btn', 'game-feedback', 'ai-thinking-indicator',
                'modal-container', 'modal-title', 'modal-message', 'change-name-input-container',
                'new-display-name-input', 'change-name-error-message', 'avatar-generation-container',
                'generate-avatar-btn', 'avatar-ai-loading', 'avatar-suggestions-container',
                'avatar-error-message', 'modal-confirm-btn', 'modal-cancel-btn',
                'developers-panel-container', 'close-developers-panel-btn'
            ];
            const toCamelCase = s => s.replace(/-./g, x => x[1].toUpperCase());
            const elements = ids.reduce((acc, id) => ({ ...acc, [toCamelCase(id)]: document.getElementById(id) }), {});
            Object.assign(window, elements); // Assign to global scope for easier access in functions

            loadingMessage.textContent = "در حال بررسی اتصال به اینترنت...";
            if (!navigator.onLine) {
                showModal("عدم اتصال", "لطفاً اتصال اینترنت خود را بررسی کرده و صفحه را مجددا بارگذاری کنید.", "باشه");
                return;
            }
            loadingMessage.textContent = "در حال آماده سازی اولین ورود...";
            setupEventListeners();
            await initFirebase();
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>